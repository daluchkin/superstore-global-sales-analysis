<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Superstore Global Sales Analysis</title>

<script src="superstore_global_analysis_files/header-attrs-2.23/header-attrs.js"></script>
<script src="superstore_global_analysis_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="superstore_global_analysis_files/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="superstore_global_analysis_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="superstore_global_analysis_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="superstore_global_analysis_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="superstore_global_analysis_files/navigation-1.1/tabsets.js"></script>
<script src="superstore_global_analysis_files/navigation-1.1/codefolding.js"></script>
<script src="superstore_global_analysis_files/navigation-1.1/sourceembed.js"></script>
<link href="superstore_global_analysis_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="superstore_global_analysis_files/pagedtable-1.1/js/pagedtable.js"></script>
<script src="superstore_global_analysis_files/kePrint-0.0.1/kePrint.js"></script>
<link href="superstore_global_analysis_files/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Superstore Global Sales Analysis</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#dataset" id="toc-dataset">Dataset</a>
<ul>
<li><a href="#metadata" id="toc-metadata">Metadata</a></li>
</ul></li>
<li><a href="#data-loading" id="toc-data-loading">Data loading</a></li>
<li><a href="#data-cleansing" id="toc-data-cleansing">Data cleansing</a>
<ul>
<li><a href="#duplication-data" id="toc-duplication-data">Duplication
Data</a></li>
<li><a href="#missing-values" id="toc-missing-values">Missing
Values</a></li>
</ul></li>
<li><a href="#preparation-for-analysis"
id="toc-preparation-for-analysis">Preparation for analysis</a></li>
<li><a href="#analysis" id="toc-analysis">Analysis</a>
<ul>
<li><a href="#total-revenue-and-gross-margin"
id="toc-total-revenue-and-gross-margin">Total Revenue and Gross
Margin</a></li>
<li><a href="#total-gross-net-revenue-and-yoy-profit-growth"
id="toc-total-gross-net-revenue-and-yoy-profit-growth">Total Gross &amp;
Net Revenue and YoY Profit Growth</a></li>
<li><a href="#quarterly-net-revenue-growth"
id="toc-quarterly-net-revenue-growth">Quarterly Net Revenue
growth</a></li>
<li><a href="#profit-trends" id="toc-profit-trends">Profit
trends</a></li>
<li><a href="#total-number-of-orders-and-loss-orders"
id="toc-total-number-of-orders-and-loss-orders">Total number of orders
and loss orders</a></li>
<li><a href="#customer-lifetime-value-clv"
id="toc-customer-lifetime-value-clv">Customer Lifetime Value
(CLV)</a></li>
<li><a href="#quarterly-customer-retention-rate"
id="toc-quarterly-customer-retention-rate">Quarterly Customer Retention
Rate</a></li>
<li><a href="#arppu-and-average-check-value"
id="toc-arppu-and-average-check-value">ARPPU and Average check
value</a></li>
<li><a href="#average-basket-value-and-size"
id="toc-average-basket-value-and-size">Average Basket Value and
size</a></li>
<li><a href="#return-rate" id="toc-return-rate">Return Rate</a></li>
<li><a href="#what-most-significant-sub-categories"
id="toc-what-most-significant-sub-categories">What most significant
sub-categories?</a></li>
<li><a href="#map" id="toc-map">Map</a></li>
<li><a href="#top-10-countries-by-sales-volume"
id="toc-top-10-countries-by-sales-volume">Top 10 countries by Sales
Volume</a></li>
<li><a href="#sales-analysis-heat-map-by-day-and-month"
id="toc-sales-analysis-heat-map-by-day-and-month">Sales analysis heat
map by day and month</a></li>
<li><a href="#top-5-returnable-sub-categories-by-merket"
id="toc-top-5-returnable-sub-categories-by-merket">Top 5 returnable
sub-categories by merket</a></li>
<li><a href="#what-are-number-of-total-and-new-customers"
id="toc-what-are-number-of-total-and-new-customers">What are number of
total and new customers?</a></li>
<li><a href="#percentage-of-new-business-revenue-generation"
id="toc-percentage-of-new-business-revenue-generation">Percentage of new
business revenue generation</a></li>
</ul></li>
</ul>
</div>

<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># loading libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(stringi)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(treemapify)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="fu">library</span>(formatR)</span></code></pre></div>
<div id="dataset" class="section level1">
<h1>Dataset</h1>
<p>The <a
href="https://www.kaggle.com/datasets/shekpaul/global-superstore">Global
Superstore dataset</a> contains data of transactions, each row
represents transaction item of products sold around the world by
Superstore, also contains a customer information, shipping and product
returns.</p>
<div id="metadata" class="section level2">
<h2>Metadata</h2>
<p>The dataset contains the following tables:</p>
<div id="table-orders" class="section level3">
<h3>Table <strong>Orders</strong></h3>
<table>
<thead>
<tr class="header">
<th>Variable name</th>
<th>Data type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Row ID</td>
<td><code>Integer</code></td>
<td>Unique ID for each row.</td>
</tr>
<tr class="even">
<td>Order ID</td>
<td><code>String</code></td>
<td>Unique Order ID for each Customer.</td>
</tr>
<tr class="odd">
<td>Order Date</td>
<td><code>Date</code></td>
<td>Order Date of the product.</td>
</tr>
<tr class="even">
<td>Ship Date</td>
<td><code>Date</code></td>
<td>Shipping Date of the Product.</td>
</tr>
<tr class="odd">
<td>Ship Mode</td>
<td><code>String</code></td>
<td>Shipping Mode specified by the Customer.</td>
</tr>
<tr class="even">
<td>Customer ID</td>
<td><code>String</code></td>
<td>Unique ID to identify each Customer.</td>
</tr>
<tr class="odd">
<td>Customer Name</td>
<td><code>String</code></td>
<td>Name of the Customer.</td>
</tr>
<tr class="even">
<td>Segment</td>
<td><code>String</code></td>
<td>The segment where the Customer belongs.</td>
</tr>
<tr class="odd">
<td>City</td>
<td><code>String</code></td>
<td>City of residence of of the Customer.</td>
</tr>
<tr class="even">
<td>State</td>
<td><code>String</code></td>
<td>State of residence of the Customer.</td>
</tr>
<tr class="odd">
<td>Country</td>
<td><code>String</code></td>
<td>Country of residence of the Customer.</td>
</tr>
<tr class="even">
<td>Postal Code</td>
<td><code>String</code></td>
<td>Postal Code of residence of the Customer.</td>
</tr>
<tr class="odd">
<td>Market</td>
<td><code>String</code></td>
<td>Market name.</td>
</tr>
<tr class="even">
<td>Region</td>
<td><code>String</code></td>
<td>Region where the Customer belong.</td>
</tr>
<tr class="odd">
<td>Product ID</td>
<td><code>String</code></td>
<td>Unique ID of the Product.</td>
</tr>
<tr class="even">
<td>Category</td>
<td><code>String</code></td>
<td>Category of the product ordered.</td>
</tr>
<tr class="odd">
<td>Sub-Category</td>
<td><code>String</code></td>
<td>Sub-Category of the product ordered.</td>
</tr>
<tr class="even">
<td>Product Name</td>
<td><code>String</code></td>
<td>Name of the Product</td>
</tr>
<tr class="odd">
<td>Sales</td>
<td><code>Decimal</code></td>
<td>Sales of the Product.</td>
</tr>
<tr class="even">
<td>Quantity</td>
<td><code>Integer</code></td>
<td>Quantity of the Product.</td>
</tr>
<tr class="odd">
<td>Discount</td>
<td><code>Decimal</code></td>
<td>Discount provided.</td>
</tr>
<tr class="even">
<td>Profit</td>
<td><code>Decimal</code></td>
<td>Profit/Loss incurred.</td>
</tr>
<tr class="odd">
<td>Shipping Cost</td>
<td><code>Decimal</code></td>
<td>Shipping cost.</td>
</tr>
<tr class="even">
<td>Order Priority</td>
<td><code>String</code></td>
<td>Order priority.</td>
</tr>
</tbody>
</table>
</div>
<div id="table-returns" class="section level3">
<h3>Table <strong>Returns</strong></h3>
<table>
<thead>
<tr class="header">
<th>Variable name</th>
<th>Data type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Order ID</td>
<td><code>String</code></td>
<td>Unique Order ID for each Customer.</td>
</tr>
<tr class="even">
<td>Returned</td>
<td><code>Bool</code></td>
<td>The flag, indicates that the order was returned.</td>
</tr>
<tr class="odd">
<td>Market</td>
<td><code>String</code></td>
<td>Market name.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="data-loading" class="section level1">
<h1>Data loading</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># DB connection</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(), <span class="at">dbname =</span> <span class="st">&quot;superstore_global&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">&quot;localhost&quot;</span>, <span class="at">port =</span> <span class="dv">5432</span>, <span class="at">user =</span> <span class="st">&quot;postgres&quot;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">password =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>)</span></code></pre></div>
<p>For analysis for used PostgreSQL database.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">-- </span><span class="al">NOTE</span><span class="co">: you need to execute the code below on DB side (R Markdown chunk eval=FALSE).</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">-- Create a new database</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> superstore_global;</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">-- schema for raw data</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> raw_data;</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">-- create table Orders for raw data</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> raw_data.superstore_orders</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>(</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    row_id         <span class="dt">VARCHAR</span>(<span class="dv">5</span>),</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    order_id       <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    order_date     <span class="dt">VARCHAR</span>(<span class="dv">10</span>),</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    ship_date      <span class="dt">VARCHAR</span>(<span class="dv">10</span>),</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    ship_mode      <span class="dt">VARCHAR</span>(<span class="dv">14</span>),</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    customer_id    <span class="dt">VARCHAR</span>(<span class="dv">8</span>),</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    customer_name  <span class="dt">VARCHAR</span>(<span class="dv">22</span>),</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    <span class="kw">segment</span>        <span class="dt">VARCHAR</span>(<span class="dv">11</span>),</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    city           <span class="dt">VARCHAR</span>(<span class="dv">35</span>),</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    state          <span class="dt">VARCHAR</span>(<span class="dv">36</span>),</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    country        <span class="dt">VARCHAR</span>(<span class="dv">32</span>),</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    postal_code    <span class="dt">VARCHAR</span>(<span class="dv">5</span>),</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    market         <span class="dt">VARCHAR</span>(<span class="dv">6</span>),</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    region         <span class="dt">VARCHAR</span>(<span class="dv">14</span>),</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    product_id     <span class="dt">VARCHAR</span>(<span class="dv">16</span>),</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    <span class="kw">category</span>       <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    sub_category   <span class="dt">VARCHAR</span>(<span class="dv">11</span>),</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    product_name   <span class="dt">VARCHAR</span>(<span class="dv">127</span>),</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    sales          <span class="dt">VARCHAR</span>(<span class="dv">10</span>),</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    quantity       <span class="dt">VARCHAR</span>(<span class="dv">2</span>),</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    discount       <span class="dt">VARCHAR</span>(<span class="dv">5</span>),</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>    profit         <span class="dt">VARCHAR</span>(<span class="dv">21</span>),</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    shipping_cost  <span class="dt">VARCHAR</span>(<span class="dv">8</span>),</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>    order_priority <span class="dt">VARCHAR</span>(<span class="dv">8</span>)</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>);</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">-- </span><span class="al">NOTE</span><span class="co">: you need to execute the code below on DB side (R Markdown chunk eval=FALSE).</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">-- create table Returns for raw data</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> raw_data.superstore_returns</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>(</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    returned <span class="dt">VARCHAR</span>(<span class="dv">3</span>),</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    order_id <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    market   <span class="dt">VARCHAR</span>(<span class="dv">13</span>)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>);</span></code></pre></div>
<p>Prepare data in Excel. Save each sheet as <em>CSV</em> file: + Sheet
<em>Orders</em> into <em>data/Global Superstore_orders.csv</em>. + Sheet
<em>Returns</em> into <em>data/Global Superstore_returns.csv</em>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">library</span>(fs)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">&quot;Global Superstore (raw data).xls&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>sheets <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="fu">paste0</span>(<span class="st">&quot;./data/&quot;</span>, file_name))</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>CSVs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="cf">for</span> (sheet <span class="cf">in</span> sheets[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) {</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  df <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xls</span>(</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&quot;./data/&quot;</span>, file_name),</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="cn">TRUE</span>, <span class="at">sheet =</span> sheet</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  )</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  csv_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    <span class="fu">getwd</span>(), <span class="st">&quot;/data/&quot;</span>, <span class="st">&quot;Global Superstore_&quot;</span>, sheet,</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    <span class="st">&quot;.csv&quot;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  )</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  CSVs <span class="ot">&lt;-</span> <span class="fu">append</span>(CSVs, csv_file)</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  <span class="fu">write.csv</span>(df, csv_file, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>}</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>orders_csv <span class="ot">&lt;-</span> CSVs[<span class="dv">1</span>]</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>returns_csv <span class="ot">&lt;-</span> CSVs[<span class="dv">2</span>]</span></code></pre></div>
<p>Now load data <strong>as-is</strong> into database. Loading raw
data.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">-- orders</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">COPY</span> raw_data.superstore_orders <span class="kw">FROM</span> ?orders_csv DELIMITER <span class="st">&#39;,&#39;</span> CSV <span class="kw">HEADER</span>;</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">-- returns</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="kw">COPY</span> raw_data.superstore_returns <span class="kw">FROM</span> ?returns_csv DELIMITER <span class="st">&#39;,&#39;</span> CSV <span class="kw">HEADER</span>;</span></code></pre></div>
</div>
<div id="data-cleansing" class="section level1">
<h1>Data cleansing</h1>
<p>Create schema <em>analysis</em> for cleaned data.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">-- schema for data cleansing</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> analysis;</span></code></pre></div>
<p>Create tables for cleaned data.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> analysis.orders</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>(</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    row_id         <span class="dt">INTEGER</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    order_id       <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    order_date     <span class="dt">DATE</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    ship_date      <span class="dt">DATE</span>,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    ship_mode      <span class="dt">VARCHAR</span>(<span class="dv">14</span>),</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    customer_id    <span class="dt">VARCHAR</span>(<span class="dv">8</span>),</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    customer_name  <span class="dt">VARCHAR</span>(<span class="dv">22</span>),</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="kw">segment</span>        <span class="dt">VARCHAR</span>(<span class="dv">11</span>),</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    city           <span class="dt">VARCHAR</span>(<span class="dv">35</span>),</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    state          <span class="dt">VARCHAR</span>(<span class="dv">36</span>),</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    country        <span class="dt">VARCHAR</span>(<span class="dv">32</span>),</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    postal_code    <span class="dt">VARCHAR</span>(<span class="dv">5</span>),</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>    market         <span class="dt">VARCHAR</span>(<span class="dv">6</span>),</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    region         <span class="dt">VARCHAR</span>(<span class="dv">14</span>),</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    product_id     <span class="dt">VARCHAR</span>(<span class="dv">16</span>),</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    <span class="kw">category</span>       <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    sub_category   <span class="dt">VARCHAR</span>(<span class="dv">11</span>),</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    product_name   <span class="dt">VARCHAR</span>(<span class="dv">127</span>),</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    sales          <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>),</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    quantity       <span class="dt">SMALLINT</span>,</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>    discount       <span class="dt">NUMERIC</span>(<span class="dv">4</span>, <span class="dv">2</span>),</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    profit         <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>),</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    shipping_cost  <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>),</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    order_priority <span class="dt">VARCHAR</span>(<span class="dv">8</span>)</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>);</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> analysis.returns</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>(</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    returned <span class="dt">BOOLEAN</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    order_id <span class="dt">VARCHAR</span>(<span class="dv">15</span>),</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    market   <span class="dt">VARCHAR</span>(<span class="dv">13</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>);</span></code></pre></div>
<p>Convert data types.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">-- Orders table</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> analysis.orders</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">CAST</span>(row_id <span class="kw">AS</span> <span class="dt">INTEGER</span>)                                 <span class="kw">AS</span> row_id,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>       order_id,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>       <span class="fu">TO_DATE</span>(order_date, <span class="st">&#39;YYYY-MM-DD&#39;</span>)                       <span class="kw">AS</span> order_date,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>       <span class="fu">TO_DATE</span>(ship_date, <span class="st">&#39;YYYY-MM-DD&#39;</span>)                        <span class="kw">AS</span> ship_date,</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>       ship_mode,</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>       customer_id,</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>       customer_name,</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>       city,</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>       state,</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>       country,</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>       postal_code,</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>       market,</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>       region,</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>       product_id,</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>       <span class="kw">category</span>,</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>       sub_category,</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>       product_name,</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>       <span class="fu">CAST</span>(<span class="kw">REPLACE</span>(sales, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;.&#39;</span>) <span class="kw">AS</span> <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>))         <span class="kw">AS</span> sales,</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>       <span class="fu">CAST</span>(quantity <span class="kw">AS</span> <span class="dt">SMALLINT</span>)                              <span class="kw">AS</span> quantity,</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>       <span class="fu">CAST</span>(<span class="kw">REPLACE</span>(discount, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;.&#39;</span>) <span class="kw">AS</span> <span class="dt">NUMERIC</span>(<span class="dv">4</span>, <span class="dv">2</span>))      <span class="kw">AS</span> discount,</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>       <span class="fu">CAST</span>(<span class="kw">REPLACE</span>(profit, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;.&#39;</span>) <span class="kw">AS</span> <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>))        <span class="kw">AS</span> profit,</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>       <span class="fu">CAST</span>(<span class="kw">REPLACE</span>(shipping_cost, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;.&#39;</span>) <span class="kw">AS</span> <span class="dt">NUMERIC</span>(<span class="dv">9</span>, <span class="dv">2</span>)) <span class="kw">AS</span> shipping_cost,</span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>       order_priority</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="kw">FROM</span> raw_data.superstore_orders;</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">-- Returns table</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> analysis.returns</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">CAST</span>(returned <span class="kw">AS</span> <span class="dt">BOOLEAN</span>) <span class="kw">AS</span> returned,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>       order_id,</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>       market</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="kw">FROM</span> raw_data.superstore_returns;</span></code></pre></div>
<p>Check <em>Returns</em> table.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="kw">SELECT</span> orders.market, returns.market</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market <span class="kw">FROM</span> analysis.orders <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>) <span class="kw">AS</span> orders</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="kw">FULL</span> <span class="kw">JOIN</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market <span class="kw">FROM</span> analysis.returns <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>) <span class="kw">AS</span> returns</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="kw">ON</span> orders.market <span class="op">=</span> returns.market;</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># print result</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>check_returns</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["market..2"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Africa","2":"NA"},{"1":"APAC","2":"APAC"},{"1":"Canada","2":"NA"},{"1":"EMEA","2":"NA"},{"1":"EU","2":"EU"},{"1":"LATAM","2":"LATAM"},{"1":"NA","2":"United States"},{"1":"US","2":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Fix market name in <em>Returns</em> table.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="kw">UPDATE</span> analysis.returns</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="kw">SET</span> market <span class="op">=</span> <span class="st">&#39;US&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="kw">WHERE</span> market <span class="op">=</span> <span class="st">&#39;United States&#39;</span>;</span></code></pre></div>
<div id="duplication-data" class="section level2">
<h2>Duplication Data</h2>
<p>Check duplicated pairs of <em>order_id</em> and <em>market</em> in
<em>returns</em> table.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="kw">SELECT</span> order_id, market, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> analysis.returns <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span> <span class="kw">HAVING</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>;</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># print result</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>duplidated_order_id</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["order_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["market"],"name":[2],"type":["chr"],"align":["left"]},{"label":["count"],"name":[3],"type":["int64"],"align":["right"]}],"data":[],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb20"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co">-- duplicated data</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    row_id,</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>    order_id,</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    order_date,</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    ship_date,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    ship_mode,</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    customer_id,</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>    customer_name,</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    <span class="kw">segment</span>,</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    city,</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    state,</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>    country,</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>    postal_code,</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>    market,</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    region,</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>    product_id,</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>    <span class="kw">category</span>,</span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>    sub_category,</span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>    product_name,</span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>    sales,</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>    quantity,</span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>    discount,</span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>    profit,</span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>    shipping_cost,</span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a>    order_priority, <span class="fu">count</span>(<span class="op">*</span>)</span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a><span class="kw">FROM</span> analysis.orders</span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">19</span>,<span class="dv">20</span>,<span class="dv">21</span>,<span class="dv">22</span>,<span class="dv">23</span>,<span class="dv">24</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="kw">having</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>;</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>orders_full_duplicates</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["row_id"],"name":[1],"type":["int"],"align":["right"]},{"label":["order_id"],"name":[2],"type":["chr"],"align":["left"]},{"label":["order_date"],"name":[3],"type":["date"],"align":["right"]},{"label":["ship_date"],"name":[4],"type":["date"],"align":["right"]},{"label":["ship_mode"],"name":[5],"type":["chr"],"align":["left"]},{"label":["customer_id"],"name":[6],"type":["chr"],"align":["left"]},{"label":["customer_name"],"name":[7],"type":["chr"],"align":["left"]},{"label":["segment"],"name":[8],"type":["chr"],"align":["left"]},{"label":["city"],"name":[9],"type":["chr"],"align":["left"]},{"label":["state"],"name":[10],"type":["chr"],"align":["left"]},{"label":["country"],"name":[11],"type":["chr"],"align":["left"]},{"label":["postal_code"],"name":[12],"type":["chr"],"align":["left"]},{"label":["market"],"name":[13],"type":["chr"],"align":["left"]},{"label":["region"],"name":[14],"type":["chr"],"align":["left"]},{"label":["product_id"],"name":[15],"type":["chr"],"align":["left"]},{"label":["category"],"name":[16],"type":["chr"],"align":["left"]},{"label":["sub_category"],"name":[17],"type":["chr"],"align":["left"]},{"label":["product_name"],"name":[18],"type":["chr"],"align":["left"]},{"label":["sales"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["quantity"],"name":[20],"type":["int"],"align":["right"]},{"label":["discount"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["profit"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["shipping_cost"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["order_priority"],"name":[24],"type":["chr"],"align":["left"]},{"label":["count"],"name":[25],"type":["int64"],"align":["right"]}],"data":[],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Check duplicates without <em>row_id</em>.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>    order_id,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>    order_date,</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>    ship_date,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>    ship_mode,</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>    customer_id,</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>    customer_name,</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>    <span class="kw">segment</span>,</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>    city,</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>    state,</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>    country,</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>    postal_code,</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>    market,</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>    region,</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>    product_id,</span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>    <span class="kw">category</span>,</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>    sub_category,</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>    product_name,</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>    sales,</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>    quantity,</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>    discount,</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>    profit,</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>    shipping_cost,</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>    order_priority, <span class="fu">count</span>(<span class="op">*</span>)</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a><span class="kw">FROM</span> analysis.orders</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">19</span>,<span class="dv">20</span>,<span class="dv">21</span>,<span class="dv">22</span>,<span class="dv">23</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a><span class="kw">having</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">1</span>;</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>orders_full_duplicates</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["order_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["order_date"],"name":[2],"type":["date"],"align":["right"]},{"label":["ship_date"],"name":[3],"type":["date"],"align":["right"]},{"label":["ship_mode"],"name":[4],"type":["chr"],"align":["left"]},{"label":["customer_id"],"name":[5],"type":["chr"],"align":["left"]},{"label":["customer_name"],"name":[6],"type":["chr"],"align":["left"]},{"label":["segment"],"name":[7],"type":["chr"],"align":["left"]},{"label":["city"],"name":[8],"type":["chr"],"align":["left"]},{"label":["state"],"name":[9],"type":["chr"],"align":["left"]},{"label":["country"],"name":[10],"type":["chr"],"align":["left"]},{"label":["postal_code"],"name":[11],"type":["chr"],"align":["left"]},{"label":["market"],"name":[12],"type":["chr"],"align":["left"]},{"label":["region"],"name":[13],"type":["chr"],"align":["left"]},{"label":["product_id"],"name":[14],"type":["chr"],"align":["left"]},{"label":["category"],"name":[15],"type":["chr"],"align":["left"]},{"label":["sub_category"],"name":[16],"type":["chr"],"align":["left"]},{"label":["product_name"],"name":[17],"type":["chr"],"align":["left"]},{"label":["sales"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["quantity"],"name":[19],"type":["int"],"align":["right"]},{"label":["discount"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["profit"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["shipping_cost"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["order_priority"],"name":[23],"type":["chr"],"align":["left"]},{"label":["count"],"name":[24],"type":["int64"],"align":["right"]}],"data":[],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div id="missing-values" class="section level2">
<h2>Missing Values</h2>
<div class="sourceCode" id="cb24"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="kw">select</span> <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> row_id <span class="kw">is</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> row_id,</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> order_id <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> order_id,</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> order_date <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> order_date,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> ship_date <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> ship_date,</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> ship_mode <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> ship_mode,</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> customer_id <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> customer_id,</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> customer_name <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> customer_name,</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> <span class="kw">segment</span> <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> <span class="kw">segment</span>,</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> city <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> city,</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> state <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> state,</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> country <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> country,</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> postal_code <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> postal_code,</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> market <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> market,</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> region <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> region,</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> product_id <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> product_id,</span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> <span class="kw">category</span> <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> <span class="kw">category</span>,</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> sub_category <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> sub_category,</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> product_name <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> product_name,</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> sales <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> sales,</span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> quantity <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> quantity,</span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> discount <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> discount,</span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> profit <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> profit,</span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> shipping_cost <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> shipping_cost,</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>       <span class="fu">count</span>(<span class="dv">1</span>) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> order_priority <span class="kw">IS</span> <span class="kw">NULL</span> ) <span class="kw">AS</span> order_priority</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="kw">FROM</span> analysis.orders;</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>missing_values</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["row_id"],"name":[1],"type":["int64"],"align":["right"]},{"label":["order_id"],"name":[2],"type":["int64"],"align":["right"]},{"label":["order_date"],"name":[3],"type":["int64"],"align":["right"]},{"label":["ship_date"],"name":[4],"type":["int64"],"align":["right"]},{"label":["ship_mode"],"name":[5],"type":["int64"],"align":["right"]},{"label":["customer_id"],"name":[6],"type":["int64"],"align":["right"]},{"label":["customer_name"],"name":[7],"type":["int64"],"align":["right"]},{"label":["segment"],"name":[8],"type":["int64"],"align":["right"]},{"label":["city"],"name":[9],"type":["int64"],"align":["right"]},{"label":["state"],"name":[10],"type":["int64"],"align":["right"]},{"label":["country"],"name":[11],"type":["int64"],"align":["right"]},{"label":["postal_code"],"name":[12],"type":["int64"],"align":["right"]},{"label":["market"],"name":[13],"type":["int64"],"align":["right"]},{"label":["region"],"name":[14],"type":["int64"],"align":["right"]},{"label":["product_id"],"name":[15],"type":["int64"],"align":["right"]},{"label":["category"],"name":[16],"type":["int64"],"align":["right"]},{"label":["sub_category"],"name":[17],"type":["int64"],"align":["right"]},{"label":["product_name"],"name":[18],"type":["int64"],"align":["right"]},{"label":["sales"],"name":[19],"type":["int64"],"align":["right"]},{"label":["quantity"],"name":[20],"type":["int64"],"align":["right"]},{"label":["discount"],"name":[21],"type":["int64"],"align":["right"]},{"label":["profit"],"name":[22],"type":["int64"],"align":["right"]},{"label":["shipping_cost"],"name":[23],"type":["int64"],"align":["right"]},{"label":["order_priority"],"name":[24],"type":["int64"],"align":["right"]}],"data":[{"1":"0","2":"0","3":"0","4":"0","5":"0","6":"0","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div id="preparation-for-analysis" class="section level1">
<h1>Preparation for analysis</h1>
<p>Make materialized view.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="co">-- materialized view</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> analysis.all_global_orders <span class="kw">AS</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>    <span class="kw">SELECT</span>  o.<span class="op">*</span>, <span class="cf">CASE</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>                    <span class="cf">WHEN</span> r.returned <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span> <span class="kw">FALSE</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>                    <span class="cf">ELSE</span> r.returned</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>                 <span class="cf">END</span> <span class="kw">AS</span> returned</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>    <span class="kw">FROM</span> analysis.orders o</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>        <span class="kw">LEFT</span> <span class="kw">JOIN</span> analysis.returns r <span class="kw">ON</span> o.order_id <span class="op">=</span> r.order_id <span class="kw">AND</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>                                        o.market <span class="op">=</span> r.market;</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">-- refresh the view to full it with data</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> analysis.all_global_orders;</span></code></pre></div>
</div>
<div id="analysis" class="section level1">
<h1>Analysis</h1>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># setup plots theme</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_light</span>())</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="fu">theme_update</span>(</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>),</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>),</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">unit</span>(</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>    <span class="st">&quot;lines&quot;</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>  )</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>)</span></code></pre></div>
<div id="total-revenue-and-gross-margin" class="section level2">
<h2>Total Revenue and Gross Margin</h2>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="kw">SELECT</span> DATE_PART(<span class="st">&#39;year&#39;</span>, order_date):<span class="ch">:INT</span>                     <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>       market,</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">SUM</span>(sales), <span class="dv">2</span>)                                   <span class="kw">AS</span> sales,</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">SUM</span>(profit) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="kw">NOT</span> returned), <span class="dv">2</span>)      <span class="kw">AS</span> profit, <span class="co">-- exclude returns</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">SUM</span>(profit) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="kw">NOT</span> returned) <span class="op">/</span> <span class="fu">SUM</span>(sales), <span class="dv">2</span>) <span class="kw">AS</span> margin</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, sales <span class="kw">desc</span>;</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>    </span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># print result</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>revenue_margin</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["int"],"align":["right"]},{"label":["market"],"name":[2],"type":["chr"],"align":["left"]},{"label":["sales"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["profit"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["margin"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"APAC","3":"639245.61","4":"71591.54","5":"0.11"},{"1":"2011","2":"US","3":"484247.56","4":"49073.38","5":"0.10"},{"1":"2011","2":"EU","3":"478743.73","4":"60508.05","5":"0.13"},{"1":"2011","2":"LATAM","3":"385098.14","4":"33055.27","5":"0.09"},{"1":"2011","2":"EMEA","3":"136420.21","4":"5279.89","5":"0.04"},{"1":"2011","2":"Africa","3":"127187.28","4":"10944.01","5":"0.09"},{"1":"2011","2":"Canada","3":"8509.11","4":"1807.08","5":"0.21"},{"1":"2012","2":"APAC","3":"762719.98","4":"80125.28","5":"0.11"},{"1":"2012","2":"EU","3":"655462.16","4":"75793.91","5":"0.12"},{"1":"2012","2":"US","3":"470532.46","4":"57196.64","5":"0.12"},{"1":"2012","2":"LATAM","3":"464733.32","4":"42744.82","5":"0.09"},{"1":"2012","2":"EMEA","3":"163414.43","4":"5419.61","5":"0.03"},{"1":"2012","2":"Africa","3":"144480.76","4":"11908.83","5":"0.08"},{"1":"2012","2":"Canada","3":"16096.80","4":"4887.84","5":"0.30"},{"1":"2013","2":"APAC","3":"974581.48","4":"115326.68","5":"0.12"},{"1":"2013","2":"EU","3":"761680.97","4":"88268.09","5":"0.12"},{"1":"2013","2":"US","3":"608474.08","4":"79114.59","5":"0.13"},{"1":"2013","2":"LATAM","3":"608140.76","4":"59145.09","5":"0.10"},{"1":"2013","2":"Africa","3":"229068.87","4":"26686.95","5":"0.12"},{"1":"2013","2":"EMEA","3":"204640.72","4":"10598.07","5":"0.05"},{"1":"2013","2":"Canada","3":"19161.15","4":"5129.46","5":"0.27"},{"1":"2014","2":"APAC","3":"1209199.52","4":"122281.07","5":"0.10"},{"1":"2014","2":"EU","3":"1042204.52","4":"116640.95","5":"0.11"},{"1":"2014","2":"US","3":"733946.97","4":"77780.64","5":"0.11"},{"1":"2014","2":"LATAM","3":"706633.10","4":"70056.71","5":"0.10"},{"1":"2014","2":"EMEA","3":"301685.99","4":"22600.33","5":"0.07"},{"1":"2014","2":"Africa","3":"283036.46","4":"39331.34","5":"0.14"},{"1":"2014","2":"Canada","3":"23161.11","4":"5993.01","5":"0.26"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">mean</span>(revenue_margin<span class="sc">$</span>sales)</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">mean</span>(revenue_margin<span class="sc">$</span>sales)</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="fu">ggplot</span>(revenue_margin) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> market, <span class="at">y =</span> sales, <span class="at">fill =</span> <span class="fu">factor</span>(year)),</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="at">width =</span> <span class="fl">0.9</span>)</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> market, <span class="at">y =</span> profit, <span class="at">fill =</span> <span class="st">&quot;Profit&quot;</span>),</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="at">width =</span> <span class="fl">0.9</span>)</span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>      <span class="at">x =</span> market, <span class="at">y =</span> offset <span class="sc">+</span> margin <span class="sc">*</span> scale,</span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>      <span class="at">group =</span> market, <span class="at">color =</span> <span class="st">&quot;Gross Margin&quot;</span></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>    ),</span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="at">width =</span> <span class="fl">0.9</span>)</span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a>      <span class="at">x =</span> market, <span class="at">y =</span> offset <span class="sc">+</span> margin <span class="sc">*</span> scale,</span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;Gross Margin&quot;</span></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a>    ),</span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="at">width =</span> <span class="fl">0.9</span>),</span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">15</span></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a>      <span class="at">x =</span> market, <span class="at">y =</span> offset <span class="sc">+</span> margin <span class="sc">*</span> scale,</span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a>      <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(margin, <span class="at">accuracy =</span> 1L)</span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a>    ),</span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.2</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="at">width =</span> <span class="fl">0.9</span>),</span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a>    <span class="at">xintercept =</span> <span class="fu">seq</span>(</span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a>      <span class="fl">1.5</span>, <span class="fu">length</span>(<span class="fu">unique</span>(revenue_margin<span class="sc">$</span>market)),</span>
<span id="cb31-39"><a href="#cb31-39" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb31-40"><a href="#cb31-40" tabindex="-1"></a>    ),</span>
<span id="cb31-41"><a href="#cb31-41" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span></span>
<span id="cb31-42"><a href="#cb31-42" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-43"><a href="#cb31-43" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb31-44"><a href="#cb31-44" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">scale =</span> <span class="fl">0.001</span>, <span class="at">suffix =</span> <span class="st">&quot;K&quot;</span>, <span class="at">accuracy =</span> 1L),</span>
<span id="cb31-45"><a href="#cb31-45" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1300000</span>),</span>
<span id="cb31-46"><a href="#cb31-46" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1300000</span>, <span class="fl">1e+05</span>)</span>
<span id="cb31-47"><a href="#cb31-47" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-48"><a href="#cb31-48" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Gross Margin</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb31-49"><a href="#cb31-49" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb31-50"><a href="#cb31-50" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Sales&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-51"><a href="#cb31-51" tabindex="-1"></a>      <span class="at">Profit =</span> <span class="st">&quot;#003f5c&quot;</span>, <span class="st">`</span><span class="at">2011</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#58508d&quot;</span>,</span>
<span id="cb31-52"><a href="#cb31-52" tabindex="-1"></a>      <span class="st">`</span><span class="at">2012</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#bc5090&quot;</span>, <span class="st">`</span><span class="at">2013</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ff6361&quot;</span>,</span>
<span id="cb31-53"><a href="#cb31-53" tabindex="-1"></a>      <span class="st">`</span><span class="at">2014</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span></span>
<span id="cb31-54"><a href="#cb31-54" tabindex="-1"></a>    )</span>
<span id="cb31-55"><a href="#cb31-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-56"><a href="#cb31-56" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-57"><a href="#cb31-57" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Total Revenue and Gross Margin&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sales &amp; Profit, $&quot;</span>,</span>
<span id="cb31-58"><a href="#cb31-58" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Market&quot;</span></span>
<span id="cb31-59"><a href="#cb31-59" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-60"><a href="#cb31-60" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb31-61"><a href="#cb31-61" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb31-62"><a href="#cb31-62" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-33-1.png" width="100%" /></p>
</div>
<div id="total-gross-net-revenue-and-yoy-profit-growth"
class="section level2">
<h2>Total Gross &amp; Net Revenue and YoY Profit Growth</h2>
<div class="sourceCode" id="cb32"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">year</span>:: <span class="dt">INT</span> <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>       <span class="fu">round</span>(sales, <span class="dv">2</span>) <span class="kw">AS</span> sales,</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>       <span class="fu">round</span>(returned_sales, <span class="dv">2</span>) <span class="kw">AS</span> returned_sales,</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>       <span class="fu">round</span>(profit, <span class="dv">2</span>) <span class="kw">AS</span> profit,</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>       <span class="fu">round</span>((profit <span class="op">-</span> <span class="fu">lag</span>(profit, <span class="dv">1</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>))<span class="op">/</span><span class="fu">lag</span>(profit, <span class="dv">1</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>), <span class="dv">2</span>) <span class="kw">AS</span> yoy_profit_growth</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>(<span class="kw">SELECT</span></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>      DATE_PART(<span class="st">&#39;year&#39;</span>, order_date) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>      <span class="fu">sum</span>(sales) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> <span class="kw">NOT</span> returned ) <span class="kw">AS</span> sales,</span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>      <span class="fu">sum</span>(sales) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> returned ) <span class="kw">AS</span> returned_sales,</span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>      <span class="fu">sum</span>(profit) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> <span class="kw">NOT</span> returned ) <span class="kw">AS</span> profit <span class="co">-- exclude returns</span></span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="kw">distinct</span> order_id,</span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a>       <span class="fu">first_value</span>(order_date) <span class="kw">over</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id) <span class="kw">AS</span> order_date,</span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a>       <span class="fu">sum</span>(sales) <span class="kw">over</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id) <span class="kw">AS</span> sales,</span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a>       <span class="fu">sum</span>(profit) <span class="kw">over</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id) <span class="kw">AS</span> profit ,</span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a>       <span class="fu">first_value</span>(returned) <span class="kw">over</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id) <span class="kw">AS</span> returned</span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a><span class="kw">FROM</span> analysis.all_global_orders) a</span>
<span id="cb32-20"><a href="#cb32-20" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb32-21"><a href="#cb32-21" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>) a</span>
<span id="cb32-22"><a href="#cb32-22" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>;</span>
<span id="cb32-23"><a href="#cb32-23" tabindex="-1"></a>    </span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>yoy_profit_growth</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["int"],"align":["right"]},{"label":["sales"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["returned_sales"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["profit"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["yoy_profit_growth"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"2104951","3":"154500.6","4":"232259.2","5":"NA"},{"1":"2012","2":"2500157","3":"177283.0","4":"278076.9","5":"0.20"},{"1":"2013","2":"3216761","3":"188986.8","4":"384268.9","5":"0.38"},{"1":"2014","2":"4002877","3":"296990.3","4":"454712.6","5":"0.18"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">max</span>(yoy_profit_growth<span class="sc">$</span>sales)</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fu">mean</span>(yoy_profit_growth<span class="sc">$</span>sales)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="fu">ggplot</span>(yoy_profit_growth) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> sales, <span class="at">fill =</span> <span class="st">&quot;Gross Revenue&quot;</span>),</span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">width =</span> <span class="fl">0.5</span></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> sales <span class="sc">-</span> returned_sales, <span class="at">fill =</span> <span class="st">&quot;Net Revenue&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a>    ),</span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">width =</span> <span class="fl">0.45</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> profit, <span class="at">fill =</span> <span class="st">&quot;Profit&quot;</span>),</span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">width =</span> <span class="fl">0.45</span></span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> yoy_profit_growth <span class="sc">*</span> scale,</span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a>      <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;YoY Profit Growth&quot;</span></span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a>    )</span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-25"><a href="#cb34-25" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb34-26"><a href="#cb34-26" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb34-27"><a href="#cb34-27" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> yoy_profit_growth <span class="sc">*</span> scale,</span>
<span id="cb34-28"><a href="#cb34-28" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;YoY Profit Growth&quot;</span></span>
<span id="cb34-29"><a href="#cb34-29" tabindex="-1"></a>    ),</span>
<span id="cb34-30"><a href="#cb34-30" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">15</span></span>
<span id="cb34-31"><a href="#cb34-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-32"><a href="#cb34-32" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb34-33"><a href="#cb34-33" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb34-34"><a href="#cb34-34" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> yoy_profit_growth <span class="sc">*</span> scale,</span>
<span id="cb34-35"><a href="#cb34-35" tabindex="-1"></a>      <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(yoy_profit_growth, <span class="at">accuracy =</span> 1L)</span>
<span id="cb34-36"><a href="#cb34-36" tabindex="-1"></a>    ),</span>
<span id="cb34-37"><a href="#cb34-37" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.2</span>, <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb34-38"><a href="#cb34-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-39"><a href="#cb34-39" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb34-40"><a href="#cb34-40" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">YoY Profit Growth</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb34-41"><a href="#cb34-41" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-42"><a href="#cb34-42" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb34-43"><a href="#cb34-43" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb34-44"><a href="#cb34-44" tabindex="-1"></a>      <span class="at">Profit =</span> <span class="st">&quot;#003f5c&quot;</span>, <span class="st">`</span><span class="at">Gross Revenue</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#bc5090&quot;</span>,</span>
<span id="cb34-45"><a href="#cb34-45" tabindex="-1"></a>      <span class="st">`</span><span class="at">Net Revenue</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span></span>
<span id="cb34-46"><a href="#cb34-46" tabindex="-1"></a>    )</span>
<span id="cb34-47"><a href="#cb34-47" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-48"><a href="#cb34-48" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb34-49"><a href="#cb34-49" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>(<span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>, <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb34-50"><a href="#cb34-50" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4500000</span>),</span>
<span id="cb34-51"><a href="#cb34-51" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">4500000</span>, <span class="fl">5e+05</span>)</span>
<span id="cb34-52"><a href="#cb34-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-53"><a href="#cb34-53" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-54"><a href="#cb34-54" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Total Gross &amp; Net Revenue and YoY Profit Growth&quot;</span>,</span>
<span id="cb34-55"><a href="#cb34-55" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Trend lines represent year over year profit growth witch demonstrates positive growth</span><span class="sc">\n</span><span class="st">three years in a row.&quot;</span>,</span>
<span id="cb34-56"><a href="#cb34-56" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb34-57"><a href="#cb34-57" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-58"><a href="#cb34-58" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb34-59"><a href="#cb34-59" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()</span>
<span id="cb34-60"><a href="#cb34-60" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-36-1.png" width="100%" /></p>
</div>
<div id="quarterly-net-revenue-growth" class="section level2">
<h2>Quarterly Net Revenue growth</h2>
<div class="sourceCode" id="cb35"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="co">-- Trend of quarterly revenue growth</span></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>       (<span class="fu">row_number</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter)):<span class="ch">:INT</span> <span class="kw">AS</span> n,</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>       <span class="fu">concat</span>(<span class="st">&#39;Q&#39;</span>, quarter, <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>, substring(<span class="fu">cast</span>(<span class="dt">year</span> <span class="kw">as</span> TEXT), <span class="dv">3</span>, <span class="dv">4</span>)) <span class="kw">AS</span> <span class="kw">label</span>,</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a>       <span class="fu">round</span>((sales <span class="op">-</span> <span class="fu">lag</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter))<span class="op">/</span><span class="fu">lag</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter), <span class="dv">2</span>) <span class="kw">AS</span> growth</span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dt">year</span>,</span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a>       quarter,</span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a>       <span class="fu">sum</span>(sales)  <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="kw">NOT</span> returned) <span class="kw">AS</span> sales,</span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a>       <span class="fu">sum</span>(sales) <span class="kw">AS</span> gross_sales</span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a>    <span class="kw">FROM</span></span>
<span id="cb35-13"><a href="#cb35-13" tabindex="-1"></a>      (<span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb35-14"><a href="#cb35-14" tabindex="-1"></a>          <span class="fu">extract</span>(quarter <span class="kw">from</span> order_date) <span class="kw">as</span> quarter,</span>
<span id="cb35-15"><a href="#cb35-15" tabindex="-1"></a>          <span class="fu">extract</span>(<span class="dt">year</span> <span class="kw">from</span> order_date) <span class="kw">as</span> <span class="dt">year</span></span>
<span id="cb35-16"><a href="#cb35-16" tabindex="-1"></a>        <span class="kw">FROM</span> analysis.all_global_orders) a</span>
<span id="cb35-17"><a href="#cb35-17" tabindex="-1"></a>        <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb35-18"><a href="#cb35-18" tabindex="-1"></a>        <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>) b</span>
<span id="cb35-19"><a href="#cb35-19" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>;</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>quarterly_revenue</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["quarter"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["sales"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["gross_sales"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[5],"type":["int"],"align":["right"]},{"label":["label"],"name":[6],"type":["chr"],"align":["left"]},{"label":["growth"],"name":[7],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"1","3":"319740.7","4":"335780.3","5":"1","6":"Q1'11","7":"NA"},{"1":"2011","2":"2","3":"444865.5","4":"478871.0","5":"2","6":"Q2'11","7":"0.39"},{"1":"2011","2":"3","3":"569174.8","4":"613306.5","5":"3","6":"Q3'11","7":"0.28"},{"1":"2011","2":"4","3":"771170.0","4":"831493.8","5":"4","6":"Q4'11","7":"0.35"},{"1":"2012","2":"1","3":"380496.6","4":"399367.8","5":"5","6":"Q1'12","7":"-0.51"},{"1":"2012","2":"2","3":"587280.6","4":"625593.3","5":"6","6":"Q2'12","7":"0.54"},{"1":"2012","2":"3","3":"692908.8","4":"737769.2","5":"7","6":"Q3'12","7":"0.18"},{"1":"2012","2":"4","3":"839470.9","4":"914709.5","5":"8","6":"Q4'12","7":"0.21"},{"1":"2013","2":"1","3":"539263.3","4":"565020.0","5":"9","6":"Q1'13","7":"-0.36"},{"1":"2013","2":"2","3":"788826.0","4":"834839.8","5":"10","6":"Q2'13","7":"0.46"},{"1":"2013","2":"3","3":"874216.7","4":"933037.4","5":"11","6":"Q3'13","7":"0.11"},{"1":"2013","2":"4","3":"1014455.2","4":"1072850.8","5":"12","6":"Q4'13","7":"0.16"},{"1":"2014","2":"1","3":"621456.9","4":"689206.9","5":"13","6":"Q1'14","7":"-0.39"},{"1":"2014","2":"2","3":"890912.2","4":"932987.3","5":"14","6":"Q2'14","7":"0.43"},{"1":"2014","2":"3","3":"1093564.1","4":"1196483.4","5":"15","6":"Q3'14","7":"0.23"},{"1":"2014","2":"4","3":"1396660.6","4":"1481190.0","5":"16","6":"Q4'14","7":"0.28"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>reorder_value <span class="ot">&lt;-</span> <span class="cf">function</span>(x, value, decreasing) {</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">array</span>(value)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>  <span class="fu">names</span>(a) <span class="ot">&lt;-</span> x</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>  <span class="cf">if</span> (decreasing) {</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>    <span class="fu">factor</span>(x, <span class="at">levels =</span> <span class="fu">names</span>(<span class="fu">sort</span>(a, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a>    <span class="fu">factor</span>(x, <span class="at">levels =</span> <span class="fu">names</span>(<span class="fu">sort</span>(a)))</span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a>  }</span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a>}</span>
<span id="cb37-10"><a href="#cb37-10" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">max</span>(quarterly_revenue<span class="sc">$</span>sales)</span>
<span id="cb37-12"><a href="#cb37-12" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb37-13"><a href="#cb37-13" tabindex="-1"></a>  quarterly_revenue, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder_value</span>(label, n, <span class="cn">FALSE</span>))</span>
<span id="cb37-14"><a href="#cb37-14" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb37-16"><a href="#cb37-16" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> sales, <span class="at">fill =</span> <span class="st">&quot;Net Revenue&quot;</span>),</span>
<span id="cb37-17"><a href="#cb37-17" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span></span>
<span id="cb37-18"><a href="#cb37-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-19"><a href="#cb37-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb37-20"><a href="#cb37-20" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-21"><a href="#cb37-21" tabindex="-1"></a>      <span class="at">y =</span> sales, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">dollar</span>(</span>
<span id="cb37-22"><a href="#cb37-22" tabindex="-1"></a>        sales, <span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>,</span>
<span id="cb37-23"><a href="#cb37-23" tabindex="-1"></a>        <span class="at">accuracy =</span> <span class="fl">0.1</span></span>
<span id="cb37-24"><a href="#cb37-24" tabindex="-1"></a>      )</span>
<span id="cb37-25"><a href="#cb37-25" tabindex="-1"></a>    ),</span>
<span id="cb37-26"><a href="#cb37-26" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.3</span>, <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb37-27"><a href="#cb37-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-28"><a href="#cb37-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-29"><a href="#cb37-29" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-30"><a href="#cb37-30" tabindex="-1"></a>      <span class="at">y =</span> growth <span class="sc">*</span> scale, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;Q/Q Growth&quot;</span></span>
<span id="cb37-31"><a href="#cb37-31" tabindex="-1"></a>    ),</span>
<span id="cb37-32"><a href="#cb37-32" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb37-33"><a href="#cb37-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-34"><a href="#cb37-34" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Net Revenue</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#003f5c&quot;</span>)) <span class="sc">+</span></span>
<span id="cb37-35"><a href="#cb37-35" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Q/Q Growth</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span>)) <span class="sc">+</span></span>
<span id="cb37-36"><a href="#cb37-36" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb37-37"><a href="#cb37-37" tabindex="-1"></a>    <span class="at">xintercept =</span> <span class="fu">seq</span>(<span class="fl">4.5</span>, <span class="dv">16</span>, <span class="dv">4</span>),</span>
<span id="cb37-38"><a href="#cb37-38" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb37-39"><a href="#cb37-39" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-40"><a href="#cb37-40" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb37-41"><a href="#cb37-41" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>(<span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>, <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb37-42"><a href="#cb37-42" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">9e+05</span>, <span class="dv">1600000</span>),</span>
<span id="cb37-43"><a href="#cb37-43" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1600000</span>, <span class="dv">250000</span>),</span>
<span id="cb37-44"><a href="#cb37-44" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb37-45"><a href="#cb37-45" tabindex="-1"></a>      <span class="at">trans =</span> <span class="sc">~</span>.<span class="sc">/</span>scale, <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(),</span>
<span id="cb37-46"><a href="#cb37-46" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.6</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb37-47"><a href="#cb37-47" tabindex="-1"></a>    )</span>
<span id="cb37-48"><a href="#cb37-48" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-49"><a href="#cb37-49" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-50"><a href="#cb37-50" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Q/Q Net Revenue growth&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Trend line of the growth represents potentionaly of dropping of the revenue</span><span class="sc">\n</span><span class="st">growth dynamic in Q1&#39;15.&quot;</span>,</span>
<span id="cb37-51"><a href="#cb37-51" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb37-52"><a href="#cb37-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-53"><a href="#cb37-53" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-54"><a href="#cb37-54" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()</span>
<span id="cb37-55"><a href="#cb37-55" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-39-1.png" width="100%" /></p>
</div>
<div id="profit-trends" class="section level2">
<h2>Profit trends</h2>
<div class="sourceCode" id="cb38"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>       <span class="fu">round</span>((profit <span class="op">-</span> <span class="fu">lag</span>(profit) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_month_day))<span class="op">/</span><span class="fu">lag</span>(profit) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> last_month_day), <span class="dv">2</span>) <span class="kw">as</span> growth</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>(<span class="kw">SELECT</span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a>       (date_trunc(<span class="st">&#39;month&#39;</span>, order_date) <span class="op">+</span> <span class="dt">interval</span> <span class="st">&#39;1 month - 1 day&#39;</span>):<span class="ch">:date</span> <span class="kw">AS</span> last_month_day,</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>       <span class="fu">sum</span>(profit)  <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="kw">NOT</span> returned) <span class="kw">AS</span> profit</span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a>analysis.all_global_orders</span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>) a;</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>monthly_profit</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["last_month_day"],"name":[1],"type":["date"],"align":["right"]},{"label":["profit"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["growth"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011-01-31","2":"8170.04","3":"NA"},{"1":"2011-02-28","2":"8503.99","3":"0.04"},{"1":"2011-03-31","2":"15091.52","3":"0.77"},{"1":"2011-04-30","2":"13175.22","3":"-0.13"},{"1":"2011-05-31","2":"10862.76","3":"-0.18"},{"1":"2011-06-30","2":"20806.21","3":"0.92"},{"1":"2011-07-31","2":"9470.62","3":"-0.54"},{"1":"2011-08-31","2":"23056.90","3":"1.43"},{"1":"2011-09-30","2":"30484.66","3":"0.32"},{"1":"2011-10-31","2":"21602.40","3":"-0.29"},{"1":"2011-11-30","2":"32385.88","3":"0.50"},{"1":"2011-12-31","2":"38649.02","3":"0.19"},{"1":"2012-01-31","2":"10148.74","3":"-0.74"},{"1":"2012-02-29","2":"13878.95","3":"0.37"},{"1":"2012-03-31","2":"17554.97","3":"0.26"},{"1":"2012-04-30","2":"14484.36","3":"-0.17"},{"1":"2012-05-31","2":"26436.53","3":"0.83"},{"1":"2012-06-30","2":"32431.59","3":"0.23"},{"1":"2012-07-31","2":"12815.90","3":"-0.60"},{"1":"2012-08-31","2":"40096.09","3":"2.13"},{"1":"2012-09-30","2":"26036.06","3":"-0.35"},{"1":"2012-10-31","2":"26599.38","3":"0.02"},{"1":"2012-11-30","2":"28810.50","3":"0.08"},{"1":"2012-12-31","2":"28783.86","3":"0.00"},{"1":"2013-01-31","2":"25953.97","3":"-0.10"},{"1":"2013-02-28","2":"23292.14","3":"-0.10"},{"1":"2013-03-31","2":"22150.65","3":"-0.05"},{"1":"2013-04-30","2":"20270.03","3":"-0.08"},{"1":"2013-05-31","2":"27705.29","3":"0.37"},{"1":"2013-06-30","2":"41515.59","3":"0.50"},{"1":"2013-07-31","2":"27728.65","3":"-0.33"},{"1":"2013-08-31","2":"26038.22","3":"-0.06"},{"1":"2013-09-30","2":"36664.72","3":"0.41"},{"1":"2013-10-31","2":"40202.79","3":"0.10"},{"1":"2013-11-30","2":"45251.71","3":"0.13"},{"1":"2013-12-31","2":"47495.17","3":"0.05"},{"1":"2014-01-31","2":"26428.80","3":"-0.44"},{"1":"2014-02-28","2":"16112.76","3":"-0.39"},{"1":"2014-03-31","2":"28472.13","3":"0.77"},{"1":"2014-04-30","2":"23286.16","3":"-0.18"},{"1":"2014-05-31","2":"31703.86","3":"0.36"},{"1":"2014-06-30","2":"40886.91","3":"0.29"},{"1":"2014-07-31","2":"26286.33","3":"-0.36"},{"1":"2014-08-31","2":"45585.45","3":"0.73"},{"1":"2014-09-30","2":"58308.05","3":"0.28"},{"1":"2014-10-31","2":"54626.59","3":"-0.06"},{"1":"2014-11-30","2":"58625.55","3":"0.07"},{"1":"2014-12-31","2":"44361.46","3":"-0.24"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fu">max</span>(monthly_profit<span class="sc">$</span>profit)</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="fu">ggplot</span>(monthly_profit) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> profit, <span class="at">color =</span> <span class="st">&quot;Profit&quot;</span>),</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> growth <span class="sc">*</span> scale,</span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;YoY Growth&quot;</span></span>
<span id="cb40-12"><a href="#cb40-12" tabindex="-1"></a>    ),</span>
<span id="cb40-13"><a href="#cb40-13" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb40-14"><a href="#cb40-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-15"><a href="#cb40-15" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb40-16"><a href="#cb40-16" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> profit),</span>
<span id="cb40-17"><a href="#cb40-17" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb40-18"><a href="#cb40-18" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="fl">0.75</span></span>
<span id="cb40-19"><a href="#cb40-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-20"><a href="#cb40-20" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb40-21"><a href="#cb40-21" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> growth <span class="sc">*</span> scale),</span>
<span id="cb40-22"><a href="#cb40-22" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb40-23"><a href="#cb40-23" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="fl">0.75</span></span>
<span id="cb40-24"><a href="#cb40-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-25"><a href="#cb40-25" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb40-26"><a href="#cb40-26" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb40-27"><a href="#cb40-27" tabindex="-1"></a>      <span class="at">trans =</span> <span class="sc">~</span>.<span class="sc">/</span>scale, <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()</span>
<span id="cb40-28"><a href="#cb40-28" tabindex="-1"></a>    ),</span>
<span id="cb40-29"><a href="#cb40-29" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50000</span>, <span class="dv">150000</span>),</span>
<span id="cb40-30"><a href="#cb40-30" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">50000</span>, <span class="dv">150000</span>, <span class="dv">25000</span>),</span>
<span id="cb40-31"><a href="#cb40-31" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">scale =</span> <span class="fl">0.001</span>, <span class="at">suffix =</span> <span class="st">&quot;K&quot;</span>)</span>
<span id="cb40-32"><a href="#cb40-32" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-33"><a href="#cb40-33" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb40-34"><a href="#cb40-34" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="at">Profit =</span> <span class="st">&quot;#003f5c&quot;</span>, <span class="st">`</span><span class="at">YoY Growth</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span>)</span>
<span id="cb40-35"><a href="#cb40-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-36"><a href="#cb40-36" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Profit trends&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Profit, $&quot;</span>) <span class="sc">+</span></span>
<span id="cb40-37"><a href="#cb40-37" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-42-1.png" width="100%" /></p>
</div>
<div id="total-number-of-orders-and-loss-orders" class="section level2">
<h2>Total number of orders and loss orders</h2>
<div class="sourceCode" id="cb41"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="kw">SELECT</span> market,</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>             <span class="dt">year</span>,</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>             <span class="fu">sum</span>(sales) <span class="kw">as</span> sales,</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>             <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> order_id):<span class="ch">:INT</span>                               <span class="kw">AS</span> total_orders,</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>             (<span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> order_id) <span class="kw">FILTER</span> ( <span class="kw">WHERE</span> profit <span class="op">&lt;</span> <span class="dv">0</span> )):<span class="ch">:INT</span> <span class="kw">AS</span> loss_orders</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>      <span class="kw">FROM</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>                   <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>                   order_id,</span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>                   <span class="fu">SUM</span>(sales)                    <span class="kw">AS</span> sales,</span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>                   <span class="fu">SUM</span>(profit)                   <span class="kw">AS</span> profit</span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a>            <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a>            <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) a</span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a>      <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a>      <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">2</span>, <span class="dv">3</span> <span class="kw">desc</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>orders</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["sales"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["total_orders"],"name":[4],"type":["int"],"align":["right"]},{"label":["loss_orders"],"name":[5],"type":["int"],"align":["right"]}],"data":[{"1":"APAC","2":"2011","3":"639245.61","4":"966","5":"276"},{"1":"US","2":"2011","3":"484247.56","4":"969","5":"205"},{"1":"EU","2":"2011","3":"478743.73","4":"806","5":"184"},{"1":"LATAM","2":"2011","3":"385098.14","4":"881","5":"219"},{"1":"EMEA","2":"2011","3":"136420.21","4":"405","5":"121"},{"1":"Africa","2":"2011","3":"127187.28","4":"382","5":"94"},{"1":"Canada","2":"2011","3":"8509.11","4":"36","5":"0"},{"1":"APAC","2":"2012","3":"762719.98","4":"1182","5":"326"},{"1":"EU","2":"2012","3":"655462.16","4":"1042","5":"210"},{"1":"US","2":"2012","3":"470532.46","4":"1038","5":"217"},{"1":"LATAM","2":"2012","3":"464733.32","4":"1108","5":"301"},{"1":"EMEA","2":"2012","3":"163414.43","4":"501","5":"162"},{"1":"Africa","2":"2012","3":"144480.76","4":"429","5":"99"},{"1":"Canada","2":"2012","3":"16096.80","4":"48","5":"0"},{"1":"APAC","2":"2013","3":"974581.48","4":"1404","5":"404"},{"1":"EU","2":"2013","3":"761680.97","4":"1207","5":"253"},{"1":"US","2":"2013","3":"608474.08","4":"1310","5":"248"},{"1":"LATAM","2":"2013","3":"608140.76","4":"1475","5":"396"},{"1":"Africa","2":"2013","3":"229068.87","4":"608","5":"121"},{"1":"EMEA","2":"2013","3":"204640.72","4":"668","5":"199"},{"1":"Canada","2":"2013","3":"19161.15","4":"57","5":"0"},{"1":"APAC","2":"2014","3":"1209199.52","4":"1885","5":"552"},{"1":"EU","2":"2014","3":"1042204.52","4":"1538","5":"330"},{"1":"US","2":"2014","3":"733946.97","4":"1692","5":"352"},{"1":"LATAM","2":"2014","3":"706633.10","4":"1674","5":"454"},{"1":"EMEA","2":"2014","3":"301685.99","4":"888","5":"263"},{"1":"Africa","2":"2014","3":"283036.46","4":"813","5":"162"},{"1":"Canada","2":"2014","3":"23161.11","4":"60","5":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Visualize data for 2014 year.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="fu">ggplot</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]) <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>      <span class="fu">reorder</span>(market, sales, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a>      sales, <span class="at">fill =</span> <span class="st">&quot;Revenue&quot;</span></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a>    ),</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">&quot;dodge2&quot;</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>, <span class="at">alpha =</span> <span class="fl">0.9</span></span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">reorder</span>(market, sales),</span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a>      <span class="at">y =</span> <span class="dv">0</span>, <span class="at">xend =</span> <span class="fu">reorder</span>(market, sales),</span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a>      <span class="at">yend =</span> total_orders <span class="sc">*</span> <span class="fl">1e+06</span><span class="sc">/</span><span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>total_orders),</span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;Total Orders&quot;</span></span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a>    ),</span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span></span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a>      <span class="fu">reorder</span>(market, sales, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a>      total_orders <span class="sc">*</span> <span class="fl">1e+06</span><span class="sc">/</span><span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>total_orders)</span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a>    ),</span>
<span id="cb43-23"><a href="#cb43-23" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">95</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb43-24"><a href="#cb43-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-25"><a href="#cb43-25" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb43-26"><a href="#cb43-26" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-27"><a href="#cb43-27" tabindex="-1"></a>      <span class="fu">reorder</span>(market, sales, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-28"><a href="#cb43-28" tabindex="-1"></a>      loss_orders <span class="sc">*</span> <span class="fl">1e+06</span><span class="sc">/</span><span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>total_orders),</span>
<span id="cb43-29"><a href="#cb43-29" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">&quot;Loss Orders&quot;</span></span>
<span id="cb43-30"><a href="#cb43-30" tabindex="-1"></a>    ),</span>
<span id="cb43-31"><a href="#cb43-31" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.1</span></span>
<span id="cb43-32"><a href="#cb43-32" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-33"><a href="#cb43-33" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb43-34"><a href="#cb43-34" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="at">Revenue =</span> <span class="st">&quot;#ececec&quot;</span>, <span class="st">`</span><span class="at">Loss Orders</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)</span>
<span id="cb43-35"><a href="#cb43-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-36"><a href="#cb43-36" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Total Orders</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb43-37"><a href="#cb43-37" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb43-38"><a href="#cb43-38" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;gray12&quot;</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb43-39"><a href="#cb43-39" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb43-40"><a href="#cb43-40" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-41"><a href="#cb43-41" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb43-42"><a href="#cb43-42" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">accuracy =</span> <span class="fl">0.01</span>, <span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>),</span>
<span id="cb43-43"><a href="#cb43-43" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(</span>
<span id="cb43-44"><a href="#cb43-44" tabindex="-1"></a>      <span class="dv">0</span>, <span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>sales) <span class="sc">*</span></span>
<span id="cb43-45"><a href="#cb43-45" tabindex="-1"></a>        <span class="fl">1.1</span></span>
<span id="cb43-46"><a href="#cb43-46" tabindex="-1"></a>    ),</span>
<span id="cb43-47"><a href="#cb43-47" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb43-48"><a href="#cb43-48" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(</span>
<span id="cb43-49"><a href="#cb43-49" tabindex="-1"></a>      <span class="dv">0</span>, <span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>sales) <span class="sc">*</span></span>
<span id="cb43-50"><a href="#cb43-50" tabindex="-1"></a>        <span class="fl">1.1</span>, <span class="dv">250000</span></span>
<span id="cb43-51"><a href="#cb43-51" tabindex="-1"></a>    ),</span>
<span id="cb43-52"><a href="#cb43-52" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb43-53"><a href="#cb43-53" tabindex="-1"></a>      <span class="at">trans =</span> <span class="sc">~</span>.<span class="sc">/</span><span class="fl">1e+06</span> <span class="sc">*</span> <span class="fu">max</span>(orders[orders<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span>, ]<span class="sc">$</span>total_orders),</span>
<span id="cb43-54"><a href="#cb43-54" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;Number of Orders&quot;</span>, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2000</span>, <span class="dv">250</span>)</span>
<span id="cb43-55"><a href="#cb43-55" tabindex="-1"></a>    )</span>
<span id="cb43-56"><a href="#cb43-56" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-57"><a href="#cb43-57" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-58"><a href="#cb43-58" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Number of loss orders for 2014&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Revenue, $&quot;</span>,</span>
<span id="cb43-59"><a href="#cb43-59" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Market&quot;</span></span>
<span id="cb43-60"><a href="#cb43-60" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-61"><a href="#cb43-61" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb43-62"><a href="#cb43-62" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)),</span>
<span id="cb43-63"><a href="#cb43-63" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>))</span>
<span id="cb43-64"><a href="#cb43-64" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-45-1.png" width="100%" /></p>
</div>
<div id="customer-lifetime-value-clv" class="section level2">
<h2>Customer Lifetime Value (CLV)</h2>
<div class="sourceCode" id="cb44"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="kw">SELECT</span> market,</span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>       <span class="dt">year</span>,</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>       <span class="fu">round</span>(CLV, <span class="dv">2</span>) <span class="kw">AS</span> CLV,</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>       <span class="fu">round</span>((CLV <span class="op">-</span> <span class="fu">lag</span>(CLV) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, <span class="kw">segment</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>))<span class="op">/</span><span class="fu">lag</span>(CLV) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, <span class="kw">segment</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>), <span class="dv">2</span>) <span class="kw">AS</span> growth</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a>(<span class="kw">SELECT</span> a.market,</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>       a.<span class="kw">segment</span>,</span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a>       a.<span class="dt">year</span>,</span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a>       a.customer_value <span class="op">*</span> b.CLS <span class="kw">AS</span> CLV</span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a>  <span class="kw">FROM</span> (<span class="kw">SELECT</span> a.market,</span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a>               a.<span class="kw">segment</span>,</span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a>               a.<span class="dt">year</span>,</span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a>               a.sales,</span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a>               b.unique_customers,</span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a>               a.sales <span class="op">/</span> b.unique_customers <span class="kw">AS</span> customer_value</span>
<span id="cb44-18"><a href="#cb44-18" tabindex="-1"></a>        <span class="kw">FROM</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb44-19"><a href="#cb44-19" tabindex="-1"></a>                     <span class="kw">segment</span>,</span>
<span id="cb44-20"><a href="#cb44-20" tabindex="-1"></a>                     <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb44-21"><a href="#cb44-21" tabindex="-1"></a>                     <span class="fu">SUM</span>(sales)                    <span class="kw">AS</span> sales</span>
<span id="cb44-22"><a href="#cb44-22" tabindex="-1"></a>              <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb44-23"><a href="#cb44-23" tabindex="-1"></a>              <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span></span>
<span id="cb44-24"><a href="#cb44-24" tabindex="-1"></a>              <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) a</span>
<span id="cb44-25"><a href="#cb44-25" tabindex="-1"></a>                 <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb44-26"><a href="#cb44-26" tabindex="-1"></a>             (<span class="kw">SELECT</span> market,</span>
<span id="cb44-27"><a href="#cb44-27" tabindex="-1"></a>                     <span class="kw">segment</span>,</span>
<span id="cb44-28"><a href="#cb44-28" tabindex="-1"></a>                     <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb44-29"><a href="#cb44-29" tabindex="-1"></a>                     <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id)   <span class="kw">AS</span> unique_customers</span>
<span id="cb44-30"><a href="#cb44-30" tabindex="-1"></a>              <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb44-31"><a href="#cb44-31" tabindex="-1"></a>              <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span></span>
<span id="cb44-32"><a href="#cb44-32" tabindex="-1"></a>              <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) b <span class="kw">ON</span> a.market <span class="op">=</span> b.market <span class="kw">AND</span> a.<span class="kw">segment</span> <span class="op">=</span> b.<span class="kw">segment</span> <span class="kw">AND</span> a.<span class="dt">year</span> <span class="op">=</span> b.<span class="dt">year</span>) a</span>
<span id="cb44-33"><a href="#cb44-33" tabindex="-1"></a>           <span class="kw">INNER</span> <span class="kw">JOIN</span></span>
<span id="cb44-34"><a href="#cb44-34" tabindex="-1"></a>       (<span class="kw">SELECT</span> market,</span>
<span id="cb44-35"><a href="#cb44-35" tabindex="-1"></a>               <span class="kw">segment</span>,</span>
<span id="cb44-36"><a href="#cb44-36" tabindex="-1"></a>               <span class="dt">year</span>,</span>
<span id="cb44-37"><a href="#cb44-37" tabindex="-1"></a>               DATE_PART(<span class="st">&#39;year&#39;</span>, <span class="fu">SUM</span>(days)):<span class="ch">:decimal</span> <span class="op">/</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> CLS</span>
<span id="cb44-38"><a href="#cb44-38" tabindex="-1"></a>        <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market,</span>
<span id="cb44-39"><a href="#cb44-39" tabindex="-1"></a>                              <span class="kw">segment</span>,</span>
<span id="cb44-40"><a href="#cb44-40" tabindex="-1"></a>                              <span class="dt">year</span>,</span>
<span id="cb44-41"><a href="#cb44-41" tabindex="-1"></a>                              customer_id,</span>
<span id="cb44-42"><a href="#cb44-42" tabindex="-1"></a>                              <span class="fu">MIN</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> customer_id)       <span class="kw">AS</span> first_date,</span>
<span id="cb44-43"><a href="#cb44-43" tabindex="-1"></a>                              <span class="fu">MAX</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="dt">year</span>, customer_id) <span class="kw">AS</span> last_date,</span>
<span id="cb44-44"><a href="#cb44-44" tabindex="-1"></a>                              AGE(<span class="fu">MAX</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="dt">year</span>, customer_id),</span>
<span id="cb44-45"><a href="#cb44-45" tabindex="-1"></a>                                  <span class="fu">MIN</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> customer_id))  <span class="kw">AS</span> days</span>
<span id="cb44-46"><a href="#cb44-46" tabindex="-1"></a>  </span>
<span id="cb44-47"><a href="#cb44-47" tabindex="-1"></a>              <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb44-48"><a href="#cb44-48" tabindex="-1"></a>                           <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">year</span></span>
<span id="cb44-49"><a href="#cb44-49" tabindex="-1"></a>                    <span class="kw">FROM</span> analysis.all_global_orders) a) b</span>
<span id="cb44-50"><a href="#cb44-50" tabindex="-1"></a>        <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) b <span class="kw">ON</span></span>
<span id="cb44-51"><a href="#cb44-51" tabindex="-1"></a>                   a.market <span class="op">=</span> b.market <span class="kw">AND</span></span>
<span id="cb44-52"><a href="#cb44-52" tabindex="-1"></a>                   a.<span class="kw">segment</span> <span class="op">=</span> b.<span class="kw">segment</span> <span class="kw">AND</span></span>
<span id="cb44-53"><a href="#cb44-53" tabindex="-1"></a>                   a.<span class="dt">year</span> <span class="op">=</span> b.<span class="dt">year</span>) a;</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># print result</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>CLV</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["segment"],"name":[2],"type":["chr"],"align":["left"]},{"label":["year"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["clv"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["growth"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"Africa","2":"Consumer","3":"2011","4":"76.91","5":"NA"},{"1":"Africa","2":"Consumer","3":"2012","4":"481.92","5":"5.27"},{"1":"Africa","2":"Consumer","3":"2013","4":"892.18","5":"0.85"},{"1":"Africa","2":"Consumer","3":"2014","4":"1692.84","5":"0.90"},{"1":"Africa","2":"Corporate","3":"2011","4":"70.10","5":"NA"},{"1":"Africa","2":"Corporate","3":"2012","4":"254.83","5":"2.64"},{"1":"Africa","2":"Corporate","3":"2013","4":"977.04","5":"2.83"},{"1":"Africa","2":"Corporate","3":"2014","4":"1146.13","5":"0.17"},{"1":"Africa","2":"Home Office","3":"2011","4":"144.37","5":"NA"},{"1":"Africa","2":"Home Office","3":"2012","4":"260.19","5":"0.80"},{"1":"Africa","2":"Home Office","3":"2013","4":"966.57","5":"2.71"},{"1":"Africa","2":"Home Office","3":"2014","4":"1555.18","5":"0.61"},{"1":"APAC","2":"Consumer","3":"2011","4":"578.95","5":"NA"},{"1":"APAC","2":"Consumer","3":"2012","4":"1918.68","5":"2.31"},{"1":"APAC","2":"Consumer","3":"2013","4":"3734.81","5":"0.95"},{"1":"APAC","2":"Consumer","3":"2014","4":"5737.16","5":"0.54"},{"1":"APAC","2":"Corporate","3":"2011","4":"692.65","5":"NA"},{"1":"APAC","2":"Corporate","3":"2012","4":"1880.17","5":"1.71"},{"1":"APAC","2":"Corporate","3":"2013","4":"3828.61","5":"1.04"},{"1":"APAC","2":"Corporate","3":"2014","4":"5690.48","5":"0.49"},{"1":"APAC","2":"Home Office","3":"2011","4":"590.70","5":"NA"},{"1":"APAC","2":"Home Office","3":"2012","4":"1755.89","5":"1.97"},{"1":"APAC","2":"Home Office","3":"2013","4":"3815.83","5":"1.17"},{"1":"APAC","2":"Home Office","3":"2014","4":"6656.25","5":"0.74"},{"1":"Canada","2":"Consumer","3":"2011","4":"25.96","5":"NA"},{"1":"Canada","2":"Consumer","3":"2012","4":"329.38","5":"11.69"},{"1":"Canada","2":"Consumer","3":"2013","4":"663.34","5":"1.01"},{"1":"Canada","2":"Consumer","3":"2014","4":"1209.43","5":"0.82"},{"1":"Canada","2":"Corporate","3":"2011","4":"17.34","5":"NA"},{"1":"Canada","2":"Corporate","3":"2012","4":"191.10","5":"10.02"},{"1":"Canada","2":"Corporate","3":"2013","4":"482.85","5":"1.53"},{"1":"Canada","2":"Corporate","3":"2014","4":"1158.34","5":"1.40"},{"1":"Canada","2":"Home Office","3":"2011","4":"53.05","5":"NA"},{"1":"Canada","2":"Home Office","3":"2012","4":"228.47","5":"3.31"},{"1":"Canada","2":"Home Office","3":"2013","4":"1256.72","5":"4.50"},{"1":"Canada","2":"Home Office","3":"2014","4":"759.95","5":"-0.40"},{"1":"EMEA","2":"Consumer","3":"2011","4":"62.06","5":"NA"},{"1":"EMEA","2":"Consumer","3":"2012","4":"349.29","5":"4.63"},{"1":"EMEA","2":"Consumer","3":"2013","4":"797.82","5":"1.28"},{"1":"EMEA","2":"Consumer","3":"2014","4":"1562.82","5":"0.96"},{"1":"EMEA","2":"Corporate","3":"2011","4":"96.75","5":"NA"},{"1":"EMEA","2":"Corporate","3":"2012","4":"360.16","5":"2.72"},{"1":"EMEA","2":"Corporate","3":"2013","4":"766.41","5":"1.13"},{"1":"EMEA","2":"Corporate","3":"2014","4":"1360.31","5":"0.77"},{"1":"EMEA","2":"Home Office","3":"2011","4":"95.44","5":"NA"},{"1":"EMEA","2":"Home Office","3":"2012","4":"303.39","5":"2.18"},{"1":"EMEA","2":"Home Office","3":"2013","4":"677.17","5":"1.23"},{"1":"EMEA","2":"Home Office","3":"2014","4":"1711.71","5":"1.53"},{"1":"EU","2":"Consumer","3":"2011","4":"512.80","5":"NA"},{"1":"EU","2":"Consumer","3":"2012","4":"1845.09","5":"2.60"},{"1":"EU","2":"Consumer","3":"2013","4":"2873.79","5":"0.56"},{"1":"EU","2":"Consumer","3":"2014","4":"5018.94","5":"0.75"},{"1":"EU","2":"Corporate","3":"2011","4":"540.16","5":"NA"},{"1":"EU","2":"Corporate","3":"2012","4":"1554.15","5":"1.88"},{"1":"EU","2":"Corporate","3":"2013","4":"3104.34","5":"1.00"},{"1":"EU","2":"Corporate","3":"2014","4":"5630.15","5":"0.81"},{"1":"EU","2":"Home Office","3":"2011","4":"393.32","5":"NA"},{"1":"EU","2":"Home Office","3":"2012","4":"1355.59","5":"2.45"},{"1":"EU","2":"Home Office","3":"2013","4":"2713.76","5":"1.00"},{"1":"EU","2":"Home Office","3":"2014","4":"5437.67","5":"1.00"},{"1":"LATAM","2":"Consumer","3":"2011","4":"429.28","5":"NA"},{"1":"LATAM","2":"Consumer","3":"2012","4":"1209.67","5":"1.82"},{"1":"LATAM","2":"Consumer","3":"2013","4":"2468.66","5":"1.04"},{"1":"LATAM","2":"Consumer","3":"2014","4":"3555.89","5":"0.44"},{"1":"LATAM","2":"Corporate","3":"2011","4":"396.01","5":"NA"},{"1":"LATAM","2":"Corporate","3":"2012","4":"1349.29","5":"2.41"},{"1":"LATAM","2":"Corporate","3":"2013","4":"2147.15","5":"0.59"},{"1":"LATAM","2":"Corporate","3":"2014","4":"3765.73","5":"0.75"},{"1":"LATAM","2":"Home Office","3":"2011","4":"312.55","5":"NA"},{"1":"LATAM","2":"Home Office","3":"2012","4":"1174.44","5":"2.76"},{"1":"LATAM","2":"Home Office","3":"2013","4":"2109.38","5":"0.80"},{"1":"LATAM","2":"Home Office","3":"2014","4":"3754.43","5":"0.78"},{"1":"US","2":"Consumer","3":"2011","4":"470.45","5":"NA"},{"1":"US","2":"Consumer","3":"2012","4":"1408.87","5":"1.99"},{"1":"US","2":"Consumer","3":"2013","4":"2293.64","5":"0.63"},{"1":"US","2":"Consumer","3":"2014","4":"3303.78","5":"0.44"},{"1":"US","2":"Corporate","3":"2011","4":"404.85","5":"NA"},{"1":"US","2":"Corporate","3":"2012","4":"1201.26","5":"1.97"},{"1":"US","2":"Corporate","3":"2013","4":"2727.28","5":"1.27"},{"1":"US","2":"Corporate","3":"2014","4":"4239.38","5":"0.55"},{"1":"US","2":"Home Office","3":"2011","4":"463.84","5":"NA"},{"1":"US","2":"Home Office","3":"2012","4":"1013.48","5":"1.18"},{"1":"US","2":"Home Office","3":"2013","4":"2365.31","5":"1.33"},{"1":"US","2":"Home Office","3":"2014","4":"4418.71","5":"0.87"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="fu">ggplot</span>(CLV) <span class="sc">+</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> clv, <span class="at">fill =</span> segment),</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>()</span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> growth <span class="sc">*</span> <span class="fu">mean</span>(</span>
<span id="cb46-9"><a href="#cb46-9" tabindex="-1"></a>        CLV[CLV<span class="sc">$</span>market <span class="sc">==</span> market <span class="sc">&amp;</span> CLV<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb46-10"><a href="#cb46-10" tabindex="-1"></a>          segment, <span class="st">&quot;clv&quot;</span>]</span>
<span id="cb46-11"><a href="#cb46-11" tabindex="-1"></a>      ),</span>
<span id="cb46-12"><a href="#cb46-12" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;YoY Growth&quot;</span></span>
<span id="cb46-13"><a href="#cb46-13" tabindex="-1"></a>    )</span>
<span id="cb46-14"><a href="#cb46-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb46-16"><a href="#cb46-16" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb46-17"><a href="#cb46-17" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> growth <span class="sc">*</span> <span class="fu">mean</span>(</span>
<span id="cb46-18"><a href="#cb46-18" tabindex="-1"></a>        CLV[CLV<span class="sc">$</span>market <span class="sc">==</span> market <span class="sc">&amp;</span> CLV<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb46-19"><a href="#cb46-19" tabindex="-1"></a>          segment, <span class="st">&quot;clv&quot;</span>]</span>
<span id="cb46-20"><a href="#cb46-20" tabindex="-1"></a>      ),</span>
<span id="cb46-21"><a href="#cb46-21" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;YoY Growth&quot;</span></span>
<span id="cb46-22"><a href="#cb46-22" tabindex="-1"></a>    ),</span>
<span id="cb46-23"><a href="#cb46-23" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb46-24"><a href="#cb46-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-25"><a href="#cb46-25" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb46-26"><a href="#cb46-26" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb46-27"><a href="#cb46-27" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> growth <span class="sc">*</span> <span class="fu">mean</span>(</span>
<span id="cb46-28"><a href="#cb46-28" tabindex="-1"></a>        CLV[CLV<span class="sc">$</span>market <span class="sc">==</span> market <span class="sc">&amp;</span> CLV<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb46-29"><a href="#cb46-29" tabindex="-1"></a>          segment, <span class="st">&quot;clv&quot;</span>]</span>
<span id="cb46-30"><a href="#cb46-30" tabindex="-1"></a>      ),</span>
<span id="cb46-31"><a href="#cb46-31" tabindex="-1"></a>      <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(growth, <span class="at">accuracy =</span> 1L),</span>
<span id="cb46-32"><a href="#cb46-32" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;YoY Growth&quot;</span></span>
<span id="cb46-33"><a href="#cb46-33" tabindex="-1"></a>    ),</span>
<span id="cb46-34"><a href="#cb46-34" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb46-35"><a href="#cb46-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-36"><a href="#cb46-36" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-37"><a href="#cb46-37" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Customer Lifetime Value&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb46-38"><a href="#cb46-38" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Customer Lifetime Value, $&quot;</span></span>
<span id="cb46-39"><a href="#cb46-39" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-40"><a href="#cb46-40" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb46-41"><a href="#cb46-41" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb46-42"><a href="#cb46-42" tabindex="-1"></a>      <span class="at">Consumer =</span> <span class="st">&quot;#ff6361&quot;</span>, <span class="at">Corporate =</span> <span class="st">&quot;#bc5090&quot;</span>,</span>
<span id="cb46-43"><a href="#cb46-43" tabindex="-1"></a>      <span class="st">`</span><span class="at">Home Office</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span></span>
<span id="cb46-44"><a href="#cb46-44" tabindex="-1"></a>    )</span>
<span id="cb46-45"><a href="#cb46-45" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-46"><a href="#cb46-46" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">YoY Growth</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb46-47"><a href="#cb46-47" tabindex="-1"></a>  <span class="fu">facet_grid</span>(market <span class="sc">~</span> segment, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb46-48"><a href="#cb46-48" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb46-49"><a href="#cb46-49" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-50"><a href="#cb46-50" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_blank</span>(), <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb46-51"><a href="#cb46-51" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-48-1.png" width="100%" /></p>
</div>
<div id="quarterly-customer-retention-rate" class="section level2">
<h2>Quarterly Customer Retention Rate</h2>
<div class="sourceCode" id="cb47"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="kw">WITH</span> cte_orders <span class="kw">AS</span> (</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>       order_id,</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>       customer_id,</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>       order_date,</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a>       market,</span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a>       <span class="fu">min</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> customer_id, market) <span class="kw">AS</span> first_date</span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb47-11"><a href="#cb47-11" tabindex="-1"></a>    analysis.all_global_orders</span>
<span id="cb47-12"><a href="#cb47-12" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> customer_id, market, order_date),</span>
<span id="cb47-13"><a href="#cb47-13" tabindex="-1"></a>    cte_orders_split <span class="kw">AS</span> (</span>
<span id="cb47-14"><a href="#cb47-14" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb47-15"><a href="#cb47-15" tabindex="-1"></a>       <span class="fu">extract</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> order_year,</span>
<span id="cb47-16"><a href="#cb47-16" tabindex="-1"></a>       <span class="fu">extract</span>(QUARTER <span class="kw">FROM</span> order_date) <span class="kw">AS</span> order_q,</span>
<span id="cb47-17"><a href="#cb47-17" tabindex="-1"></a>       <span class="fu">extract</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> first_date) <span class="kw">AS</span> first_year,</span>
<span id="cb47-18"><a href="#cb47-18" tabindex="-1"></a>       <span class="fu">extract</span>(QUARTER <span class="kw">FROM</span> first_date) <span class="kw">AS</span> first_q</span>
<span id="cb47-19"><a href="#cb47-19" tabindex="-1"></a><span class="kw">FROM</span> cte_orders)</span>
<span id="cb47-20"><a href="#cb47-20" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">year</span>, quarter,</span>
<span id="cb47-22"><a href="#cb47-22" tabindex="-1"></a>       market, <span class="kw">segment</span>,</span>
<span id="cb47-23"><a href="#cb47-23" tabindex="-1"></a>       uniq_customers:<span class="ch">:INT</span>,</span>
<span id="cb47-24"><a href="#cb47-24" tabindex="-1"></a>       new_customers:<span class="ch">:INT</span>,</span>
<span id="cb47-25"><a href="#cb47-25" tabindex="-1"></a>       n:<span class="ch">:INT</span>,</span>
<span id="cb47-26"><a href="#cb47-26" tabindex="-1"></a>       <span class="fu">CONCAT</span>(<span class="st">&#39;Q&#39;</span>, quarter, <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>, SUBSTRING(TEXT(<span class="dt">year</span>), <span class="dv">3</span>, <span class="dv">2</span>))               <span class="kw">AS</span> qy,</span>
<span id="cb47-27"><a href="#cb47-27" tabindex="-1"></a>       <span class="fu">round</span>((uniq_customers<span class="op">-</span><span class="fu">coalesce</span>(new_customers, <span class="dv">0</span>)):<span class="ch">:decimal</span><span class="op">/</span><span class="fu">lag</span>(uniq_customers) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, <span class="kw">segment</span> <span class="kw">ORDER</span> <span class="kw">BY</span> n), <span class="dv">2</span>) <span class="kw">AS</span> ret_rate</span>
<span id="cb47-28"><a href="#cb47-28" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb47-29"><a href="#cb47-29" tabindex="-1"></a>(<span class="kw">SELECT</span> order_year <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb47-30"><a href="#cb47-30" tabindex="-1"></a>       order_q <span class="kw">AS</span> quarter,</span>
<span id="cb47-31"><a href="#cb47-31" tabindex="-1"></a>       a.market,</span>
<span id="cb47-32"><a href="#cb47-32" tabindex="-1"></a>       a.<span class="kw">segment</span>,</span>
<span id="cb47-33"><a href="#cb47-33" tabindex="-1"></a>       a.uniq_customers,</span>
<span id="cb47-34"><a href="#cb47-34" tabindex="-1"></a>       b.new_customers,</span>
<span id="cb47-35"><a href="#cb47-35" tabindex="-1"></a>       <span class="fu">row_number</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> a.market, a.<span class="kw">segment</span> <span class="kw">ORDER</span> <span class="kw">BY</span> a.order_year, a.order_q) n</span>
<span id="cb47-36"><a href="#cb47-36" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb47-37"><a href="#cb47-37" tabindex="-1"></a>(<span class="kw">SELECT</span> order_year,</span>
<span id="cb47-38"><a href="#cb47-38" tabindex="-1"></a>       order_q,</span>
<span id="cb47-39"><a href="#cb47-39" tabindex="-1"></a>       market,</span>
<span id="cb47-40"><a href="#cb47-40" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb47-41"><a href="#cb47-41" tabindex="-1"></a>       <span class="fu">count</span>(<span class="kw">DISTINCT</span> customer_id) uniq_customers</span>
<span id="cb47-42"><a href="#cb47-42" tabindex="-1"></a><span class="kw">FROM</span> cte_orders_split</span>
<span id="cb47-43"><a href="#cb47-43" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>) a</span>
<span id="cb47-44"><a href="#cb47-44" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb47-45"><a href="#cb47-45" tabindex="-1"></a>(<span class="kw">SELECT</span> first_year,</span>
<span id="cb47-46"><a href="#cb47-46" tabindex="-1"></a>       first_q,</span>
<span id="cb47-47"><a href="#cb47-47" tabindex="-1"></a>       market,</span>
<span id="cb47-48"><a href="#cb47-48" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb47-49"><a href="#cb47-49" tabindex="-1"></a>       <span class="fu">count</span>(<span class="kw">DISTINCT</span> customer_id) new_customers</span>
<span id="cb47-50"><a href="#cb47-50" tabindex="-1"></a><span class="kw">FROM</span> cte_orders_split</span>
<span id="cb47-51"><a href="#cb47-51" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>) b <span class="kw">ON</span> a.order_year <span class="op">=</span> b.first_year <span class="kw">AND</span></span>
<span id="cb47-52"><a href="#cb47-52" tabindex="-1"></a>                          a.order_q <span class="op">=</span> b.first_q <span class="kw">AND</span></span>
<span id="cb47-53"><a href="#cb47-53" tabindex="-1"></a>                          a.market <span class="op">=</span> b.market <span class="kw">AND</span></span>
<span id="cb47-54"><a href="#cb47-54" tabindex="-1"></a>                          a.<span class="kw">segment</span> <span class="op">=</span> b.<span class="kw">segment</span></span>
<span id="cb47-55"><a href="#cb47-55" tabindex="-1"></a>) a;</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># prinit results</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>customer_retention</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["quarter"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["market"],"name":[3],"type":["chr"],"align":["left"]},{"label":["segment"],"name":[4],"type":["chr"],"align":["left"]},{"label":["uniq_customers"],"name":[5],"type":["int"],"align":["right"]},{"label":["new_customers"],"name":[6],"type":["int"],"align":["right"]},{"label":["n"],"name":[7],"type":["int"],"align":["right"]},{"label":["qy"],"name":[8],"type":["chr"],"align":["left"]},{"label":["ret_rate"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"1","3":"Africa","4":"Consumer","5":"40","6":"40","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Africa","4":"Consumer","5":"43","6":"39","7":"2","8":"Q2'11","9":"0.10"},{"1":"2011","2":"3","3":"Africa","4":"Consumer","5":"44","6":"35","7":"3","8":"Q3'11","9":"0.21"},{"1":"2011","2":"4","3":"Africa","4":"Consumer","5":"54","6":"37","7":"4","8":"Q4'11","9":"0.39"},{"1":"2012","2":"1","3":"Africa","4":"Consumer","5":"43","6":"34","7":"5","8":"Q1'12","9":"0.17"},{"1":"2012","2":"2","3":"Africa","4":"Consumer","5":"44","6":"25","7":"6","8":"Q2'12","9":"0.44"},{"1":"2012","2":"3","3":"Africa","4":"Consumer","5":"62","6":"31","7":"7","8":"Q3'12","9":"0.70"},{"1":"2012","2":"4","3":"Africa","4":"Consumer","5":"67","6":"22","7":"8","8":"Q4'12","9":"0.73"},{"1":"2013","2":"1","3":"Africa","4":"Consumer","5":"48","6":"19","7":"9","8":"Q1'13","9":"0.43"},{"1":"2013","2":"2","3":"Africa","4":"Consumer","5":"56","6":"19","7":"10","8":"Q2'13","9":"0.77"},{"1":"2013","2":"3","3":"Africa","4":"Consumer","5":"81","6":"19","7":"11","8":"Q3'13","9":"1.11"},{"1":"2013","2":"4","3":"Africa","4":"Consumer","5":"82","6":"16","7":"12","8":"Q4'13","9":"0.81"},{"1":"2014","2":"1","3":"Africa","4":"Consumer","5":"69","6":"9","7":"13","8":"Q1'14","9":"0.73"},{"1":"2014","2":"2","3":"Africa","4":"Consumer","5":"103","6":"20","7":"14","8":"Q2'14","9":"1.20"},{"1":"2014","2":"3","3":"Africa","4":"Consumer","5":"92","6":"12","7":"15","8":"Q3'14","9":"0.78"},{"1":"2014","2":"4","3":"Africa","4":"Consumer","5":"129","6":"9","7":"16","8":"Q4'14","9":"1.30"},{"1":"2011","2":"1","3":"Africa","4":"Corporate","5":"22","6":"22","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Africa","4":"Corporate","5":"21","6":"19","7":"2","8":"Q2'11","9":"0.09"},{"1":"2011","2":"3","3":"Africa","4":"Corporate","5":"31","6":"28","7":"3","8":"Q3'11","9":"0.14"},{"1":"2011","2":"4","3":"Africa","4":"Corporate","5":"37","6":"25","7":"4","8":"Q4'11","9":"0.39"},{"1":"2012","2":"1","3":"Africa","4":"Corporate","5":"24","6":"16","7":"5","8":"Q1'12","9":"0.22"},{"1":"2012","2":"2","3":"Africa","4":"Corporate","5":"28","6":"15","7":"6","8":"Q2'12","9":"0.54"},{"1":"2012","2":"3","3":"Africa","4":"Corporate","5":"35","6":"21","7":"7","8":"Q3'12","9":"0.50"},{"1":"2012","2":"4","3":"Africa","4":"Corporate","5":"29","6":"12","7":"8","8":"Q4'12","9":"0.49"},{"1":"2013","2":"1","3":"Africa","4":"Corporate","5":"36","6":"11","7":"9","8":"Q1'13","9":"0.86"},{"1":"2013","2":"2","3":"Africa","4":"Corporate","5":"39","6":"9","7":"10","8":"Q2'13","9":"0.83"},{"1":"2013","2":"3","3":"Africa","4":"Corporate","5":"55","6":"11","7":"11","8":"Q3'13","9":"1.13"},{"1":"2013","2":"4","3":"Africa","4":"Corporate","5":"53","6":"16","7":"12","8":"Q4'13","9":"0.67"},{"1":"2014","2":"1","3":"Africa","4":"Corporate","5":"36","6":"8","7":"13","8":"Q1'14","9":"0.53"},{"1":"2014","2":"2","3":"Africa","4":"Corporate","5":"60","6":"8","7":"14","8":"Q2'14","9":"1.44"},{"1":"2014","2":"3","3":"Africa","4":"Corporate","5":"51","6":"2","7":"15","8":"Q3'14","9":"0.82"},{"1":"2014","2":"4","3":"Africa","4":"Corporate","5":"64","6":"3","7":"16","8":"Q4'14","9":"1.20"},{"1":"2011","2":"1","3":"Africa","4":"Home Office","5":"9","6":"9","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Africa","4":"Home Office","5":"22","6":"20","7":"2","8":"Q2'11","9":"0.22"},{"1":"2011","2":"3","3":"Africa","4":"Home Office","5":"15","6":"10","7":"3","8":"Q3'11","9":"0.23"},{"1":"2011","2":"4","3":"Africa","4":"Home Office","5":"24","6":"18","7":"4","8":"Q4'11","9":"0.40"},{"1":"2012","2":"1","3":"Africa","4":"Home Office","5":"14","6":"9","7":"5","8":"Q1'12","9":"0.21"},{"1":"2012","2":"2","3":"Africa","4":"Home Office","5":"15","6":"8","7":"6","8":"Q2'12","9":"0.50"},{"1":"2012","2":"3","3":"Africa","4":"Home Office","5":"27","6":"13","7":"7","8":"Q3'12","9":"0.93"},{"1":"2012","2":"4","3":"Africa","4":"Home Office","5":"17","6":"5","7":"8","8":"Q4'12","9":"0.44"},{"1":"2013","2":"1","3":"Africa","4":"Home Office","5":"23","6":"13","7":"9","8":"Q1'13","9":"0.59"},{"1":"2013","2":"2","3":"Africa","4":"Home Office","5":"30","6":"12","7":"10","8":"Q2'13","9":"0.78"},{"1":"2013","2":"3","3":"Africa","4":"Home Office","5":"35","6":"9","7":"11","8":"Q3'13","9":"0.87"},{"1":"2013","2":"4","3":"Africa","4":"Home Office","5":"32","6":"3","7":"12","8":"Q4'13","9":"0.83"},{"1":"2014","2":"1","3":"Africa","4":"Home Office","5":"29","6":"3","7":"13","8":"Q1'14","9":"0.81"},{"1":"2014","2":"2","3":"Africa","4":"Home Office","5":"28","6":"5","7":"14","8":"Q2'14","9":"0.79"},{"1":"2014","2":"3","3":"Africa","4":"Home Office","5":"37","6":"4","7":"15","8":"Q3'14","9":"1.18"},{"1":"2014","2":"4","3":"Africa","4":"Home Office","5":"36","6":"1","7":"16","8":"Q4'14","9":"0.95"},{"1":"2011","2":"1","3":"APAC","4":"Consumer","5":"80","6":"80","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"APAC","4":"Consumer","5":"91","6":"72","7":"2","8":"Q2'11","9":"0.24"},{"1":"2011","2":"3","3":"APAC","4":"Consumer","5":"113","6":"73","7":"3","8":"Q3'11","9":"0.44"},{"1":"2011","2":"4","3":"APAC","4":"Consumer","5":"151","6":"69","7":"4","8":"Q4'11","9":"0.73"},{"1":"2012","2":"1","3":"APAC","4":"Consumer","5":"82","6":"15","7":"5","8":"Q1'12","9":"0.44"},{"1":"2012","2":"2","3":"APAC","4":"Consumer","5":"144","6":"33","7":"6","8":"Q2'12","9":"1.35"},{"1":"2012","2":"3","3":"APAC","4":"Consumer","5":"126","6":"13","7":"7","8":"Q3'12","9":"0.78"},{"1":"2012","2":"4","3":"APAC","4":"Consumer","5":"176","6":"21","7":"8","8":"Q4'12","9":"1.23"},{"1":"2013","2":"1","3":"APAC","4":"Consumer","5":"97","6":"7","7":"9","8":"Q1'13","9":"0.51"},{"1":"2013","2":"2","3":"APAC","4":"Consumer","5":"163","6":"11","7":"10","8":"Q2'13","9":"1.57"},{"1":"2013","2":"3","3":"APAC","4":"Consumer","5":"152","6":"7","7":"11","8":"Q3'13","9":"0.89"},{"1":"2013","2":"4","3":"APAC","4":"Consumer","5":"172","6":"6","7":"12","8":"Q4'13","9":"1.09"},{"1":"2014","2":"1","3":"APAC","4":"Consumer","5":"114","6":"1","7":"13","8":"Q1'14","9":"0.66"},{"1":"2014","2":"2","3":"APAC","4":"Consumer","5":"179","6":"1","7":"14","8":"Q2'14","9":"1.56"},{"1":"2014","2":"3","3":"APAC","4":"Consumer","5":"196","6":"NA","7":"15","8":"Q3'14","9":"1.09"},{"1":"2014","2":"4","3":"APAC","4":"Consumer","5":"227","6":"1","7":"16","8":"Q4'14","9":"1.15"},{"1":"2011","2":"1","3":"APAC","4":"Corporate","5":"40","6":"40","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"APAC","4":"Corporate","5":"57","6":"48","7":"2","8":"Q2'11","9":"0.23"},{"1":"2011","2":"3","3":"APAC","4":"Corporate","5":"61","6":"45","7":"3","8":"Q3'11","9":"0.28"},{"1":"2011","2":"4","3":"APAC","4":"Corporate","5":"88","6":"44","7":"4","8":"Q4'11","9":"0.72"},{"1":"2012","2":"1","3":"APAC","4":"Corporate","5":"41","6":"12","7":"5","8":"Q1'12","9":"0.33"},{"1":"2012","2":"2","3":"APAC","4":"Corporate","5":"81","6":"18","7":"6","8":"Q2'12","9":"1.54"},{"1":"2012","2":"3","3":"APAC","4":"Corporate","5":"67","6":"5","7":"7","8":"Q3'12","9":"0.77"},{"1":"2012","2":"4","3":"APAC","4":"Corporate","5":"88","6":"10","7":"8","8":"Q4'12","9":"1.16"},{"1":"2013","2":"1","3":"APAC","4":"Corporate","5":"49","6":"4","7":"9","8":"Q1'13","9":"0.51"},{"1":"2013","2":"2","3":"APAC","4":"Corporate","5":"84","6":"6","7":"10","8":"Q2'13","9":"1.59"},{"1":"2013","2":"3","3":"APAC","4":"Corporate","5":"101","6":"3","7":"11","8":"Q3'13","9":"1.17"},{"1":"2013","2":"4","3":"APAC","4":"Corporate","5":"95","6":"NA","7":"12","8":"Q4'13","9":"0.94"},{"1":"2014","2":"1","3":"APAC","4":"Corporate","5":"90","6":"NA","7":"13","8":"Q1'14","9":"0.95"},{"1":"2014","2":"2","3":"APAC","4":"Corporate","5":"105","6":"3","7":"14","8":"Q2'14","9":"1.13"},{"1":"2014","2":"3","3":"APAC","4":"Corporate","5":"93","6":"NA","7":"15","8":"Q3'14","9":"0.89"},{"1":"2014","2":"4","3":"APAC","4":"Corporate","5":"129","6":"NA","7":"16","8":"Q4'14","9":"1.39"},{"1":"2011","2":"1","3":"APAC","4":"Home Office","5":"24","6":"24","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"APAC","4":"Home Office","5":"31","6":"28","7":"2","8":"Q2'11","9":"0.13"},{"1":"2011","2":"3","3":"APAC","4":"Home Office","5":"37","6":"26","7":"3","8":"Q3'11","9":"0.35"},{"1":"2011","2":"4","3":"APAC","4":"Home Office","5":"52","6":"23","7":"4","8":"Q4'11","9":"0.78"},{"1":"2012","2":"1","3":"APAC","4":"Home Office","5":"35","6":"12","7":"5","8":"Q1'12","9":"0.44"},{"1":"2012","2":"2","3":"APAC","4":"Home Office","5":"44","6":"11","7":"6","8":"Q2'12","9":"0.94"},{"1":"2012","2":"3","3":"APAC","4":"Home Office","5":"51","6":"9","7":"7","8":"Q3'12","9":"0.95"},{"1":"2012","2":"4","3":"APAC","4":"Home Office","5":"50","6":"8","7":"8","8":"Q4'12","9":"0.82"},{"1":"2013","2":"1","3":"APAC","4":"Home Office","5":"28","6":"2","7":"9","8":"Q1'13","9":"0.52"},{"1":"2013","2":"2","3":"APAC","4":"Home Office","5":"53","6":"2","7":"10","8":"Q2'13","9":"1.82"},{"1":"2013","2":"3","3":"APAC","4":"Home Office","5":"54","6":"3","7":"11","8":"Q3'13","9":"0.96"},{"1":"2013","2":"4","3":"APAC","4":"Home Office","5":"65","6":"NA","7":"12","8":"Q4'13","9":"1.20"},{"1":"2014","2":"1","3":"APAC","4":"Home Office","5":"49","6":"NA","7":"13","8":"Q1'14","9":"0.75"},{"1":"2014","2":"2","3":"APAC","4":"Home Office","5":"71","6":"NA","7":"14","8":"Q2'14","9":"1.45"},{"1":"2014","2":"3","3":"APAC","4":"Home Office","5":"69","6":"NA","7":"15","8":"Q3'14","9":"0.97"},{"1":"2014","2":"4","3":"APAC","4":"Home Office","5":"77","6":"NA","7":"16","8":"Q4'14","9":"1.12"},{"1":"2011","2":"1","3":"Canada","4":"Consumer","5":"4","6":"4","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Canada","4":"Consumer","5":"6","6":"6","7":"2","8":"Q2'11","9":"0.00"},{"1":"2011","2":"3","3":"Canada","4":"Consumer","5":"6","6":"6","7":"3","8":"Q3'11","9":"0.00"},{"1":"2011","2":"4","3":"Canada","4":"Consumer","5":"3","6":"3","7":"4","8":"Q4'11","9":"0.00"},{"1":"2012","2":"1","3":"Canada","4":"Consumer","5":"1","6":"1","7":"5","8":"Q1'12","9":"0.00"},{"1":"2012","2":"2","3":"Canada","4":"Consumer","5":"11","6":"11","7":"6","8":"Q2'12","9":"0.00"},{"1":"2012","2":"3","3":"Canada","4":"Consumer","5":"8","6":"7","7":"7","8":"Q3'12","9":"0.09"},{"1":"2012","2":"4","3":"Canada","4":"Consumer","5":"6","6":"6","7":"8","8":"Q4'12","9":"0.00"},{"1":"2013","2":"1","3":"Canada","4":"Consumer","5":"9","6":"8","7":"9","8":"Q1'13","9":"0.17"},{"1":"2013","2":"2","3":"Canada","4":"Consumer","5":"3","6":"3","7":"10","8":"Q2'13","9":"0.00"},{"1":"2013","2":"3","3":"Canada","4":"Consumer","5":"8","6":"6","7":"11","8":"Q3'13","9":"0.67"},{"1":"2013","2":"4","3":"Canada","4":"Consumer","5":"9","6":"9","7":"12","8":"Q4'13","9":"0.00"},{"1":"2014","2":"1","3":"Canada","4":"Consumer","5":"4","6":"3","7":"13","8":"Q1'14","9":"0.11"},{"1":"2014","2":"2","3":"Canada","4":"Consumer","5":"7","6":"4","7":"14","8":"Q2'14","9":"0.75"},{"1":"2014","2":"3","3":"Canada","4":"Consumer","5":"6","6":"6","7":"15","8":"Q3'14","9":"0.00"},{"1":"2014","2":"4","3":"Canada","4":"Consumer","5":"9","6":"8","7":"16","8":"Q4'14","9":"0.17"},{"1":"2011","2":"1","3":"Canada","4":"Corporate","5":"1","6":"1","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Canada","4":"Corporate","5":"2","6":"2","7":"2","8":"Q2'11","9":"0.00"},{"1":"2011","2":"3","3":"Canada","4":"Corporate","5":"5","6":"5","7":"3","8":"Q3'11","9":"0.00"},{"1":"2011","2":"4","3":"Canada","4":"Corporate","5":"4","6":"4","7":"4","8":"Q4'11","9":"0.00"},{"1":"2012","2":"1","3":"Canada","4":"Corporate","5":"2","6":"1","7":"5","8":"Q1'12","9":"0.25"},{"1":"2012","2":"2","3":"Canada","4":"Corporate","5":"3","6":"3","7":"6","8":"Q2'12","9":"0.00"},{"1":"2012","2":"3","3":"Canada","4":"Corporate","5":"6","6":"6","7":"7","8":"Q3'12","9":"0.00"},{"1":"2012","2":"4","3":"Canada","4":"Corporate","5":"3","6":"3","7":"8","8":"Q4'12","9":"0.00"},{"1":"2013","2":"1","3":"Canada","4":"Corporate","5":"3","6":"2","7":"9","8":"Q1'13","9":"0.33"},{"1":"2013","2":"2","3":"Canada","4":"Corporate","5":"6","6":"5","7":"10","8":"Q2'13","9":"0.33"},{"1":"2013","2":"3","3":"Canada","4":"Corporate","5":"2","6":"2","7":"11","8":"Q3'13","9":"0.00"},{"1":"2013","2":"4","3":"Canada","4":"Corporate","5":"6","6":"4","7":"12","8":"Q4'13","9":"1.00"},{"1":"2014","2":"1","3":"Canada","4":"Corporate","5":"5","6":"3","7":"13","8":"Q1'14","9":"0.33"},{"1":"2014","2":"2","3":"Canada","4":"Corporate","5":"4","6":"4","7":"14","8":"Q2'14","9":"0.00"},{"1":"2014","2":"3","3":"Canada","4":"Corporate","5":"7","6":"7","7":"15","8":"Q3'14","9":"0.00"},{"1":"2014","2":"4","3":"Canada","4":"Corporate","5":"5","6":"4","7":"16","8":"Q4'14","9":"0.14"},{"1":"2011","2":"1","3":"Canada","4":"Home Office","5":"2","6":"2","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"Canada","4":"Home Office","5":"1","6":"1","7":"2","8":"Q2'11","9":"0.00"},{"1":"2011","2":"3","3":"Canada","4":"Home Office","5":"1","6":"1","7":"3","8":"Q3'11","9":"0.00"},{"1":"2011","2":"4","3":"Canada","4":"Home Office","5":"1","6":"1","7":"4","8":"Q4'11","9":"0.00"},{"1":"2012","2":"2","3":"Canada","4":"Home Office","5":"5","6":"5","7":"5","8":"Q2'12","9":"0.00"},{"1":"2012","2":"4","3":"Canada","4":"Home Office","5":"3","6":"3","7":"6","8":"Q4'12","9":"0.00"},{"1":"2013","2":"1","3":"Canada","4":"Home Office","5":"2","6":"1","7":"7","8":"Q1'13","9":"0.33"},{"1":"2013","2":"2","3":"Canada","4":"Home Office","5":"4","6":"3","7":"8","8":"Q2'13","9":"0.50"},{"1":"2013","2":"3","3":"Canada","4":"Home Office","5":"4","6":"3","7":"9","8":"Q3'13","9":"0.25"},{"1":"2014","2":"1","3":"Canada","4":"Home Office","5":"4","6":"4","7":"10","8":"Q1'14","9":"0.00"},{"1":"2014","2":"2","3":"Canada","4":"Home Office","5":"1","6":"1","7":"11","8":"Q2'14","9":"0.00"},{"1":"2014","2":"3","3":"Canada","4":"Home Office","5":"6","6":"6","7":"12","8":"Q3'14","9":"0.00"},{"1":"2014","2":"4","3":"Canada","4":"Home Office","5":"4","6":"3","7":"13","8":"Q4'14","9":"0.17"},{"1":"2011","2":"1","3":"EMEA","4":"Consumer","5":"30","6":"30","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EMEA","4":"Consumer","5":"52","6":"49","7":"2","8":"Q2'11","9":"0.10"},{"1":"2011","2":"3","3":"EMEA","4":"Consumer","5":"58","6":"51","7":"3","8":"Q3'11","9":"0.13"},{"1":"2011","2":"4","3":"EMEA","4":"Consumer","5":"57","6":"39","7":"4","8":"Q4'11","9":"0.31"},{"1":"2012","2":"1","3":"EMEA","4":"Consumer","5":"51","6":"28","7":"5","8":"Q1'12","9":"0.40"},{"1":"2012","2":"2","3":"EMEA","4":"Consumer","5":"59","6":"31","7":"6","8":"Q2'12","9":"0.55"},{"1":"2012","2":"3","3":"EMEA","4":"Consumer","5":"65","6":"25","7":"7","8":"Q3'12","9":"0.68"},{"1":"2012","2":"4","3":"EMEA","4":"Consumer","5":"73","6":"25","7":"8","8":"Q4'12","9":"0.74"},{"1":"2013","2":"1","3":"EMEA","4":"Consumer","5":"50","6":"17","7":"9","8":"Q1'13","9":"0.45"},{"1":"2013","2":"2","3":"EMEA","4":"Consumer","5":"81","6":"23","7":"10","8":"Q2'13","9":"1.16"},{"1":"2013","2":"3","3":"EMEA","4":"Consumer","5":"86","6":"22","7":"11","8":"Q3'13","9":"0.79"},{"1":"2013","2":"4","3":"EMEA","4":"Consumer","5":"91","6":"15","7":"12","8":"Q4'13","9":"0.88"},{"1":"2014","2":"1","3":"EMEA","4":"Consumer","5":"67","6":"8","7":"13","8":"Q1'14","9":"0.65"},{"1":"2014","2":"2","3":"EMEA","4":"Consumer","5":"89","6":"11","7":"14","8":"Q2'14","9":"1.16"},{"1":"2014","2":"3","3":"EMEA","4":"Consumer","5":"131","6":"15","7":"15","8":"Q3'14","9":"1.30"},{"1":"2014","2":"4","3":"EMEA","4":"Consumer","5":"127","6":"6","7":"16","8":"Q4'14","9":"0.92"},{"1":"2011","2":"1","3":"EMEA","4":"Corporate","5":"20","6":"20","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EMEA","4":"Corporate","5":"32","6":"28","7":"2","8":"Q2'11","9":"0.20"},{"1":"2011","2":"3","3":"EMEA","4":"Corporate","5":"36","6":"28","7":"3","8":"Q3'11","9":"0.25"},{"1":"2011","2":"4","3":"EMEA","4":"Corporate","5":"29","6":"21","7":"4","8":"Q4'11","9":"0.22"},{"1":"2012","2":"1","3":"EMEA","4":"Corporate","5":"22","6":"14","7":"5","8":"Q1'12","9":"0.28"},{"1":"2012","2":"2","3":"EMEA","4":"Corporate","5":"39","6":"24","7":"6","8":"Q2'12","9":"0.68"},{"1":"2012","2":"3","3":"EMEA","4":"Corporate","5":"48","6":"22","7":"7","8":"Q3'12","9":"0.67"},{"1":"2012","2":"4","3":"EMEA","4":"Corporate","5":"40","6":"15","7":"8","8":"Q4'12","9":"0.52"},{"1":"2013","2":"1","3":"EMEA","4":"Corporate","5":"39","6":"6","7":"9","8":"Q1'13","9":"0.83"},{"1":"2013","2":"2","3":"EMEA","4":"Corporate","5":"42","6":"6","7":"10","8":"Q2'13","9":"0.92"},{"1":"2013","2":"3","3":"EMEA","4":"Corporate","5":"66","6":"12","7":"11","8":"Q3'13","9":"1.29"},{"1":"2013","2":"4","3":"EMEA","4":"Corporate","5":"53","6":"11","7":"12","8":"Q4'13","9":"0.64"},{"1":"2014","2":"1","3":"EMEA","4":"Corporate","5":"46","6":"4","7":"13","8":"Q1'14","9":"0.79"},{"1":"2014","2":"2","3":"EMEA","4":"Corporate","5":"63","6":"7","7":"14","8":"Q2'14","9":"1.22"},{"1":"2014","2":"3","3":"EMEA","4":"Corporate","5":"72","6":"5","7":"15","8":"Q3'14","9":"1.06"},{"1":"2014","2":"4","3":"EMEA","4":"Corporate","5":"57","6":"3","7":"16","8":"Q4'14","9":"0.75"},{"1":"2011","2":"1","3":"EMEA","4":"Home Office","5":"9","6":"9","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EMEA","4":"Home Office","5":"16","6":"14","7":"2","8":"Q2'11","9":"0.22"},{"1":"2011","2":"3","3":"EMEA","4":"Home Office","5":"27","6":"24","7":"3","8":"Q3'11","9":"0.19"},{"1":"2011","2":"4","3":"EMEA","4":"Home Office","5":"23","6":"16","7":"4","8":"Q4'11","9":"0.26"},{"1":"2012","2":"1","3":"EMEA","4":"Home Office","5":"17","6":"9","7":"5","8":"Q1'12","9":"0.35"},{"1":"2012","2":"2","3":"EMEA","4":"Home Office","5":"14","6":"4","7":"6","8":"Q2'12","9":"0.59"},{"1":"2012","2":"3","3":"EMEA","4":"Home Office","5":"27","6":"11","7":"7","8":"Q3'12","9":"1.14"},{"1":"2012","2":"4","3":"EMEA","4":"Home Office","5":"18","6":"9","7":"8","8":"Q4'12","9":"0.33"},{"1":"2013","2":"1","3":"EMEA","4":"Home Office","5":"18","6":"5","7":"9","8":"Q1'13","9":"0.72"},{"1":"2013","2":"2","3":"EMEA","4":"Home Office","5":"27","6":"8","7":"10","8":"Q2'13","9":"1.06"},{"1":"2013","2":"3","3":"EMEA","4":"Home Office","5":"26","6":"7","7":"11","8":"Q3'13","9":"0.70"},{"1":"2013","2":"4","3":"EMEA","4":"Home Office","5":"31","6":"9","7":"12","8":"Q4'13","9":"0.85"},{"1":"2014","2":"1","3":"EMEA","4":"Home Office","5":"32","6":"2","7":"13","8":"Q1'14","9":"0.97"},{"1":"2014","2":"2","3":"EMEA","4":"Home Office","5":"41","6":"4","7":"14","8":"Q2'14","9":"1.16"},{"1":"2014","2":"3","3":"EMEA","4":"Home Office","5":"46","6":"3","7":"15","8":"Q3'14","9":"1.05"},{"1":"2014","2":"4","3":"EMEA","4":"Home Office","5":"38","6":"5","7":"16","8":"Q4'14","9":"0.72"},{"1":"2011","2":"1","3":"EU","4":"Consumer","5":"68","6":"68","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EU","4":"Consumer","5":"89","6":"77","7":"2","8":"Q2'11","9":"0.18"},{"1":"2011","2":"3","3":"EU","4":"Consumer","5":"118","6":"73","7":"3","8":"Q3'11","9":"0.51"},{"1":"2011","2":"4","3":"EU","4":"Consumer","5":"116","6":"62","7":"4","8":"Q4'11","9":"0.46"},{"1":"2012","2":"1","3":"EU","4":"Consumer","5":"91","6":"34","7":"5","8":"Q1'12","9":"0.49"},{"1":"2012","2":"2","3":"EU","4":"Consumer","5":"122","6":"29","7":"6","8":"Q2'12","9":"1.02"},{"1":"2012","2":"3","3":"EU","4":"Consumer","5":"154","6":"27","7":"7","8":"Q3'12","9":"1.04"},{"1":"2012","2":"4","3":"EU","4":"Consumer","5":"151","6":"11","7":"8","8":"Q4'12","9":"0.91"},{"1":"2013","2":"1","3":"EU","4":"Consumer","5":"115","6":"10","7":"9","8":"Q1'13","9":"0.70"},{"1":"2013","2":"2","3":"EU","4":"Consumer","5":"128","6":"6","7":"10","8":"Q2'13","9":"1.06"},{"1":"2013","2":"3","3":"EU","4":"Consumer","5":"165","6":"6","7":"11","8":"Q3'13","9":"1.24"},{"1":"2013","2":"4","3":"EU","4":"Consumer","5":"160","6":"5","7":"12","8":"Q4'13","9":"0.94"},{"1":"2014","2":"1","3":"EU","4":"Consumer","5":"135","6":"1","7":"13","8":"Q1'14","9":"0.84"},{"1":"2014","2":"2","3":"EU","4":"Consumer","5":"157","6":"NA","7":"14","8":"Q2'14","9":"1.16"},{"1":"2014","2":"3","3":"EU","4":"Consumer","5":"193","6":"NA","7":"15","8":"Q3'14","9":"1.23"},{"1":"2014","2":"4","3":"EU","4":"Consumer","5":"209","6":"NA","7":"16","8":"Q4'14","9":"1.08"},{"1":"2011","2":"1","3":"EU","4":"Corporate","5":"39","6":"39","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EU","4":"Corporate","5":"66","6":"53","7":"2","8":"Q2'11","9":"0.33"},{"1":"2011","2":"3","3":"EU","4":"Corporate","5":"58","6":"34","7":"3","8":"Q3'11","9":"0.36"},{"1":"2011","2":"4","3":"EU","4":"Corporate","5":"57","6":"27","7":"4","8":"Q4'11","9":"0.52"},{"1":"2012","2":"1","3":"EU","4":"Corporate","5":"54","6":"20","7":"5","8":"Q1'12","9":"0.60"},{"1":"2012","2":"2","3":"EU","4":"Corporate","5":"62","6":"19","7":"6","8":"Q2'12","9":"0.80"},{"1":"2012","2":"3","3":"EU","4":"Corporate","5":"89","6":"19","7":"7","8":"Q3'12","9":"1.13"},{"1":"2012","2":"4","3":"EU","4":"Corporate","5":"89","6":"9","7":"8","8":"Q4'12","9":"0.90"},{"1":"2013","2":"1","3":"EU","4":"Corporate","5":"64","6":"6","7":"9","8":"Q1'13","9":"0.65"},{"1":"2013","2":"2","3":"EU","4":"Corporate","5":"73","6":"3","7":"10","8":"Q2'13","9":"1.09"},{"1":"2013","2":"3","3":"EU","4":"Corporate","5":"100","6":"4","7":"11","8":"Q3'13","9":"1.32"},{"1":"2013","2":"4","3":"EU","4":"Corporate","5":"98","6":"3","7":"12","8":"Q4'13","9":"0.95"},{"1":"2014","2":"1","3":"EU","4":"Corporate","5":"80","6":"1","7":"13","8":"Q1'14","9":"0.81"},{"1":"2014","2":"2","3":"EU","4":"Corporate","5":"90","6":"NA","7":"14","8":"Q2'14","9":"1.13"},{"1":"2014","2":"3","3":"EU","4":"Corporate","5":"127","6":"1","7":"15","8":"Q3'14","9":"1.40"},{"1":"2014","2":"4","3":"EU","4":"Corporate","5":"124","6":"NA","7":"16","8":"Q4'14","9":"0.98"},{"1":"2011","2":"1","3":"EU","4":"Home Office","5":"24","6":"24","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"EU","4":"Home Office","5":"27","6":"23","7":"2","8":"Q2'11","9":"0.17"},{"1":"2011","2":"3","3":"EU","4":"Home Office","5":"38","6":"27","7":"3","8":"Q3'11","9":"0.41"},{"1":"2011","2":"4","3":"EU","4":"Home Office","5":"49","6":"26","7":"4","8":"Q4'11","9":"0.61"},{"1":"2012","2":"1","3":"EU","4":"Home Office","5":"29","6":"6","7":"5","8":"Q1'12","9":"0.47"},{"1":"2012","2":"2","3":"EU","4":"Home Office","5":"33","6":"8","7":"6","8":"Q2'12","9":"0.86"},{"1":"2012","2":"3","3":"EU","4":"Home Office","5":"52","6":"12","7":"7","8":"Q3'12","9":"1.21"},{"1":"2012","2":"4","3":"EU","4":"Home Office","5":"43","6":"4","7":"8","8":"Q4'12","9":"0.75"},{"1":"2013","2":"1","3":"EU","4":"Home Office","5":"39","6":"8","7":"9","8":"Q1'13","9":"0.72"},{"1":"2013","2":"2","3":"EU","4":"Home Office","5":"45","6":"5","7":"10","8":"Q2'13","9":"1.03"},{"1":"2013","2":"3","3":"EU","4":"Home Office","5":"66","6":"2","7":"11","8":"Q3'13","9":"1.42"},{"1":"2013","2":"4","3":"EU","4":"Home Office","5":"57","6":"1","7":"12","8":"Q4'13","9":"0.85"},{"1":"2014","2":"1","3":"EU","4":"Home Office","5":"41","6":"NA","7":"13","8":"Q1'14","9":"0.72"},{"1":"2014","2":"2","3":"EU","4":"Home Office","5":"55","6":"NA","7":"14","8":"Q2'14","9":"1.34"},{"1":"2014","2":"3","3":"EU","4":"Home Office","5":"76","6":"2","7":"15","8":"Q3'14","9":"1.35"},{"1":"2014","2":"4","3":"EU","4":"Home Office","5":"67","6":"NA","7":"16","8":"Q4'14","9":"0.88"},{"1":"2011","2":"1","3":"LATAM","4":"Consumer","5":"55","6":"55","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"LATAM","4":"Consumer","5":"98","6":"84","7":"2","8":"Q2'11","9":"0.25"},{"1":"2011","2":"3","3":"LATAM","4":"Consumer","5":"87","6":"54","7":"3","8":"Q3'11","9":"0.34"},{"1":"2011","2":"4","3":"LATAM","4":"Consumer","5":"154","6":"83","7":"4","8":"Q4'11","9":"0.82"},{"1":"2012","2":"1","3":"LATAM","4":"Consumer","5":"65","6":"18","7":"5","8":"Q1'12","9":"0.31"},{"1":"2012","2":"2","3":"LATAM","4":"Consumer","5":"118","6":"39","7":"6","8":"Q2'12","9":"1.22"},{"1":"2012","2":"3","3":"LATAM","4":"Consumer","5":"103","6":"26","7":"7","8":"Q3'12","9":"0.65"},{"1":"2012","2":"4","3":"LATAM","4":"Consumer","5":"172","6":"17","7":"8","8":"Q4'12","9":"1.50"},{"1":"2013","2":"1","3":"LATAM","4":"Consumer","5":"91","6":"8","7":"9","8":"Q1'13","9":"0.48"},{"1":"2013","2":"2","3":"LATAM","4":"Consumer","5":"140","6":"10","7":"10","8":"Q2'13","9":"1.43"},{"1":"2013","2":"3","3":"LATAM","4":"Consumer","5":"148","6":"7","7":"11","8":"Q3'13","9":"1.01"},{"1":"2013","2":"4","3":"LATAM","4":"Consumer","5":"202","6":"2","7":"12","8":"Q4'13","9":"1.35"},{"1":"2014","2":"1","3":"LATAM","4":"Consumer","5":"87","6":"2","7":"13","8":"Q1'14","9":"0.42"},{"1":"2014","2":"2","3":"LATAM","4":"Consumer","5":"170","6":"3","7":"14","8":"Q2'14","9":"1.92"},{"1":"2014","2":"3","3":"LATAM","4":"Consumer","5":"159","6":"NA","7":"15","8":"Q3'14","9":"0.94"},{"1":"2014","2":"4","3":"LATAM","4":"Consumer","5":"213","6":"1","7":"16","8":"Q4'14","9":"1.33"},{"1":"2011","2":"1","3":"LATAM","4":"Corporate","5":"23","6":"23","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"LATAM","4":"Corporate","5":"53","6":"48","7":"2","8":"Q2'11","9":"0.22"},{"1":"2011","2":"3","3":"LATAM","4":"Corporate","5":"50","6":"36","7":"3","8":"Q3'11","9":"0.26"},{"1":"2011","2":"4","3":"LATAM","4":"Corporate","5":"89","6":"50","7":"4","8":"Q4'11","9":"0.78"},{"1":"2012","2":"1","3":"LATAM","4":"Corporate","5":"31","6":"13","7":"5","8":"Q1'12","9":"0.20"},{"1":"2012","2":"2","3":"LATAM","4":"Corporate","5":"67","6":"17","7":"6","8":"Q2'12","9":"1.61"},{"1":"2012","2":"3","3":"LATAM","4":"Corporate","5":"61","6":"11","7":"7","8":"Q3'12","9":"0.75"},{"1":"2012","2":"4","3":"LATAM","4":"Corporate","5":"99","6":"14","7":"8","8":"Q4'12","9":"1.39"},{"1":"2013","2":"1","3":"LATAM","4":"Corporate","5":"42","6":"5","7":"9","8":"Q1'13","9":"0.37"},{"1":"2013","2":"2","3":"LATAM","4":"Corporate","5":"90","6":"5","7":"10","8":"Q2'13","9":"2.02"},{"1":"2013","2":"3","3":"LATAM","4":"Corporate","5":"95","6":"7","7":"11","8":"Q3'13","9":"0.98"},{"1":"2013","2":"4","3":"LATAM","4":"Corporate","5":"106","6":"4","7":"12","8":"Q4'13","9":"1.07"},{"1":"2014","2":"1","3":"LATAM","4":"Corporate","5":"56","6":"2","7":"13","8":"Q1'14","9":"0.51"},{"1":"2014","2":"2","3":"LATAM","4":"Corporate","5":"84","6":"NA","7":"14","8":"Q2'14","9":"1.50"},{"1":"2014","2":"3","3":"LATAM","4":"Corporate","5":"95","6":"NA","7":"15","8":"Q3'14","9":"1.13"},{"1":"2014","2":"4","3":"LATAM","4":"Corporate","5":"129","6":"2","7":"16","8":"Q4'14","9":"1.34"},{"1":"2011","2":"1","3":"LATAM","4":"Home Office","5":"14","6":"14","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"LATAM","4":"Home Office","5":"34","6":"32","7":"2","8":"Q2'11","9":"0.14"},{"1":"2011","2":"3","3":"LATAM","4":"Home Office","5":"33","6":"18","7":"3","8":"Q3'11","9":"0.44"},{"1":"2011","2":"4","3":"LATAM","4":"Home Office","5":"45","6":"26","7":"4","8":"Q4'11","9":"0.58"},{"1":"2012","2":"1","3":"LATAM","4":"Home Office","5":"17","6":"6","7":"5","8":"Q1'12","9":"0.24"},{"1":"2012","2":"2","3":"LATAM","4":"Home Office","5":"43","6":"14","7":"6","8":"Q2'12","9":"1.71"},{"1":"2012","2":"3","3":"LATAM","4":"Home Office","5":"48","6":"11","7":"7","8":"Q3'12","9":"0.86"},{"1":"2012","2":"4","3":"LATAM","4":"Home Office","5":"58","6":"11","7":"8","8":"Q4'12","9":"0.98"},{"1":"2013","2":"1","3":"LATAM","4":"Home Office","5":"34","6":"3","7":"9","8":"Q1'13","9":"0.53"},{"1":"2013","2":"2","3":"LATAM","4":"Home Office","5":"50","6":"5","7":"10","8":"Q2'13","9":"1.32"},{"1":"2013","2":"3","3":"LATAM","4":"Home Office","5":"58","6":"2","7":"11","8":"Q3'13","9":"1.12"},{"1":"2013","2":"4","3":"LATAM","4":"Home Office","5":"72","6":"3","7":"12","8":"Q4'13","9":"1.19"},{"1":"2014","2":"1","3":"LATAM","4":"Home Office","5":"31","6":"1","7":"13","8":"Q1'14","9":"0.42"},{"1":"2014","2":"2","3":"LATAM","4":"Home Office","5":"64","6":"1","7":"14","8":"Q2'14","9":"2.03"},{"1":"2014","2":"3","3":"LATAM","4":"Home Office","5":"64","6":"1","7":"15","8":"Q3'14","9":"0.98"},{"1":"2014","2":"4","3":"LATAM","4":"Home Office","5":"80","6":"NA","7":"16","8":"Q4'14","9":"1.25"},{"1":"2011","2":"1","3":"US","4":"Consumer","5":"70","6":"70","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"US","4":"Consumer","5":"94","6":"83","7":"2","8":"Q2'11","9":"0.16"},{"1":"2011","2":"3","3":"US","4":"Consumer","5":"124","6":"87","7":"3","8":"Q3'11","9":"0.39"},{"1":"2011","2":"4","3":"US","4":"Consumer","5":"152","6":"71","7":"4","8":"Q4'11","9":"0.65"},{"1":"2012","2":"1","3":"US","4":"Consumer","5":"69","6":"14","7":"5","8":"Q1'12","9":"0.36"},{"1":"2012","2":"2","3":"US","4":"Consumer","5":"100","6":"19","7":"6","8":"Q2'12","9":"1.17"},{"1":"2012","2":"3","3":"US","4":"Consumer","5":"111","6":"13","7":"7","8":"Q3'12","9":"0.98"},{"1":"2012","2":"4","3":"US","4":"Consumer","5":"171","6":"18","7":"8","8":"Q4'12","9":"1.38"},{"1":"2013","2":"1","3":"US","4":"Consumer","5":"75","6":"8","7":"9","8":"Q1'13","9":"0.39"},{"1":"2013","2":"2","3":"US","4":"Consumer","5":"129","6":"10","7":"10","8":"Q2'13","9":"1.59"},{"1":"2013","2":"3","3":"US","4":"Consumer","5":"147","6":"3","7":"11","8":"Q3'13","9":"1.12"},{"1":"2013","2":"4","3":"US","4":"Consumer","5":"176","6":"6","7":"12","8":"Q4'13","9":"1.16"},{"1":"2014","2":"1","3":"US","4":"Consumer","5":"105","6":"2","7":"13","8":"Q1'14","9":"0.59"},{"1":"2014","2":"2","3":"US","4":"Consumer","5":"147","6":"1","7":"14","8":"Q2'14","9":"1.39"},{"1":"2014","2":"3","3":"US","4":"Consumer","5":"182","6":"2","7":"15","8":"Q3'14","9":"1.22"},{"1":"2014","2":"4","3":"US","4":"Consumer","5":"226","6":"2","7":"16","8":"Q4'14","9":"1.23"},{"1":"2011","2":"1","3":"US","4":"Corporate","5":"29","6":"29","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"US","4":"Corporate","5":"55","6":"50","7":"2","8":"Q2'11","9":"0.17"},{"1":"2011","2":"3","3":"US","4":"Corporate","5":"64","6":"42","7":"3","8":"Q3'11","9":"0.40"},{"1":"2011","2":"4","3":"US","4":"Corporate","5":"103","6":"58","7":"4","8":"Q4'11","9":"0.70"},{"1":"2012","2":"1","3":"US","4":"Corporate","5":"50","6":"14","7":"5","8":"Q1'12","9":"0.35"},{"1":"2012","2":"2","3":"US","4":"Corporate","5":"49","6":"8","7":"6","8":"Q2'12","9":"0.82"},{"1":"2012","2":"3","3":"US","4":"Corporate","5":"75","6":"12","7":"7","8":"Q3'12","9":"1.29"},{"1":"2012","2":"4","3":"US","4":"Corporate","5":"81","6":"5","7":"8","8":"Q4'12","9":"1.01"},{"1":"2013","2":"1","3":"US","4":"Corporate","5":"57","6":"5","7":"9","8":"Q1'13","9":"0.64"},{"1":"2013","2":"2","3":"US","4":"Corporate","5":"65","6":"7","7":"10","8":"Q2'13","9":"1.02"},{"1":"2013","2":"3","3":"US","4":"Corporate","5":"95","6":"1","7":"11","8":"Q3'13","9":"1.45"},{"1":"2013","2":"4","3":"US","4":"Corporate","5":"109","6":"2","7":"12","8":"Q4'13","9":"1.13"},{"1":"2014","2":"1","3":"US","4":"Corporate","5":"63","6":"1","7":"13","8":"Q1'14","9":"0.57"},{"1":"2014","2":"2","3":"US","4":"Corporate","5":"86","6":"1","7":"14","8":"Q2'14","9":"1.35"},{"1":"2014","2":"3","3":"US","4":"Corporate","5":"101","6":"1","7":"15","8":"Q3'14","9":"1.16"},{"1":"2014","2":"4","3":"US","4":"Corporate","5":"134","6":"NA","7":"16","8":"Q4'14","9":"1.33"},{"1":"2011","2":"1","3":"US","4":"Home Office","5":"22","6":"22","7":"1","8":"Q1'11","9":"NA"},{"1":"2011","2":"2","3":"US","4":"Home Office","5":"31","6":"27","7":"2","8":"Q2'11","9":"0.18"},{"1":"2011","2":"3","3":"US","4":"Home Office","5":"40","6":"32","7":"3","8":"Q3'11","9":"0.26"},{"1":"2011","2":"4","3":"US","4":"Home Office","5":"50","6":"24","7":"4","8":"Q4'11","9":"0.65"},{"1":"2012","2":"1","3":"US","4":"Home Office","5":"16","6":"4","7":"5","8":"Q1'12","9":"0.24"},{"1":"2012","2":"2","3":"US","4":"Home Office","5":"43","6":"9","7":"6","8":"Q2'12","9":"2.13"},{"1":"2012","2":"3","3":"US","4":"Home Office","5":"47","6":"11","7":"7","8":"Q3'12","9":"0.84"},{"1":"2012","2":"4","3":"US","4":"Home Office","5":"58","6":"9","7":"8","8":"Q4'12","9":"1.04"},{"1":"2013","2":"1","3":"US","4":"Home Office","5":"28","6":"1","7":"9","8":"Q1'13","9":"0.47"},{"1":"2013","2":"2","3":"US","4":"Home Office","5":"45","6":"5","7":"10","8":"Q2'13","9":"1.43"},{"1":"2013","2":"3","3":"US","4":"Home Office","5":"58","6":"2","7":"11","8":"Q3'13","9":"1.24"},{"1":"2013","2":"4","3":"US","4":"Home Office","5":"59","6":"1","7":"12","8":"Q4'13","9":"1.00"},{"1":"2014","2":"1","3":"US","4":"Home Office","5":"44","6":"NA","7":"13","8":"Q1'14","9":"0.75"},{"1":"2014","2":"2","3":"US","4":"Home Office","5":"56","6":"NA","7":"14","8":"Q2'14","9":"1.27"},{"1":"2014","2":"3","3":"US","4":"Home Office","5":"63","6":"NA","7":"15","8":"Q3'14","9":"1.13"},{"1":"2014","2":"4","3":"US","4":"Home Office","5":"79","6":"1","7":"16","8":"Q4'14","9":"1.24"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="fu">ggplot</span>(customer_retention) <span class="sc">+</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">reorder</span>(qy, n),</span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a>      <span class="at">y =</span> ret_rate, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> segment</span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a>    ),</span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb49-11"><a href="#cb49-11" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fl">4.5</span>),</span>
<span id="cb49-12"><a href="#cb49-12" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb49-13"><a href="#cb49-13" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb49-15"><a href="#cb49-15" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fl">8.5</span>),</span>
<span id="cb49-16"><a href="#cb49-16" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb49-17"><a href="#cb49-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb49-19"><a href="#cb49-19" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fl">12.5</span>),</span>
<span id="cb49-20"><a href="#cb49-20" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb49-21"><a href="#cb49-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-22"><a href="#cb49-22" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb49-23"><a href="#cb49-23" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">label =</span> <span class="dv">2011</span>, <span class="at">x =</span> <span class="fl">2.5</span>, <span class="at">y =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-24"><a href="#cb49-24" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;lightgray&quot;</span></span>
<span id="cb49-25"><a href="#cb49-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-26"><a href="#cb49-26" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb49-27"><a href="#cb49-27" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">label =</span> <span class="dv">2012</span>, <span class="at">x =</span> <span class="fl">6.5</span>, <span class="at">y =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-28"><a href="#cb49-28" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;lightgray&quot;</span></span>
<span id="cb49-29"><a href="#cb49-29" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-30"><a href="#cb49-30" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb49-31"><a href="#cb49-31" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">label =</span> <span class="dv">2013</span>, <span class="at">x =</span> <span class="fl">10.5</span>, <span class="at">y =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-32"><a href="#cb49-32" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;lightgray&quot;</span></span>
<span id="cb49-33"><a href="#cb49-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-34"><a href="#cb49-34" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb49-35"><a href="#cb49-35" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">label =</span> <span class="dv">2014</span>, <span class="at">x =</span> <span class="fl">14.5</span>, <span class="at">y =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-36"><a href="#cb49-36" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;lightgray&quot;</span></span>
<span id="cb49-37"><a href="#cb49-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-38"><a href="#cb49-38" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb49-39"><a href="#cb49-39" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">rep</span>(</span>
<span id="cb49-40"><a href="#cb49-40" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb49-41"><a href="#cb49-41" tabindex="-1"></a>      <span class="dv">4</span></span>
<span id="cb49-42"><a href="#cb49-42" tabindex="-1"></a>    )</span>
<span id="cb49-43"><a href="#cb49-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-44"><a href="#cb49-44" tabindex="-1"></a>  <span class="fu">facet_grid</span>(market <span class="sc">~</span> segment) <span class="sc">+</span></span>
<span id="cb49-45"><a href="#cb49-45" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-46"><a href="#cb49-46" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-47"><a href="#cb49-47" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_blank</span>(), <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb49-48"><a href="#cb49-48" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-49"><a href="#cb49-49" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb49-50"><a href="#cb49-50" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Quarterly Customer Retention Rate&quot;</span>,</span>
<span id="cb49-51"><a href="#cb49-51" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Retention Rate&quot;</span></span>
<span id="cb49-52"><a href="#cb49-52" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-51-1.png" width="100%" /></p>
</div>
<div id="arppu-and-average-check-value" class="section level2">
<h2>ARPPU and Average check value</h2>
<div class="sourceCode" id="cb50"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a><span class="kw">SELECT</span> (date_trunc(<span class="st">&#39;month&#39;</span>, order_date)):<span class="ch">:date</span> <span class="kw">AS</span> last_month_day,</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>       <span class="fu">count</span>(<span class="kw">DISTINCT</span> customer_id):<span class="ch">:INT</span> <span class="kw">AS</span> uniq_customers,</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>       <span class="fu">count</span>(<span class="kw">DISTINCT</span> order_id):<span class="ch">:INT</span> <span class="kw">AS</span> count_orders,</span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales)<span class="op">/</span><span class="fu">count</span>(<span class="kw">DISTINCT</span> customer_id), <span class="dv">2</span>) <span class="kw">AS</span> arppu,</span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales)<span class="op">/</span><span class="fu">count</span>(<span class="kw">DISTINCT</span> order_id), <span class="dv">2</span>) <span class="kw">AS</span> avg_check</span>
<span id="cb50-7"><a href="#cb50-7" tabindex="-1"></a><span class="kw">FROM</span> analysis.all_global_orders <span class="co">-- from materialized view</span></span>
<span id="cb50-8"><a href="#cb50-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb50-9"><a href="#cb50-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>arppu_check</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["last_month_day"],"name":[1],"type":["date"],"align":["right"]},{"label":["uniq_customers"],"name":[2],"type":["int"],"align":["right"]},{"label":["count_orders"],"name":[3],"type":["int"],"align":["right"]},{"label":["arppu"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["avg_check"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011-01-01","2":"199","3":"216","4":"496.98","5":"457.86"},{"1":"2011-02-01","2":"168","3":"183","4":"542.57","5":"498.10"},{"1":"2011-03-01","2":"242","3":"277","4":"602.19","5":"526.10"},{"1":"2011-04-01","2":"241","3":"267","4":"485.13","5":"437.89"},{"1":"2011-05-01","2":"255","3":"295","4":"575.48","5":"497.45"},{"1":"2011-06-01","2":"374","3":"468","4":"575.42","5":"459.84"},{"1":"2011-07-01","2":"229","3":"250","4":"504.41","5":"462.04"},{"1":"2011-08-01","2":"363","3":"443","4":"571.85","5":"468.58"},{"1":"2011-09-01","2":"422","3":"527","4":"687.71","5":"550.69"},{"1":"2011-10-01","2":"335","3":"401","4":"594.24","5":"496.44"},{"1":"2011-11-01","2":"457","3":"563","4":"653.17","5":"530.19"},{"1":"2011-12-01","2":"464","3":"620","4":"719.67","5":"538.59"},{"1":"2012-01-01","2":"237","3":"260","4":"572.91","5":"522.23"},{"1":"2012-02-01","2":"213","3":"230","4":"471.88","5":"437.00"},{"1":"2012-03-01","2":"301","3":"337","4":"541.78","5":"483.91"},{"1":"2012-04-01","2":"273","3":"322","4":"589.94","5":"500.16"},{"1":"2012-05-01","2":"331","3":"413","4":"629.50","5":"504.52"},{"1":"2012-06-01","2":"461","3":"571","4":"555.70","5":"448.64"},{"1":"2012-07-01","2":"271","3":"324","4":"535.93","5":"448.26"},{"1":"2012-08-01","2":"430","3":"522","4":"704.98","5":"580.73"},{"1":"2012-09-01","2":"507","3":"641","4":"570.79","5":"451.47"},{"1":"2012-10-01","2":"394","3":"499","4":"641.98","5":"506.89"},{"1":"2012-11-01","2":"541","3":"716","4":"597.99","5":"451.83"},{"1":"2012-12-01","2":"476","3":"628","4":"710.62","5":"538.63"},{"1":"2013-01-01","2":"297","3":"345","4":"670.66","5":"577.35"},{"1":"2013-02-01","2":"266","3":"306","4":"628.72","5":"546.54"},{"1":"2013-03-01","2":"341","3":"411","4":"582.39","5":"483.20"},{"1":"2013-04-01","2":"336","3":"394","4":"529.23","5":"451.32"},{"1":"2013-05-01","2":"405","3":"522","4":"643.21","5":"499.04"},{"1":"2013-06-01","2":"550","3":"724","4":"720.95","5":"547.68"},{"1":"2013-07-01","2":"365","3":"447","4":"629.94","5":"514.38"},{"1":"2013-08-01","2":"534","3":"692","4":"611.40","5":"471.80"},{"1":"2013-09-01","2":"594","3":"836","4":"634.04","5":"450.50"},{"1":"2013-10-01","2":"433","3":"580","4":"677.61","5":"505.87"},{"1":"2013-11-01","2":"580","3":"789","4":"644.81","5":"474.00"},{"1":"2013-12-01","2":"587","3":"825","4":"690.72","5":"491.46"},{"1":"2014-01-01","2":"379","3":"450","4":"636.59","5":"536.15"},{"1":"2014-02-01","2":"338","3":"385","4":"546.86","5":"480.10"},{"1":"2014-03-01","2":"429","3":"530","4":"613.29","5":"496.42"},{"1":"2014-04-01","2":"417","3":"523","4":"582.19","5":"464.19"},{"1":"2014-05-01","2":"507","3":"667","4":"568.84","5":"432.39"},{"1":"2014-06-01","2":"656","3":"899","4":"612.52","5":"446.96"},{"1":"2014-07-01","2":"421","3":"540","4":"614.50","5":"479.08"},{"1":"2014-08-01","2":"608","3":"843","4":"751.02","5":"541.66"},{"1":"2014-09-01","2":"697","3":"1017","4":"690.33","5":"473.11"},{"1":"2014-10-01","2":"572","3":"810","4":"739.10","5":"521.93"},{"1":"2014-11-01","2":"711","3":"1077","4":"780.98","5":"515.58"},{"1":"2014-12-01","2":"726","3":"1093","4":"693.04","5":"460.33"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="fu">ggplot</span>(arppu_check) <span class="sc">+</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> arppu, <span class="at">fill =</span> <span class="st">&quot;ARPPU&quot;</span>),</span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span></span>
<span id="cb52-5"><a href="#cb52-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb52-7"><a href="#cb52-7" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb52-8"><a href="#cb52-8" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> avg_check, <span class="at">color =</span> <span class="st">&quot;Avg. check&quot;</span></span>
<span id="cb52-9"><a href="#cb52-9" tabindex="-1"></a>    ),</span>
<span id="cb52-10"><a href="#cb52-10" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb52-11"><a href="#cb52-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb52-13"><a href="#cb52-13" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb52-14"><a href="#cb52-14" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> avg_check, <span class="at">color =</span> <span class="st">&quot;Avg. check&quot;</span></span>
<span id="cb52-15"><a href="#cb52-15" tabindex="-1"></a>    ),</span>
<span id="cb52-16"><a href="#cb52-16" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb52-17"><a href="#cb52-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-18"><a href="#cb52-18" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb52-19"><a href="#cb52-19" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> avg_check),</span>
<span id="cb52-20"><a href="#cb52-20" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb52-21"><a href="#cb52-21" tabindex="-1"></a>    <span class="at">se =</span> <span class="cn">FALSE</span></span>
<span id="cb52-22"><a href="#cb52-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-23"><a href="#cb52-23" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb52-24"><a href="#cb52-24" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> arppu),</span>
<span id="cb52-25"><a href="#cb52-25" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb52-26"><a href="#cb52-26" tabindex="-1"></a>    <span class="at">se =</span> <span class="cn">FALSE</span></span>
<span id="cb52-27"><a href="#cb52-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-28"><a href="#cb52-28" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-29"><a href="#cb52-29" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Average revenue per paying user (ARPPU) and average check value</span><span class="sc">\n</span><span class="st">from 2011 to 2014&quot;</span>,</span>
<span id="cb52-30"><a href="#cb52-30" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;ARPPU &amp; Avg.check value, $&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb52-31"><a href="#cb52-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-32"><a href="#cb52-32" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="at">ARPPU =</span> <span class="st">&quot;#003f5c&quot;</span>)) <span class="sc">+</span></span>
<span id="cb52-33"><a href="#cb52-33" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Avg. check</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#ffa600&quot;</span>)) <span class="sc">+</span></span>
<span id="cb52-34"><a href="#cb52-34" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-54-1.png" width="100%" /></p>
</div>
<div id="average-basket-value-and-size" class="section level2">
<h2>Average Basket Value and size</h2>
<div class="sourceCode" id="cb53"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="co">-- avg basket value and size</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="kw">WITH</span> order_cost <span class="kw">AS</span> (</span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a>    <span class="kw">SELECT</span> market,</span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a>       (date_trunc(<span class="st">&#39;month&#39;</span>, order_date)):<span class="ch">:date</span> <span class="kw">AS</span> last_month_day,</span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a>       order_id,</span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales), <span class="dv">2</span>) <span class="kw">as</span> sales,</span>
<span id="cb53-9"><a href="#cb53-9" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(quantity), <span class="dv">2</span>) <span class="kw">as</span> quantity</span>
<span id="cb53-10"><a href="#cb53-10" tabindex="-1"></a>    <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb53-11"><a href="#cb53-11" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span></span>
<span id="cb53-12"><a href="#cb53-12" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span></span>
<span id="cb53-13"><a href="#cb53-13" tabindex="-1"></a>    )</span>
<span id="cb53-14"><a href="#cb53-14" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb53-17"><a href="#cb53-17" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">min</span>(basket_value) <span class="kw">over</span> (<span class="kw">partition</span> <span class="kw">by</span> market) <span class="op">/</span> <span class="fu">max</span>(basket_size) <span class="kw">over</span> (<span class="kw">partition</span> <span class="kw">by</span> market), <span class="dv">2</span>) <span class="kw">AS</span> scale</span>
<span id="cb53-18"><a href="#cb53-18" tabindex="-1"></a>       <span class="kw">from</span></span>
<span id="cb53-19"><a href="#cb53-19" tabindex="-1"></a>(<span class="kw">SELECT</span></span>
<span id="cb53-20"><a href="#cb53-20" tabindex="-1"></a>    market,</span>
<span id="cb53-21"><a href="#cb53-21" tabindex="-1"></a>    last_month_day,</span>
<span id="cb53-22"><a href="#cb53-22" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">avg</span>(sales), <span class="dv">2</span>) <span class="kw">AS</span> basket_value,</span>
<span id="cb53-23"><a href="#cb53-23" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">avg</span>(quantity), <span class="dv">0</span>) <span class="kw">AS</span> basket_size</span>
<span id="cb53-24"><a href="#cb53-24" tabindex="-1"></a>    <span class="kw">FROM</span> order_cost</span>
<span id="cb53-25"><a href="#cb53-25" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>) a;</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>basket_value</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["last_month_day"],"name":[2],"type":["date"],"align":["right"]},{"label":["basket_value"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["basket_size"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["scale"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"Africa","2":"2014-07-01","3":"276.35","4":"4","5":"18.79"},{"1":"Africa","2":"2014-08-01","3":"336.69","4":"3","5":"18.79"},{"1":"Africa","2":"2011-02-01","3":"424.60","4":"7","5":"18.79"},{"1":"Africa","2":"2014-02-01","3":"264.10","4":"4","5":"18.79"},{"1":"Africa","2":"2013-06-01","3":"245.03","4":"4","5":"18.79"},{"1":"Africa","2":"2011-08-01","3":"359.19","4":"5","5":"18.79"},{"1":"Africa","2":"2012-08-01","3":"337.06","4":"5","5":"18.79"},{"1":"Africa","2":"2014-12-01","3":"310.12","4":"5","5":"18.79"},{"1":"Africa","2":"2011-07-01","3":"450.85","4":"5","5":"18.79"},{"1":"Africa","2":"2011-05-01","3":"279.56","4":"4","5":"18.79"},{"1":"Africa","2":"2012-04-01","3":"475.67","4":"4","5":"18.79"},{"1":"Africa","2":"2014-11-01","3":"357.20","4":"5","5":"18.79"},{"1":"Africa","2":"2014-01-01","3":"283.98","4":"4","5":"18.79"},{"1":"Africa","2":"2012-09-01","3":"305.84","4":"4","5":"18.79"},{"1":"Africa","2":"2013-04-01","3":"269.15","4":"4","5":"18.79"},{"1":"Africa","2":"2011-03-01","3":"185.45","4":"3","5":"18.79"},{"1":"Africa","2":"2013-10-01","3":"422.88","4":"5","5":"18.79"},{"1":"Africa","2":"2013-07-01","3":"428.68","4":"5","5":"18.79"},{"1":"Africa","2":"2014-06-01","3":"299.62","4":"5","5":"18.79"},{"1":"Africa","2":"2014-03-01","3":"337.46","4":"5","5":"18.79"},{"1":"Africa","2":"2013-03-01","3":"348.62","4":"5","5":"18.79"},{"1":"Africa","2":"2013-11-01","3":"339.33","4":"4","5":"18.79"},{"1":"Africa","2":"2013-08-01","3":"385.25","4":"5","5":"18.79"},{"1":"Africa","2":"2011-11-01","3":"250.67","4":"5","5":"18.79"},{"1":"Africa","2":"2011-12-01","3":"331.90","4":"4","5":"18.79"},{"1":"Africa","2":"2012-06-01","3":"361.95","4":"5","5":"18.79"},{"1":"Africa","2":"2013-09-01","3":"350.42","4":"4","5":"18.79"},{"1":"Africa","2":"2014-04-01","3":"369.46","4":"5","5":"18.79"},{"1":"Africa","2":"2012-03-01","3":"355.24","4":"4","5":"18.79"},{"1":"Africa","2":"2011-10-01","3":"363.94","4":"6","5":"18.79"},{"1":"Africa","2":"2012-01-01","3":"190.47","4":"4","5":"18.79"},{"1":"Africa","2":"2013-05-01","3":"376.89","4":"4","5":"18.79"},{"1":"Africa","2":"2012-12-01","3":"452.48","4":"5","5":"18.79"},{"1":"Africa","2":"2014-09-01","3":"392.96","4":"4","5":"18.79"},{"1":"Africa","2":"2011-09-01","3":"448.00","4":"5","5":"18.79"},{"1":"Africa","2":"2012-02-01","3":"131.50","4":"3","5":"18.79"},{"1":"Africa","2":"2012-05-01","3":"324.92","4":"6","5":"18.79"},{"1":"Africa","2":"2012-11-01","3":"290.27","4":"5","5":"18.79"},{"1":"Africa","2":"2011-04-01","3":"361.46","4":"6","5":"18.79"},{"1":"Africa","2":"2013-01-01","3":"314.07","4":"5","5":"18.79"},{"1":"Africa","2":"2013-12-01","3":"348.11","4":"5","5":"18.79"},{"1":"Africa","2":"2012-07-01","3":"273.33","4":"4","5":"18.79"},{"1":"Africa","2":"2012-10-01","3":"550.80","4":"3","5":"18.79"},{"1":"Africa","2":"2011-06-01","3":"189.28","4":"5","5":"18.79"},{"1":"Africa","2":"2014-05-01","3":"376.54","4":"4","5":"18.79"},{"1":"Africa","2":"2011-01-01","3":"378.74","4":"5","5":"18.79"},{"1":"Africa","2":"2014-10-01","3":"435.81","4":"6","5":"18.79"},{"1":"Africa","2":"2013-02-01","3":"680.53","4":"5","5":"18.79"},{"1":"APAC","2":"2011-11-01","3":"780.72","4":"8","5":"41.36"},{"1":"APAC","2":"2013-12-01","3":"643.70","4":"7","5":"41.36"},{"1":"APAC","2":"2014-11-01","3":"741.90","4":"8","5":"41.36"},{"1":"APAC","2":"2013-08-01","3":"728.84","4":"8","5":"41.36"},{"1":"APAC","2":"2012-06-01","3":"534.54","4":"7","5":"41.36"},{"1":"APAC","2":"2014-04-01","3":"689.93","4":"8","5":"41.36"},{"1":"APAC","2":"2013-04-01","3":"589.65","4":"7","5":"41.36"},{"1":"APAC","2":"2012-10-01","3":"747.41","4":"8","5":"41.36"},{"1":"APAC","2":"2013-11-01","3":"657.68","4":"8","5":"41.36"},{"1":"APAC","2":"2013-05-01","3":"583.09","4":"8","5":"41.36"},{"1":"APAC","2":"2013-01-01","3":"892.37","4":"9","5":"41.36"},{"1":"APAC","2":"2011-12-01","3":"674.43","4":"8","5":"41.36"},{"1":"APAC","2":"2011-07-01","3":"588.81","4":"7","5":"41.36"},{"1":"APAC","2":"2011-06-01","3":"740.30","4":"7","5":"41.36"},{"1":"APAC","2":"2011-10-01","3":"716.79","4":"8","5":"41.36"},{"1":"APAC","2":"2012-08-01","3":"750.42","4":"8","5":"41.36"},{"1":"APAC","2":"2014-06-01","3":"565.79","4":"7","5":"41.36"},{"1":"APAC","2":"2013-10-01","3":"666.00","4":"7","5":"41.36"},{"1":"APAC","2":"2014-05-01","3":"515.81","4":"7","5":"41.36"},{"1":"APAC","2":"2014-02-01","3":"577.19","4":"8","5":"41.36"},{"1":"APAC","2":"2012-07-01","3":"372.21","4":"7","5":"41.36"},{"1":"APAC","2":"2014-09-01","3":"643.34","4":"7","5":"41.36"},{"1":"APAC","2":"2011-08-01","3":"603.39","4":"7","5":"41.36"},{"1":"APAC","2":"2013-03-01","3":"702.83","4":"7","5":"41.36"},{"1":"APAC","2":"2012-11-01","3":"679.97","4":"8","5":"41.36"},{"1":"APAC","2":"2014-12-01","3":"581.74","4":"7","5":"41.36"},{"1":"APAC","2":"2012-04-01","3":"660.65","4":"7","5":"41.36"},{"1":"APAC","2":"2014-08-01","3":"636.19","4":"8","5":"41.36"},{"1":"APAC","2":"2011-09-01","3":"616.82","4":"8","5":"41.36"},{"1":"APAC","2":"2013-02-01","3":"673.76","4":"8","5":"41.36"},{"1":"APAC","2":"2011-01-01","3":"443.45","4":"6","5":"41.36"},{"1":"APAC","2":"2012-12-01","3":"694.07","4":"7","5":"41.36"},{"1":"APAC","2":"2012-09-01","3":"470.71","4":"6","5":"41.36"},{"1":"APAC","2":"2012-05-01","3":"581.06","4":"7","5":"41.36"},{"1":"APAC","2":"2014-10-01","3":"646.43","4":"7","5":"41.36"},{"1":"APAC","2":"2013-07-01","3":"768.97","4":"9","5":"41.36"},{"1":"APAC","2":"2011-03-01","3":"541.96","4":"7","5":"41.36"},{"1":"APAC","2":"2014-07-01","3":"705.22","4":"8","5":"41.36"},{"1":"APAC","2":"2014-03-01","3":"772.77","4":"8","5":"41.36"},{"1":"APAC","2":"2012-01-01","3":"836.22","4":"9","5":"41.36"},{"1":"APAC","2":"2014-01-01","3":"747.00","4":"9","5":"41.36"},{"1":"APAC","2":"2013-09-01","3":"664.17","4":"8","5":"41.36"},{"1":"APAC","2":"2012-02-01","3":"810.06","4":"8","5":"41.36"},{"1":"APAC","2":"2013-06-01","3":"801.91","4":"8","5":"41.36"},{"1":"APAC","2":"2012-03-01","3":"633.10","4":"7","5":"41.36"},{"1":"APAC","2":"2011-05-01","3":"682.61","4":"7","5":"41.36"},{"1":"APAC","2":"2011-02-01","3":"724.26","4":"7","5":"41.36"},{"1":"APAC","2":"2011-04-01","3":"685.57","4":"9","5":"41.36"},{"1":"Canada","2":"2014-04-01","3":"142.91","4":"2","5":"1.11"},{"1":"Canada","2":"2011-09-01","3":"113.32","4":"2","5":"1.11"},{"1":"Canada","2":"2014-06-01","3":"161.05","4":"4","5":"1.11"},{"1":"Canada","2":"2012-07-01","3":"695.03","4":"5","5":"1.11"},{"1":"Canada","2":"2014-12-01","3":"723.02","4":"5","5":"1.11"},{"1":"Canada","2":"2013-05-01","3":"136.74","4":"3","5":"1.11"},{"1":"Canada","2":"2012-04-01","3":"319.04","4":"3","5":"1.11"},{"1":"Canada","2":"2012-02-01","3":"263.34","4":"6","5":"1.11"},{"1":"Canada","2":"2013-07-01","3":"307.16","4":"14","5":"1.11"},{"1":"Canada","2":"2014-01-01","3":"462.49","4":"4","5":"1.11"},{"1":"Canada","2":"2011-11-01","3":"363.78","4":"3","5":"1.11"},{"1":"Canada","2":"2014-10-01","3":"696.62","4":"7","5":"1.11"},{"1":"Canada","2":"2013-04-01","3":"15.48","4":"1","5":"1.11"},{"1":"Canada","2":"2013-10-01","3":"594.20","4":"5","5":"1.11"},{"1":"Canada","2":"2011-06-01","3":"46.95","4":"2","5":"1.11"},{"1":"Canada","2":"2014-09-01","3":"205.35","4":"4","5":"1.11"},{"1":"Canada","2":"2012-11-01","3":"326.82","4":"4","5":"1.11"},{"1":"Canada","2":"2014-03-01","3":"151.15","4":"3","5":"1.11"},{"1":"Canada","2":"2012-08-01","3":"268.37","4":"5","5":"1.11"},{"1":"Canada","2":"2013-06-01","3":"245.95","4":"6","5":"1.11"},{"1":"Canada","2":"2014-02-01","3":"605.15","4":"8","5":"1.11"},{"1":"Canada","2":"2012-09-01","3":"71.98","4":"3","5":"1.11"},{"1":"Canada","2":"2013-08-01","3":"565.87","4":"4","5":"1.11"},{"1":"Canada","2":"2013-09-01","3":"217.55","4":"1","5":"1.11"},{"1":"Canada","2":"2011-08-01","3":"113.22","4":"6","5":"1.11"},{"1":"Canada","2":"2012-05-01","3":"270.20","4":"4","5":"1.11"},{"1":"Canada","2":"2013-01-01","3":"317.68","4":"5","5":"1.11"},{"1":"Canada","2":"2011-02-01","3":"248.72","4":"3","5":"1.11"},{"1":"Canada","2":"2013-11-01","3":"360.72","4":"5","5":"1.11"},{"1":"Canada","2":"2013-12-01","3":"428.28","4":"5","5":"1.11"},{"1":"Canada","2":"2011-03-01","3":"526.74","4":"6","5":"1.11"},{"1":"Canada","2":"2011-01-01","3":"165.26","4":"1","5":"1.11"},{"1":"Canada","2":"2014-05-01","3":"38.71","4":"2","5":"1.11"},{"1":"Canada","2":"2012-10-01","3":"386.25","4":"4","5":"1.11"},{"1":"Canada","2":"2013-02-01","3":"115.71","4":"2","5":"1.11"},{"1":"Canada","2":"2011-12-01","3":"326.67","4":"8","5":"1.11"},{"1":"Canada","2":"2011-05-01","3":"250.67","4":"2","5":"1.11"},{"1":"Canada","2":"2012-03-01","3":"25.23","4":"1","5":"1.11"},{"1":"Canada","2":"2011-04-01","3":"143.04","4":"5","5":"1.11"},{"1":"Canada","2":"2014-11-01","3":"415.87","4":"4","5":"1.11"},{"1":"Canada","2":"2011-07-01","3":"419.75","4":"4","5":"1.11"},{"1":"Canada","2":"2012-12-01","3":"114.61","4":"3","5":"1.11"},{"1":"Canada","2":"2011-10-01","3":"72.06","4":"2","5":"1.11"},{"1":"Canada","2":"2014-08-01","3":"448.89","4":"6","5":"1.11"},{"1":"Canada","2":"2013-03-01","3":"67.65","4":"2","5":"1.11"},{"1":"Canada","2":"2012-06-01","3":"496.22","4":"4","5":"1.11"},{"1":"Canada","2":"2014-07-01","3":"25.01","4":"3","5":"1.11"},{"1":"EMEA","2":"2013-05-01","3":"159.04","4":"3","5":"15.51"},{"1":"EMEA","2":"2013-03-01","3":"271.90","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-09-01","3":"245.91","4":"4","5":"15.51"},{"1":"EMEA","2":"2014-04-01","3":"242.63","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-07-01","3":"200.55","4":"3","5":"15.51"},{"1":"EMEA","2":"2013-02-01","3":"108.54","4":"3","5":"15.51"},{"1":"EMEA","2":"2011-08-01","3":"319.18","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-01-01","3":"356.44","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-10-01","3":"282.19","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-10-01","3":"359.31","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-08-01","3":"405.01","4":"5","5":"15.51"},{"1":"EMEA","2":"2011-06-01","3":"298.04","4":"4","5":"15.51"},{"1":"EMEA","2":"2011-11-01","3":"387.31","4":"6","5":"15.51"},{"1":"EMEA","2":"2014-07-01","3":"275.57","4":"4","5":"15.51"},{"1":"EMEA","2":"2011-04-01","3":"148.21","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-11-01","3":"350.84","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-02-01","3":"523.99","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-06-01","3":"316.36","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-06-01","3":"408.69","4":"5","5":"15.51"},{"1":"EMEA","2":"2013-12-01","3":"271.07","4":"4","5":"15.51"},{"1":"EMEA","2":"2011-05-01","3":"358.88","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-01-01","3":"310.49","4":"4","5":"15.51"},{"1":"EMEA","2":"2011-03-01","3":"530.04","4":"6","5":"15.51"},{"1":"EMEA","2":"2013-04-01","3":"333.91","4":"4","5":"15.51"},{"1":"EMEA","2":"2012-09-01","3":"312.33","4":"4","5":"15.51"},{"1":"EMEA","2":"2014-11-01","3":"228.77","4":"4","5":"15.51"},{"1":"EMEA","2":"2014-09-01","3":"292.53","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-08-01","3":"318.03","4":"5","5":"15.51"},{"1":"EMEA","2":"2013-07-01","3":"311.14","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-12-01","3":"221.06","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-03-01","3":"341.57","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-05-01","3":"381.40","4":"5","5":"15.51"},{"1":"EMEA","2":"2011-02-01","3":"445.08","4":"6","5":"15.51"},{"1":"EMEA","2":"2012-03-01","3":"301.50","4":"4","5":"15.51"},{"1":"EMEA","2":"2012-02-01","3":"285.58","4":"5","5":"15.51"},{"1":"EMEA","2":"2011-09-01","3":"261.17","4":"4","5":"15.51"},{"1":"EMEA","2":"2011-10-01","3":"311.51","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-04-01","3":"268.86","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-01-01","3":"340.65","4":"4","5":"15.51"},{"1":"EMEA","2":"2012-11-01","3":"287.02","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-08-01","3":"390.04","4":"5","5":"15.51"},{"1":"EMEA","2":"2014-12-01","3":"354.07","4":"4","5":"15.51"},{"1":"EMEA","2":"2013-06-01","3":"388.57","4":"5","5":"15.51"},{"1":"EMEA","2":"2011-07-01","3":"170.85","4":"2","5":"15.51"},{"1":"EMEA","2":"2011-12-01","3":"349.14","4":"5","5":"15.51"},{"1":"EMEA","2":"2012-10-01","3":"231.82","4":"3","5":"15.51"},{"1":"EMEA","2":"2012-05-01","3":"416.90","4":"7","5":"15.51"},{"1":"EMEA","2":"2011-01-01","3":"469.23","4":"5","5":"15.51"},{"1":"EU","2":"2013-05-01","3":"600.87","4":"7","5":"45.25"},{"1":"EU","2":"2013-02-01","3":"624.65","4":"8","5":"45.25"},{"1":"EU","2":"2014-10-01","3":"633.74","4":"8","5":"45.25"},{"1":"EU","2":"2012-07-01","3":"690.37","4":"8","5":"45.25"},{"1":"EU","2":"2012-05-01","3":"645.36","4":"7","5":"45.25"},{"1":"EU","2":"2014-05-01","3":"522.30","4":"7","5":"45.25"},{"1":"EU","2":"2012-12-01","3":"632.50","4":"8","5":"45.25"},{"1":"EU","2":"2013-04-01","3":"525.76","4":"6","5":"45.25"},{"1":"EU","2":"2011-10-01","3":"432.67","4":"7","5":"45.25"},{"1":"EU","2":"2011-09-01","3":"669.45","4":"7","5":"45.25"},{"1":"EU","2":"2011-08-01","3":"537.94","4":"7","5":"45.25"},{"1":"EU","2":"2014-12-01","3":"546.21","4":"8","5":"45.25"},{"1":"EU","2":"2013-09-01","3":"531.44","4":"8","5":"45.25"},{"1":"EU","2":"2014-01-01","3":"550.60","4":"7","5":"45.25"},{"1":"EU","2":"2012-11-01","3":"449.39","4":"7","5":"45.25"},{"1":"EU","2":"2014-09-01","3":"627.08","4":"7","5":"45.25"},{"1":"EU","2":"2014-11-01","3":"643.34","4":"9","5":"45.25"},{"1":"EU","2":"2014-03-01","3":"533.21","4":"7","5":"45.25"},{"1":"EU","2":"2011-01-01","3":"413.42","4":"7","5":"45.25"},{"1":"EU","2":"2011-07-01","3":"423.63","4":"6","5":"45.25"},{"1":"EU","2":"2011-04-01","3":"516.94","4":"8","5":"45.25"},{"1":"EU","2":"2012-04-01","3":"511.02","4":"7","5":"45.25"},{"1":"EU","2":"2013-08-01","3":"441.71","4":"7","5":"45.25"},{"1":"EU","2":"2012-08-01","3":"642.47","4":"8","5":"45.25"},{"1":"EU","2":"2012-01-01","3":"521.77","4":"7","5":"45.25"},{"1":"EU","2":"2012-06-01","3":"553.82","4":"7","5":"45.25"},{"1":"EU","2":"2014-08-01","3":"599.18","4":"8","5":"45.25"},{"1":"EU","2":"2013-03-01","3":"478.44","4":"7","5":"45.25"},{"1":"EU","2":"2013-07-01","3":"753.40","4":"8","5":"45.25"},{"1":"EU","2":"2012-02-01","3":"488.13","4":"7","5":"45.25"},{"1":"EU","2":"2013-10-01","3":"486.67","4":"6","5":"45.25"},{"1":"EU","2":"2013-12-01","3":"535.64","4":"7","5":"45.25"},{"1":"EU","2":"2014-04-01","3":"622.70","4":"8","5":"45.25"},{"1":"EU","2":"2013-01-01","3":"634.89","4":"7","5":"45.25"},{"1":"EU","2":"2012-10-01","3":"571.89","4":"8","5":"45.25"},{"1":"EU","2":"2011-02-01","3":"526.42","4":"7","5":"45.25"},{"1":"EU","2":"2012-09-01","3":"582.24","4":"8","5":"45.25"},{"1":"EU","2":"2011-05-01","3":"610.35","4":"8","5":"45.25"},{"1":"EU","2":"2011-11-01","3":"635.66","4":"8","5":"45.25"},{"1":"EU","2":"2013-11-01","3":"623.16","4":"7","5":"45.25"},{"1":"EU","2":"2014-02-01","3":"546.07","4":"7","5":"45.25"},{"1":"EU","2":"2012-03-01","3":"587.75","4":"8","5":"45.25"},{"1":"EU","2":"2014-06-01","3":"599.83","4":"7","5":"45.25"},{"1":"EU","2":"2011-12-01","3":"685.91","4":"8","5":"45.25"},{"1":"EU","2":"2011-06-01","3":"511.72","4":"7","5":"45.25"},{"1":"EU","2":"2011-03-01","3":"407.28","4":"6","5":"45.25"},{"1":"EU","2":"2013-06-01","3":"719.36","4":"8","5":"45.25"},{"1":"EU","2":"2014-07-01","3":"602.04","4":"8","5":"45.25"},{"1":"LATAM","2":"2011-09-01","3":"469.38","4":"8","5":"31.92"},{"1":"LATAM","2":"2012-04-01","3":"473.12","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-06-01","3":"345.82","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-07-01","3":"432.69","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-10-01","3":"407.72","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-06-01","3":"379.44","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-12-01","3":"441.91","4":"7","5":"31.92"},{"1":"LATAM","2":"2011-03-01","3":"384.76","4":"6","5":"31.92"},{"1":"LATAM","2":"2014-09-01","3":"406.24","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-09-01","3":"411.67","4":"8","5":"31.92"},{"1":"LATAM","2":"2012-10-01","3":"392.37","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-05-01","3":"517.07","4":"7","5":"31.92"},{"1":"LATAM","2":"2011-01-01","3":"623.80","4":"7","5":"31.92"},{"1":"LATAM","2":"2011-11-01","3":"400.75","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-06-01","3":"331.79","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-01-01","3":"448.03","4":"7","5":"31.92"},{"1":"LATAM","2":"2013-11-01","3":"350.29","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-03-01","3":"331.34","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-12-01","3":"524.22","4":"9","5":"31.92"},{"1":"LATAM","2":"2012-11-01","3":"376.13","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-07-01","3":"396.66","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-06-01","3":"443.57","4":"9","5":"31.92"},{"1":"LATAM","2":"2012-09-01","3":"438.60","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-02-01","3":"374.00","4":"5","5":"31.92"},{"1":"LATAM","2":"2014-11-01","3":"463.05","4":"8","5":"31.92"},{"1":"LATAM","2":"2014-07-01","3":"450.71","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-05-01","3":"485.41","4":"7","5":"31.92"},{"1":"LATAM","2":"2013-03-01","3":"375.31","4":"7","5":"31.92"},{"1":"LATAM","2":"2011-08-01","3":"453.44","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-02-01","3":"485.38","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-05-01","3":"438.69","4":"8","5":"31.92"},{"1":"LATAM","2":"2014-08-01","3":"514.49","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-04-01","3":"344.97","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-10-01","3":"429.12","4":"8","5":"31.92"},{"1":"LATAM","2":"2011-10-01","3":"457.10","4":"6","5":"31.92"},{"1":"LATAM","2":"2013-12-01","3":"420.40","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-02-01","3":"462.55","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-02-01","3":"287.27","4":"7","5":"31.92"},{"1":"LATAM","2":"2013-01-01","3":"614.93","4":"9","5":"31.92"},{"1":"LATAM","2":"2014-04-01","3":"376.30","4":"7","5":"31.92"},{"1":"LATAM","2":"2013-07-01","3":"359.30","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-01-01","3":"363.04","4":"8","5":"31.92"},{"1":"LATAM","2":"2014-03-01","3":"366.11","4":"7","5":"31.92"},{"1":"LATAM","2":"2014-05-01","3":"370.95","4":"7","5":"31.92"},{"1":"LATAM","2":"2012-08-01","3":"526.22","4":"8","5":"31.92"},{"1":"LATAM","2":"2013-04-01","3":"436.51","4":"9","5":"31.92"},{"1":"LATAM","2":"2013-08-01","3":"389.05","4":"7","5":"31.92"},{"1":"LATAM","2":"2011-12-01","3":"472.86","4":"8","5":"31.92"},{"1":"US","2":"2012-06-01","3":"364.67","4":"7","5":"18.43"},{"1":"US","2":"2013-09-01","3":"381.72","4":"7","5":"18.43"},{"1":"US","2":"2014-02-01","3":"390.07","4":"7","5":"18.43"},{"1":"US","2":"2012-05-01","3":"407.19","4":"8","5":"18.43"},{"1":"US","2":"2012-10-01","3":"360.98","4":"7","5":"18.43"},{"1":"US","2":"2011-10-01","3":"403.25","4":"7","5":"18.43"},{"1":"US","2":"2014-12-01","3":"385.00","4":"8","5":"18.43"},{"1":"US","2":"2013-01-01","3":"386.30","4":"7","5":"18.43"},{"1":"US","2":"2013-05-01","3":"520.10","4":"8","5":"18.43"},{"1":"US","2":"2011-11-01","3":"520.72","4":"8","5":"18.43"},{"1":"US","2":"2011-02-01","3":"165.88","4":"6","5":"18.43"},{"1":"US","2":"2012-04-01","3":"474.93","4":"8","5":"18.43"},{"1":"US","2":"2014-07-01","3":"432.40","4":"8","5":"18.43"},{"1":"US","2":"2013-10-01","3":"553.56","4":"7","5":"18.43"},{"1":"US","2":"2011-08-01","3":"387.63","4":"8","5":"18.43"},{"1":"US","2":"2012-08-01","3":"542.62","4":"9","5":"18.43"},{"1":"US","2":"2011-07-01","3":"522.25","4":"8","5":"18.43"},{"1":"US","2":"2014-09-01","3":"395.15","4":"7","5":"18.43"},{"1":"US","2":"2012-01-01","3":"626.69","4":"8","5":"18.43"},{"1":"US","2":"2011-03-01","3":"784.38","4":"8","5":"18.43"},{"1":"US","2":"2013-04-01","3":"446.01","4":"7","5":"18.43"},{"1":"US","2":"2014-05-01","3":"351.16","4":"7","5":"18.43"},{"1":"US","2":"2013-08-01","3":"365.56","4":"8","5":"18.43"},{"1":"US","2":"2011-06-01","3":"524.17","4":"8","5":"18.43"},{"1":"US","2":"2011-09-01","3":"629.06","4":"8","5":"18.43"},{"1":"US","2":"2013-02-01","3":"519.72","4":"7","5":"18.43"},{"1":"US","2":"2012-12-01","3":"465.34","4":"7","5":"18.43"},{"1":"US","2":"2014-04-01","3":"358.15","4":"7","5":"18.43"},{"1":"US","2":"2012-03-01","3":"499.57","4":"7","5":"18.43"},{"1":"US","2":"2012-07-01","3":"435.84","4":"8","5":"18.43"},{"1":"US","2":"2011-05-01","3":"342.73","4":"7","5":"18.43"},{"1":"US","2":"2013-07-01","3":"400.42","4":"8","5":"18.43"},{"1":"US","2":"2013-12-01","3":"562.07","4":"8","5":"18.43"},{"1":"US","2":"2012-09-01","3":"461.40","4":"8","5":"18.43"},{"1":"US","2":"2014-06-01","3":"386.08","4":"7","5":"18.43"},{"1":"US","2":"2012-02-01","3":"321.34","4":"7","5":"18.43"},{"1":"US","2":"2011-04-01","3":"428.72","4":"8","5":"18.43"},{"1":"US","2":"2011-12-01","3":"493.23","4":"8","5":"18.43"},{"1":"US","2":"2013-06-01","3":"406.50","4":"8","5":"18.43"},{"1":"US","2":"2013-03-01","3":"602.19","4":"7","5":"18.43"},{"1":"US","2":"2014-11-01","3":"445.74","4":"7","5":"18.43"},{"1":"US","2":"2013-11-01","3":"441.89","4":"8","5":"18.43"},{"1":"US","2":"2014-10-01","3":"518.63","4":"8","5":"18.43"},{"1":"US","2":"2014-03-01","3":"485.67","4":"7","5":"18.43"},{"1":"US","2":"2014-08-01","3":"559.24","4":"8","5":"18.43"},{"1":"US","2":"2014-01-01","3":"604.10","4":"8","5":"18.43"},{"1":"US","2":"2012-11-01","3":"480.84","4":"8","5":"18.43"},{"1":"US","2":"2011-01-01","3":"449.88","4":"9","5":"18.43"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="fu">ggplot</span>(basket_value) <span class="sc">+</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> basket_value, <span class="at">group =</span> market</span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a>    )</span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">xend =</span> last_month_day,</span>
<span id="cb55-10"><a href="#cb55-10" tabindex="-1"></a>      <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> basket_size <span class="sc">*</span> scale</span>
<span id="cb55-11"><a href="#cb55-11" tabindex="-1"></a>    ),</span>
<span id="cb55-12"><a href="#cb55-12" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb55-13"><a href="#cb55-13" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-14"><a href="#cb55-14" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb55-15"><a href="#cb55-15" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb55-16"><a href="#cb55-16" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> basket_size <span class="sc">*</span> scale,</span>
<span id="cb55-17"><a href="#cb55-17" tabindex="-1"></a>      <span class="at">size =</span> <span class="fu">ifelse</span>(</span>
<span id="cb55-18"><a href="#cb55-18" tabindex="-1"></a>        basket_size <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">2</span>, basket_size <span class="sc">-</span></span>
<span id="cb55-19"><a href="#cb55-19" tabindex="-1"></a>          <span class="dv">2</span></span>
<span id="cb55-20"><a href="#cb55-20" tabindex="-1"></a>      )</span>
<span id="cb55-21"><a href="#cb55-21" tabindex="-1"></a>    ),</span>
<span id="cb55-22"><a href="#cb55-22" tabindex="-1"></a>    <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb55-23"><a href="#cb55-23" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb55-24"><a href="#cb55-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-25"><a href="#cb55-25" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb55-26"><a href="#cb55-26" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb55-27"><a href="#cb55-27" tabindex="-1"></a>      <span class="at">x =</span> last_month_day, <span class="at">y =</span> basket_size <span class="sc">*</span> scale,</span>
<span id="cb55-28"><a href="#cb55-28" tabindex="-1"></a>      <span class="at">label =</span> basket_size, <span class="at">size =</span> <span class="fu">ifelse</span>(</span>
<span id="cb55-29"><a href="#cb55-29" tabindex="-1"></a>        basket_size <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">2</span>, basket_size <span class="sc">-</span></span>
<span id="cb55-30"><a href="#cb55-30" tabindex="-1"></a>          <span class="dv">2</span></span>
<span id="cb55-31"><a href="#cb55-31" tabindex="-1"></a>      )</span>
<span id="cb55-32"><a href="#cb55-32" tabindex="-1"></a>    ),</span>
<span id="cb55-33"><a href="#cb55-33" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb55-34"><a href="#cb55-34" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-35"><a href="#cb55-35" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb55-36"><a href="#cb55-36" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> last_month_day, <span class="at">y =</span> basket_value),</span>
<span id="cb55-37"><a href="#cb55-37" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb55-38"><a href="#cb55-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-39"><a href="#cb55-39" tabindex="-1"></a>  <span class="fu">facet_grid</span>(market <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb55-40"><a href="#cb55-40" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb55-41"><a href="#cb55-41" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb55-42"><a href="#cb55-42" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_blank</span>(), <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb55-43"><a href="#cb55-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-44"><a href="#cb55-44" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb55-45"><a href="#cb55-45" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Average basket value and size&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb55-46"><a href="#cb55-46" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Basket Value, $&quot;</span></span>
<span id="cb55-47"><a href="#cb55-47" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-57-1.png" width="100%" /></p>
</div>
<div id="return-rate" class="section level2">
<h2>Return Rate</h2>
<div class="sourceCode" id="cb56"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="co">-- return rate</span></span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">extract</span>(<span class="dt">year</span> <span class="kw">from</span> order_date) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales), <span class="dv">2</span>) <span class="kw">AS</span> total_sales,</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> returned), <span class="dv">2</span>) <span class="kw">AS</span> returned_sales,</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a>       <span class="fu">count</span>(<span class="kw">distinct</span> order_id):<span class="ch">:INT</span> <span class="kw">AS</span> count_orders,</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a>       (<span class="fu">count</span>(<span class="kw">distinct</span> order_id) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> returned)):<span class="ch">:INT</span> <span class="kw">AS</span> returned_orders,</span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a>       <span class="fu">round</span>((<span class="fu">count</span>(<span class="kw">distinct</span> order_id) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> returned)):<span class="ch">:decimal</span><span class="op">/</span><span class="fu">count</span>(<span class="kw">distinct</span> order_id), <span class="dv">3</span>) <span class="kw">as</span> return_rate</span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a><span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>returns</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["total_sales"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["returned_sales"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["count_orders"],"name":[4],"type":["int"],"align":["right"]},{"label":["returned_orders"],"name":[5],"type":["int"],"align":["right"]},{"label":["return_rate"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"2259452","3":"154500.6","4":"4440","5":"209","6":"0.047"},{"1":"2012","2":"2677440","3":"177283.0","4":"5343","5":"258","6":"0.048"},{"1":"2013","2":"3405748","3":"188986.8","4":"6721","5":"317","6":"0.047"},{"1":"2014","2":"4299868","3":"297273.8","4":"8531","5":"388","6":"0.045"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="fu">ggplot</span>(returns) <span class="sc">+</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> total_sales, <span class="at">fill =</span> <span class="st">&quot;Sales&quot;</span>),</span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.8</span>)</span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> returned_sales, <span class="at">fill =</span> <span class="st">&quot;Returned Sales&quot;</span></span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a>    ),</span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.8</span>)</span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb58-13"><a href="#cb58-13" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb58-14"><a href="#cb58-14" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> return_rate <span class="sc">*</span> total_sales,</span>
<span id="cb58-15"><a href="#cb58-15" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;Return Rate&quot;</span></span>
<span id="cb58-16"><a href="#cb58-16" tabindex="-1"></a>    )</span>
<span id="cb58-17"><a href="#cb58-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-18"><a href="#cb58-18" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb58-19"><a href="#cb58-19" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb58-20"><a href="#cb58-20" tabindex="-1"></a>      <span class="at">x =</span> year, <span class="at">y =</span> return_rate <span class="sc">*</span> total_sales,</span>
<span id="cb58-21"><a href="#cb58-21" tabindex="-1"></a>      <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(return_rate, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb58-22"><a href="#cb58-22" tabindex="-1"></a>    ),</span>
<span id="cb58-23"><a href="#cb58-23" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span></span>
<span id="cb58-24"><a href="#cb58-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-25"><a href="#cb58-25" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Return rate&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sales, $&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb58-26"><a href="#cb58-26" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb58-27"><a href="#cb58-27" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>)</span>
<span id="cb58-28"><a href="#cb58-28" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-29"><a href="#cb58-29" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb58-30"><a href="#cb58-30" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="at">Sales =</span> <span class="st">&quot;#dbe5da&quot;</span>, <span class="st">`</span><span class="at">Returned Sales</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#bbcbbc&quot;</span>)</span>
<span id="cb58-31"><a href="#cb58-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-32"><a href="#cb58-32" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Return Rate</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb58-33"><a href="#cb58-33" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-60-1.png" width="100%" /></p>
</div>
<div id="what-most-significant-sub-categories" class="section level2">
<h2>What most significant sub-categories?</h2>
<div class="sourceCode" id="cb59"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="kw">WITH</span> cte_sales <span class="kw">AS</span>(</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">extract</span>(<span class="dt">year</span> <span class="kw">from</span> order_date) <span class="kw">as</span> <span class="dt">year</span>,</span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>       sub_category,</span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a>       <span class="kw">segment</span>,</span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a>       <span class="fu">sum</span>(sales) <span class="kw">as</span> sales,</span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a>       <span class="fu">sum</span>(profit) <span class="kw">as</span> profit</span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a><span class="kw">from</span> analysis.all_global_orders</span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a>       <span class="fu">round</span>(<span class="fu">sum</span>(sales<span class="op">/</span>total_sales) <span class="kw">over</span>(<span class="kw">partition</span> <span class="kw">by</span> <span class="dt">year</span>, <span class="kw">segment</span> <span class="kw">order</span> <span class="kw">by</span> sales <span class="kw">desc</span> <span class="kw">rows</span> <span class="kw">BETWEEN</span></span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a>            <span class="kw">unbounded</span> <span class="kw">preceding</span> <span class="kw">and</span> <span class="kw">current</span> <span class="kw">row</span>), <span class="dv">2</span>) <span class="kw">as</span> cum_percent</span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a>       <span class="kw">from</span></span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a>(<span class="kw">select</span> <span class="dt">year</span>, sub_category, <span class="kw">segment</span>,</span>
<span id="cb59-16"><a href="#cb59-16" tabindex="-1"></a>       sales, <span class="fu">sum</span>(sales) <span class="kw">over</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="dt">year</span>, <span class="kw">segment</span>) <span class="kw">as</span> total_sales</span>
<span id="cb59-17"><a href="#cb59-17" tabindex="-1"></a><span class="kw">from</span> cte_sales</span>
<span id="cb59-18"><a href="#cb59-18" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span> <span class="kw">desc</span>) a;</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>pareto_sales</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["sub_category"],"name":[2],"type":["chr"],"align":["left"]},{"label":["segment"],"name":[3],"type":["chr"],"align":["left"]},{"label":["sales"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["total_sales"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["cum_percent"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"2011","2":"Phones","3":"Consumer","4":"186824.74","5":"1173671.8","6":"0.16"},{"1":"2011","2":"Chairs","3":"Consumer","4":"150154.43","5":"1173671.8","6":"0.29"},{"1":"2011","2":"Bookcases","3":"Consumer","4":"132231.72","5":"1173671.8","6":"0.40"},{"1":"2011","2":"Storage","3":"Consumer","4":"112624.13","5":"1173671.8","6":"0.50"},{"1":"2011","2":"Copiers","3":"Consumer","4":"112032.85","5":"1173671.8","6":"0.59"},{"1":"2011","2":"Appliances","3":"Consumer","4":"87689.97","5":"1173671.8","6":"0.67"},{"1":"2011","2":"Tables","3":"Consumer","4":"76803.79","5":"1173671.8","6":"0.73"},{"1":"2011","2":"Machines","3":"Consumer","4":"72202.39","5":"1173671.8","6":"0.79"},{"1":"2011","2":"Accessories","3":"Consumer","4":"51689.17","5":"1173671.8","6":"0.84"},{"1":"2011","2":"Binders","3":"Consumer","4":"51578.90","5":"1173671.8","6":"0.88"},{"1":"2011","2":"Furnishings","3":"Consumer","4":"34306.10","5":"1173671.8","6":"0.91"},{"1":"2011","2":"Art","3":"Consumer","4":"31837.72","5":"1173671.8","6":"0.94"},{"1":"2011","2":"Supplies","3":"Consumer","4":"25298.23","5":"1173671.8","6":"0.96"},{"1":"2011","2":"Paper","3":"Consumer","4":"20640.34","5":"1173671.8","6":"0.98"},{"1":"2011","2":"Envelopes","3":"Consumer","4":"13987.13","5":"1173671.8","6":"0.99"},{"1":"2011","2":"Fasteners","3":"Consumer","4":"7252.01","5":"1173671.8","6":"0.99"},{"1":"2011","2":"Labels","3":"Consumer","4":"6518.22","5":"1173671.8","6":"1.00"},{"1":"2011","2":"Phones","3":"Corporate","4":"100623.40","5":"691662.8","6":"0.15"},{"1":"2011","2":"Chairs","3":"Corporate","4":"91157.61","5":"691662.8","6":"0.28"},{"1":"2011","2":"Bookcases","3":"Corporate","4":"82556.30","5":"691662.8","6":"0.40"},{"1":"2011","2":"Copiers","3":"Corporate","4":"69099.17","5":"691662.8","6":"0.50"},{"1":"2011","2":"Storage","3":"Corporate","4":"61260.48","5":"691662.8","6":"0.59"},{"1":"2011","2":"Appliances","3":"Corporate","4":"57164.04","5":"691662.8","6":"0.67"},{"1":"2011","2":"Tables","3":"Corporate","4":"48595.05","5":"691662.8","6":"0.74"},{"1":"2011","2":"Accessories","3":"Corporate","4":"37368.55","5":"691662.8","6":"0.79"},{"1":"2011","2":"Machines","3":"Corporate","4":"35618.44","5":"691662.8","6":"0.84"},{"1":"2011","2":"Binders","3":"Corporate","4":"22178.54","5":"691662.8","6":"0.88"},{"1":"2011","2":"Furnishings","3":"Corporate","4":"19163.89","5":"691662.8","6":"0.90"},{"1":"2011","2":"Art","3":"Corporate","4":"19112.30","5":"691662.8","6":"0.93"},{"1":"2011","2":"Supplies","3":"Corporate","4":"15592.33","5":"691662.8","6":"0.95"},{"1":"2011","2":"Paper","3":"Corporate","4":"14239.65","5":"691662.8","6":"0.97"},{"1":"2011","2":"Envelopes","3":"Corporate","4":"8920.38","5":"691662.8","6":"0.99"},{"1":"2011","2":"Labels","3":"Corporate","4":"4861.10","5":"691662.8","6":"0.99"},{"1":"2011","2":"Fasteners","3":"Corporate","4":"4151.57","5":"691662.8","6":"1.00"},{"1":"2011","2":"Machines","3":"Home Office","4":"52724.91","5":"394117.0","6":"0.13"},{"1":"2011","2":"Phones","3":"Home Office","4":"49834.44","5":"394117.0","6":"0.26"},{"1":"2011","2":"Bookcases","3":"Home Office","4":"44608.27","5":"394117.0","6":"0.37"},{"1":"2011","2":"Chairs","3":"Home Office","4":"44418.94","5":"394117.0","6":"0.49"},{"1":"2011","2":"Copiers","3":"Home Office","4":"35235.93","5":"394117.0","6":"0.58"},{"1":"2011","2":"Storage","3":"Home Office","4":"31742.44","5":"394117.0","6":"0.66"},{"1":"2011","2":"Appliances","3":"Home Office","4":"28529.48","5":"394117.0","6":"0.73"},{"1":"2011","2":"Accessories","3":"Home Office","4":"24398.36","5":"394117.0","6":"0.79"},{"1":"2011","2":"Tables","3":"Home Office","4":"21732.72","5":"394117.0","6":"0.85"},{"1":"2011","2":"Binders","3":"Home Office","4":"13241.54","5":"394117.0","6":"0.88"},{"1":"2011","2":"Art","3":"Home Office","4":"13188.97","5":"394117.0","6":"0.91"},{"1":"2011","2":"Furnishings","3":"Home Office","4":"10463.69","5":"394117.0","6":"0.94"},{"1":"2011","2":"Paper","3":"Home Office","4":"7786.05","5":"394117.0","6":"0.96"},{"1":"2011","2":"Supplies","3":"Home Office","4":"6690.01","5":"394117.0","6":"0.98"},{"1":"2011","2":"Envelopes","3":"Home Office","4":"5079.10","5":"394117.0","6":"0.99"},{"1":"2011","2":"Labels","3":"Home Office","4":"2237.15","5":"394117.0","6":"0.99"},{"1":"2011","2":"Fasteners","3":"Home Office","4":"2205.00","5":"394117.0","6":"1.00"},{"1":"2012","2":"Phones","3":"Consumer","4":"210390.73","5":"1463760.9","6":"0.14"},{"1":"2012","2":"Bookcases","3":"Consumer","4":"178848.61","5":"1463760.9","6":"0.27"},{"1":"2012","2":"Copiers","3":"Consumer","4":"168622.68","5":"1463760.9","6":"0.38"},{"1":"2012","2":"Chairs","3":"Consumer","4":"156549.46","5":"1463760.9","6":"0.49"},{"1":"2012","2":"Storage","3":"Consumer","4":"128041.19","5":"1463760.9","6":"0.58"},{"1":"2012","2":"Appliances","3":"Consumer","4":"127444.72","5":"1463760.9","6":"0.66"},{"1":"2012","2":"Machines","3":"Consumer","4":"96016.00","5":"1463760.9","6":"0.73"},{"1":"2012","2":"Accessories","3":"Consumer","4":"94212.87","5":"1463760.9","6":"0.79"},{"1":"2012","2":"Tables","3":"Consumer","4":"74204.30","5":"1463760.9","6":"0.84"},{"1":"2012","2":"Binders","3":"Consumer","4":"55098.05","5":"1463760.9","6":"0.88"},{"1":"2012","2":"Furnishings","3":"Consumer","4":"45737.97","5":"1463760.9","6":"0.91"},{"1":"2012","2":"Art","3":"Consumer","4":"43626.41","5":"1463760.9","6":"0.94"},{"1":"2012","2":"Paper","3":"Consumer","4":"24769.80","5":"1463760.9","6":"0.96"},{"1":"2012","2":"Supplies","3":"Consumer","4":"21856.85","5":"1463760.9","6":"0.97"},{"1":"2012","2":"Envelopes","3":"Consumer","4":"19942.85","5":"1463760.9","6":"0.99"},{"1":"2012","2":"Fasteners","3":"Consumer","4":"10207.94","5":"1463760.9","6":"0.99"},{"1":"2012","2":"Labels","3":"Consumer","4":"8190.52","5":"1463760.9","6":"1.00"},{"1":"2012","2":"Phones","3":"Corporate","4":"108964.11","5":"774459.9","6":"0.14"},{"1":"2012","2":"Copiers","3":"Corporate","4":"98631.76","5":"774459.9","6":"0.27"},{"1":"2012","2":"Bookcases","3":"Corporate","4":"95774.39","5":"774459.9","6":"0.39"},{"1":"2012","2":"Chairs","3":"Corporate","4":"74427.49","5":"774459.9","6":"0.49"},{"1":"2012","2":"Appliances","3":"Corporate","4":"65822.88","5":"774459.9","6":"0.57"},{"1":"2012","2":"Storage","3":"Corporate","4":"64849.17","5":"774459.9","6":"0.66"},{"1":"2012","2":"Tables","3":"Corporate","4":"57729.83","5":"774459.9","6":"0.73"},{"1":"2012","2":"Accessories","3":"Corporate","4":"43766.18","5":"774459.9","6":"0.79"},{"1":"2012","2":"Machines","3":"Corporate","4":"41551.32","5":"774459.9","6":"0.84"},{"1":"2012","2":"Art","3":"Corporate","4":"25007.18","5":"774459.9","6":"0.87"},{"1":"2012","2":"Binders","3":"Corporate","4":"24963.57","5":"774459.9","6":"0.91"},{"1":"2012","2":"Furnishings","3":"Corporate","4":"22015.45","5":"774459.9","6":"0.93"},{"1":"2012","2":"Paper","3":"Corporate","4":"16604.82","5":"774459.9","6":"0.96"},{"1":"2012","2":"Supplies","3":"Corporate","4":"12218.34","5":"774459.9","6":"0.97"},{"1":"2012","2":"Envelopes","3":"Corporate","4":"11311.39","5":"774459.9","6":"0.99"},{"1":"2012","2":"Fasteners","3":"Corporate","4":"6044.96","5":"774459.9","6":"0.99"},{"1":"2012","2":"Labels","3":"Corporate","4":"4777.08","5":"774459.9","6":"1.00"},{"1":"2012","2":"Chairs","3":"Home Office","4":"64081.28","5":"439219.0","6":"0.15"},{"1":"2012","2":"Copiers","3":"Home Office","4":"59914.22","5":"439219.0","6":"0.28"},{"1":"2012","2":"Phones","3":"Home Office","4":"44661.53","5":"439219.0","6":"0.38"},{"1":"2012","2":"Bookcases","3":"Home Office","4":"43330.51","5":"439219.0","6":"0.48"},{"1":"2012","2":"Storage","3":"Home Office","4":"35665.62","5":"439219.0","6":"0.56"},{"1":"2012","2":"Accessories","3":"Home Office","4":"34418.68","5":"439219.0","6":"0.64"},{"1":"2012","2":"Tables","3":"Home Office","4":"32152.40","5":"439219.0","6":"0.72"},{"1":"2012","2":"Appliances","3":"Home Office","4":"29675.45","5":"439219.0","6":"0.78"},{"1":"2012","2":"Machines","3":"Home Office","4":"22291.65","5":"439219.0","6":"0.83"},{"1":"2012","2":"Furnishings","3":"Home Office","4":"14051.12","5":"439219.0","6":"0.87"},{"1":"2012","2":"Art","3":"Home Office","4":"13724.90","5":"439219.0","6":"0.90"},{"1":"2012","2":"Binders","3":"Home Office","4":"13356.43","5":"439219.0","6":"0.93"},{"1":"2012","2":"Paper","3":"Home Office","4":"10137.86","5":"439219.0","6":"0.95"},{"1":"2012","2":"Supplies","3":"Home Office","4":"9222.24","5":"439219.0","6":"0.97"},{"1":"2012","2":"Envelopes","3":"Home Office","4":"6759.58","5":"439219.0","6":"0.99"},{"1":"2012","2":"Fasteners","3":"Home Office","4":"3224.83","5":"439219.0","6":"0.99"},{"1":"2012","2":"Labels","3":"Home Office","4":"2550.74","5":"439219.0","6":"1.00"},{"1":"2013","2":"Phones","3":"Consumer","4":"244492.77","5":"1729256.0","6":"0.14"},{"1":"2013","2":"Chairs","3":"Consumer","4":"207559.62","5":"1729256.0","6":"0.26"},{"1":"2013","2":"Copiers","3":"Consumer","4":"204833.77","5":"1729256.0","6":"0.38"},{"1":"2013","2":"Bookcases","3":"Consumer","4":"197046.35","5":"1729256.0","6":"0.49"},{"1":"2013","2":"Storage","3":"Consumer","4":"149458.48","5":"1729256.0","6":"0.58"},{"1":"2013","2":"Appliances","3":"Consumer","4":"114555.01","5":"1729256.0","6":"0.65"},{"1":"2013","2":"Accessories","3":"Consumer","4":"111517.57","5":"1729256.0","6":"0.71"},{"1":"2013","2":"Tables","3":"Consumer","4":"108347.23","5":"1729256.0","6":"0.77"},{"1":"2013","2":"Machines","3":"Consumer","4":"101140.70","5":"1729256.0","6":"0.83"},{"1":"2013","2":"Binders","3":"Consumer","4":"65952.06","5":"1729256.0","6":"0.87"},{"1":"2013","2":"Furnishings","3":"Consumer","4":"56905.83","5":"1729256.0","6":"0.90"},{"1":"2013","2":"Art","3":"Consumer","4":"54188.03","5":"1729256.0","6":"0.93"},{"1":"2013","2":"Supplies","3":"Consumer","4":"33681.93","5":"1729256.0","6":"0.95"},{"1":"2013","2":"Paper","3":"Consumer","4":"32679.61","5":"1729256.0","6":"0.97"},{"1":"2013","2":"Envelopes","3":"Consumer","4":"26341.07","5":"1729256.0","6":"0.99"},{"1":"2013","2":"Fasteners","3":"Consumer","4":"10735.36","5":"1729256.0","6":"0.99"},{"1":"2013","2":"Labels","3":"Consumer","4":"9820.57","5":"1729256.0","6":"1.00"},{"1":"2013","2":"Chairs","3":"Corporate","4":"147023.44","5":"1064973.9","6":"0.14"},{"1":"2013","2":"Copiers","3":"Corporate","4":"135212.68","5":"1064973.9","6":"0.27"},{"1":"2013","2":"Phones","3":"Corporate","4":"127752.36","5":"1064973.9","6":"0.38"},{"1":"2013","2":"Bookcases","3":"Corporate","4":"120194.43","5":"1064973.9","6":"0.50"},{"1":"2013","2":"Storage","3":"Corporate","4":"98011.34","5":"1064973.9","6":"0.59"},{"1":"2013","2":"Appliances","3":"Corporate","4":"82234.89","5":"1064973.9","6":"0.67"},{"1":"2013","2":"Accessories","3":"Corporate","4":"65260.38","5":"1064973.9","6":"0.73"},{"1":"2013","2":"Tables","3":"Corporate","4":"64561.37","5":"1064973.9","6":"0.79"},{"1":"2013","2":"Machines","3":"Corporate","4":"62926.14","5":"1064973.9","6":"0.85"},{"1":"2013","2":"Furnishings","3":"Corporate","4":"37200.68","5":"1064973.9","6":"0.88"},{"1":"2013","2":"Binders","3":"Corporate","4":"29893.65","5":"1064973.9","6":"0.91"},{"1":"2013","2":"Art","3":"Corporate","4":"24829.64","5":"1064973.9","6":"0.93"},{"1":"2013","2":"Supplies","3":"Corporate","4":"22423.66","5":"1064973.9","6":"0.96"},{"1":"2013","2":"Paper","3":"Corporate","4":"19953.12","5":"1064973.9","6":"0.97"},{"1":"2013","2":"Envelopes","3":"Corporate","4":"15339.46","5":"1064973.9","6":"0.99"},{"1":"2013","2":"Fasteners","3":"Corporate","4":"6957.97","5":"1064973.9","6":"1.00"},{"1":"2013","2":"Labels","3":"Corporate","4":"5198.64","5":"1064973.9","6":"1.00"},{"1":"2013","2":"Phones","3":"Home Office","4":"81274.03","5":"611518.2","6":"0.13"},{"1":"2013","2":"Copiers","3":"Home Office","4":"75468.42","5":"611518.2","6":"0.26"},{"1":"2013","2":"Chairs","3":"Home Office","4":"72931.57","5":"611518.2","6":"0.38"},{"1":"2013","2":"Storage","3":"Home Office","4":"62006.17","5":"611518.2","6":"0.48"},{"1":"2013","2":"Bookcases","3":"Home Office","4":"58785.14","5":"611518.2","6":"0.57"},{"1":"2013","2":"Appliances","3":"Home Office","4":"58161.30","5":"611518.2","6":"0.67"},{"1":"2013","2":"Machines","3":"Home Office","4":"34309.44","5":"611518.2","6":"0.72"},{"1":"2013","2":"Accessories","3":"Home Office","4":"33117.31","5":"611518.2","6":"0.78"},{"1":"2013","2":"Tables","3":"Home Office","4":"29455.00","5":"611518.2","6":"0.83"},{"1":"2013","2":"Binders","3":"Home Office","4":"25229.56","5":"611518.2","6":"0.87"},{"1":"2013","2":"Art","3":"Home Office","4":"18989.59","5":"611518.2","6":"0.90"},{"1":"2013","2":"Paper","3":"Home Office","4":"17879.78","5":"611518.2","6":"0.93"},{"1":"2013","2":"Furnishings","3":"Home Office","4":"17713.33","5":"611518.2","6":"0.96"},{"1":"2013","2":"Supplies","3":"Home Office","4":"9807.52","5":"611518.2","6":"0.97"},{"1":"2013","2":"Envelopes","3":"Home Office","4":"9124.76","5":"611518.2","6":"0.99"},{"1":"2013","2":"Fasteners","3":"Home Office","4":"3903.64","5":"611518.2","6":"0.99"},{"1":"2013","2":"Labels","3":"Home Office","4":"3361.66","5":"611518.2","6":"1.00"},{"1":"2014","2":"Copiers","3":"Consumer","4":"271592.19","5":"2141263.6","6":"0.13"},{"1":"2014","2":"Chairs","3":"Consumer","4":"264099.23","5":"2141263.6","6":"0.25"},{"1":"2014","2":"Phones","3":"Consumer","4":"263714.35","5":"2141263.6","6":"0.37"},{"1":"2014","2":"Bookcases","3":"Consumer","4":"256984.60","5":"2141263.6","6":"0.49"},{"1":"2014","2":"Storage","3":"Consumer","4":"185382.67","5":"2141263.6","6":"0.58"},{"1":"2014","2":"Appliances","3":"Consumer","4":"180540.79","5":"2141263.6","6":"0.66"},{"1":"2014","2":"Accessories","3":"Consumer","4":"124743.83","5":"2141263.6","6":"0.72"},{"1":"2014","2":"Tables","3":"Consumer","4":"122371.81","5":"2141263.6","6":"0.78"},{"1":"2014","2":"Machines","3":"Consumer","4":"113014.11","5":"2141263.6","6":"0.83"},{"1":"2014","2":"Binders","3":"Consumer","4":"81116.51","5":"2141263.6","6":"0.87"},{"1":"2014","2":"Art","3":"Consumer","4":"71218.77","5":"2141263.6","6":"0.90"},{"1":"2014","2":"Furnishings","3":"Consumer","4":"66245.23","5":"2141263.6","6":"0.93"},{"1":"2014","2":"Supplies","3":"Consumer","4":"42423.30","5":"2141263.6","6":"0.95"},{"1":"2014","2":"Paper","3":"Consumer","4":"41565.09","5":"2141263.6","6":"0.97"},{"1":"2014","2":"Envelopes","3":"Consumer","4":"28202.98","5":"2141263.6","6":"0.99"},{"1":"2014","2":"Labels","3":"Consumer","4":"14168.87","5":"2141263.6","6":"0.99"},{"1":"2014","2":"Fasteners","3":"Consumer","4":"13879.23","5":"2141263.6","6":"1.00"},{"1":"2014","2":"Copiers","3":"Corporate","4":"159830.79","5":"1293602.4","6":"0.12"},{"1":"2014","2":"Bookcases","3":"Corporate","4":"158802.12","5":"1293602.4","6":"0.25"},{"1":"2014","2":"Phones","3":"Corporate","4":"156745.88","5":"1293602.4","6":"0.37"},{"1":"2014","2":"Chairs","3":"Corporate","4":"135911.08","5":"1293602.4","6":"0.47"},{"1":"2014","2":"Storage","3":"Corporate","4":"115898.64","5":"1293602.4","6":"0.56"},{"1":"2014","2":"Appliances","3":"Corporate","4":"112433.66","5":"1293602.4","6":"0.65"},{"1":"2014","2":"Machines","3":"Corporate","4":"89811.92","5":"1293602.4","6":"0.72"},{"1":"2014","2":"Accessories","3":"Corporate","4":"84628.60","5":"1293602.4","6":"0.78"},{"1":"2014","2":"Tables","3":"Corporate","4":"74907.52","5":"1293602.4","6":"0.84"},{"1":"2014","2":"Binders","3":"Corporate","4":"51498.72","5":"1293602.4","6":"0.88"},{"1":"2014","2":"Art","3":"Corporate","4":"34622.37","5":"1293602.4","6":"0.91"},{"1":"2014","2":"Furnishings","3":"Corporate","4":"34499.51","5":"1293602.4","6":"0.94"},{"1":"2014","2":"Supplies","3":"Corporate","4":"31252.06","5":"1293602.4","6":"0.96"},{"1":"2014","2":"Paper","3":"Corporate","4":"21185.01","5":"1293602.4","6":"0.98"},{"1":"2014","2":"Envelopes","3":"Corporate","4":"16234.59","5":"1293602.4","6":"0.99"},{"1":"2014","2":"Fasteners","3":"Corporate","4":"8983.92","5":"1293602.4","6":"1.00"},{"1":"2014","2":"Labels","3":"Corporate","4":"6356.00","5":"1293602.4","6":"1.00"},{"1":"2014","2":"Phones","3":"Home Office","4":"131546.31","5":"865001.7","6":"0.15"},{"1":"2014","2":"Copiers","3":"Home Office","4":"118962.05","5":"865001.7","6":"0.29"},{"1":"2014","2":"Bookcases","3":"Home Office","4":"97410.11","5":"865001.7","6":"0.40"},{"1":"2014","2":"Chairs","3":"Home Office","4":"93368.01","5":"865001.7","6":"0.51"},{"1":"2014","2":"Storage","3":"Home Office","4":"82146.35","5":"865001.7","6":"0.61"},{"1":"2014","2":"Appliances","3":"Home Office","4":"66812.35","5":"865001.7","6":"0.68"},{"1":"2014","2":"Machines","3":"Home Office","4":"57453.30","5":"865001.7","6":"0.75"},{"1":"2014","2":"Tables","3":"Home Office","4":"46181.15","5":"865001.7","6":"0.80"},{"1":"2014","2":"Accessories","3":"Home Office","4":"44115.78","5":"865001.7","6":"0.85"},{"1":"2014","2":"Binders","3":"Home Office","4":"27804.67","5":"865001.7","6":"0.89"},{"1":"2014","2":"Furnishings","3":"Home Office","4":"27275.64","5":"865001.7","6":"0.92"},{"1":"2014","2":"Art","3":"Home Office","4":"21746.64","5":"865001.7","6":"0.94"},{"1":"2014","2":"Paper","3":"Home Office","4":"16850.72","5":"865001.7","6":"0.96"},{"1":"2014","2":"Supplies","3":"Home Office","4":"12607.76","5":"865001.7","6":"0.98"},{"1":"2014","2":"Envelopes","3":"Home Office","4":"9661.08","5":"865001.7","6":"0.99"},{"1":"2014","2":"Fasteners","3":"Home Office","4":"5696.04","5":"865001.7","6":"0.99"},{"1":"2014","2":"Labels","3":"Home Office","4":"5363.76","5":"865001.7","6":"1.00"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="cf">for</span> (segment <span class="cf">in</span> <span class="fu">unique</span>(pareto_sales<span class="sc">$</span>segment)) {</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>  scale <span class="ot">&lt;-</span> <span class="fu">max</span>(</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>    pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> pareto_sales<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a>      segment, ]<span class="sc">$</span>sales</span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a>  )</span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a>  x_intercept <span class="ot">&lt;-</span> <span class="fu">approx</span>(</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a>    pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> pareto_sales<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a>      segment, ]<span class="sc">$</span>cum_percent <span class="sc">*</span> scale, <span class="fu">fct_reorder</span>(</span>
<span id="cb61-9"><a href="#cb61-9" tabindex="-1"></a>      pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span></span>
<span id="cb61-10"><a href="#cb61-10" tabindex="-1"></a>        pareto_sales<span class="sc">$</span>segment <span class="sc">==</span> segment, ]<span class="sc">$</span>sub_category,</span>
<span id="cb61-11"><a href="#cb61-11" tabindex="-1"></a>      <span class="sc">-</span>pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span></span>
<span id="cb61-12"><a href="#cb61-12" tabindex="-1"></a>        pareto_sales<span class="sc">$</span>segment <span class="sc">==</span> segment, ]<span class="sc">$</span>sales</span>
<span id="cb61-13"><a href="#cb61-13" tabindex="-1"></a>    ),</span>
<span id="cb61-14"><a href="#cb61-14" tabindex="-1"></a>    <span class="fl">0.8</span> <span class="sc">*</span> scale</span>
<span id="cb61-15"><a href="#cb61-15" tabindex="-1"></a>  )<span class="sc">$</span>y</span>
<span id="cb61-16"><a href="#cb61-16" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb61-18"><a href="#cb61-18" tabindex="-1"></a>    pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> pareto_sales<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb61-19"><a href="#cb61-19" tabindex="-1"></a>      segment, ]</span>
<span id="cb61-20"><a href="#cb61-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-21"><a href="#cb61-21" tabindex="-1"></a>    <span class="fu">geom_area</span>(</span>
<span id="cb61-22"><a href="#cb61-22" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb61-23"><a href="#cb61-23" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(sub_category, <span class="sc">-</span>sales),</span>
<span id="cb61-24"><a href="#cb61-24" tabindex="-1"></a>        <span class="at">y =</span> cum_percent <span class="sc">*</span> scale, <span class="at">group =</span> <span class="dv">1</span></span>
<span id="cb61-25"><a href="#cb61-25" tabindex="-1"></a>      ),</span>
<span id="cb61-26"><a href="#cb61-26" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">&quot;#ececec&quot;</span></span>
<span id="cb61-27"><a href="#cb61-27" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-28"><a href="#cb61-28" tabindex="-1"></a>    <span class="fu">geom_bar</span>(</span>
<span id="cb61-29"><a href="#cb61-29" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb61-30"><a href="#cb61-30" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(sub_category, <span class="sc">-</span>sales),</span>
<span id="cb61-31"><a href="#cb61-31" tabindex="-1"></a>        <span class="at">y =</span> sales</span>
<span id="cb61-32"><a href="#cb61-32" tabindex="-1"></a>      ),</span>
<span id="cb61-33"><a href="#cb61-33" tabindex="-1"></a>      <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;#bbcbbc&quot;</span></span>
<span id="cb61-34"><a href="#cb61-34" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-35"><a href="#cb61-35" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb61-36"><a href="#cb61-36" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb61-37"><a href="#cb61-37" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(sub_category, <span class="sc">-</span>sales),</span>
<span id="cb61-38"><a href="#cb61-38" tabindex="-1"></a>        <span class="at">y =</span> cum_percent <span class="sc">*</span> scale, <span class="at">group =</span> <span class="dv">1</span></span>
<span id="cb61-39"><a href="#cb61-39" tabindex="-1"></a>      )</span>
<span id="cb61-40"><a href="#cb61-40" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-41"><a href="#cb61-41" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb61-42"><a href="#cb61-42" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb61-43"><a href="#cb61-43" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(sub_category, <span class="sc">-</span>sales),</span>
<span id="cb61-44"><a href="#cb61-44" tabindex="-1"></a>        <span class="at">y =</span> cum_percent <span class="sc">*</span> scale</span>
<span id="cb61-45"><a href="#cb61-45" tabindex="-1"></a>      )</span>
<span id="cb61-46"><a href="#cb61-46" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-47"><a href="#cb61-47" tabindex="-1"></a>    <span class="fu">geom_text</span>(</span>
<span id="cb61-48"><a href="#cb61-48" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb61-49"><a href="#cb61-49" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(sub_category, <span class="sc">-</span>sales),</span>
<span id="cb61-50"><a href="#cb61-50" tabindex="-1"></a>        <span class="at">y =</span> cum_percent <span class="sc">*</span> scale, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(cum_percent, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb61-51"><a href="#cb61-51" tabindex="-1"></a>      ),</span>
<span id="cb61-52"><a href="#cb61-52" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">2</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span></span>
<span id="cb61-53"><a href="#cb61-53" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-54"><a href="#cb61-54" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb61-55"><a href="#cb61-55" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(</span>
<span id="cb61-56"><a href="#cb61-56" tabindex="-1"></a>        <span class="at">trans =</span> <span class="sc">~</span>.<span class="sc">/</span>scale, <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(),</span>
<span id="cb61-57"><a href="#cb61-57" tabindex="-1"></a>        <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb61-58"><a href="#cb61-58" tabindex="-1"></a>      ),</span>
<span id="cb61-59"><a href="#cb61-59" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, scale, <span class="dv">25000</span>),</span>
<span id="cb61-60"><a href="#cb61-60" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, scale <span class="sc">*</span> <span class="fl">1.1</span>),</span>
<span id="cb61-61"><a href="#cb61-61" tabindex="-1"></a>      <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">scale =</span> <span class="fl">0.001</span>, <span class="at">suffix =</span> <span class="st">&quot;K&quot;</span>)</span>
<span id="cb61-62"><a href="#cb61-62" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-63"><a href="#cb61-63" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">guide =</span> <span class="fu">guide_axis</span>(<span class="at">angle =</span> <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb61-64"><a href="#cb61-64" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb61-65"><a href="#cb61-65" tabindex="-1"></a>      <span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> <span class="cn">Inf</span>, <span class="at">y =</span> <span class="fl">0.8</span> <span class="sc">*</span> scale, <span class="at">yend =</span> <span class="fl">0.8</span> <span class="sc">*</span></span>
<span id="cb61-66"><a href="#cb61-66" tabindex="-1"></a>        scale, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="fl">0.25</span>,</span>
<span id="cb61-67"><a href="#cb61-67" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb61-68"><a href="#cb61-68" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-69"><a href="#cb61-69" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb61-70"><a href="#cb61-70" tabindex="-1"></a>      <span class="at">x =</span> x_intercept, <span class="at">xend =</span> x_intercept, <span class="at">y =</span> <span class="sc">-</span><span class="cn">Inf</span>,</span>
<span id="cb61-71"><a href="#cb61-71" tabindex="-1"></a>      <span class="at">yend =</span> <span class="fl">0.8</span> <span class="sc">*</span> scale, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="fl">0.25</span>,</span>
<span id="cb61-72"><a href="#cb61-72" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb61-73"><a href="#cb61-73" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-74"><a href="#cb61-74" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb61-75"><a href="#cb61-75" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb61-76"><a href="#cb61-76" tabindex="-1"></a>        <span class="st">&quot;Sales by sub-category in &quot;</span>, segment,</span>
<span id="cb61-77"><a href="#cb61-77" tabindex="-1"></a>        <span class="st">&quot; customer segment for 2014&quot;</span></span>
<span id="cb61-78"><a href="#cb61-78" tabindex="-1"></a>      ),</span>
<span id="cb61-79"><a href="#cb61-79" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;Sub-Category&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sales, $&quot;</span>, <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb61-80"><a href="#cb61-80" tabindex="-1"></a>        <span class="st">&quot;80% of the total revenue comes from most significant sub-categories</span><span class="sc">\n</span><span class="st">such as &quot;</span>,</span>
<span id="cb61-81"><a href="#cb61-81" tabindex="-1"></a>        <span class="fu">stri_replace_last</span>(</span>
<span id="cb61-82"><a href="#cb61-82" tabindex="-1"></a>          <span class="fu">paste</span>(</span>
<span id="cb61-83"><a href="#cb61-83" tabindex="-1"></a>          <span class="fu">as.character</span>(</span>
<span id="cb61-84"><a href="#cb61-84" tabindex="-1"></a>            <span class="fu">fct_reorder</span>(</span>
<span id="cb61-85"><a href="#cb61-85" tabindex="-1"></a>            pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span></span>
<span id="cb61-86"><a href="#cb61-86" tabindex="-1"></a>              <span class="dv">2014</span> <span class="sc">&amp;</span> pareto_sales<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb61-87"><a href="#cb61-87" tabindex="-1"></a>              segment, ]<span class="sc">$</span>sub_category,</span>
<span id="cb61-88"><a href="#cb61-88" tabindex="-1"></a>            <span class="sc">-</span>pareto_sales[pareto_sales<span class="sc">$</span>year <span class="sc">==</span></span>
<span id="cb61-89"><a href="#cb61-89" tabindex="-1"></a>              <span class="dv">2014</span> <span class="sc">&amp;</span> pareto_sales<span class="sc">$</span>segment <span class="sc">==</span></span>
<span id="cb61-90"><a href="#cb61-90" tabindex="-1"></a>              segment, ]<span class="sc">$</span>sales</span>
<span id="cb61-91"><a href="#cb61-91" tabindex="-1"></a>          )[<span class="fu">seq</span>(</span>
<span id="cb61-92"><a href="#cb61-92" tabindex="-1"></a>            <span class="dv">1</span>, <span class="fu">round</span>(<span class="fl">8.27</span>, <span class="dv">0</span>),</span>
<span id="cb61-93"><a href="#cb61-93" tabindex="-1"></a>            <span class="dv">1</span></span>
<span id="cb61-94"><a href="#cb61-94" tabindex="-1"></a>          )]</span>
<span id="cb61-95"><a href="#cb61-95" tabindex="-1"></a>          ),</span>
<span id="cb61-96"><a href="#cb61-96" tabindex="-1"></a>          <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span></span>
<span id="cb61-97"><a href="#cb61-97" tabindex="-1"></a>        ),</span>
<span id="cb61-98"><a href="#cb61-98" tabindex="-1"></a>          <span class="at">fixed =</span> <span class="st">&quot;,&quot;</span>, <span class="st">&quot; &amp;&quot;</span></span>
<span id="cb61-99"><a href="#cb61-99" tabindex="-1"></a>        )</span>
<span id="cb61-100"><a href="#cb61-100" tabindex="-1"></a>      )</span>
<span id="cb61-101"><a href="#cb61-101" tabindex="-1"></a>    )</span>
<span id="cb61-102"><a href="#cb61-102" tabindex="-1"></a>  <span class="fu">print</span>(g)</span>
<span id="cb61-103"><a href="#cb61-103" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-63-1.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-63-2.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-63-3.png" width="100%" /></p>
</div>
<div id="map" class="section level2">
<h2>Map</h2>
<div class="sourceCode" id="cb62"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a><span class="kw">SELECT</span> market,</span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>       region,</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>       country,</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a>       <span class="fu">sum</span>(sales) <span class="kw">AS</span> sales</span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a><span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span></span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>;</span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>map</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["region"],"name":[2],"type":["chr"],"align":["left"]},{"label":["country"],"name":[3],"type":["chr"],"align":["left"]},{"label":["sales"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"Africa","2":"Africa","3":"Algeria","4":"36091.59"},{"1":"Africa","2":"Africa","3":"Angola","4":"25554.00"},{"1":"Africa","2":"Africa","3":"Benin","4":"6212.07"},{"1":"Africa","2":"Africa","3":"Burundi","4":"267.72"},{"1":"Africa","2":"Africa","3":"Cameroon","4":"22349.37"},{"1":"Africa","2":"Africa","3":"Central African Republic","4":"2377.56"},{"1":"Africa","2":"Africa","3":"Chad","4":"1317.03"},{"1":"Africa","2":"Africa","3":"Cote d'Ivoire","4":"25618.17"},{"1":"Africa","2":"Africa","3":"Democratic Republic of the Congo","4":"87416.58"},{"1":"Africa","2":"Africa","3":"Djibouti","4":"2392.95"},{"1":"Africa","2":"Africa","3":"Egypt","4":"84139.32"},{"1":"Africa","2":"Africa","3":"Equatorial Guinea","4":"150.51"},{"1":"Africa","2":"Africa","3":"Eritrea","4":"187.74"},{"1":"Africa","2":"Africa","3":"Ethiopia","4":"850.62"},{"1":"Africa","2":"Africa","3":"Gabon","4":"1751.73"},{"1":"Africa","2":"Africa","3":"Ghana","4":"23272.26"},{"1":"Africa","2":"Africa","3":"Guinea","4":"3498.27"},{"1":"Africa","2":"Africa","3":"Guinea-Bissau","4":"2065.44"},{"1":"Africa","2":"Africa","3":"Kenya","4":"17573.13"},{"1":"Africa","2":"Africa","3":"Lesotho","4":"6711.99"},{"1":"Africa","2":"Africa","3":"Liberia","4":"3560.88"},{"1":"Africa","2":"Africa","3":"Libya","4":"7808.40"},{"1":"Africa","2":"Africa","3":"Madagascar","4":"12617.55"},{"1":"Africa","2":"Africa","3":"Mali","4":"8914.47"},{"1":"Africa","2":"Africa","3":"Mauritania","4":"4020.93"},{"1":"Africa","2":"Africa","3":"Morocco","4":"87077.94"},{"1":"Africa","2":"Africa","3":"Mozambique","4":"21302.88"},{"1":"Africa","2":"Africa","3":"Namibia","4":"2899.47"},{"1":"Africa","2":"Africa","3":"Niger","4":"6922.98"},{"1":"Africa","2":"Africa","3":"Nigeria","4":"54350.47"},{"1":"Africa","2":"Africa","3":"Republic of the Congo","4":"2713.23"},{"1":"Africa","2":"Africa","3":"Rwanda","4":"5194.08"},{"1":"Africa","2":"Africa","3":"Senegal","4":"28848.90"},{"1":"Africa","2":"Africa","3":"Sierra Leone","4":"2447.67"},{"1":"Africa","2":"Africa","3":"Somalia","4":"8185.05"},{"1":"Africa","2":"Africa","3":"South Africa","4":"95292.27"},{"1":"Africa","2":"Africa","3":"South Sudan","4":"1045.62"},{"1":"Africa","2":"Africa","3":"Sudan","4":"16338.57"},{"1":"Africa","2":"Africa","3":"Swaziland","4":"288.03"},{"1":"Africa","2":"Africa","3":"Tanzania","4":"26816.13"},{"1":"Africa","2":"Africa","3":"Togo","4":"4146.42"},{"1":"Africa","2":"Africa","3":"Tunisia","4":"1760.79"},{"1":"Africa","2":"Africa","3":"Uganda","4":"1621.96"},{"1":"Africa","2":"Africa","3":"Zambia","4":"26035.50"},{"1":"Africa","2":"Africa","3":"Zimbabwe","4":"3765.13"},{"1":"APAC","2":"Central Asia","3":"Afghanistan","4":"21673.32"},{"1":"APAC","2":"Central Asia","3":"Bangladesh","4":"78256.47"},{"1":"APAC","2":"Central Asia","3":"India","4":"589650.19"},{"1":"APAC","2":"Central Asia","3":"Nepal","4":"3522.24"},{"1":"APAC","2":"Central Asia","3":"Pakistan","4":"58872.90"},{"1":"APAC","2":"Central Asia","3":"Sri Lanka","4":"851.82"},{"1":"APAC","2":"North Asia","3":"China","4":"700562.09"},{"1":"APAC","2":"North Asia","3":"Hong Kong","4":"6147.00"},{"1":"APAC","2":"North Asia","3":"Japan","4":"100787.54"},{"1":"APAC","2":"North Asia","3":"Mongolia","4":"40.23"},{"1":"APAC","2":"North Asia","3":"South Korea","4":"33125.52"},{"1":"APAC","2":"North Asia","3":"Taiwan","4":"7647.63"},{"1":"APAC","2":"Oceania","3":"Australia","4":"925236.91"},{"1":"APAC","2":"Oceania","3":"New Zealand","4":"172020.63"},{"1":"APAC","2":"Oceania","3":"Papua New Guinea","4":"2928.15"},{"1":"APAC","2":"Southeast Asia","3":"Cambodia","4":"17476.02"},{"1":"APAC","2":"Southeast Asia","3":"Indonesia","4":"404887.67"},{"1":"APAC","2":"Southeast Asia","3":"Malaysia","4":"61362.21"},{"1":"APAC","2":"Southeast Asia","3":"Myanmar (Burma)","4":"34138.88"},{"1":"APAC","2":"Southeast Asia","3":"Philippines","4":"183420.66"},{"1":"APAC","2":"Southeast Asia","3":"Singapore","4":"40286.25"},{"1":"APAC","2":"Southeast Asia","3":"Thailand","4":"77052.02"},{"1":"APAC","2":"Southeast Asia","3":"Vietnam","4":"65800.24"},{"1":"Canada","2":"Canada","3":"Canada","4":"66928.17"},{"1":"EMEA","2":"EMEA","3":"Albania","4":"3888.12"},{"1":"EMEA","2":"EMEA","3":"Armenia","4":"156.75"},{"1":"EMEA","2":"EMEA","3":"Austria","4":"11377.05"},{"1":"EMEA","2":"EMEA","3":"Azerbaijan","4":"5631.51"},{"1":"EMEA","2":"EMEA","3":"Bahrain","4":"669.18"},{"1":"EMEA","2":"EMEA","3":"Belarus","4":"13386.09"},{"1":"EMEA","2":"EMEA","3":"Bosnia and Herzegovina","4":"2599.26"},{"1":"EMEA","2":"EMEA","3":"Bulgaria","4":"15557.64"},{"1":"EMEA","2":"EMEA","3":"Croatia","4":"4461.18"},{"1":"EMEA","2":"EMEA","3":"Czech Republic","4":"9573.93"},{"1":"EMEA","2":"EMEA","3":"Estonia","4":"4479.84"},{"1":"EMEA","2":"EMEA","3":"Georgia","4":"5427.42"},{"1":"EMEA","2":"EMEA","3":"Hungary","4":"14254.05"},{"1":"EMEA","2":"EMEA","3":"Iran","4":"113746.11"},{"1":"EMEA","2":"EMEA","3":"Iraq","4":"70714.80"},{"1":"EMEA","2":"EMEA","3":"Israel","4":"19294.08"},{"1":"EMEA","2":"EMEA","3":"Jordan","4":"7326.15"},{"1":"EMEA","2":"EMEA","3":"Kazakhstan","4":"4605.48"},{"1":"EMEA","2":"EMEA","3":"Kyrgyzstan","4":"5106.30"},{"1":"EMEA","2":"EMEA","3":"Lebanon","4":"2796.66"},{"1":"EMEA","2":"EMEA","3":"Lithuania","4":"6724.36"},{"1":"EMEA","2":"EMEA","3":"Macedonia","4":"209.64"},{"1":"EMEA","2":"EMEA","3":"Moldova","4":"5139.93"},{"1":"EMEA","2":"EMEA","3":"Mongolia","4":"6749.61"},{"1":"EMEA","2":"EMEA","3":"Montenegro","4":"4004.37"},{"1":"EMEA","2":"EMEA","3":"Poland","4":"44228.85"},{"1":"EMEA","2":"EMEA","3":"Qatar","4":"6049.80"},{"1":"EMEA","2":"EMEA","3":"Romania","4":"37256.58"},{"1":"EMEA","2":"EMEA","3":"Russia","4":"82913.88"},{"1":"EMEA","2":"EMEA","3":"Saudi Arabia","4":"82012.20"},{"1":"EMEA","2":"EMEA","3":"Slovakia","4":"865.32"},{"1":"EMEA","2":"EMEA","3":"Slovenia","4":"1469.94"},{"1":"EMEA","2":"EMEA","3":"Syria","4":"5310.64"},{"1":"EMEA","2":"EMEA","3":"Tajikistan","4":"242.78"},{"1":"EMEA","2":"EMEA","3":"Turkey","4":"108507.90"},{"1":"EMEA","2":"EMEA","3":"Turkmenistan","4":"2027.05"},{"1":"EMEA","2":"EMEA","3":"Ukraine","4":"86857.17"},{"1":"EMEA","2":"EMEA","3":"United Arab Emirates","4":"744.14"},{"1":"EMEA","2":"EMEA","3":"Uzbekistan","4":"7329.87"},{"1":"EMEA","2":"EMEA","3":"Yemen","4":"2465.72"},{"1":"EU","2":"Central","3":"Austria","4":"81162.00"},{"1":"EU","2":"Central","3":"Belgium","4":"49226.70"},{"1":"EU","2":"Central","3":"France","4":"858931.65"},{"1":"EU","2":"Central","3":"Germany","4":"628840.40"},{"1":"EU","2":"Central","3":"Netherlands","4":"77515.39"},{"1":"EU","2":"Central","3":"Switzerland","4":"24877.86"},{"1":"EU","2":"North","3":"Denmark","4":"8638.15"},{"1":"EU","2":"North","3":"Finland","4":"20704.35"},{"1":"EU","2":"North","3":"Ireland","4":"16639.68"},{"1":"EU","2":"North","3":"Norway","4":"20525.37"},{"1":"EU","2":"North","3":"Sweden","4":"30491.65"},{"1":"EU","2":"North","3":"United Kingdom","4":"528576.55"},{"1":"EU","2":"South","3":"Italy","4":"289709.71"},{"1":"EU","2":"South","3":"Portugal","4":"15105.20"},{"1":"EU","2":"South","3":"Spain","4":"287146.72"},{"1":"LATAM","2":"Caribbean","3":"Barbados","4":"7174.28"},{"1":"LATAM","2":"Caribbean","3":"Cuba","4":"158854.94"},{"1":"LATAM","2":"Caribbean","3":"Dominican Republic","4":"126140.58"},{"1":"LATAM","2":"Caribbean","3":"Guadeloupe","4":"1461.64"},{"1":"LATAM","2":"Caribbean","3":"Haiti","4":"11038.35"},{"1":"LATAM","2":"Caribbean","3":"Jamaica","4":"6761.79"},{"1":"LATAM","2":"Caribbean","3":"Martinique","4":"5968.15"},{"1":"LATAM","2":"Caribbean","3":"Trinidad and Tobago","4":"6881.16"},{"1":"LATAM","2":"Central","3":"El Salvador","4":"177554.91"},{"1":"LATAM","2":"Central","3":"Guatemala","4":"131602.46"},{"1":"LATAM","2":"Central","3":"Honduras","4":"90125.70"},{"1":"LATAM","2":"Central","3":"Nicaragua","4":"149687.06"},{"1":"LATAM","2":"Central","3":"Panama","4":"51539.88"},{"1":"LATAM","2":"North","3":"Mexico","4":"622590.78"},{"1":"LATAM","2":"South","3":"Argentina","4":"57511.75"},{"1":"LATAM","2":"South","3":"Bolivia","4":"11588.97"},{"1":"LATAM","2":"South","3":"Brazil","4":"361106.41"},{"1":"LATAM","2":"South","3":"Chile","4":"35447.07"},{"1":"LATAM","2":"South","3":"Colombia","4":"81502.51"},{"1":"LATAM","2":"South","3":"Ecuador","4":"13342.98"},{"1":"LATAM","2":"South","3":"Paraguay","4":"2590.37"},{"1":"LATAM","2":"South","3":"Peru","4":"17833.21"},{"1":"LATAM","2":"South","3":"Uruguay","4":"9712.54"},{"1":"LATAM","2":"South","3":"Venezuela","4":"26587.83"},{"1":"US","2":"Central","3":"United States","4":"501239.88"},{"1":"US","2":"East","3":"United States","4":"678781.36"},{"1":"US","2":"South","3":"United States","4":"391721.90"},{"1":"US","2":"West","3":"United States","4":"725457.93"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="co"># add geocodes</span></span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">&quot;world&quot;</span>)</span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a>mapp <span class="ot">&lt;-</span> map <span class="sc">%&gt;%</span></span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>  <span class="fu">geocode</span>(</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a>    <span class="at">country =</span> country, <span class="at">method =</span> <span class="st">&quot;osm&quot;</span>, <span class="at">lat =</span> latitude,</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>    <span class="at">long =</span> longitude</span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a>  )</span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> mapp <span class="sc">%&gt;%</span></span>
<span id="cb64-10"><a href="#cb64-10" tabindex="-1"></a>  <span class="fu">group_by</span>(market) <span class="sc">%&gt;%</span></span>
<span id="cb64-11"><a href="#cb64-11" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb64-12"><a href="#cb64-12" tabindex="-1"></a>    <span class="at">longitude =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-13"><a href="#cb64-13" tabindex="-1"></a>    <span class="at">latitude =</span> <span class="fu">mean</span>(latitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-14"><a href="#cb64-14" tabindex="-1"></a>    <span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-15"><a href="#cb64-15" tabindex="-1"></a>  )</span>
<span id="cb64-16"><a href="#cb64-16" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_map</span>(</span>
<span id="cb64-18"><a href="#cb64-18" tabindex="-1"></a>  <span class="at">data =</span> world, <span class="at">map =</span> world, <span class="fu">aes</span>(long, lat, <span class="at">map_id =</span> region),</span>
<span id="cb64-19"><a href="#cb64-19" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;#ececec&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb64-20"><a href="#cb64-20" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb64-21"><a href="#cb64-21" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb64-22"><a href="#cb64-22" tabindex="-1"></a>    <span class="at">data =</span> centroids, <span class="fu">aes</span>(</span>
<span id="cb64-23"><a href="#cb64-23" tabindex="-1"></a>      <span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">size =</span> sales,</span>
<span id="cb64-24"><a href="#cb64-24" tabindex="-1"></a>      <span class="at">color =</span> market</span>
<span id="cb64-25"><a href="#cb64-25" tabindex="-1"></a>    ),</span>
<span id="cb64-26"><a href="#cb64-26" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.75</span></span>
<span id="cb64-27"><a href="#cb64-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-28"><a href="#cb64-28" tabindex="-1"></a>  <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb64-29"><a href="#cb64-29" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb64-30"><a href="#cb64-30" tabindex="-1"></a>    <span class="at">data =</span> centroids, <span class="fu">aes</span>(</span>
<span id="cb64-31"><a href="#cb64-31" tabindex="-1"></a>      <span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">dollar</span>(</span>
<span id="cb64-32"><a href="#cb64-32" tabindex="-1"></a>        sales, <span class="at">scale =</span> <span class="fl">1e-06</span>, <span class="at">suffix =</span> <span class="st">&quot;M&quot;</span>,</span>
<span id="cb64-33"><a href="#cb64-33" tabindex="-1"></a>        <span class="at">accuracy =</span> <span class="fl">0.1</span></span>
<span id="cb64-34"><a href="#cb64-34" tabindex="-1"></a>      )</span>
<span id="cb64-35"><a href="#cb64-35" tabindex="-1"></a>    ),</span>
<span id="cb64-36"><a href="#cb64-36" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>, <span class="at">vjust =</span> <span class="fl">1.5</span></span>
<span id="cb64-37"><a href="#cb64-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-38"><a href="#cb64-38" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb64-39"><a href="#cb64-39" tabindex="-1"></a>    <span class="at">data =</span> centroids, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">label =</span> market),</span>
<span id="cb64-40"><a href="#cb64-40" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span></span>
<span id="cb64-41"><a href="#cb64-41" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-42"><a href="#cb64-42" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb64-43"><a href="#cb64-43" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Total revenue per market from 2011 to 2014&quot;</span>,</span>
<span id="cb64-44"><a href="#cb64-44" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb64-45"><a href="#cb64-45" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-46"><a href="#cb64-46" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb64-47"><a href="#cb64-47" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-48"><a href="#cb64-48" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-49"><a href="#cb64-49" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-50"><a href="#cb64-50" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>, <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-51"><a href="#cb64-51" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-52"><a href="#cb64-52" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb64-53"><a href="#cb64-53" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-66-1.png" width="100%" /></p>
</div>
<div id="top-10-countries-by-sales-volume" class="section level2">
<h2>Top 10 countries by Sales Volume</h2>
<div class="sourceCode" id="cb65"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a></span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span></span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>(<span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>       <span class="fu">round</span>((sales <span class="op">-</span> <span class="fu">lag</span>(sales) <span class="kw">over</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, country  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>))<span class="op">/</span></span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>       <span class="fu">lag</span>(sales) <span class="kw">over</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, country  <span class="kw">ORDER</span> <span class="kw">BY</span>  <span class="dt">year</span>), <span class="dv">2</span>) <span class="kw">as</span> YoY_Growth_Sales,</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>       <span class="fu">round</span>((profit <span class="op">-</span> <span class="fu">lag</span>(profit) <span class="kw">over</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, country  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>))<span class="op">/</span></span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a>       <span class="fu">lag</span>(profit) <span class="kw">over</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, country  <span class="kw">ORDER</span> <span class="kw">BY</span>  <span class="dt">year</span>), <span class="dv">2</span>) <span class="kw">as</span> YoY_Growth_Profit</span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a><span class="kw">from</span></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a>(<span class="kw">select</span> market,</span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a>       country,</span>
<span id="cb65-11"><a href="#cb65-11" tabindex="-1"></a>       <span class="fu">extract</span>(<span class="dt">year</span> <span class="kw">from</span> order_date) <span class="kw">as</span> <span class="dt">year</span>,</span>
<span id="cb65-12"><a href="#cb65-12" tabindex="-1"></a>       <span class="fu">sum</span>(sales) <span class="kw">as</span> sales,</span>
<span id="cb65-13"><a href="#cb65-13" tabindex="-1"></a>       <span class="fu">sum</span>(profit) <span class="kw">as</span> profit</span>
<span id="cb65-14"><a href="#cb65-14" tabindex="-1"></a><span class="kw">from</span> analysis.all_global_orders</span>
<span id="cb65-15"><a href="#cb65-15" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) a) a</span>
<span id="cb65-16"><a href="#cb65-16" tabindex="-1"></a><span class="kw">where</span> <span class="dt">year</span> <span class="op">=</span> <span class="dv">2014</span> <span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">desc</span> <span class="kw">limit</span> <span class="dv">10</span>;</span></code></pre></div>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>top_sales_countries</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["country"],"name":[2],"type":["chr"],"align":["left"]},{"label":["year"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["sales"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["profit"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["yoy_growth_sales"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["yoy_growth_profit"],"name":[7],"type":["dbl"],"align":["right"]}],"data":[{"1":"US","2":"United States","3":"2014","4":"733947.0","5":"93507.97","6":"0.21","7":"0.14"},{"1":"APAC","2":"Australia","3":"2014","4":"314733.4","5":"32030.37","6":"0.17","7":"0.11"},{"1":"EU","2":"France","3":"2014","4":"308437.4","5":"35142.08","6":"0.34","7":"0.08"},{"1":"APAC","2":"China","3":"2014","4":"218979.3","5":"46793.98","6":"0.12","7":"0.05"},{"1":"EU","2":"Germany","3":"2014","4":"216537.2","5":"35956.07","6":"0.47","7":"0.33"},{"1":"APAC","2":"India","3":"2014","4":"205032.0","5":"48807.66","6":"0.35","7":"0.48"},{"1":"LATAM","2":"Mexico","3":"2014","4":"195479.8","5":"31330.88","6":"0.23","7":"0.12"},{"1":"EU","2":"United Kingdom","3":"2014","4":"194005.1","5":"36755.55","6":"0.56","7":"0.33"},{"1":"APAC","2":"Indonesia","3":"2014","4":"145334.8","5":"10527.21","6":"0.40","7":"11.24"},{"1":"LATAM","2":"Brazil","3":"2014","4":"119772.1","5":"15422.79","6":"0.29","7":"6.81"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>top_sales_countries <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>  <span class="fu">mutate_at</span>(</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;yoy_growth_sales&quot;</span>, <span class="st">&quot;yoy_growth_profit&quot;</span>),</span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">cell_spec</span>(</span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>      scales<span class="sc">::</span><span class="fu">percent</span>(., <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a>      <span class="st">&quot;html&quot;</span>, <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb67-7"><a href="#cb67-7" tabindex="-1"></a>        . <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;red&quot;</span>, . <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;green&quot;</span>, <span class="fu">is.na</span>(.) <span class="sc">~</span></span>
<span id="cb67-8"><a href="#cb67-8" tabindex="-1"></a>          <span class="st">&quot;lightgray&quot;</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb67-9"><a href="#cb67-9" tabindex="-1"></a>      )</span>
<span id="cb67-10"><a href="#cb67-10" tabindex="-1"></a>    )</span>
<span id="cb67-11"><a href="#cb67-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-12"><a href="#cb67-12" tabindex="-1"></a>  <span class="fu">mutate_at</span>(</span>
<span id="cb67-13"><a href="#cb67-13" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;profit&quot;</span>),</span>
<span id="cb67-14"><a href="#cb67-14" tabindex="-1"></a>    <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">dollar</span>(., <span class="at">accuracy =</span> <span class="fl">0.01</span>)</span>
<span id="cb67-15"><a href="#cb67-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-16"><a href="#cb67-16" tabindex="-1"></a>  <span class="fu">relocate</span>(yoy_growth_sales, <span class="at">.after =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb67-17"><a href="#cb67-17" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb67-18"><a href="#cb67-18" tabindex="-1"></a>  <span class="fu">kbl</span>(</span>
<span id="cb67-19"><a href="#cb67-19" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb67-20"><a href="#cb67-20" tabindex="-1"></a>      <span class="st">&quot;Market&quot;</span>, <span class="st">&quot;Country&quot;</span>, <span class="st">&quot;Total&quot;</span>, <span class="st">&quot;YoY Growth&quot;</span>,</span>
<span id="cb67-21"><a href="#cb67-21" tabindex="-1"></a>      <span class="st">&quot;Total&quot;</span>, <span class="st">&quot;YoY Growth&quot;</span></span>
<span id="cb67-22"><a href="#cb67-22" tabindex="-1"></a>    ),</span>
<span id="cb67-23"><a href="#cb67-23" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Top 10 countries by Sales Volume for 2014&quot;</span>,</span>
<span id="cb67-24"><a href="#cb67-24" tabindex="-1"></a>    <span class="at">escape =</span> F, <span class="at">align =</span> <span class="fu">c</span>(<span class="st">&quot;llrrrr&quot;</span>)</span>
<span id="cb67-25"><a href="#cb67-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-26"><a href="#cb67-26" tabindex="-1"></a>  <span class="fu">row_spec</span>(<span class="dv">0</span>, <span class="at">align =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb67-27"><a href="#cb67-27" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb67-28"><a href="#cb67-28" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;bordered&quot;</span>),</span>
<span id="cb67-29"><a href="#cb67-29" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">TRUE</span></span>
<span id="cb67-30"><a href="#cb67-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-31"><a href="#cb67-31" tabindex="-1"></a>  <span class="fu">add_header_above</span>(</span>
<span id="cb67-32"><a href="#cb67-32" tabindex="-1"></a>    <span class="at">header =</span> <span class="fu">c</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot; &quot;</span>, <span class="at">Sales =</span> <span class="dv">2</span>, <span class="at">Profit =</span> <span class="dv">2</span>),</span>
<span id="cb67-33"><a href="#cb67-33" tabindex="-1"></a>    <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">border_left =</span> <span class="cn">TRUE</span>, <span class="at">border_right =</span> <span class="cn">TRUE</span></span>
<span id="cb67-34"><a href="#cb67-34" tabindex="-1"></a>  )</span></code></pre></div>
<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;">
<caption>
Top 10 countries by Sales Volume for 2014
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; font-weight: bold; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Sales
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; font-weight: bold; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Profit
</div>
</th>
</tr>
<tr>
<th style="text-align:left;text-align: center;">
Market
</th>
<th style="text-align:left;text-align: center;">
Country
</th>
<th style="text-align:right;text-align: center;">
Total
</th>
<th style="text-align:right;text-align: center;">
YoY Growth
</th>
<th style="text-align:right;text-align: center;">
Total
</th>
<th style="text-align:right;text-align: center;">
YoY Growth
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
US
</td>
<td style="text-align:left;">
United States
</td>
<td style="text-align:right;">
$733,946.97
</td>
<td style="text-align:right;">
<span style="     color: green !important;">21.0%</span>
</td>
<td style="text-align:right;">
$93,507.97
</td>
<td style="text-align:right;">
<span style="     color: green !important;">14.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
APAC
</td>
<td style="text-align:left;">
Australia
</td>
<td style="text-align:right;">
$314,733.41
</td>
<td style="text-align:right;">
<span style="     color: green !important;">17.0%</span>
</td>
<td style="text-align:right;">
$32,030.37
</td>
<td style="text-align:right;">
<span style="     color: green !important;">11.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
EU
</td>
<td style="text-align:left;">
France
</td>
<td style="text-align:right;">
$308,437.39
</td>
<td style="text-align:right;">
<span style="     color: green !important;">34.0%</span>
</td>
<td style="text-align:right;">
$35,142.08
</td>
<td style="text-align:right;">
<span style="     color: green !important;">8.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
APAC
</td>
<td style="text-align:left;">
China
</td>
<td style="text-align:right;">
$218,979.31
</td>
<td style="text-align:right;">
<span style="     color: green !important;">12.0%</span>
</td>
<td style="text-align:right;">
$46,793.98
</td>
<td style="text-align:right;">
<span style="     color: green !important;">5.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
EU
</td>
<td style="text-align:left;">
Germany
</td>
<td style="text-align:right;">
$216,537.21
</td>
<td style="text-align:right;">
<span style="     color: green !important;">47.0%</span>
</td>
<td style="text-align:right;">
$35,956.07
</td>
<td style="text-align:right;">
<span style="     color: green !important;">33.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
APAC
</td>
<td style="text-align:left;">
India
</td>
<td style="text-align:right;">
$205,032.00
</td>
<td style="text-align:right;">
<span style="     color: green !important;">35.0%</span>
</td>
<td style="text-align:right;">
$48,807.66
</td>
<td style="text-align:right;">
<span style="     color: green !important;">48.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
LATAM
</td>
<td style="text-align:left;">
Mexico
</td>
<td style="text-align:right;">
$195,479.76
</td>
<td style="text-align:right;">
<span style="     color: green !important;">23.0%</span>
</td>
<td style="text-align:right;">
$31,330.88
</td>
<td style="text-align:right;">
<span style="     color: green !important;">12.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
EU
</td>
<td style="text-align:left;">
United Kingdom
</td>
<td style="text-align:right;">
$194,005.10
</td>
<td style="text-align:right;">
<span style="     color: green !important;">56.0%</span>
</td>
<td style="text-align:right;">
$36,755.55
</td>
<td style="text-align:right;">
<span style="     color: green !important;">33.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
APAC
</td>
<td style="text-align:left;">
Indonesia
</td>
<td style="text-align:right;">
$145,334.84
</td>
<td style="text-align:right;">
<span style="     color: green !important;">40.0%</span>
</td>
<td style="text-align:right;">
$10,527.21
</td>
<td style="text-align:right;">
<span style="     color: green !important;">1 124.0%</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
LATAM
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
$119,772.15
</td>
<td style="text-align:right;">
<span style="     color: green !important;">29.0%</span>
</td>
<td style="text-align:right;">
$15,422.79
</td>
<td style="text-align:right;">
<span style="     color: green !important;">681.0%</span>
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>countries_coords <span class="ot">&lt;-</span> top_sales_countries <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>  <span class="fu">geocode</span>(</span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>    <span class="at">country =</span> country, <span class="at">method =</span> <span class="st">&quot;osm&quot;</span>, <span class="at">lat =</span> latitude,</span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>    <span class="at">long =</span> longitude</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a>  )</span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_map</span>(</span>
<span id="cb68-8"><a href="#cb68-8" tabindex="-1"></a>  <span class="at">data =</span> world, <span class="at">map =</span> world, <span class="fu">aes</span>(long, lat, <span class="at">map_id =</span> region),</span>
<span id="cb68-9"><a href="#cb68-9" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;#ececec&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb68-10"><a href="#cb68-10" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb68-11"><a href="#cb68-11" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb68-12"><a href="#cb68-12" tabindex="-1"></a>    <span class="at">data =</span> countries_coords, <span class="fu">aes</span>(</span>
<span id="cb68-13"><a href="#cb68-13" tabindex="-1"></a>      <span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">size =</span> sales,</span>
<span id="cb68-14"><a href="#cb68-14" tabindex="-1"></a>      <span class="at">color =</span> market, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb68-15"><a href="#cb68-15" tabindex="-1"></a>    ),</span>
<span id="cb68-16"><a href="#cb68-16" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb68-17"><a href="#cb68-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-18"><a href="#cb68-18" tabindex="-1"></a>  <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb68-19"><a href="#cb68-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb68-20"><a href="#cb68-20" tabindex="-1"></a>    <span class="at">data =</span> countries_coords, <span class="fu">aes</span>(</span>
<span id="cb68-21"><a href="#cb68-21" tabindex="-1"></a>      <span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">dollar</span>(</span>
<span id="cb68-22"><a href="#cb68-22" tabindex="-1"></a>        sales, <span class="at">scale =</span> <span class="fl">0.001</span>, <span class="at">suffix =</span> <span class="st">&quot;K&quot;</span>,</span>
<span id="cb68-23"><a href="#cb68-23" tabindex="-1"></a>        <span class="at">accuracy =</span> <span class="fl">0.1</span></span>
<span id="cb68-24"><a href="#cb68-24" tabindex="-1"></a>      )</span>
<span id="cb68-25"><a href="#cb68-25" tabindex="-1"></a>    ),</span>
<span id="cb68-26"><a href="#cb68-26" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>, <span class="at">vjust =</span> <span class="fl">1.5</span></span>
<span id="cb68-27"><a href="#cb68-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-28"><a href="#cb68-28" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb68-29"><a href="#cb68-29" tabindex="-1"></a>    <span class="at">data =</span> countries_coords, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">label =</span> country),</span>
<span id="cb68-30"><a href="#cb68-30" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span></span>
<span id="cb68-31"><a href="#cb68-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-32"><a href="#cb68-32" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-33"><a href="#cb68-33" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Top 10 countries by Sales Volume for 2014&quot;</span>,</span>
<span id="cb68-34"><a href="#cb68-34" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb68-35"><a href="#cb68-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-36"><a href="#cb68-36" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb68-37"><a href="#cb68-37" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-38"><a href="#cb68-38" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-39"><a href="#cb68-39" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-40"><a href="#cb68-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>, <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-41"><a href="#cb68-41" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-42"><a href="#cb68-42" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb68-43"><a href="#cb68-43" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-70-1.png" width="100%" /></p>
</div>
<div id="sales-analysis-heat-map-by-day-and-month"
class="section level2">
<h2>Sales analysis heat map by day and month</h2>
<div class="sourceCode" id="cb69"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a></span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a>       count_orders:<span class="ch">:numeric</span> <span class="op">/</span> (<span class="fu">SUM</span>(count_orders) <span class="kw">OVER</span> ()) <span class="kw">AS</span> proc</span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a><span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="dt">month</span>,</span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a>             n_month,</span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a>             wod,</span>
<span id="cb69-7"><a href="#cb69-7" tabindex="-1"></a>             n_wod,</span>
<span id="cb69-8"><a href="#cb69-8" tabindex="-1"></a>             <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> order_id):<span class="ch">:INT</span> count_orders</span>
<span id="cb69-9"><a href="#cb69-9" tabindex="-1"></a>      <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> order_id,</span>
<span id="cb69-10"><a href="#cb69-10" tabindex="-1"></a>                <span class="fu">EXTRACT</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> <span class="fu">FIRST_VALUE</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id))  <span class="kw">AS</span> n_month,</span>
<span id="cb69-11"><a href="#cb69-11" tabindex="-1"></a>                <span class="fu">TO_CHAR</span>(<span class="fu">FIRST_VALUE</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id), <span class="st">&#39;Month&#39;</span>)    <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb69-12"><a href="#cb69-12" tabindex="-1"></a>                <span class="fu">EXTRACT</span>(ISODOW <span class="kw">FROM</span> <span class="fu">FIRST_VALUE</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id)) <span class="kw">AS</span> n_wod,</span>
<span id="cb69-13"><a href="#cb69-13" tabindex="-1"></a>                <span class="fu">TO_CHAR</span>(<span class="fu">FIRST_VALUE</span>(order_date) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> order_id), <span class="st">&#39;Day&#39;</span>)      <span class="kw">AS</span> wod</span>
<span id="cb69-14"><a href="#cb69-14" tabindex="-1"></a>            <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb69-15"><a href="#cb69-15" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> n_month, n_wod) a</span>
<span id="cb69-16"><a href="#cb69-16" tabindex="-1"></a>      <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">month</span>, n_month, wod, n_wod) a</span>
<span id="cb69-17"><a href="#cb69-17" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n_month, n_wod;</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>heat</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["month"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n_month"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["wod"],"name":[3],"type":["chr"],"align":["left"]},{"label":["n_wod"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["count_orders"],"name":[5],"type":["int"],"align":["right"]},{"label":["proc"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"January","2":"1","3":"Monday","4":"1","5":"225","6":"0.0089874176"},{"1":"January","2":"1","3":"Tuesday","4":"2","5":"203","6":"0.0081086479"},{"1":"January","2":"1","3":"Wednesday","4":"3","5":"234","6":"0.0093469143"},{"1":"January","2":"1","3":"Thursday","4":"4","5":"218","6":"0.0087078091"},{"1":"January","2":"1","3":"Friday","4":"5","5":"224","6":"0.0089474735"},{"1":"January","2":"1","3":"Saturday","4":"6","5":"106","6":"0.0042340723"},{"1":"January","2":"1","3":"Sunday","4":"7","5":"28","6":"0.0011184342"},{"1":"February","2":"2","3":"Monday","4":"1","5":"200","6":"0.0079888157"},{"1":"February","2":"2","3":"Tuesday","4":"2","5":"184","6":"0.0073497104"},{"1":"February","2":"2","3":"Wednesday","4":"3","5":"191","6":"0.0076293190"},{"1":"February","2":"2","3":"Thursday","4":"4","5":"176","6":"0.0070301578"},{"1":"February","2":"2","3":"Friday","4":"5","5":"196","6":"0.0078290393"},{"1":"February","2":"2","3":"Saturday","4":"6","5":"101","6":"0.0040343519"},{"1":"February","2":"2","3":"Sunday","4":"7","5":"14","6":"0.0005592171"},{"1":"March","2":"3","3":"Monday","4":"1","5":"298","6":"0.0119033353"},{"1":"March","2":"3","3":"Tuesday","4":"2","5":"275","6":"0.0109846215"},{"1":"March","2":"3","3":"Wednesday","4":"3","5":"242","6":"0.0096664669"},{"1":"March","2":"3","3":"Thursday","4":"4","5":"253","6":"0.0101058518"},{"1":"March","2":"3","3":"Friday","4":"5","5":"279","6":"0.0111443978"},{"1":"March","2":"3","3":"Saturday","4":"6","5":"151","6":"0.0060315558"},{"1":"March","2":"3","3":"Sunday","4":"7","5":"24","6":"0.0009586579"},{"1":"April","2":"4","3":"Monday","4":"1","5":"271","6":"0.0108248452"},{"1":"April","2":"4","3":"Tuesday","4":"2","5":"266","6":"0.0106251248"},{"1":"April","2":"4","3":"Wednesday","4":"3","5":"259","6":"0.0103455163"},{"1":"April","2":"4","3":"Thursday","4":"4","5":"230","6":"0.0091871380"},{"1":"April","2":"4","3":"Friday","4":"5","5":"257","6":"0.0102656281"},{"1":"April","2":"4","3":"Saturday","4":"6","5":"142","6":"0.0056720591"},{"1":"April","2":"4","3":"Sunday","4":"7","5":"33","6":"0.0013181546"},{"1":"May","2":"5","3":"Monday","4":"1","5":"297","6":"0.0118633913"},{"1":"May","2":"5","3":"Tuesday","4":"2","5":"322","6":"0.0128619932"},{"1":"May","2":"5","3":"Wednesday","4":"3","5":"331","6":"0.0132214899"},{"1":"May","2":"5","3":"Thursday","4":"4","5":"350","6":"0.0139804274"},{"1":"May","2":"5","3":"Friday","4":"5","5":"354","6":"0.0141402037"},{"1":"May","2":"5","3":"Saturday","4":"6","5":"164","6":"0.0065508288"},{"1":"May","2":"5","3":"Sunday","4":"7","5":"34","6":"0.0013580987"},{"1":"June","2":"6","3":"Monday","4":"1","5":"512","6":"0.0204513681"},{"1":"June","2":"6","3":"Tuesday","4":"2","5":"438","6":"0.0174955063"},{"1":"June","2":"6","3":"Wednesday","4":"3","5":"492","6":"0.0196524865"},{"1":"June","2":"6","3":"Thursday","4":"4","5":"405","6":"0.0161773517"},{"1":"June","2":"6","3":"Friday","4":"5","5":"449","6":"0.0179348912"},{"1":"June","2":"6","3":"Saturday","4":"6","5":"248","6":"0.0099061314"},{"1":"June","2":"6","3":"Sunday","4":"7","5":"53","6":"0.0021170361"},{"1":"July","2":"7","3":"Monday","4":"1","5":"281","6":"0.0112242860"},{"1":"July","2":"7","3":"Tuesday","4":"2","5":"296","6":"0.0118234472"},{"1":"July","2":"7","3":"Wednesday","4":"3","5":"288","6":"0.0115038945"},{"1":"July","2":"7","3":"Thursday","4":"4","5":"255","6":"0.0101857400"},{"1":"July","2":"7","3":"Friday","4":"5","5":"220","6":"0.0087876972"},{"1":"July","2":"7","3":"Saturday","4":"6","5":"157","6":"0.0062712203"},{"1":"July","2":"7","3":"Sunday","4":"7","5":"32","6":"0.0012782105"},{"1":"August","2":"8","3":"Monday","4":"1","5":"396","6":"0.0158178550"},{"1":"August","2":"8","3":"Tuesday","4":"2","5":"419","6":"0.0167365688"},{"1":"August","2":"8","3":"Wednesday","4":"3","5":"424","6":"0.0169362892"},{"1":"August","2":"8","3":"Thursday","4":"4","5":"437","6":"0.0174555622"},{"1":"August","2":"8","3":"Friday","4":"5","5":"487","6":"0.0194527661"},{"1":"August","2":"8","3":"Saturday","4":"6","5":"221","6":"0.0088276413"},{"1":"August","2":"8","3":"Sunday","4":"7","5":"43","6":"0.0017175954"},{"1":"September","2":"9","3":"Monday","4":"1","5":"562","6":"0.0224485720"},{"1":"September","2":"9","3":"Tuesday","4":"2","5":"540","6":"0.0215698023"},{"1":"September","2":"9","3":"Wednesday","4":"3","5":"477","6":"0.0190533253"},{"1":"September","2":"9","3":"Thursday","4":"4","5":"523","6":"0.0208907529"},{"1":"September","2":"9","3":"Friday","4":"5","5":"552","6":"0.0220491312"},{"1":"September","2":"9","3":"Saturday","4":"6","5":"240","6":"0.0095865788"},{"1":"September","2":"9","3":"Sunday","4":"7","5":"50","6":"0.0019972039"},{"1":"October","2":"10","3":"Monday","4":"1","5":"392","6":"0.0156580787"},{"1":"October","2":"10","3":"Tuesday","4":"2","5":"407","6":"0.0162572399"},{"1":"October","2":"10","3":"Wednesday","4":"3","5":"436","6":"0.0174156181"},{"1":"October","2":"10","3":"Thursday","4":"4","5":"395","6":"0.0157779109"},{"1":"October","2":"10","3":"Friday","4":"5","5":"419","6":"0.0167365688"},{"1":"October","2":"10","3":"Saturday","4":"6","5":"166","6":"0.0066307170"},{"1":"October","2":"10","3":"Sunday","4":"7","5":"37","6":"0.0014779309"},{"1":"November","2":"11","3":"Monday","4":"1","5":"515","6":"0.0205712003"},{"1":"November","2":"11","3":"Tuesday","4":"2","5":"579","6":"0.0231276213"},{"1":"November","2":"11","3":"Wednesday","4":"3","5":"516","6":"0.0206111444"},{"1":"November","2":"11","3":"Thursday","4":"4","5":"545","6":"0.0217695227"},{"1":"November","2":"11","3":"Friday","4":"5","5":"556","6":"0.0222089075"},{"1":"November","2":"11","3":"Saturday","4":"6","5":"290","6":"0.0115837827"},{"1":"November","2":"11","3":"Sunday","4":"7","5":"64","6":"0.0025564210"},{"1":"December","2":"12","3":"Monday","4":"1","5":"568","6":"0.0226882365"},{"1":"December","2":"12","3":"Tuesday","4":"2","5":"593","6":"0.0236868384"},{"1":"December","2":"12","3":"Wednesday","4":"3","5":"538","6":"0.0214899141"},{"1":"December","2":"12","3":"Thursday","4":"4","5":"550","6":"0.0219692431"},{"1":"December","2":"12","3":"Friday","4":"5","5":"511","6":"0.0204114240"},{"1":"December","2":"12","3":"Saturday","4":"6","5":"271","6":"0.0108248452"},{"1":"December","2":"12","3":"Sunday","4":"7","5":"58","6":"0.0023167565"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>heat <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a>    <span class="at">wod =</span> <span class="fu">as.factor</span>(wod),</span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">as.factor</span>(month)</span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-6"><a href="#cb71-6" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-7"><a href="#cb71-7" tabindex="-1"></a>    <span class="at">wod =</span> <span class="fu">fct_reorder</span>(wod, n_wod),</span>
<span id="cb71-8"><a href="#cb71-8" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">fct_reorder</span>(month, <span class="sc">-</span>n_month)</span>
<span id="cb71-9"><a href="#cb71-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb71-10"><a href="#cb71-10" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> wod, <span class="at">y =</span> month, <span class="at">fill =</span> proc)) <span class="sc">+</span></span>
<span id="cb71-11"><a href="#cb71-11" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-12"><a href="#cb71-12" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">high =</span> <span class="st">&quot;red&quot;</span>, <span class="at">low =</span> <span class="st">&quot;white&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb71-13"><a href="#cb71-13" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb71-14"><a href="#cb71-14" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-15"><a href="#cb71-15" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Sales heat map by day of week and month from 2011 to 2014&quot;</span>,</span>
<span id="cb71-16"><a href="#cb71-16" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Weekday&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Month&quot;</span></span>
<span id="cb71-17"><a href="#cb71-17" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-73-1.png" width="100%" /></p>
</div>
<div id="top-5-returnable-sub-categories-by-merket"
class="section level2">
<h2>Top 5 returnable sub-categories by merket</h2>
<div class="sourceCode" id="cb72"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a></span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a><span class="kw">SELECT</span> a.market,</span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a>       a.new_sub_category <span class="kw">AS</span> sub_category,</span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a>       <span class="fu">SUM</span>(a.perc)        <span class="kw">AS</span> perc</span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a><span class="kw">FROM</span> (<span class="kw">SELECT</span> a.market,</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a>             a.perc,</span>
<span id="cb72-7"><a href="#cb72-7" tabindex="-1"></a>             <span class="cf">CASE</span></span>
<span id="cb72-8"><a href="#cb72-8" tabindex="-1"></a>                 <span class="cf">WHEN</span> <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market <span class="kw">ORDER</span> <span class="kw">BY</span> perc <span class="kw">DESC</span>) <span class="op">&lt;=</span> <span class="dv">5</span> <span class="cf">THEN</span> sub_category</span>
<span id="cb72-9"><a href="#cb72-9" tabindex="-1"></a>                 <span class="cf">ELSE</span> <span class="st">&#39;Other&#39;</span></span>
<span id="cb72-10"><a href="#cb72-10" tabindex="-1"></a>                 <span class="cf">END</span> <span class="kw">AS</span> new_sub_category</span>
<span id="cb72-11"><a href="#cb72-11" tabindex="-1"></a>      <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market,</span>
<span id="cb72-12"><a href="#cb72-12" tabindex="-1"></a>                            sub_category,</span>
<span id="cb72-13"><a href="#cb72-13" tabindex="-1"></a>                            <span class="fu">ROUND</span>(<span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, sub_category) <span class="op">/</span></span>
<span id="cb72-14"><a href="#cb72-14" tabindex="-1"></a>                                  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market):<span class="ch">:numeric</span>, <span class="dv">3</span>) <span class="kw">AS</span> perc</span>
<span id="cb72-15"><a href="#cb72-15" tabindex="-1"></a>            <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb72-16"><a href="#cb72-16" tabindex="-1"></a>            <span class="kw">WHERE</span> returned</span>
<span id="cb72-17"><a href="#cb72-17" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> market, perc <span class="kw">DESC</span>) a) a</span>
<span id="cb72-18"><a href="#cb72-18" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> market, sub_category</span>
<span id="cb72-19"><a href="#cb72-19" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> market, perc <span class="kw">DESC</span>;</span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>returnable_sub_category</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["sub_category"],"name":[2],"type":["chr"],"align":["left"]},{"label":["perc"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"APAC","2":"Other","3":"0.594"},{"1":"APAC","2":"Chairs","3":"0.093"},{"1":"APAC","2":"Storage","3":"0.083"},{"1":"APAC","2":"Binders","3":"0.080"},{"1":"APAC","2":"Fasteners","3":"0.079"},{"1":"APAC","2":"Accessories","3":"0.073"},{"1":"EU","2":"Other","3":"0.482"},{"1":"EU","2":"Art","3":"0.146"},{"1":"EU","2":"Storage","3":"0.100"},{"1":"EU","2":"Binders","3":"0.096"},{"1":"EU","2":"Accessories","3":"0.060"},{"1":"EU","2":"Bookcases","3":"0.058"},{"1":"EU","2":"Copiers","3":"0.058"},{"1":"LATAM","2":"Other","3":"0.593"},{"1":"LATAM","2":"Binders","3":"0.094"},{"1":"LATAM","2":"Chairs","3":"0.088"},{"1":"LATAM","2":"Storage","3":"0.077"},{"1":"LATAM","2":"Accessories","3":"0.076"},{"1":"LATAM","2":"Fasteners","3":"0.073"},{"1":"US","2":"Other","3":"0.412"},{"1":"US","2":"Binders","3":"0.171"},{"1":"US","2":"Paper","3":"0.154"},{"1":"US","2":"Phones","3":"0.096"},{"1":"US","2":"Furnishings","3":"0.090"},{"1":"US","2":"Accessories","3":"0.076"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="cf">for</span> (market <span class="cf">in</span> <span class="fu">unique</span>(returnable_sub_category<span class="sc">$</span>market)) {</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>  <span class="fu">print</span>(</span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a>    returnable_sub_category[returnable_sub_category<span class="sc">$</span>market <span class="sc">==</span></span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a>      market, ] <span class="sc">%&gt;%</span></span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a>      <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> perc, <span class="at">fill =</span> sub_category)) <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a>      <span class="fu">geom_col</span>() <span class="sc">+</span> <span class="fu">geom_text</span>(</span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(perc)),</span>
<span id="cb74-8"><a href="#cb74-8" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb74-9"><a href="#cb74-9" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb74-10"><a href="#cb74-10" tabindex="-1"></a>      <span class="fu">coord_polar</span>(<span class="at">theta =</span> <span class="st">&quot;y&quot;</span>) <span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb74-12"><a href="#cb74-12" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(</span>
<span id="cb74-13"><a href="#cb74-13" tabindex="-1"></a>          <span class="st">&quot;Top 5 returnable sub-categories in&quot;</span>,</span>
<span id="cb74-14"><a href="#cb74-14" tabindex="-1"></a>          market, <span class="st">&quot;market&quot;</span></span>
<span id="cb74-15"><a href="#cb74-15" tabindex="-1"></a>        ),</span>
<span id="cb74-16"><a href="#cb74-16" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;Sub-Category&quot;</span></span>
<span id="cb74-17"><a href="#cb74-17" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb74-18"><a href="#cb74-18" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb74-19"><a href="#cb74-19" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-20"><a href="#cb74-20" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-21"><a href="#cb74-21" tabindex="-1"></a>        <span class="at">panel.border =</span> <span class="fu">element_blank</span>()</span>
<span id="cb74-22"><a href="#cb74-22" tabindex="-1"></a>      )</span>
<span id="cb74-23"><a href="#cb74-23" tabindex="-1"></a>  )</span>
<span id="cb74-24"><a href="#cb74-24" tabindex="-1"></a></span>
<span id="cb74-25"><a href="#cb74-25" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-76-1.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-76-2.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-76-3.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-76-4.png" width="100%" /></p>
</div>
<div id="what-are-number-of-total-and-new-customers"
class="section level2">
<h2>What are number of total and new customers?</h2>
<div class="sourceCode" id="cb75"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a></span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a><span class="kw">WITH</span> cte_timespot <span class="kw">AS</span> (<span class="kw">SELECT</span> m.market, a.<span class="dt">year</span>, a.quarter</span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>                      <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market <span class="kw">FROM</span> analysis.all_global_orders) m</span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>                               <span class="kw">CROSS</span> <span class="kw">JOIN</span></span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a>                           (<span class="kw">SELECT</span> b.<span class="dt">year</span>, a.quarter</span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>                            <span class="kw">FROM</span> (<span class="kw">SELECT</span> UNNEST(<span class="dt">ARRAY</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]) <span class="kw">AS</span> quarter) a</span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a>                                     <span class="kw">CROSS</span> <span class="kw">JOIN</span></span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a>                                     (<span class="kw">SELECT</span> UNNEST(<span class="dt">ARRAY</span> [<span class="dv">2011</span>, <span class="dv">2012</span>, <span class="dv">2013</span>, <span class="dv">2014</span>]) <span class="kw">AS</span> <span class="dt">year</span>) b</span>
<span id="cb75-9"><a href="#cb75-9" tabindex="-1"></a>                            <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>) a</span>
<span id="cb75-10"><a href="#cb75-10" tabindex="-1"></a>                      <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb75-11"><a href="#cb75-11" tabindex="-1"></a>     cte_unique_customers <span class="kw">AS</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb75-12"><a href="#cb75-12" tabindex="-1"></a>                                     <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date)    <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb75-13"><a href="#cb75-13" tabindex="-1"></a>                                     <span class="fu">EXTRACT</span>(QUARTER <span class="kw">FROM</span> order_date) <span class="kw">AS</span> quarter,</span>
<span id="cb75-14"><a href="#cb75-14" tabindex="-1"></a>                                     <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id)      <span class="kw">AS</span> unique_customers</span>
<span id="cb75-15"><a href="#cb75-15" tabindex="-1"></a>                              <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb75-16"><a href="#cb75-16" tabindex="-1"></a>                              <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb75-17"><a href="#cb75-17" tabindex="-1"></a>     cte_new_customers <span class="kw">AS</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb75-18"><a href="#cb75-18" tabindex="-1"></a>                                  <span class="dt">year</span>,</span>
<span id="cb75-19"><a href="#cb75-19" tabindex="-1"></a>                                  quarter,</span>
<span id="cb75-20"><a href="#cb75-20" tabindex="-1"></a>                                  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> new_customers</span>
<span id="cb75-21"><a href="#cb75-21" tabindex="-1"></a>                           <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> market,</span>
<span id="cb75-22"><a href="#cb75-22" tabindex="-1"></a>                                                 customer_id,</span>
<span id="cb75-23"><a href="#cb75-23" tabindex="-1"></a>                                                 <span class="fu">FIRST_VALUE</span>(<span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date))</span>
<span id="cb75-24"><a href="#cb75-24" tabindex="-1"></a>                                                 <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, customer_id <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date))                                   <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb75-25"><a href="#cb75-25" tabindex="-1"></a>                                                 <span class="fu">FIRST_VALUE</span>(<span class="fu">EXTRACT</span>(QUARTER <span class="kw">FROM</span> order_date))</span>
<span id="cb75-26"><a href="#cb75-26" tabindex="-1"></a>                                                 <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, customer_id <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date), <span class="fu">EXTRACT</span>(QUARTER <span class="kw">FROM</span> order_date)) <span class="kw">AS</span> quarter</span>
<span id="cb75-27"><a href="#cb75-27" tabindex="-1"></a>                                 <span class="kw">FROM</span> analysis.all_global_orders) a</span>
<span id="cb75-28"><a href="#cb75-28" tabindex="-1"></a>                           <span class="kw">GROUP</span> <span class="kw">BY</span> market, <span class="dt">year</span>, quarter)</span>
<span id="cb75-29"><a href="#cb75-29" tabindex="-1"></a><span class="kw">SELECT</span> a.market,</span>
<span id="cb75-30"><a href="#cb75-30" tabindex="-1"></a>       a.<span class="dt">year</span>,</span>
<span id="cb75-31"><a href="#cb75-31" tabindex="-1"></a>       a.quarter,</span>
<span id="cb75-32"><a href="#cb75-32" tabindex="-1"></a>       a.unique_customers:<span class="ch">:INT</span>,</span>
<span id="cb75-33"><a href="#cb75-33" tabindex="-1"></a>       <span class="fu">COALESCE</span>(b.new_customers, <span class="dv">0</span>):<span class="ch">:INT</span> <span class="kw">AS</span> new_customers,</span>
<span id="cb75-34"><a href="#cb75-34" tabindex="-1"></a>       <span class="fu">CONCAT</span>(<span class="st">&#39;Q&#39;</span>, a.quarter, <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>, SUBSTRING(TEXT(a.<span class="dt">year</span>), <span class="dv">3</span>, <span class="dv">2</span>))               <span class="kw">AS</span> qy,</span>
<span id="cb75-35"><a href="#cb75-35" tabindex="-1"></a>       <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> a.market <span class="kw">ORDER</span> <span class="kw">BY</span> a.<span class="dt">year</span>, a.quarter):<span class="ch">:INT</span> <span class="kw">AS</span> n</span>
<span id="cb75-36"><a href="#cb75-36" tabindex="-1"></a><span class="kw">FROM</span> cte_timespot t</span>
<span id="cb75-37"><a href="#cb75-37" tabindex="-1"></a>         <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb75-38"><a href="#cb75-38" tabindex="-1"></a>     cte_unique_customers a <span class="kw">ON</span> t.market <span class="op">=</span> a.market <span class="kw">AND</span> t.<span class="dt">year</span> <span class="op">=</span> a.<span class="dt">year</span> <span class="kw">AND</span> t.quarter <span class="op">=</span> a.quarter</span>
<span id="cb75-39"><a href="#cb75-39" tabindex="-1"></a>         <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb75-40"><a href="#cb75-40" tabindex="-1"></a>     cte_new_customers b <span class="kw">ON</span> a.market <span class="op">=</span> b.market <span class="kw">AND</span> a.<span class="dt">year</span> <span class="op">=</span> b.<span class="dt">year</span> <span class="kw">AND</span> a.quarter <span class="op">=</span> b.quarter;</span></code></pre></div>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>new_total_customers</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["quarter"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["unique_customers"],"name":[4],"type":["int"],"align":["right"]},{"label":["new_customers"],"name":[5],"type":["int"],"align":["right"]},{"label":["qy"],"name":[6],"type":["chr"],"align":["left"]},{"label":["n"],"name":[7],"type":["int"],"align":["right"]}],"data":[{"1":"Africa","2":"2011","3":"1","4":"71","5":"71","6":"Q1'11","7":"1"},{"1":"Africa","2":"2011","3":"2","4":"86","5":"78","6":"Q2'11","7":"2"},{"1":"Africa","2":"2011","3":"3","4":"90","5":"73","6":"Q3'11","7":"3"},{"1":"Africa","2":"2011","3":"4","4":"115","5":"80","6":"Q4'11","7":"4"},{"1":"Africa","2":"2012","3":"1","4":"81","5":"59","6":"Q1'12","7":"5"},{"1":"Africa","2":"2012","3":"2","4":"87","5":"48","6":"Q2'12","7":"6"},{"1":"Africa","2":"2012","3":"3","4":"124","5":"65","6":"Q3'12","7":"7"},{"1":"Africa","2":"2012","3":"4","4":"113","5":"39","6":"Q4'12","7":"8"},{"1":"Africa","2":"2013","3":"1","4":"107","5":"43","6":"Q1'13","7":"9"},{"1":"Africa","2":"2013","3":"2","4":"125","5":"40","6":"Q2'13","7":"10"},{"1":"Africa","2":"2013","3":"3","4":"171","5":"39","6":"Q3'13","7":"11"},{"1":"Africa","2":"2013","3":"4","4":"167","5":"35","6":"Q4'13","7":"12"},{"1":"Africa","2":"2014","3":"1","4":"134","5":"20","6":"Q1'14","7":"13"},{"1":"Africa","2":"2014","3":"2","4":"191","5":"33","6":"Q2'14","7":"14"},{"1":"Africa","2":"2014","3":"3","4":"180","5":"18","6":"Q3'14","7":"15"},{"1":"Africa","2":"2014","3":"4","4":"229","5":"13","6":"Q4'14","7":"16"},{"1":"APAC","2":"2011","3":"1","4":"144","5":"144","6":"Q1'11","7":"1"},{"1":"APAC","2":"2011","3":"2","4":"179","5":"148","6":"Q2'11","7":"2"},{"1":"APAC","2":"2011","3":"3","4":"211","5":"144","6":"Q3'11","7":"3"},{"1":"APAC","2":"2011","3":"4","4":"291","5":"136","6":"Q4'11","7":"4"},{"1":"APAC","2":"2012","3":"1","4":"158","5":"39","6":"Q1'12","7":"5"},{"1":"APAC","2":"2012","3":"2","4":"269","5":"62","6":"Q2'12","7":"6"},{"1":"APAC","2":"2012","3":"3","4":"244","5":"27","6":"Q3'12","7":"7"},{"1":"APAC","2":"2012","3":"4","4":"314","5":"39","6":"Q4'12","7":"8"},{"1":"APAC","2":"2013","3":"1","4":"174","5":"13","6":"Q1'13","7":"9"},{"1":"APAC","2":"2013","3":"2","4":"300","5":"19","6":"Q2'13","7":"10"},{"1":"APAC","2":"2013","3":"3","4":"307","5":"13","6":"Q3'13","7":"11"},{"1":"APAC","2":"2013","3":"4","4":"332","5":"6","6":"Q4'13","7":"12"},{"1":"APAC","2":"2014","3":"1","4":"253","5":"1","6":"Q1'14","7":"13"},{"1":"APAC","2":"2014","3":"2","4":"355","5":"4","6":"Q2'14","7":"14"},{"1":"APAC","2":"2014","3":"3","4":"358","5":"0","6":"Q3'14","7":"15"},{"1":"APAC","2":"2014","3":"4","4":"433","5":"1","6":"Q4'14","7":"16"},{"1":"Canada","2":"2011","3":"1","4":"7","5":"7","6":"Q1'11","7":"1"},{"1":"Canada","2":"2011","3":"2","4":"9","5":"9","6":"Q2'11","7":"2"},{"1":"Canada","2":"2011","3":"3","4":"12","5":"12","6":"Q3'11","7":"3"},{"1":"Canada","2":"2011","3":"4","4":"8","5":"8","6":"Q4'11","7":"4"},{"1":"Canada","2":"2012","3":"1","4":"3","5":"2","6":"Q1'12","7":"5"},{"1":"Canada","2":"2012","3":"2","4":"19","5":"19","6":"Q2'12","7":"6"},{"1":"Canada","2":"2012","3":"3","4":"14","5":"13","6":"Q3'12","7":"7"},{"1":"Canada","2":"2012","3":"4","4":"12","5":"12","6":"Q4'12","7":"8"},{"1":"Canada","2":"2013","3":"1","4":"14","5":"11","6":"Q1'13","7":"9"},{"1":"Canada","2":"2013","3":"2","4":"13","5":"11","6":"Q2'13","7":"10"},{"1":"Canada","2":"2013","3":"3","4":"14","5":"11","6":"Q3'13","7":"11"},{"1":"Canada","2":"2013","3":"4","4":"15","5":"13","6":"Q4'13","7":"12"},{"1":"Canada","2":"2014","3":"1","4":"13","5":"10","6":"Q1'14","7":"13"},{"1":"Canada","2":"2014","3":"2","4":"12","5":"9","6":"Q2'14","7":"14"},{"1":"Canada","2":"2014","3":"3","4":"19","5":"19","6":"Q3'14","7":"15"},{"1":"Canada","2":"2014","3":"4","4":"18","5":"15","6":"Q4'14","7":"16"},{"1":"EMEA","2":"2011","3":"1","4":"59","5":"59","6":"Q1'11","7":"1"},{"1":"EMEA","2":"2011","3":"2","4":"100","5":"91","6":"Q2'11","7":"2"},{"1":"EMEA","2":"2011","3":"3","4":"121","5":"103","6":"Q3'11","7":"3"},{"1":"EMEA","2":"2011","3":"4","4":"109","5":"76","6":"Q4'11","7":"4"},{"1":"EMEA","2":"2012","3":"1","4":"90","5":"51","6":"Q1'12","7":"5"},{"1":"EMEA","2":"2012","3":"2","4":"112","5":"59","6":"Q2'12","7":"6"},{"1":"EMEA","2":"2012","3":"3","4":"140","5":"58","6":"Q3'12","7":"7"},{"1":"EMEA","2":"2012","3":"4","4":"131","5":"49","6":"Q4'12","7":"8"},{"1":"EMEA","2":"2013","3":"1","4":"107","5":"28","6":"Q1'13","7":"9"},{"1":"EMEA","2":"2013","3":"2","4":"150","5":"37","6":"Q2'13","7":"10"},{"1":"EMEA","2":"2013","3":"3","4":"178","5":"41","6":"Q3'13","7":"11"},{"1":"EMEA","2":"2013","3":"4","4":"175","5":"35","6":"Q4'13","7":"12"},{"1":"EMEA","2":"2014","3":"1","4":"145","5":"14","6":"Q1'14","7":"13"},{"1":"EMEA","2":"2014","3":"2","4":"193","5":"22","6":"Q2'14","7":"14"},{"1":"EMEA","2":"2014","3":"3","4":"249","5":"23","6":"Q3'14","7":"15"},{"1":"EMEA","2":"2014","3":"4","4":"222","5":"14","6":"Q4'14","7":"16"},{"1":"EU","2":"2011","3":"1","4":"131","5":"131","6":"Q1'11","7":"1"},{"1":"EU","2":"2011","3":"2","4":"182","5":"153","6":"Q2'11","7":"2"},{"1":"EU","2":"2011","3":"3","4":"214","5":"134","6":"Q3'11","7":"3"},{"1":"EU","2":"2011","3":"4","4":"222","5":"115","6":"Q4'11","7":"4"},{"1":"EU","2":"2012","3":"1","4":"174","5":"60","6":"Q1'12","7":"5"},{"1":"EU","2":"2012","3":"2","4":"217","5":"56","6":"Q2'12","7":"6"},{"1":"EU","2":"2012","3":"3","4":"295","5":"58","6":"Q3'12","7":"7"},{"1":"EU","2":"2012","3":"4","4":"283","5":"24","6":"Q4'12","7":"8"},{"1":"EU","2":"2013","3":"1","4":"218","5":"24","6":"Q1'13","7":"9"},{"1":"EU","2":"2013","3":"2","4":"246","5":"14","6":"Q2'13","7":"10"},{"1":"EU","2":"2013","3":"3","4":"331","5":"12","6":"Q3'13","7":"11"},{"1":"EU","2":"2013","3":"4","4":"315","5":"9","6":"Q4'13","7":"12"},{"1":"EU","2":"2014","3":"1","4":"256","5":"2","6":"Q1'14","7":"13"},{"1":"EU","2":"2014","3":"2","4":"302","5":"0","6":"Q2'14","7":"14"},{"1":"EU","2":"2014","3":"3","4":"396","5":"3","6":"Q3'14","7":"15"},{"1":"EU","2":"2014","3":"4","4":"400","5":"0","6":"Q4'14","7":"16"},{"1":"LATAM","2":"2011","3":"1","4":"92","5":"92","6":"Q1'11","7":"1"},{"1":"LATAM","2":"2011","3":"2","4":"185","5":"164","6":"Q2'11","7":"2"},{"1":"LATAM","2":"2011","3":"3","4":"170","5":"108","6":"Q3'11","7":"3"},{"1":"LATAM","2":"2011","3":"4","4":"288","5":"159","6":"Q4'11","7":"4"},{"1":"LATAM","2":"2012","3":"1","4":"113","5":"37","6":"Q1'12","7":"5"},{"1":"LATAM","2":"2012","3":"2","4":"228","5":"70","6":"Q2'12","7":"6"},{"1":"LATAM","2":"2012","3":"3","4":"212","5":"48","6":"Q3'12","7":"7"},{"1":"LATAM","2":"2012","3":"4","4":"329","5":"42","6":"Q4'12","7":"8"},{"1":"LATAM","2":"2013","3":"1","4":"167","5":"16","6":"Q1'13","7":"9"},{"1":"LATAM","2":"2013","3":"2","4":"280","5":"20","6":"Q2'13","7":"10"},{"1":"LATAM","2":"2013","3":"3","4":"301","5":"16","6":"Q3'13","7":"11"},{"1":"LATAM","2":"2013","3":"4","4":"380","5":"9","6":"Q4'13","7":"12"},{"1":"LATAM","2":"2014","3":"1","4":"174","5":"5","6":"Q1'14","7":"13"},{"1":"LATAM","2":"2014","3":"2","4":"318","5":"4","6":"Q2'14","7":"14"},{"1":"LATAM","2":"2014","3":"3","4":"318","5":"1","6":"Q3'14","7":"15"},{"1":"LATAM","2":"2014","3":"4","4":"422","5":"3","6":"Q4'14","7":"16"},{"1":"US","2":"2011","3":"1","4":"121","5":"121","6":"Q1'11","7":"1"},{"1":"US","2":"2011","3":"2","4":"180","5":"160","6":"Q2'11","7":"2"},{"1":"US","2":"2011","3":"3","4":"228","5":"161","6":"Q3'11","7":"3"},{"1":"US","2":"2011","3":"4","4":"305","5":"153","6":"Q4'11","7":"4"},{"1":"US","2":"2012","3":"1","4":"135","5":"32","6":"Q1'12","7":"5"},{"1":"US","2":"2012","3":"2","4":"192","5":"36","6":"Q2'12","7":"6"},{"1":"US","2":"2012","3":"3","4":"233","5":"36","6":"Q3'12","7":"7"},{"1":"US","2":"2012","3":"4","4":"310","5":"32","6":"Q4'12","7":"8"},{"1":"US","2":"2013","3":"1","4":"160","5":"14","6":"Q1'13","7":"9"},{"1":"US","2":"2013","3":"2","4":"239","5":"22","6":"Q2'13","7":"10"},{"1":"US","2":"2013","3":"3","4":"300","5":"6","6":"Q3'13","7":"11"},{"1":"US","2":"2013","3":"4","4":"344","5":"9","6":"Q4'13","7":"12"},{"1":"US","2":"2014","3":"1","4":"212","5":"3","6":"Q1'14","7":"13"},{"1":"US","2":"2014","3":"2","4":"289","5":"2","6":"Q2'14","7":"14"},{"1":"US","2":"2014","3":"3","4":"346","5":"3","6":"Q3'14","7":"15"},{"1":"US","2":"2014","3":"4","4":"439","5":"3","6":"Q4'14","7":"16"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="cf">for</span> (market <span class="cf">in</span> <span class="fu">unique</span>(new_total_customers<span class="sc">$</span>market)) {</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>    new_total_customers[new_total_customers<span class="sc">$</span>market <span class="sc">==</span></span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>      market, ]</span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6" tabindex="-1"></a>    <span class="fu">geom_bar</span>(</span>
<span id="cb77-7"><a href="#cb77-7" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb77-8"><a href="#cb77-8" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb77-9"><a href="#cb77-9" tabindex="-1"></a>        <span class="at">y =</span> unique_customers, <span class="at">fill =</span> <span class="st">&quot;Unique Customers&quot;</span></span>
<span id="cb77-10"><a href="#cb77-10" tabindex="-1"></a>      ),</span>
<span id="cb77-11"><a href="#cb77-11" tabindex="-1"></a>      <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span></span>
<span id="cb77-12"><a href="#cb77-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-13"><a href="#cb77-13" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb77-14"><a href="#cb77-14" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb77-15"><a href="#cb77-15" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb77-16"><a href="#cb77-16" tabindex="-1"></a>        <span class="at">y =</span> new_customers, <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;New Customers&quot;</span></span>
<span id="cb77-17"><a href="#cb77-17" tabindex="-1"></a>      ),</span>
<span id="cb77-18"><a href="#cb77-18" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb77-19"><a href="#cb77-19" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-20"><a href="#cb77-20" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb77-21"><a href="#cb77-21" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb77-22"><a href="#cb77-22" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb77-23"><a href="#cb77-23" tabindex="-1"></a>        <span class="at">y =</span> new_customers, <span class="at">color =</span> <span class="st">&quot;New Customers&quot;</span></span>
<span id="cb77-24"><a href="#cb77-24" tabindex="-1"></a>      ),</span>
<span id="cb77-25"><a href="#cb77-25" tabindex="-1"></a>      <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb77-26"><a href="#cb77-26" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-27"><a href="#cb77-27" tabindex="-1"></a>    <span class="fu">geom_text</span>(</span>
<span id="cb77-28"><a href="#cb77-28" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb77-29"><a href="#cb77-29" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb77-30"><a href="#cb77-30" tabindex="-1"></a>        <span class="at">y =</span> new_customers, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">number</span>(new_customers)</span>
<span id="cb77-31"><a href="#cb77-31" tabindex="-1"></a>      ),</span>
<span id="cb77-32"><a href="#cb77-32" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">3</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.2</span></span>
<span id="cb77-33"><a href="#cb77-33" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-34"><a href="#cb77-34" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb77-35"><a href="#cb77-35" tabindex="-1"></a>      <span class="at">xintercept =</span> <span class="fu">seq</span>(<span class="fl">4.5</span>, <span class="fl">12.5</span>, <span class="dv">4</span>),</span>
<span id="cb77-36"><a href="#cb77-36" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span></span>
<span id="cb77-37"><a href="#cb77-37" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-38"><a href="#cb77-38" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb77-39"><a href="#cb77-39" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Unique Customers</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#e5bc8b&quot;</span>)</span>
<span id="cb77-40"><a href="#cb77-40" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-41"><a href="#cb77-41" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb77-42"><a href="#cb77-42" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">New Customers</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#003f5c&quot;</span>)</span>
<span id="cb77-43"><a href="#cb77-43" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-44"><a href="#cb77-44" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb77-45"><a href="#cb77-45" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(</span>
<span id="cb77-46"><a href="#cb77-46" tabindex="-1"></a>        <span class="dv">0</span>, <span class="fu">max</span>(</span>
<span id="cb77-47"><a href="#cb77-47" tabindex="-1"></a>          new_total_customers[new_total_customers<span class="sc">$</span>market <span class="sc">==</span></span>
<span id="cb77-48"><a href="#cb77-48" tabindex="-1"></a>          market, ]<span class="sc">$</span>unique_customers</span>
<span id="cb77-49"><a href="#cb77-49" tabindex="-1"></a>        ) <span class="sc">*</span></span>
<span id="cb77-50"><a href="#cb77-50" tabindex="-1"></a>          <span class="fl">1.1</span></span>
<span id="cb77-51"><a href="#cb77-51" tabindex="-1"></a>      )</span>
<span id="cb77-52"><a href="#cb77-52" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-53"><a href="#cb77-53" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb77-54"><a href="#cb77-54" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(</span>
<span id="cb77-55"><a href="#cb77-55" tabindex="-1"></a>        <span class="st">&quot;Total unique and new customers in&quot;</span>,</span>
<span id="cb77-56"><a href="#cb77-56" tabindex="-1"></a>        market, <span class="st">&quot;market&quot;</span></span>
<span id="cb77-57"><a href="#cb77-57" tabindex="-1"></a>      ),</span>
<span id="cb77-58"><a href="#cb77-58" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Number of customers&quot;</span></span>
<span id="cb77-59"><a href="#cb77-59" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-60"><a href="#cb77-60" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb77-61"><a href="#cb77-61" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>()</span>
<span id="cb77-62"><a href="#cb77-62" tabindex="-1"></a>    )</span>
<span id="cb77-63"><a href="#cb77-63" tabindex="-1"></a></span>
<span id="cb77-64"><a href="#cb77-64" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb77-65"><a href="#cb77-65" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-1.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-2.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-3.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-4.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-5.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-6.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-79-7.png" width="100%" /></p>
</div>
<div id="percentage-of-new-business-revenue-generation"
class="section level2">
<h2>Percentage of new business revenue generation</h2>
<div class="sourceCode" id="cb78"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a></span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a><span class="kw">WITH</span> cte_all_orders <span class="kw">AS</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>                               order_id,</span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a>                               order_date,</span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>                               customer_id,</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>                               <span class="fu">SUM</span>(sales) <span class="kw">AS</span> sales</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a>                        <span class="kw">FROM</span> analysis.all_global_orders</span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a>                        <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a>       <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter) <span class="kw">AS</span> n</span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a><span class="kw">FROM</span> (<span class="kw">SELECT</span> market,</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a>             <span class="dt">year</span>,</span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a>             quarter,</span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a>             <span class="fu">CONCAT</span>(<span class="st">&#39;Q&#39;</span>, quarter, <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>, SUBSTRING(TEXT(<span class="dt">year</span>), <span class="dv">3</span>, <span class="dv">2</span>))                           <span class="kw">AS</span> qy,</span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a>             <span class="fu">COALESCE</span>(<span class="fu">SUM</span>(sales) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> first_year), <span class="dv">0</span>)                          <span class="kw">AS</span> new_sales,</span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a>             <span class="fu">SUM</span>(sales)                                                                        <span class="kw">AS</span> total_sales,</span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a>             <span class="fu">ROUND</span>((<span class="fu">COALESCE</span>(<span class="fu">SUM</span>(sales) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> first_year), <span class="dv">0</span>)) <span class="op">/</span> <span class="fu">SUM</span>(sales), <span class="dv">2</span>) <span class="kw">AS</span> proc_new_business</span>
<span id="cb78-19"><a href="#cb78-19" tabindex="-1"></a>      <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="op">*</span>,</span>
<span id="cb78-20"><a href="#cb78-20" tabindex="-1"></a>                   <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date)                               <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb78-21"><a href="#cb78-21" tabindex="-1"></a>                   <span class="fu">EXTRACT</span>(QUARTER <span class="kw">FROM</span> order_date)                            <span class="kw">AS</span> quarter,</span>
<span id="cb78-22"><a href="#cb78-22" tabindex="-1"></a>                   <span class="fu">FIRST_VALUE</span>(<span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date))</span>
<span id="cb78-23"><a href="#cb78-23" tabindex="-1"></a>                   <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> market, customer_id <span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">AS</span> first_year</span>
<span id="cb78-24"><a href="#cb78-24" tabindex="-1"></a>            <span class="kw">FROM</span> cte_all_orders) a</span>
<span id="cb78-25"><a href="#cb78-25" tabindex="-1"></a>      <span class="kw">GROUP</span> <span class="kw">BY</span> market, <span class="dt">year</span>, quarter, qy) a;</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="co"># print results</span></span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>new_business</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["market"],"name":[1],"type":["chr"],"align":["left"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["quarter"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["qy"],"name":[4],"type":["chr"],"align":["left"]},{"label":["new_sales"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["total_sales"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["proc_new_business"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[8],"type":["int64"],"align":["right"]}],"data":[{"1":"Africa","2":"2011","3":"1","4":"Q1'11","5":"24551.94","6":"24551.94","7":"1.00","8":"1"},{"1":"Africa","2":"2011","3":"2","4":"Q2'11","5":"24952.17","6":"24952.17","7":"1.00","8":"2"},{"1":"Africa","2":"2011","3":"3","4":"Q3'11","5":"39421.85","6":"39421.85","7":"1.00","8":"3"},{"1":"Africa","2":"2011","3":"4","4":"Q4'11","5":"38261.32","6":"38261.32","7":"1.00","8":"4"},{"1":"Africa","2":"2012","3":"1","4":"Q1'12","5":"15892.82","6":"18736.87","7":"0.85","8":"5"},{"1":"Africa","2":"2012","3":"2","4":"Q2'12","5":"24945.38","6":"34430.25","7":"0.72","8":"6"},{"1":"Africa","2":"2012","3":"3","4":"Q3'12","5":"27439.14","6":"42288.90","7":"0.65","8":"7"},{"1":"Africa","2":"2012","3":"4","4":"Q4'12","5":"28505.96","6":"49024.74","7":"0.58","8":"8"},{"1":"Africa","2":"2013","3":"1","4":"Q1'13","5":"18462.18","6":"51722.67","7":"0.36","8":"9"},{"1":"Africa","2":"2013","3":"2","4":"Q2'13","5":"14670.71","6":"39292.22","7":"0.37","8":"10"},{"1":"Africa","2":"2013","3":"3","4":"Q3'13","5":"26768.36","6":"73449.71","7":"0.36","8":"11"},{"1":"Africa","2":"2013","3":"4","4":"Q4'13","5":"23823.63","6":"64604.27","7":"0.37","8":"12"},{"1":"Africa","2":"2014","3":"1","4":"Q1'14","5":"5301.01","6":"42164.40","7":"0.13","8":"13"},{"1":"Africa","2":"2014","3":"2","4":"Q2'14","5":"19203.72","6":"73349.57","7":"0.26","8":"14"},{"1":"Africa","2":"2014","3":"3","4":"Q3'14","5":"8227.66","6":"73194.83","7":"0.11","8":"15"},{"1":"Africa","2":"2014","3":"4","4":"Q4'14","5":"16891.90","6":"94327.66","7":"0.18","8":"16"},{"1":"APAC","2":"2011","3":"1","4":"Q1'11","5":"93056.63","6":"93056.63","7":"1.00","8":"1"},{"1":"APAC","2":"2011","3":"2","4":"Q2'11","5":"140930.70","6":"140930.70","7":"1.00","8":"2"},{"1":"APAC","2":"2011","3":"3","4":"Q3'11","5":"152585.64","6":"152585.64","7":"1.00","8":"3"},{"1":"APAC","2":"2011","3":"4","4":"Q4'11","5":"252672.64","6":"252672.64","7":"1.00","8":"4"},{"1":"APAC","2":"2012","3":"1","4":"Q1'12","5":"34389.79","6":"130485.37","7":"0.26","8":"5"},{"1":"APAC","2":"2012","3":"2","4":"Q2'12","5":"44194.19","6":"185016.18","7":"0.24","8":"6"},{"1":"APAC","2":"2012","3":"3","4":"Q3'12","5":"46669.17","6":"172349.48","7":"0.27","8":"7"},{"1":"APAC","2":"2012","3":"4","4":"Q4'12","5":"74886.84","6":"274868.95","7":"0.27","8":"8"},{"1":"APAC","2":"2013","3":"1","4":"Q1'13","5":"10730.39","6":"157968.63","7":"0.07","8":"9"},{"1":"APAC","2":"2013","3":"2","4":"Q2'13","5":"14415.25","6":"259702.03","7":"0.06","8":"10"},{"1":"APAC","2":"2013","3":"3","4":"Q3'13","5":"18941.37","6":"279661.30","7":"0.07","8":"11"},{"1":"APAC","2":"2013","3":"4","4":"Q4'13","5":"21078.38","6":"277249.52","7":"0.08","8":"12"},{"1":"APAC","2":"2014","3":"1","4":"Q1'14","5":"42.64","6":"215939.50","7":"0.00","8":"13"},{"1":"APAC","2":"2014","3":"2","4":"Q2'14","5":"3443.55","6":"269189.36","7":"0.01","8":"14"},{"1":"APAC","2":"2014","3":"3","4":"Q3'14","5":"669.32","6":"304473.58","7":"0.00","8":"15"},{"1":"APAC","2":"2014","3":"4","4":"Q4'14","5":"1586.61","6":"419597.08","7":"0.00","8":"16"},{"1":"Canada","2":"2011","3":"1","4":"Q1'11","5":"2408.16","6":"2408.16","7":"1.00","8":"1"},{"1":"Canada","2":"2011","3":"2","4":"Q2'11","5":"1225.89","6":"1225.89","7":"1.00","8":"2"},{"1":"Canada","2":"2011","3":"3","4":"Q3'11","5":"2585.37","6":"2585.37","7":"1.00","8":"3"},{"1":"Canada","2":"2011","3":"4","4":"Q4'11","5":"2289.69","6":"2289.69","7":"1.00","8":"4"},{"1":"Canada","2":"2012","3":"1","4":"Q1'12","5":"422.07","6":"551.91","7":"0.76","8":"5"},{"1":"Canada","2":"2012","3":"2","4":"Q2'12","5":"8085.57","6":"8085.57","7":"1.00","8":"6"},{"1":"Canada","2":"2012","3":"3","4":"Q3'12","5":"4011.03","6":"4055.22","7":"0.99","8":"7"},{"1":"Canada","2":"2012","3":"4","4":"Q4'12","5":"3404.10","6":"3404.10","7":"1.00","8":"8"},{"1":"Canada","2":"2013","3":"1","4":"Q1'13","5":"2793.54","6":"2841.51","7":"0.98","8":"9"},{"1":"Canada","2":"2013","3":"2","4":"Q2'13","5":"1713.18","6":"2311.56","7":"0.74","8":"10"},{"1":"Canada","2":"2013","3":"3","4":"Q3'13","5":"6579.93","6":"7491.51","7":"0.88","8":"11"},{"1":"Canada","2":"2013","3":"4","4":"Q4'13","5":"6245.58","6":"6516.57","7":"0.96","8":"12"},{"1":"Canada","2":"2014","3":"1","4":"Q1'14","5":"4726.11","6":"5622.96","7":"0.84","8":"13"},{"1":"Canada","2":"2014","3":"2","4":"Q2'14","5":"1189.29","6":"1406.94","7":"0.85","8":"14"},{"1":"Canada","2":"2014","3":"3","4":"Q3'14","5":"5065.41","6":"5065.41","7":"1.00","8":"15"},{"1":"Canada","2":"2014","3":"4","4":"Q4'14","5":"9079.71","6":"11065.80","7":"0.82","8":"16"},{"1":"EMEA","2":"2011","3":"1","4":"Q1'11","5":"29841.73","6":"29841.73","7":"1.00","8":"1"},{"1":"EMEA","2":"2011","3":"2","4":"Q2'11","5":"28027.36","6":"28027.36","7":"1.00","8":"2"},{"1":"EMEA","2":"2011","3":"3","4":"Q3'11","5":"36764.30","6":"36764.30","7":"1.00","8":"3"},{"1":"EMEA","2":"2011","3":"4","4":"Q4'11","5":"41786.82","6":"41786.82","7":"1.00","8":"4"},{"1":"EMEA","2":"2012","3":"1","4":"Q1'12","5":"15907.56","6":"30153.81","7":"0.53","8":"5"},{"1":"EMEA","2":"2012","3":"2","4":"Q2'12","5":"31995.81","6":"44959.22","7":"0.71","8":"6"},{"1":"EMEA","2":"2012","3":"3","4":"Q3'12","5":"26253.14","6":"51297.51","7":"0.51","8":"7"},{"1":"EMEA","2":"2012","3":"4","4":"Q4'12","5":"24676.33","6":"37003.89","7":"0.67","8":"8"},{"1":"EMEA","2":"2013","3":"1","4":"Q1'13","5":"9000.72","6":"28780.30","7":"0.31","8":"9"},{"1":"EMEA","2":"2013","3":"2","4":"Q2'13","5":"13916.98","6":"54118.62","7":"0.26","8":"10"},{"1":"EMEA","2":"2013","3":"3","4":"Q3'13","5":"13860.69","6":"58891.63","7":"0.24","8":"11"},{"1":"EMEA","2":"2013","3":"4","4":"Q4'13","5":"13147.88","6":"62850.17","7":"0.21","8":"12"},{"1":"EMEA","2":"2014","3":"1","4":"Q1'14","5":"5034.68","6":"62070.56","7":"0.08","8":"13"},{"1":"EMEA","2":"2014","3":"2","4":"Q2'14","5":"8577.43","6":"67535.63","7":"0.13","8":"14"},{"1":"EMEA","2":"2014","3":"3","4":"Q3'14","5":"18950.77","6":"95555.60","7":"0.20","8":"15"},{"1":"EMEA","2":"2014","3":"4","4":"Q4'14","5":"13266.11","6":"76524.20","7":"0.17","8":"16"},{"1":"EU","2":"2011","3":"1","4":"Q1'11","5":"62418.10","6":"62418.10","7":"1.00","8":"1"},{"1":"EU","2":"2011","3":"2","4":"Q2'11","5":"111739.32","6":"111739.32","7":"1.00","8":"2"},{"1":"EU","2":"2011","3":"3","4":"Q3'11","5":"147423.60","6":"147423.60","7":"1.00","8":"3"},{"1":"EU","2":"2011","3":"4","4":"Q4'11","5":"157162.71","6":"157162.71","7":"1.00","8":"4"},{"1":"EU","2":"2012","3":"1","4":"Q1'12","5":"28685.90","6":"107627.99","7":"0.27","8":"5"},{"1":"EU","2":"2012","3":"2","4":"Q2'12","5":"63308.67","6":"143940.90","7":"0.44","8":"6"},{"1":"EU","2":"2012","3":"3","4":"Q3'12","5":"71738.61","6":"218761.25","7":"0.33","8":"7"},{"1":"EU","2":"2012","3":"4","4":"Q4'12","5":"54051.91","6":"185132.02","7":"0.29","8":"8"},{"1":"EU","2":"2013","3":"1","4":"Q1'13","5":"16785.72","6":"143226.03","7":"0.12","8":"9"},{"1":"EU","2":"2013","3":"2","4":"Q2'13","5":"18187.98","6":"186848.29","7":"0.10","8":"10"},{"1":"EU","2":"2013","3":"3","4":"Q3'13","5":"12685.37","6":"217995.19","7":"0.06","8":"11"},{"1":"EU","2":"2013","3":"4","4":"Q4'13","5":"14271.64","6":"213611.46","7":"0.07","8":"12"},{"1":"EU","2":"2014","3":"1","4":"Q1'14","5":"979.43","6":"168640.79","7":"0.01","8":"13"},{"1":"EU","2":"2014","3":"2","4":"Q2'14","5":"0.00","6":"230563.51","7":"0.00","8":"14"},{"1":"EU","2":"2014","3":"3","4":"Q3'14","5":"2135.82","6":"336616.89","7":"0.01","8":"15"},{"1":"EU","2":"2014","3":"4","4":"Q4'14","5":"1081.16","6":"306383.33","7":"0.00","8":"16"},{"1":"LATAM","2":"2011","3":"1","4":"Q1'11","5":"49055.85","6":"49055.85","7":"1.00","8":"1"},{"1":"LATAM","2":"2011","3":"2","4":"Q2'11","5":"85456.84","6":"85456.84","7":"1.00","8":"2"},{"1":"LATAM","2":"2011","3":"3","4":"Q3'11","5":"90892.54","6":"90892.54","7":"1.00","8":"3"},{"1":"LATAM","2":"2011","3":"4","4":"Q4'11","5":"159692.91","6":"159692.91","7":"1.00","8":"4"},{"1":"LATAM","2":"2012","3":"1","4":"Q1'12","5":"17128.57","6":"42960.16","7":"0.40","8":"5"},{"1":"LATAM","2":"2012","3":"2","4":"Q2'12","5":"49258.80","6":"120036.91","7":"0.41","8":"6"},{"1":"LATAM","2":"2012","3":"3","4":"Q3'12","5":"38476.55","6":"118757.36","7":"0.32","8":"7"},{"1":"LATAM","2":"2012","3":"4","4":"Q4'12","5":"69791.56","6":"182978.89","7":"0.38","8":"8"},{"1":"LATAM","2":"2013","3":"1","4":"Q1'13","5":"5160.83","6":"87884.42","7":"0.06","8":"9"},{"1":"LATAM","2":"2013","3":"2","4":"Q2'13","5":"16677.53","6":"157196.97","7":"0.11","8":"10"},{"1":"LATAM","2":"2013","3":"3","4":"Q3'13","5":"13723.96","6":"150933.53","7":"0.09","8":"11"},{"1":"LATAM","2":"2013","3":"4","4":"Q4'13","5":"18274.87","6":"212125.84","7":"0.09","8":"12"},{"1":"LATAM","2":"2014","3":"1","4":"Q1'14","5":"1753.14","6":"75873.12","7":"0.02","8":"13"},{"1":"LATAM","2":"2014","3":"2","4":"Q2'14","5":"1407.20","6":"156918.95","7":"0.01","8":"14"},{"1":"LATAM","2":"2014","3":"3","4":"Q3'14","5":"972.33","6":"181143.93","7":"0.01","8":"15"},{"1":"LATAM","2":"2014","3":"4","4":"Q4'14","5":"3264.80","6":"292697.10","7":"0.01","8":"16"},{"1":"US","2":"2011","3":"1","4":"Q1'11","5":"74447.86","6":"74447.86","7":"1.00","8":"1"},{"1":"US","2":"2011","3":"2","4":"Q2'11","5":"86538.77","6":"86538.77","7":"1.00","8":"2"},{"1":"US","2":"2011","3":"3","4":"Q3'11","5":"143633.18","6":"143633.18","7":"1.00","8":"3"},{"1":"US","2":"2011","3":"4","4":"Q4'11","5":"179627.75","6":"179627.75","7":"1.00","8":"4"},{"1":"US","2":"2012","3":"1","4":"Q1'12","5":"17627.83","6":"68851.74","7":"0.26","8":"5"},{"1":"US","2":"2012","3":"2","4":"Q2'12","5":"18200.44","6":"89124.28","7":"0.20","8":"6"},{"1":"US","2":"2012","3":"3","4":"Q3'12","5":"31361.88","6":"130259.51","7":"0.24","8":"7"},{"1":"US","2":"2012","3":"4","4":"Q4'12","5":"38198.35","6":"182296.93","7":"0.21","8":"8"},{"1":"US","2":"2013","3":"1","4":"Q1'13","5":"4904.52","6":"92596.44","7":"0.05","8":"9"},{"1":"US","2":"2013","3":"2","4":"Q2'13","5":"22553.37","6":"135370.14","7":"0.17","8":"10"},{"1":"US","2":"2013","3":"3","4":"Q3'13","5":"13924.17","6":"144614.50","7":"0.10","8":"11"},{"1":"US","2":"2013","3":"4","4":"Q4'13","5":"13421.58","6":"235893.00","7":"0.06","8":"12"},{"1":"US","2":"2014","3":"1","4":"Q1'14","5":"485.05","6":"118895.61","7":"0.00","8":"13"},{"1":"US","2":"2014","3":"2","4":"Q2'14","5":"71.09","6":"134023.37","7":"0.00","8":"14"},{"1":"US","2":"2014","3":"3","4":"Q3'14","5":"3177.15","6":"200433.15","7":"0.02","8":"15"},{"1":"US","2":"2014","3":"4","4":"Q4'14","5":"3778.52","6":"280594.84","7":"0.01","8":"16"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="cf">for</span> (market <span class="cf">in</span> <span class="fu">unique</span>(new_business<span class="sc">$</span>market)) {</span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>  scale <span class="ot">&lt;-</span> <span class="fu">max</span>(</span>
<span id="cb80-3"><a href="#cb80-3" tabindex="-1"></a>    new_business[new_business<span class="sc">$</span>market <span class="sc">==</span> market,</span>
<span id="cb80-4"><a href="#cb80-4" tabindex="-1"></a>      ]<span class="sc">$</span>total_sales</span>
<span id="cb80-5"><a href="#cb80-5" tabindex="-1"></a>  )</span>
<span id="cb80-6"><a href="#cb80-6" tabindex="-1"></a>  hi <span class="ot">&lt;-</span> <span class="fu">round</span>(</span>
<span id="cb80-7"><a href="#cb80-7" tabindex="-1"></a>    scale <span class="sc">*</span> <span class="fl">1.1</span><span class="sc">/</span><span class="dv">10</span><span class="sc">^</span><span class="fu">floor</span>(<span class="fu">log10</span>(scale <span class="sc">*</span> <span class="fl">1.1</span>)),</span>
<span id="cb80-8"><a href="#cb80-8" tabindex="-1"></a>    <span class="dv">0</span></span>
<span id="cb80-9"><a href="#cb80-9" tabindex="-1"></a>  ) <span class="sc">*</span></span>
<span id="cb80-10"><a href="#cb80-10" tabindex="-1"></a>    <span class="dv">10</span><span class="sc">^</span><span class="fu">floor</span>(<span class="fu">log10</span>(scale <span class="sc">*</span> <span class="fl">1.1</span>))</span>
<span id="cb80-11"><a href="#cb80-11" tabindex="-1"></a>  scale <span class="ot">&lt;-</span> scale <span class="sc">*</span> <span class="fl">0.8</span></span>
<span id="cb80-12"><a href="#cb80-12" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> new_business[new_business<span class="sc">$</span>market <span class="sc">==</span> market,</span>
<span id="cb80-13"><a href="#cb80-13" tabindex="-1"></a>    ] <span class="sc">%&gt;%</span></span>
<span id="cb80-14"><a href="#cb80-14" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_bar</span>(</span>
<span id="cb80-15"><a href="#cb80-15" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb80-16"><a href="#cb80-16" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb80-17"><a href="#cb80-17" tabindex="-1"></a>      <span class="at">y =</span> total_sales, <span class="at">fill =</span> <span class="st">&quot;Total Revenue&quot;</span></span>
<span id="cb80-18"><a href="#cb80-18" tabindex="-1"></a>    ),</span>
<span id="cb80-19"><a href="#cb80-19" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span></span>
<span id="cb80-20"><a href="#cb80-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-21"><a href="#cb80-21" tabindex="-1"></a>    <span class="fu">geom_bar</span>(</span>
<span id="cb80-22"><a href="#cb80-22" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb80-23"><a href="#cb80-23" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb80-24"><a href="#cb80-24" tabindex="-1"></a>        <span class="at">y =</span> new_sales, <span class="at">fill =</span> <span class="st">&quot;New Revenue&quot;</span></span>
<span id="cb80-25"><a href="#cb80-25" tabindex="-1"></a>      ),</span>
<span id="cb80-26"><a href="#cb80-26" tabindex="-1"></a>      <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span></span>
<span id="cb80-27"><a href="#cb80-27" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-28"><a href="#cb80-28" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb80-29"><a href="#cb80-29" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb80-30"><a href="#cb80-30" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb80-31"><a href="#cb80-31" tabindex="-1"></a>        <span class="at">y =</span> proc_new_business <span class="sc">*</span> scale, <span class="at">group =</span> <span class="dv">1</span>,</span>
<span id="cb80-32"><a href="#cb80-32" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;New Business&quot;</span></span>
<span id="cb80-33"><a href="#cb80-33" tabindex="-1"></a>      )</span>
<span id="cb80-34"><a href="#cb80-34" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-35"><a href="#cb80-35" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb80-36"><a href="#cb80-36" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb80-37"><a href="#cb80-37" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb80-38"><a href="#cb80-38" tabindex="-1"></a>        <span class="at">y =</span> proc_new_business <span class="sc">*</span> scale, <span class="at">color =</span> <span class="st">&quot;New Business&quot;</span></span>
<span id="cb80-39"><a href="#cb80-39" tabindex="-1"></a>      ),</span>
<span id="cb80-40"><a href="#cb80-40" tabindex="-1"></a>      <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb80-41"><a href="#cb80-41" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-42"><a href="#cb80-42" tabindex="-1"></a>    <span class="fu">geom_text</span>(</span>
<span id="cb80-43"><a href="#cb80-43" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb80-44"><a href="#cb80-44" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">fct_reorder</span>(qy, n),</span>
<span id="cb80-45"><a href="#cb80-45" tabindex="-1"></a>        <span class="at">y =</span> proc_new_business <span class="sc">*</span> scale, <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(proc_new_business, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb80-46"><a href="#cb80-46" tabindex="-1"></a>      ),</span>
<span id="cb80-47"><a href="#cb80-47" tabindex="-1"></a>      <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb80-48"><a href="#cb80-48" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-49"><a href="#cb80-49" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb80-50"><a href="#cb80-50" tabindex="-1"></a>      <span class="at">xintercept =</span> <span class="fu">seq</span>(<span class="fl">4.5</span>, <span class="fl">12.5</span>, <span class="dv">4</span>),</span>
<span id="cb80-51"><a href="#cb80-51" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>, <span class="at">color =</span> <span class="st">&quot;gray&quot;</span></span>
<span id="cb80-52"><a href="#cb80-52" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-53"><a href="#cb80-53" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb80-54"><a href="#cb80-54" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, hi),</span>
<span id="cb80-55"><a href="#cb80-55" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, hi, <span class="at">by =</span> hi<span class="sc">/</span><span class="dv">5</span>),</span>
<span id="cb80-56"><a href="#cb80-56" tabindex="-1"></a>      <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">number</span>(</span>
<span id="cb80-57"><a href="#cb80-57" tabindex="-1"></a>        <span class="fu">seq</span>(<span class="dv">0</span>, hi, <span class="at">by =</span> hi<span class="sc">/</span><span class="dv">5</span>),</span>
<span id="cb80-58"><a href="#cb80-58" tabindex="-1"></a>        <span class="at">scale =</span> <span class="dv">10</span><span class="sc">^-</span>(<span class="fu">floor</span>(<span class="fu">log10</span>(hi)) <span class="sc">-</span></span>
<span id="cb80-59"><a href="#cb80-59" tabindex="-1"></a>          <span class="fu">floor</span>(<span class="fu">log10</span>(hi))<span class="sc">%%</span><span class="dv">3</span>),</span>
<span id="cb80-60"><a href="#cb80-60" tabindex="-1"></a>        <span class="at">suffix =</span> <span class="fu">ifelse</span>(</span>
<span id="cb80-61"><a href="#cb80-61" tabindex="-1"></a>          <span class="fu">floor</span>(<span class="fu">log10</span>(hi)) <span class="sc">-</span></span>
<span id="cb80-62"><a href="#cb80-62" tabindex="-1"></a>          <span class="fu">floor</span>(<span class="fu">log10</span>(hi))<span class="sc">%%</span><span class="dv">3</span> <span class="sc">&gt;</span></span>
<span id="cb80-63"><a href="#cb80-63" tabindex="-1"></a>          <span class="dv">3</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;K&quot;</span></span>
<span id="cb80-64"><a href="#cb80-64" tabindex="-1"></a>        )</span>
<span id="cb80-65"><a href="#cb80-65" tabindex="-1"></a>      )</span>
<span id="cb80-66"><a href="#cb80-66" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-67"><a href="#cb80-67" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb80-68"><a href="#cb80-68" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(</span>
<span id="cb80-69"><a href="#cb80-69" tabindex="-1"></a>        <span class="st">&quot;Percentage of new business revenue generation in&quot;</span>,</span>
<span id="cb80-70"><a href="#cb80-70" tabindex="-1"></a>        market, <span class="st">&quot;market&quot;</span></span>
<span id="cb80-71"><a href="#cb80-71" tabindex="-1"></a>      ),</span>
<span id="cb80-72"><a href="#cb80-72" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Revenue, $&quot;</span></span>
<span id="cb80-73"><a href="#cb80-73" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-74"><a href="#cb80-74" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb80-75"><a href="#cb80-75" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb80-76"><a href="#cb80-76" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>()</span>
<span id="cb80-77"><a href="#cb80-77" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-78"><a href="#cb80-78" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb80-79"><a href="#cb80-79" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb80-80"><a href="#cb80-80" tabindex="-1"></a>        <span class="st">`</span><span class="at">Total Revenue</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#dbe5da&quot;</span>, <span class="st">`</span><span class="at">New Revenue</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#bbcbbc&quot;</span></span>
<span id="cb80-81"><a href="#cb80-81" tabindex="-1"></a>      )</span>
<span id="cb80-82"><a href="#cb80-82" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb80-83"><a href="#cb80-83" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb80-84"><a href="#cb80-84" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">New Business</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;#5e8765&quot;</span>)</span>
<span id="cb80-85"><a href="#cb80-85" tabindex="-1"></a>    )</span>
<span id="cb80-86"><a href="#cb80-86" tabindex="-1"></a></span>
<span id="cb80-87"><a href="#cb80-87" tabindex="-1"></a>  <span class="fu">print</span>(plot)</span>
<span id="cb80-88"><a href="#cb80-88" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-1.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-2.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-3.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-4.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-5.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-6.png" width="100%" /><img src="superstore_global_analysis_files/figure-html/unnamed-chunk-82-7.png" width="100%" /></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="co"># Disconnect DB connection</span></span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a><span class="fu">dbDisconnect</span>(<span class="at">conn =</span> con)</span></code></pre></div>
</div>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiU3VwZXJzdG9yZSBHbG9iYWwgU2FsZXMgQW5hbHlzaXMiCm91dHB1dDogCiAgaHRtbF9kb2N1bWVudDoKICAgIHRvYzogdHJ1ZQogICAgdG9jX2RlcHRoOiAyCiAgICB0aGVtZTogdW5pdGVkICAKICAgIGhpZ2hsaWdodDogcHlnbWVudHMKICAgIGRmX3ByaW50OiBwYWdlZAogICAgY29kZV9kb3dubG9hZDogdHJ1ZQogICAgc2VsZl9jb250YWluZWQ6IG5vCi0tLQoKCmBgYHtyIHNldHVwLCBpbmNsdWRlPUZBTFNFfQoKa25pdHI6Om9wdHNfY2h1bmskc2V0KG91dC53aWR0aCA9ICIxMDAlIiwgZWNobyA9IFRSVUUsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0UsIHJlc3VsdHM9J21hcmt1cCcsIHRpZHk9VFJVRSwgdGlkeS5vcHRzPWxpc3QoYXJyb3c9VFJVRSwgaW5kZW50PTIsIHdpZHRoLmN1dG9mZj01MCwgYXJncy5uZXdsaW5lID0gVFJVRSkpCgpgYGAKCgpgYGB7cn0KCiMgbG9hZGluZyBsaWJyYXJpZXMKbGlicmFyeShEQkkpCmxpYnJhcnkoUlBvc3RncmVzKQpsaWJyYXJ5KGdncGxvdDIpCmxpYnJhcnkoZm9yY2F0cykKbGlicmFyeShzdHJpbmdpKQpsaWJyYXJ5KGthYmxlRXh0cmEpCmxpYnJhcnkoUkNvbG9yQnJld2VyKQpsaWJyYXJ5KHRyZWVtYXBpZnkpCmxpYnJhcnkoa25pdHIpCmxpYnJhcnkodGlkeXZlcnNlKQpsaWJyYXJ5KHRpZHlnZW9jb2RlcikKbGlicmFyeShmb3JtYXRSKQoKYGBgCgoKIyBEYXRhc2V0CgpUaGUgW0dsb2JhbCBTdXBlcnN0b3JlIGRhdGFzZXRdKGh0dHBzOi8vd3d3LmthZ2dsZS5jb20vZGF0YXNldHMvc2hla3BhdWwvZ2xvYmFsLXN1cGVyc3RvcmUpIGNvbnRhaW5zIGRhdGEgb2YgdHJhbnNhY3Rpb25zLCBlYWNoIHJvdyByZXByZXNlbnRzIHRyYW5zYWN0aW9uIGl0ZW0gb2YgcHJvZHVjdHMgc29sZCBhcm91bmQgdGhlIHdvcmxkIGJ5IFN1cGVyc3RvcmUsIGFsc28gY29udGFpbnMgYSBjdXN0b21lciBpbmZvcm1hdGlvbiwgc2hpcHBpbmcgYW5kIHByb2R1Y3QgcmV0dXJucy4KCiMjIE1ldGFkYXRhCgpUaGUgZGF0YXNldCBjb250YWlucyB0aGUgZm9sbG93aW5nIHRhYmxlczoKCiMjIyBUYWJsZSAqKk9yZGVycyoqCgp8IFZhcmlhYmxlIG5hbWUgfCBEYXRhIHR5cGUgfCBEZXNjcmlwdGlvbiB8CnwtLS18LS0tfC0tLXwKfCBSb3cgSUQgfCBgSW50ZWdlcmAgfCBVbmlxdWUgSUQgZm9yIGVhY2ggcm93LiB8CnwgT3JkZXIgSUQgfCBgU3RyaW5nYCB8IFVuaXF1ZSBPcmRlciBJRCBmb3IgZWFjaCBDdXN0b21lci4gfAp8IE9yZGVyIERhdGUgfCBgRGF0ZWAgfCBPcmRlciBEYXRlIG9mIHRoZSBwcm9kdWN0LiB8CQp8IFNoaXAgRGF0ZSB8IGBEYXRlYCB8IFNoaXBwaW5nIERhdGUgb2YgdGhlIFByb2R1Y3QuIHwKfCBTaGlwIE1vZGUgfCBgU3RyaW5nYCB8IFNoaXBwaW5nIE1vZGUgc3BlY2lmaWVkIGJ5IHRoZSBDdXN0b21lci4gfAp8IEN1c3RvbWVyIElEIHwgYFN0cmluZ2AgfCBVbmlxdWUgSUQgdG8gaWRlbnRpZnkgZWFjaCBDdXN0b21lci4gfAp8IEN1c3RvbWVyIE5hbWUJfCBgU3RyaW5nYCB8ICBOYW1lIG9mIHRoZSBDdXN0b21lci58CnwgU2VnbWVudCB8IGBTdHJpbmdgIHwgIFRoZSBzZWdtZW50IHdoZXJlIHRoZSBDdXN0b21lciBiZWxvbmdzLiB8CnwgQ2l0eSB8IGBTdHJpbmdgIHwgQ2l0eSBvZiByZXNpZGVuY2Ugb2Ygb2YgdGhlIEN1c3RvbWVyLiB8CnwgU3RhdGUgfCBgU3RyaW5nYCB8IFN0YXRlIG9mIHJlc2lkZW5jZSBvZiB0aGUgQ3VzdG9tZXIuIHwKfCBDb3VudHJ5IHwgYFN0cmluZ2AgfCBDb3VudHJ5IG9mIHJlc2lkZW5jZSBvZiB0aGUgQ3VzdG9tZXIuIHwJCnwgUG9zdGFsIENvZGUgfCBgU3RyaW5nYCB8IFBvc3RhbCBDb2RlIG9mIHJlc2lkZW5jZSBvZiB0aGUgQ3VzdG9tZXIuIHwJCnwgTWFya2V0IHwgYFN0cmluZ2AgfCBNYXJrZXQgbmFtZS4gfAkKfCBSZWdpb24gfCBgU3RyaW5nYCB8IFJlZ2lvbiB3aGVyZSB0aGUgQ3VzdG9tZXIgYmVsb25nLiB8CnwgUHJvZHVjdCBJRCB8IGBTdHJpbmdgIHwgVW5pcXVlIElEIG9mIHRoZSBQcm9kdWN0LiB8CnwgQ2F0ZWdvcnkgfCBgU3RyaW5nYCB8IENhdGVnb3J5IG9mIHRoZSBwcm9kdWN0IG9yZGVyZWQuIHwKfCBTdWItQ2F0ZWdvcnkgfCBgU3RyaW5nYCB8IFN1Yi1DYXRlZ29yeSBvZiB0aGUgcHJvZHVjdCBvcmRlcmVkLiB8CnwgUHJvZHVjdCBOYW1lIHwgYFN0cmluZ2AgfCBOYW1lIG9mIHRoZSBQcm9kdWN0IHwKfCBTYWxlcyB8IGBEZWNpbWFsYCB8IFNhbGVzIG9mIHRoZSBQcm9kdWN0LiB8CnwgUXVhbnRpdHkgfCBgSW50ZWdlcmAgfCBRdWFudGl0eSBvZiB0aGUgUHJvZHVjdC4gfAp8IERpc2NvdW50IHwgYERlY2ltYWxgIHwgRGlzY291bnQgcHJvdmlkZWQuIHwKfCBQcm9maXQgfCBgRGVjaW1hbGAgfCBQcm9maXQvTG9zcyBpbmN1cnJlZC4gfAp8IFNoaXBwaW5nIENvc3QgfCBgRGVjaW1hbGAgfCBTaGlwcGluZyBjb3N0LiB8CnwgT3JkZXIgUHJpb3JpdHkgfCBgU3RyaW5nYCB8IE9yZGVyIHByaW9yaXR5LiB8CgoKIyMjIFRhYmxlICoqUmV0dXJucyoqCgp8IFZhcmlhYmxlIG5hbWUgfCBEYXRhIHR5cGUgfCBEZXNjcmlwdGlvbiB8CnwgLS0tIHwgLS0tIHwgLS0tIHwKfCBPcmRlciBJRCB8IGBTdHJpbmdgIHwgVW5pcXVlIE9yZGVyIElEIGZvciBlYWNoIEN1c3RvbWVyLiB8CnwgUmV0dXJuZWQgfCBgQm9vbGAgfCBUaGUgZmxhZywgaW5kaWNhdGVzIHRoYXQgdGhlIG9yZGVyIHdhcyByZXR1cm5lZC4gfAp8IE1hcmtldCB8IGBTdHJpbmdgIHwgTWFya2V0IG5hbWUuIHwKCgojIERhdGEgbG9hZGluZwoKYGBge3J9CgojIERCIGNvbm5lY3Rpb24KY29uIDwtIGRiQ29ubmVjdCgKICBSUG9zdGdyZXM6OlBvc3RncmVzKCksCiAgZGJuYW1lID0gInN1cGVyc3RvcmVfZ2xvYmFsIiwKICBob3N0ID0gImxvY2FsaG9zdCIsCiAgcG9ydCA9IDU0MzIsCiAgdXNlciA9ICJwb3N0Z3JlcyIsCiAgcGFzc3dvcmQgPSAiIgopCgpgYGAKCkZvciBhbmFseXNpcyBmb3IgdXNlZCBQb3N0Z3JlU1FMIGRhdGFiYXNlLgoKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIGV2YWw9RkFMU0UsIGluY2x1ZGU9VFJVRX0KLS0gTk9URTogeW91IG5lZWQgdG8gZXhlY3V0ZSB0aGUgY29kZSBiZWxvdyBvbiBEQiBzaWRlIChSIE1hcmtkb3duIGNodW5rIGV2YWw9RkFMU0UpLgoKLS0gQ3JlYXRlIGEgbmV3IGRhdGFiYXNlCkNSRUFURSBEQVRBQkFTRSBzdXBlcnN0b3JlX2dsb2JhbDsKCmBgYAoKYGBge3NxbCBjb25uZWN0aW9uPWNvbiwgaW5jbHVkZT1GQUxTRX0KCi0tIHByZXBhcmUgZm9yIG1hcmtkb3duIGdlbmVyYXRpb24KRE8gJCQKQkVHSU4KICAgIElGIChTRUxFQ1QgY291bnQoKikKICAgICAgICAgIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnNjaGVtYXRhIFdIRVJFIHNjaGVtYV9uYW1lID0gJ3Jhd19kYXRhJykgPD4gMCBUSEVOCiAgICAgICAgRFJPUCBTQ0hFTUEgcmF3X2RhdGEgQ0FTQ0FERTsKICAgIEVORCBJRjsKRU5EICQkOwoKYGBgCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29ufQotLSBzY2hlbWEgZm9yIHJhdyBkYXRhCkNSRUFURSBTQ0hFTUEgcmF3X2RhdGE7CgpgYGAKCmBgYHtzcWwgY29ubmVjdGlvbj1jb259Ci0tIGNyZWF0ZSB0YWJsZSBPcmRlcnMgZm9yIHJhdyBkYXRhCkNSRUFURSBUQUJMRSByYXdfZGF0YS5zdXBlcnN0b3JlX29yZGVycwooCiAgICByb3dfaWQgICAgICAgICBWQVJDSEFSKDUpLAogICAgb3JkZXJfaWQgICAgICAgVkFSQ0hBUigxNSksCiAgICBvcmRlcl9kYXRlICAgICBWQVJDSEFSKDEwKSwKICAgIHNoaXBfZGF0ZSAgICAgIFZBUkNIQVIoMTApLAogICAgc2hpcF9tb2RlICAgICAgVkFSQ0hBUigxNCksCiAgICBjdXN0b21lcl9pZCAgICBWQVJDSEFSKDgpLAogICAgY3VzdG9tZXJfbmFtZSAgVkFSQ0hBUigyMiksCiAgICBzZWdtZW50ICAgICAgICBWQVJDSEFSKDExKSwKICAgIGNpdHkgICAgICAgICAgIFZBUkNIQVIoMzUpLAogICAgc3RhdGUgICAgICAgICAgVkFSQ0hBUigzNiksCiAgICBjb3VudHJ5ICAgICAgICBWQVJDSEFSKDMyKSwKICAgIHBvc3RhbF9jb2RlICAgIFZBUkNIQVIoNSksCiAgICBtYXJrZXQgICAgICAgICBWQVJDSEFSKDYpLAogICAgcmVnaW9uICAgICAgICAgVkFSQ0hBUigxNCksCiAgICBwcm9kdWN0X2lkICAgICBWQVJDSEFSKDE2KSwKICAgIGNhdGVnb3J5ICAgICAgIFZBUkNIQVIoMTUpLAogICAgc3ViX2NhdGVnb3J5ICAgVkFSQ0hBUigxMSksCiAgICBwcm9kdWN0X25hbWUgICBWQVJDSEFSKDEyNyksCiAgICBzYWxlcyAgICAgICAgICBWQVJDSEFSKDEwKSwKICAgIHF1YW50aXR5ICAgICAgIFZBUkNIQVIoMiksCiAgICBkaXNjb3VudCAgICAgICBWQVJDSEFSKDUpLAogICAgcHJvZml0ICAgICAgICAgVkFSQ0hBUigyMSksCiAgICBzaGlwcGluZ19jb3N0ICBWQVJDSEFSKDgpLAogICAgb3JkZXJfcHJpb3JpdHkgVkFSQ0hBUig4KQopOwoKYGBgCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29ufQotLSBOT1RFOiB5b3UgbmVlZCB0byBleGVjdXRlIHRoZSBjb2RlIGJlbG93IG9uIERCIHNpZGUgKFIgTWFya2Rvd24gY2h1bmsgZXZhbD1GQUxTRSkuCgotLSBjcmVhdGUgdGFibGUgUmV0dXJucyBmb3IgcmF3IGRhdGEKQ1JFQVRFIFRBQkxFIHJhd19kYXRhLnN1cGVyc3RvcmVfcmV0dXJucwooCiAgICByZXR1cm5lZCBWQVJDSEFSKDMpLAogICAgb3JkZXJfaWQgVkFSQ0hBUigxNSksCiAgICBtYXJrZXQgICBWQVJDSEFSKDEzKQopOwoKYGBgCgpQcmVwYXJlIGRhdGEgaW4gRXhjZWwuIFNhdmUgZWFjaCBzaGVldCBhcyAqQ1NWKiBmaWxlOgogICsgU2hlZXQgKk9yZGVycyogaW50byAqZGF0YS9HbG9iYWwgU3VwZXJzdG9yZV9vcmRlcnMuY3N2Ki4KICArIFNoZWV0ICpSZXR1cm5zKiBpbnRvICpkYXRhL0dsb2JhbCBTdXBlcnN0b3JlX3JldHVybnMuY3N2Ki4KICAKYGBge3J9CgpsaWJyYXJ5KHJlYWR4bCkKbGlicmFyeShmcykKCmZpbGVfbmFtZSA8LSAiR2xvYmFsIFN1cGVyc3RvcmUgKHJhdyBkYXRhKS54bHMiCnNoZWV0cyA8LSByZWFkeGw6OmV4Y2VsX3NoZWV0cyhwYXN0ZTAoIi4vZGF0YS8iLCBmaWxlX25hbWUpKQpDU1ZzIDwtIGMoKQpmb3IgKHNoZWV0IGluIHNoZWV0c1sxOjJdKSB7CiAgICBkZiA8LSByZWFkeGw6OnJlYWRfeGxzKHBhc3RlMCgiLi9kYXRhLyIsIGZpbGVfbmFtZSksIGNvbF9uYW1lcyA9IFRSVUUsIHNoZWV0ID0gc2hlZXQpCiAgICBjc3ZfZmlsZSA8LSBwYXN0ZTAoZ2V0d2QoKSwgIi9kYXRhLyIsICJHbG9iYWwgU3VwZXJzdG9yZV8iLCBzaGVldCAsIi5jc3YiKQogICAgQ1NWcyA8LSBhcHBlbmQoQ1NWcywgY3N2X2ZpbGUpCiAgICB3cml0ZS5jc3YoZGYsIGNzdl9maWxlLCByb3cubmFtZXM9RkFMU0UpCn0KCm9yZGVyc19jc3YgPC0gQ1NWc1sxXQpyZXR1cm5zX2NzdiA8LSBDU1ZzWzJdCiAgICAgICAgICAgICAgICAgICAgCmBgYAoKCk5vdyBsb2FkIGRhdGEgKiphcy1pcyoqIGludG8gZGF0YWJhc2UuCkxvYWRpbmcgcmF3IGRhdGEuCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29ufQotLSBvcmRlcnMKQ09QWSByYXdfZGF0YS5zdXBlcnN0b3JlX29yZGVycyBGUk9NID9vcmRlcnNfY3N2IERFTElNSVRFUiAnLCcgQ1NWIEhFQURFUjsKCmBgYAoKYGBge3NxbCBjb25uZWN0aW9uPWNvbn0KLS0gcmV0dXJucwpDT1BZIHJhd19kYXRhLnN1cGVyc3RvcmVfcmV0dXJucyBGUk9NID9yZXR1cm5zX2NzdiBERUxJTUlURVIgJywnIENTViBIRUFERVI7CgpgYGAKCgojIERhdGEgY2xlYW5zaW5nCgoKQ3JlYXRlIHNjaGVtYSAqYW5hbHlzaXMqIGZvciBjbGVhbmVkIGRhdGEuCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBpbmNsdWRlPUZBTFNFfQoKLS0gcHJlcGFyZSBmb3IgbWFya2Rvd24gZ2VuZXJhdGlvbgpETyAkJApCRUdJTgogICAgSUYgKFNFTEVDVCBjb3VudCgqKQogICAgICAgICAgRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEuc2NoZW1hdGEgV0hFUkUgc2NoZW1hX25hbWUgPSAnYW5hbHlzaXMnKSA8PiAwIFRIRU4KICAgICAgICBEUk9QIFNDSEVNQSBhbmFseXNpcyBDQVNDQURFOwogICAgRU5EIElGOwpFTkQgJCQ7CgpgYGAKCmBgYHtzcWwgY29ubmVjdGlvbj1jb259Ci0tIHNjaGVtYSBmb3IgZGF0YSBjbGVhbnNpbmcKQ1JFQVRFIFNDSEVNQSBhbmFseXNpczsKCmBgYAoKQ3JlYXRlIHRhYmxlcyBmb3IgY2xlYW5lZCBkYXRhLgoKYGBge3NxbCBjb25uZWN0aW9uPWNvbn0KQ1JFQVRFIFRBQkxFIGFuYWx5c2lzLm9yZGVycwooCiAgICByb3dfaWQgICAgICAgICBJTlRFR0VSLAogICAgb3JkZXJfaWQgICAgICAgVkFSQ0hBUigxNSksCiAgICBvcmRlcl9kYXRlICAgICBEQVRFLAogICAgc2hpcF9kYXRlICAgICAgREFURSwKICAgIHNoaXBfbW9kZSAgICAgIFZBUkNIQVIoMTQpLAogICAgY3VzdG9tZXJfaWQgICAgVkFSQ0hBUig4KSwKICAgIGN1c3RvbWVyX25hbWUgIFZBUkNIQVIoMjIpLAogICAgc2VnbWVudCAgICAgICAgVkFSQ0hBUigxMSksCiAgICBjaXR5ICAgICAgICAgICBWQVJDSEFSKDM1KSwKICAgIHN0YXRlICAgICAgICAgIFZBUkNIQVIoMzYpLAogICAgY291bnRyeSAgICAgICAgVkFSQ0hBUigzMiksCiAgICBwb3N0YWxfY29kZSAgICBWQVJDSEFSKDUpLAogICAgbWFya2V0ICAgICAgICAgVkFSQ0hBUig2KSwKICAgIHJlZ2lvbiAgICAgICAgIFZBUkNIQVIoMTQpLAogICAgcHJvZHVjdF9pZCAgICAgVkFSQ0hBUigxNiksCiAgICBjYXRlZ29yeSAgICAgICBWQVJDSEFSKDE1KSwKICAgIHN1Yl9jYXRlZ29yeSAgIFZBUkNIQVIoMTEpLAogICAgcHJvZHVjdF9uYW1lICAgVkFSQ0hBUigxMjcpLAogICAgc2FsZXMgICAgICAgICAgTlVNRVJJQyg5LCAyKSwKICAgIHF1YW50aXR5ICAgICAgIFNNQUxMSU5ULAogICAgZGlzY291bnQgICAgICAgTlVNRVJJQyg0LCAyKSwKICAgIHByb2ZpdCAgICAgICAgIE5VTUVSSUMoOSwgMiksCiAgICBzaGlwcGluZ19jb3N0ICBOVU1FUklDKDksIDIpLAogICAgb3JkZXJfcHJpb3JpdHkgVkFSQ0hBUig4KQopOwoKYGBgCgpgYGAge3NxbCBjb25uZWN0aW9uPWNvbn0KQ1JFQVRFIFRBQkxFIGFuYWx5c2lzLnJldHVybnMKKAogICAgcmV0dXJuZWQgQk9PTEVBTiwKICAgIG9yZGVyX2lkIFZBUkNIQVIoMTUpLAogICAgbWFya2V0ICAgVkFSQ0hBUigxMykKKTsKCgpgYGAKCkNvbnZlcnQgZGF0YSB0eXBlcy4KCmBgYHtzcWwgY29ubmVjdGlvbj1jb259Ci0tIE9yZGVycyB0YWJsZQpJTlNFUlQgSU5UTyBhbmFseXNpcy5vcmRlcnMKU0VMRUNUIENBU1Qocm93X2lkIEFTIElOVEVHRVIpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQVMgcm93X2lkLAogICAgICAgb3JkZXJfaWQsCiAgICAgICBUT19EQVRFKG9yZGVyX2RhdGUsICdZWVlZLU1NLUREJykgICAgICAgICAgICAgICAgICAgICAgIEFTIG9yZGVyX2RhdGUsCiAgICAgICBUT19EQVRFKHNoaXBfZGF0ZSwgJ1lZWVktTU0tREQnKSAgICAgICAgICAgICAgICAgICAgICAgIEFTIHNoaXBfZGF0ZSwKICAgICAgIHNoaXBfbW9kZSwKICAgICAgIGN1c3RvbWVyX2lkLAogICAgICAgY3VzdG9tZXJfbmFtZSwKICAgICAgIHNlZ21lbnQsCiAgICAgICBjaXR5LAogICAgICAgc3RhdGUsCiAgICAgICBjb3VudHJ5LAogICAgICAgcG9zdGFsX2NvZGUsCiAgICAgICBtYXJrZXQsCiAgICAgICByZWdpb24sCiAgICAgICBwcm9kdWN0X2lkLAogICAgICAgY2F0ZWdvcnksCiAgICAgICBzdWJfY2F0ZWdvcnksCiAgICAgICBwcm9kdWN0X25hbWUsCiAgICAgICBDQVNUKFJFUExBQ0Uoc2FsZXMsICcsJywgJy4nKSBBUyBOVU1FUklDKDksIDIpKSAgICAgICAgIEFTIHNhbGVzLAogICAgICAgQ0FTVChxdWFudGl0eSBBUyBTTUFMTElOVCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBUyBxdWFudGl0eSwKICAgICAgIENBU1QoUkVQTEFDRShkaXNjb3VudCwgJywnLCAnLicpIEFTIE5VTUVSSUMoNCwgMikpICAgICAgQVMgZGlzY291bnQsCiAgICAgICBDQVNUKFJFUExBQ0UocHJvZml0LCAnLCcsICcuJykgQVMgTlVNRVJJQyg5LCAyKSkgICAgICAgIEFTIHByb2ZpdCwKICAgICAgIENBU1QoUkVQTEFDRShzaGlwcGluZ19jb3N0LCAnLCcsICcuJykgQVMgTlVNRVJJQyg5LCAyKSkgQVMgc2hpcHBpbmdfY29zdCwKICAgICAgIG9yZGVyX3ByaW9yaXR5CkZST00gcmF3X2RhdGEuc3VwZXJzdG9yZV9vcmRlcnM7CgpgYGAKCmBgYHtzcWwgY29ubmVjdGlvbj1jb259Ci0tIFJldHVybnMgdGFibGUKSU5TRVJUIElOVE8gYW5hbHlzaXMucmV0dXJucwpTRUxFQ1QgQ0FTVChyZXR1cm5lZCBBUyBCT09MRUFOKSBBUyByZXR1cm5lZCwKICAgICAgIG9yZGVyX2lkLAogICAgICAgbWFya2V0CkZST00gcmF3X2RhdGEuc3VwZXJzdG9yZV9yZXR1cm5zOwoKYGBgCgpDaGVjayAqUmV0dXJucyogdGFibGUuCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJjaGVja19yZXR1cm5zIn0KClNFTEVDVCBvcmRlcnMubWFya2V0LCByZXR1cm5zLm1hcmtldApGUk9NCihTRUxFQ1QgRElTVElOQ1QgbWFya2V0IEZST00gYW5hbHlzaXMub3JkZXJzIE9SREVSIEJZIDEpIEFTIG9yZGVycwpGVUxMIEpPSU4KKFNFTEVDVCBESVNUSU5DVCBtYXJrZXQgRlJPTSBhbmFseXNpcy5yZXR1cm5zIE9SREVSIEJZIDEpIEFTIHJldHVybnMKT04gb3JkZXJzLm1hcmtldCA9IHJldHVybnMubWFya2V0OwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHQKY2hlY2tfcmV0dXJucwoKYGBgCgpGaXggbWFya2V0IG5hbWUgaW4gKlJldHVybnMqIHRhYmxlLgoKYGBge3NxbCBjb25uZWN0aW9uPWNvbn0KClVQREFURSBhbmFseXNpcy5yZXR1cm5zClNFVCBtYXJrZXQgPSAnVVMnCldIRVJFIG1hcmtldCA9ICdVbml0ZWQgU3RhdGVzJzsKCmBgYAoKIyMgRHVwbGljYXRpb24gRGF0YQoKQ2hlY2sgZHVwbGljYXRlZCBwYWlycyBvZiAqb3JkZXJfaWQqIGFuZCAqbWFya2V0KiBpbiAqcmV0dXJucyogdGFibGUuCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJkdXBsaWRhdGVkX29yZGVyX2lkIn0KClNFTEVDVCBvcmRlcl9pZCwgbWFya2V0LCBjb3VudCgqKSBGUk9NIGFuYWx5c2lzLnJldHVybnMgR1JPVVAgQlkgMSwgMiBIQVZJTkcgY291bnQoKikgPiAxOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHQKZHVwbGlkYXRlZF9vcmRlcl9pZAoKYGBgCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJvcmRlcnNfZnVsbF9kdXBsaWNhdGVzIn0KCi0tIGR1cGxpY2F0ZWQgZGF0YQpTRUxFQ1QKICAgIHJvd19pZCwKICAgIG9yZGVyX2lkLAogICAgb3JkZXJfZGF0ZSwKICAgIHNoaXBfZGF0ZSwKICAgIHNoaXBfbW9kZSwKICAgIGN1c3RvbWVyX2lkLAogICAgY3VzdG9tZXJfbmFtZSwKICAgIHNlZ21lbnQsCiAgICBjaXR5LAogICAgc3RhdGUsCiAgICBjb3VudHJ5LAogICAgcG9zdGFsX2NvZGUsCiAgICBtYXJrZXQsCiAgICByZWdpb24sCiAgICBwcm9kdWN0X2lkLAogICAgY2F0ZWdvcnksCiAgICBzdWJfY2F0ZWdvcnksCiAgICBwcm9kdWN0X25hbWUsCiAgICBzYWxlcywKICAgIHF1YW50aXR5LAogICAgZGlzY291bnQsCiAgICBwcm9maXQsCiAgICBzaGlwcGluZ19jb3N0LAogICAgb3JkZXJfcHJpb3JpdHksIGNvdW50KCopCkZST00gYW5hbHlzaXMub3JkZXJzCkdST1VQIEJZIDEsMiwzLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0CmhhdmluZyBjb3VudCgqKSA+IDE7CgpgYGAKCmBgYHtyfQojIHByaW50IHJlc3VsdHMKb3JkZXJzX2Z1bGxfZHVwbGljYXRlcwoKYGBgCgpDaGVjayBkdXBsaWNhdGVzIHdpdGhvdXQgKnJvd19pZCouCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJvcmRlcnNfZnVsbF9kdXBsaWNhdGVzIn0KClNFTEVDVAogICAgb3JkZXJfaWQsCiAgICBvcmRlcl9kYXRlLAogICAgc2hpcF9kYXRlLAogICAgc2hpcF9tb2RlLAogICAgY3VzdG9tZXJfaWQsCiAgICBjdXN0b21lcl9uYW1lLAogICAgc2VnbWVudCwKICAgIGNpdHksCiAgICBzdGF0ZSwKICAgIGNvdW50cnksCiAgICBwb3N0YWxfY29kZSwKICAgIG1hcmtldCwKICAgIHJlZ2lvbiwKICAgIHByb2R1Y3RfaWQsCiAgICBjYXRlZ29yeSwKICAgIHN1Yl9jYXRlZ29yeSwKICAgIHByb2R1Y3RfbmFtZSwKICAgIHNhbGVzLAogICAgcXVhbnRpdHksCiAgICBkaXNjb3VudCwKICAgIHByb2ZpdCwKICAgIHNoaXBwaW5nX2Nvc3QsCiAgICBvcmRlcl9wcmlvcml0eSwgY291bnQoKikKRlJPTSBhbmFseXNpcy5vcmRlcnMKR1JPVVAgQlkgMSwyLDMsNCw1LDYsNyw4LDksMTAsMTEsMTIsMTMsMTQsMTUsMTYsMTcsMTgsMTksMjAsMjEsMjIsMjMKaGF2aW5nIGNvdW50KCopID4gMTsKCmBgYAoKYGBge3J9CiMgcHJpbnQgcmVzdWx0cwpvcmRlcnNfZnVsbF9kdXBsaWNhdGVzCgpgYGAKCiMjIE1pc3NpbmcgVmFsdWVzCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9Im1pc3NpbmdfdmFsdWVzIn0KCnNlbGVjdCBjb3VudCgxKSBGSUxURVIgKCBXSEVSRSByb3dfaWQgaXMgTlVMTCApIEFTIHJvd19pZCwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIG9yZGVyX2lkIElTIE5VTEwgKSBBUyBvcmRlcl9pZCwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIG9yZGVyX2RhdGUgSVMgTlVMTCApIEFTIG9yZGVyX2RhdGUsCiAgICAgICBjb3VudCgxKSBGSUxURVIgKCBXSEVSRSBzaGlwX2RhdGUgSVMgTlVMTCApIEFTIHNoaXBfZGF0ZSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHNoaXBfbW9kZSBJUyBOVUxMICkgQVMgc2hpcF9tb2RlLAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgY3VzdG9tZXJfaWQgSVMgTlVMTCApIEFTIGN1c3RvbWVyX2lkLAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgY3VzdG9tZXJfbmFtZSBJUyBOVUxMICkgQVMgY3VzdG9tZXJfbmFtZSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHNlZ21lbnQgSVMgTlVMTCApIEFTIHNlZ21lbnQsCiAgICAgICBjb3VudCgxKSBGSUxURVIgKCBXSEVSRSBjaXR5IElTIE5VTEwgKSBBUyBjaXR5LAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgc3RhdGUgSVMgTlVMTCApIEFTIHN0YXRlLAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgY291bnRyeSBJUyBOVUxMICkgQVMgY291bnRyeSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHBvc3RhbF9jb2RlIElTIE5VTEwgKSBBUyBwb3N0YWxfY29kZSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIG1hcmtldCBJUyBOVUxMICkgQVMgbWFya2V0LAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgcmVnaW9uIElTIE5VTEwgKSBBUyByZWdpb24sCiAgICAgICBjb3VudCgxKSBGSUxURVIgKCBXSEVSRSBwcm9kdWN0X2lkIElTIE5VTEwgKSBBUyBwcm9kdWN0X2lkLAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgY2F0ZWdvcnkgSVMgTlVMTCApIEFTIGNhdGVnb3J5LAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgc3ViX2NhdGVnb3J5IElTIE5VTEwgKSBBUyBzdWJfY2F0ZWdvcnksCiAgICAgICBjb3VudCgxKSBGSUxURVIgKCBXSEVSRSBwcm9kdWN0X25hbWUgSVMgTlVMTCApIEFTIHByb2R1Y3RfbmFtZSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHNhbGVzIElTIE5VTEwgKSBBUyBzYWxlcywKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHF1YW50aXR5IElTIE5VTEwgKSBBUyBxdWFudGl0eSwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIGRpc2NvdW50IElTIE5VTEwgKSBBUyBkaXNjb3VudCwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIHByb2ZpdCBJUyBOVUxMICkgQVMgcHJvZml0LAogICAgICAgY291bnQoMSkgRklMVEVSICggV0hFUkUgc2hpcHBpbmdfY29zdCBJUyBOVUxMICkgQVMgc2hpcHBpbmdfY29zdCwKICAgICAgIGNvdW50KDEpIEZJTFRFUiAoIFdIRVJFIG9yZGVyX3ByaW9yaXR5IElTIE5VTEwgKSBBUyBvcmRlcl9wcmlvcml0eQpGUk9NIGFuYWx5c2lzLm9yZGVyczsKCmBgYAoKYGBge3J9CiMgcHJpbnQgcmVzdWx0cwptaXNzaW5nX3ZhbHVlcwoKYGBgCgojIFByZXBhcmF0aW9uIGZvciBhbmFseXNpcwoKTWFrZSBtYXRlcmlhbGl6ZWQgdmlldy4KCmBgYHtzcWwgY29ubmVjdGlvbj1jb259CgotLSBtYXRlcmlhbGl6ZWQgdmlldwpDUkVBVEUgTUFURVJJQUxJWkVEIFZJRVcgSUYgTk9UIEVYSVNUUyBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycyBBUwogICAgU0VMRUNUICBvLiosIENBU0UKICAgICAgICAgICAgICAgICAgICBXSEVOIHIucmV0dXJuZWQgSVMgTlVMTCBUSEVOIEZBTFNFCiAgICAgICAgICAgICAgICAgICAgRUxTRSByLnJldHVybmVkCiAgICAgICAgICAgICAgICAgRU5EIEFTIHJldHVybmVkCiAgICBGUk9NIGFuYWx5c2lzLm9yZGVycyBvCiAgICAgICAgTEVGVCBKT0lOIGFuYWx5c2lzLnJldHVybnMgciBPTiBvLm9yZGVyX2lkID0gci5vcmRlcl9pZCBBTkQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8ubWFya2V0ID0gci5tYXJrZXQ7CgpgYGAKCmBgYHtzcWwgY29ubmVjdGlvbj1jb259CgotLSByZWZyZXNoIHRoZSB2aWV3IHRvIGZ1bGwgaXQgd2l0aCBkYXRhClJFRlJFU0ggTUFURVJJQUxJWkVEIFZJRVcgYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnM7CgpgYGAKCgojIEFuYWx5c2lzCgoKYGBge3J9CgojIHNldHVwIHBsb3RzIHRoZW1lCnRoZW1lX3NldCh0aGVtZV9saWdodCgpKQp0aGVtZV91cGRhdGUoYXhpcy50aXRsZSA9IGVsZW1lbnRfdGV4dChmYWNlID0gImJvbGQiKSwgCiAgICAgICAgICAgICBwbG90LnRpdGxlID0gZWxlbWVudF90ZXh0KGZhY2UgPSAiYm9sZCIpLAogICAgICAgICAgICAgcGFuZWwuZ3JpZC5tYWpvciA9IGVsZW1lbnRfbGluZShjb2xvciA9ICJkYXJrZ3JheSIsIGxpbmV0eXBlID0gImRvdHRlZCIpLAogICAgICAgICAgICAgcGFuZWwuZ3JpZC5taW5vciA9IGVsZW1lbnRfYmxhbmsoKSwKICAgICAgICAgICAgIHBhbmVsLmJhY2tncm91bmQgPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgICAgICBwYW5lbC5ib3JkZXI9IGVsZW1lbnRfcmVjdChjb2xvcj0iZGFya2dyYXkiKSwKICAgICAgICAgICAgIHBsb3QubWFyZ2luID0gdW5pdChjKC41LCAxLCAxLCAxKSwgImxpbmVzIikpCgpgYGAKCgojIyBUb3RhbCBSZXZlbnVlIGFuZCBHcm9zcyBNYXJnaW4KCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9InJldmVudWVfbWFyZ2luIn0KClNFTEVDVCBEQVRFX1BBUlQoJ3llYXInLCBvcmRlcl9kYXRlKTo6SU5UICAgICAgICAgICAgICAgICAgICAgQVMgeWVhciwKICAgICAgIG1hcmtldCwKICAgICAgIHJvdW5kKFNVTShzYWxlcyksIDIpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBUyBzYWxlcywKICAgICAgIHJvdW5kKFNVTShwcm9maXQpIEZJTFRFUiAoV0hFUkUgTk9UIHJldHVybmVkKSwgMikgICAgICBBUyBwcm9maXQsIC0tIGV4Y2x1ZGUgcmV0dXJucwogICAgICAgcm91bmQoU1VNKHByb2ZpdCkgRklMVEVSIChXSEVSRSBOT1QgcmV0dXJuZWQpIC8gU1VNKHNhbGVzKSwgMikgQVMgbWFyZ2luCkZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKR1JPVVAgQlkgMSwgMgpPUkRFUiBCWSB5ZWFyLCBzYWxlcyBkZXNjOwogICAgCmBgYAoKYGBge3J9CgojIHByaW50IHJlc3VsdApyZXZlbnVlX21hcmdpbgoKYGBgCgoKYGBge3Igd2FybmluZz1GQUxTRX0KCnNjYWxlIDwtIG1lYW4ocmV2ZW51ZV9tYXJnaW4kc2FsZXMpCm9mZnNldCA8LSBtZWFuKHJldmVudWVfbWFyZ2luJHNhbGVzKQogIApnZ3Bsb3QocmV2ZW51ZV9tYXJnaW4pICsKICBnZW9tX2JhcihhZXMoeD1tYXJrZXQsIHk9c2FsZXMsIGZpbGw9ZmFjdG9yKHllYXIpKSwgc3RhdD0iaWRlbnRpdHkiLCBwb3NpdGlvbiA9IHBvc2l0aW9uX2RvZGdlMih3aWR0aCA9IDAuOSkpICsKICBnZW9tX2JhcihhZXMoeD1tYXJrZXQsIHk9cHJvZml0LCBmaWxsPSJQcm9maXQiKSwgc3RhdD0iaWRlbnRpdHkiLCBwb3NpdGlvbiA9IHBvc2l0aW9uX2RvZGdlMih3aWR0aCA9IDAuOSkpICsKICBnZW9tX2xpbmUoYWVzKHg9bWFya2V0LCB5PW9mZnNldCArIG1hcmdpbipzY2FsZSwgZ3JvdXA9bWFya2V0LCBjb2xvcj0iR3Jvc3MgTWFyZ2luIiksIHBvc2l0aW9uID0gcG9zaXRpb25fZG9kZ2UyKHdpZHRoID0gMC45KSkgKwogIGdlb21fcG9pbnQoYWVzKHg9bWFya2V0LCB5PW9mZnNldCArIG1hcmdpbipzY2FsZSwgY29sb3I9Ikdyb3NzIE1hcmdpbiIpLCBwb3NpdGlvbiA9IHBvc2l0aW9uX2RvZGdlMih3aWR0aCA9IDAuOSksIHNoYXBlPTE1KSArCiAgZ2VvbV90ZXh0KGFlcyh4PW1hcmtldCwgeT1vZmZzZXQgKyBtYXJnaW4qc2NhbGUsIGxhYmVsPXNjYWxlczo6cGVyY2VudChtYXJnaW4sIGFjY3VyYWN5ID0gMUwpKSwgdmp1c3Q9LTEuMiwgcG9zaXRpb24gPSBwb3NpdGlvbl9kb2RnZTIod2lkdGggPSAwLjkpLCBzaXplPTIpICsKICBnZW9tX3ZsaW5lKHhpbnRlcmNlcHQgPSBzZXEoMS41LCBsZW5ndGgodW5pcXVlKHJldmVudWVfbWFyZ2luJG1hcmtldCkpLCAxKSwgbGluZXR5cGU9ImRvdHRlZCIsIGNvbG9yPSJncmF5IikgKwogIHNjYWxlX3lfY29udGludW91cyhsYWJlbHMgPSBzY2FsZXM6OmxhYmVsX251bWJlcihzY2FsZSA9IDFlLTMsIHN1ZmZpeCA9ICJLIiwgYWNjdXJhY3kgPSAxTCksCiAgICAgICAgICAgICAgICAgICAgIGxpbWl0cyA9IGMoMCwgMTMwMGUzKSwKICAgICAgICAgICAgICAgICAgICAgYnJlYWtzID0gc2VxKDAsIDEzMDBlMywgMTAwZTMpKSArCiAgc2NhbGVfY29sb3JfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIkdyb3NzIE1hcmdpbiI9ImJsYWNrIikpICsKICBzY2FsZV9maWxsX21hbnVhbChuYW1lPSJTYWxlcyIsIHZhbHVlcyA9IGMoIlByb2ZpdCI9IiMwMDNmNWMiLCAiMjAxMSI9IiM1ODUwOGQiLCAiMjAxMiI9IiNiYzUwOTAiLCAiMjAxMyI9IiNmZjYzNjEiLCAiMjAxNCI9IiNmZmE2MDAiKSkgKwogIGxhYnModGl0bGU9IlRvdGFsIFJldmVudWUgYW5kIEdyb3NzIE1hcmdpbiIsCiAgICAgICB5ID0gIlNhbGVzICYgUHJvZml0LCAkIiwKICAgICAgIHggPSAiTWFya2V0IikgKwogIHRoZW1lKHBhbmVsLmdyaWQubWFqb3IgPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgbGVnZW5kLnBvc2l0aW9uID0gInRvcCIpCgpgYGAKCgojIyBUb3RhbCBHcm9zcyAmIE5ldCBSZXZlbnVlIGFuZCBZb1kgUHJvZml0IEdyb3d0aAoKYGBge3NxbCBjb25uZWN0aW9uPWNvbiwgb3V0cHV0LnZhcj0ieW95X3Byb2ZpdF9ncm93dGgifQoKU0VMRUNUIHllYXI6OiBJTlQgQVMgeWVhciwKICAgICAgIHJvdW5kKHNhbGVzLCAyKSBBUyBzYWxlcywKICAgICAgIHJvdW5kKHJldHVybmVkX3NhbGVzLCAyKSBBUyByZXR1cm5lZF9zYWxlcywKICAgICAgIHJvdW5kKHByb2ZpdCwgMikgQVMgcHJvZml0LAogICAgICAgcm91bmQoKHByb2ZpdCAtIGxhZyhwcm9maXQsIDEpIE9WRVIgKE9SREVSIEJZIHllYXIpKS9sYWcocHJvZml0LCAxKSBPVkVSIChPUkRFUiBCWSB5ZWFyKSwgMikgQVMgeW95X3Byb2ZpdF9ncm93dGgKRlJPTQooU0VMRUNUCiAgICAgIERBVEVfUEFSVCgneWVhcicsIG9yZGVyX2RhdGUpIEFTIHllYXIsCiAgICAgIHN1bShzYWxlcykgRklMVEVSICggV0hFUkUgTk9UIHJldHVybmVkICkgQVMgc2FsZXMsCiAgICAgIHN1bShzYWxlcykgRklMVEVSICggV0hFUkUgcmV0dXJuZWQgKSBBUyByZXR1cm5lZF9zYWxlcywKICAgICAgc3VtKHByb2ZpdCkgRklMVEVSICggV0hFUkUgTk9UIHJldHVybmVkICkgQVMgcHJvZml0IC0tIGV4Y2x1ZGUgcmV0dXJucwpGUk9NCihTRUxFQ1QgZGlzdGluY3Qgb3JkZXJfaWQsCiAgICAgICBmaXJzdF92YWx1ZShvcmRlcl9kYXRlKSBvdmVyKFBBUlRJVElPTiBCWSBvcmRlcl9pZCkgQVMgb3JkZXJfZGF0ZSwKICAgICAgIHN1bShzYWxlcykgb3ZlcihQQVJUSVRJT04gQlkgb3JkZXJfaWQpIEFTIHNhbGVzLAogICAgICAgc3VtKHByb2ZpdCkgb3ZlcihQQVJUSVRJT04gQlkgb3JkZXJfaWQpIEFTIHByb2ZpdCAsCiAgICAgICBmaXJzdF92YWx1ZShyZXR1cm5lZCkgb3ZlcihQQVJUSVRJT04gQlkgb3JkZXJfaWQpIEFTIHJldHVybmVkCkZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMpIGEKR1JPVVAgQlkgMQpPUkRFUiBCWSAxKSBhCk9SREVSIEJZIHllYXI7CiAgICAKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCnlveV9wcm9maXRfZ3Jvd3RoCgpgYGAKCgpgYGB7ciB3YXJuaW5nPUZBTFNFfQoKc2NhbGUgPC0gbWF4KHlveV9wcm9maXRfZ3Jvd3RoJHNhbGVzKQpvZmZzZXQgPC0gbWVhbih5b3lfcHJvZml0X2dyb3d0aCRzYWxlcykKICAKZ2dwbG90KHlveV9wcm9maXRfZ3Jvd3RoKSArCiAgZ2VvbV9iYXIoYWVzKHg9eWVhciwgeSA9IHNhbGVzLCBmaWxsPSJHcm9zcyBSZXZlbnVlIiksIHN0YXQ9ImlkZW50aXR5Iiwgd2lkdGg9MC41KSArCiAgZ2VvbV9iYXIoYWVzKHg9eWVhciwgeSA9IHNhbGVzIC0gcmV0dXJuZWRfc2FsZXMsIGZpbGw9Ik5ldCBSZXZlbnVlIiksIHN0YXQ9ImlkZW50aXR5Iiwgd2lkdGg9MC40NSkgKwogIGdlb21fYmFyKGFlcyh4PXllYXIsIHkgPSBwcm9maXQsIGZpbGw9IlByb2ZpdCIpLCBzdGF0PSJpZGVudGl0eSIsIHdpZHRoPTAuNDUpICsKICBnZW9tX2xpbmUoYWVzKHg9eWVhciwgeT15b3lfcHJvZml0X2dyb3d0aCpzY2FsZSwgZ3JvdXA9MSwgY29sb3I9IllvWSBQcm9maXQgR3Jvd3RoIikpICsKICBnZW9tX3BvaW50KGFlcyh4PXllYXIsIHk9eW95X3Byb2ZpdF9ncm93dGgqc2NhbGUsIGNvbG9yPSJZb1kgUHJvZml0IEdyb3d0aCIpLCBzaGFwZT0xNSkgKwogIGdlb21fdGV4dChhZXMoeD15ZWFyLCB5PXlveV9wcm9maXRfZ3Jvd3RoKnNjYWxlLCBsYWJlbD1zY2FsZXM6OnBlcmNlbnQoeW95X3Byb2ZpdF9ncm93dGgsIGFjY3VyYWN5ID0gMUwpKSwgdmp1c3Q9LTEuMiwgc2l6ZT00KSArCiAgc2NhbGVfY29sb3JfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIllvWSBQcm9maXQgR3Jvd3RoIj0iYmxhY2siKSkgKwogIHNjYWxlX2ZpbGxfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIlByb2ZpdCI9IiMwMDNmNWMiLCAiR3Jvc3MgUmV2ZW51ZSI9IiNiYzUwOTAiLCAiTmV0IFJldmVudWUiPSIjZmZhNjAwIikpICsKICBzY2FsZV95X2NvbnRpbnVvdXMobGFiZWxzID0gc2NhbGVzOjpsYWJlbF9kb2xsYXIoc2NhbGUgPSAxZS02LCBzdWZmaXggPSAiTSIsIGFjY3VyYWN5ID0gMC4xKSwKICAgICAgICAgICAgICAgICAgICAgbGltaXRzID0gYygwLCA0LjVlNiksCiAgICAgICAgICAgICAgICAgICAgIGJyZWFrcyA9IHNlcSgwLCA0LjVlNiwgNTAwZTMpKSArCiAgbGFicyh0aXRsZT0iVG90YWwgR3Jvc3MgJiBOZXQgUmV2ZW51ZSBhbmQgWW9ZIFByb2ZpdCBHcm93dGgiLAogICAgICAgc3VidGl0bGUgPSAiVHJlbmQgbGluZXMgcmVwcmVzZW50IHllYXIgb3ZlciB5ZWFyIHByb2ZpdCBncm93dGggd2l0Y2ggZGVtb25zdHJhdGVzIHBvc2l0aXZlIGdyb3d0aFxudGhyZWUgeWVhcnMgaW4gYSByb3cuIiwKICAgICAgIHkgPSAiIiwKICAgICAgIHggPSAiIikgKwogIHRoZW1lKGxlZ2VuZC5wb3NpdGlvbiA9ICJ0b3AiLAogICAgICAgIGxlZ2VuZC50aXRsZSA9IGVsZW1lbnRfYmxhbmsoKSkKCmBgYAoKCiMjIFF1YXJ0ZXJseSBOZXQgUmV2ZW51ZSBncm93dGgKCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJxdWFydGVybHlfcmV2ZW51ZSJ9CgotLSBUcmVuZCBvZiBxdWFydGVybHkgcmV2ZW51ZSBncm93dGgKU0VMRUNUICosCiAgICAgICAocm93X251bWJlcigpIE9WRVIgKE9SREVSIEJZIHllYXIsIHF1YXJ0ZXIpKTo6SU5UIEFTIG4sCiAgICAgICBjb25jYXQoJ1EnLCBxdWFydGVyLCAnJycnLCBzdWJzdHJpbmcoY2FzdCh5ZWFyIGFzIFRFWFQpLCAzLCA0KSkgQVMgbGFiZWwsCiAgICAgICByb3VuZCgoc2FsZXMgLSBsYWcoc2FsZXMpIE9WRVIgKE9SREVSIEJZIHllYXIsIHF1YXJ0ZXIpKS9sYWcoc2FsZXMpIE9WRVIgKE9SREVSIEJZIHllYXIsIHF1YXJ0ZXIpLCAyKSBBUyBncm93dGgKRlJPTQooU0VMRUNUIHllYXIsCiAgICAgICBxdWFydGVyLAogICAgICAgc3VtKHNhbGVzKSAgRklMVEVSIChXSEVSRSBOT1QgcmV0dXJuZWQpIEFTIHNhbGVzLAogICAgICAgc3VtKHNhbGVzKSBBUyBncm9zc19zYWxlcwogICAgRlJPTQogICAgICAoU0VMRUNUICosCiAgICAgICAgICBleHRyYWN0KHF1YXJ0ZXIgZnJvbSBvcmRlcl9kYXRlKSBhcyBxdWFydGVyLAogICAgICAgICAgZXh0cmFjdCh5ZWFyIGZyb20gb3JkZXJfZGF0ZSkgYXMgeWVhcgogICAgICAgIEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMpIGEKICAgICAgICBHUk9VUCBCWSAxLCAyCiAgICAgICAgT1JERVIgQlkgMSwgMikgYgpPUkRFUiBCWSAxLCAyOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCnF1YXJ0ZXJseV9yZXZlbnVlCgpgYGAKCgpgYGB7cn0KCnJlb3JkZXJfdmFsdWUgPC0gZnVuY3Rpb24oeCwgdmFsdWUsIGRlY3JlYXNpbmcpIHsKICBhIDwtIGFycmF5KHZhbHVlKQogIG5hbWVzKGEpIDwtIHgKICBpZihkZWNyZWFzaW5nKXsKICAgIGZhY3Rvcih4LCBsZXZlbHMgPSBuYW1lcyhzb3J0KGEsIGRlY3JlYXNpbmcgPSBUUlVFKSkpCiAgfWVsc2V7CiAgICBmYWN0b3IoeCwgbGV2ZWxzID0gbmFtZXMoc29ydChhKSkpCiAgfQp9CgpzY2FsZSA8LSBtYXgocXVhcnRlcmx5X3JldmVudWUkc2FsZXMpCmdncGxvdChxdWFydGVybHlfcmV2ZW51ZSwgYWVzKHg9cmVvcmRlcl92YWx1ZShsYWJlbCwgbiwgRkFMU0UpKSkgKwogIGdlb21fYmFyKGFlcyh5PXNhbGVzLCBmaWxsPSJOZXQgUmV2ZW51ZSIpLCBzdGF0PSJpZGVudGl0eSIpICsKICBnZW9tX3RleHQoYWVzKHk9c2FsZXMsIGxhYmVsPXNjYWxlczo6ZG9sbGFyKHNhbGVzLCBzY2FsZSA9IDFlLTYsIHN1ZmZpeCA9ICdNJywgYWNjdXJhY3kgPSAwLjEpKSwgdmp1c3Q9LTEuMywgc2l6ZT0zKSArCiAgZ2VvbV9saW5lKGFlcyh5PWdyb3d0aCpzY2FsZSwgZ3JvdXA9MSwgY29sb3I9IlEvUSBHcm93dGgiKSwgc2l6ZT0xKSArCiAgc2NhbGVfZmlsbF9tYW51YWwobmFtZT0iIiwgdmFsdWVzPWMoIk5ldCBSZXZlbnVlIj0iIzAwM2Y1YyIpKSArCiAgc2NhbGVfY29sb3JfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIlEvUSBHcm93dGgiPSIjZmZhNjAwIikpICsKICBnZW9tX3ZsaW5lKHhpbnRlcmNlcHQgPSBzZXEoNC41LCAxNiwgNCksIGxpbmV0eXBlPSJkb3R0ZWQiKSArCiAgc2NhbGVfeV9jb250aW51b3VzKGxhYmVscyA9IHNjYWxlczo6bGFiZWxfZG9sbGFyKHNjYWxlID0gMWUtNiwgc3VmZml4ID0gIk0iLCBhY2N1cmFjeSA9IDAuMSksCiAgICAgICAgICAgICAgICAgICAgIGxpbWl0cyA9IGMoLTkwMGUzLCAxLjZlNiksCiAgICAgICAgICAgICAgICAgICAgIGJyZWFrcyA9IHNlcSgwLCAxLjZlNiwgMjUwZTMpLAogICAgICAgICAgICAgICAgICAgICBzZWMuYXhpcyA9IHNlY19heGlzKHRyYW5zID0gfi4vc2NhbGUsIGxhYmVscyA9IHNjYWxlczo6bGFiZWxfcGVyY2VudCgpLCBicmVha3MgPSBzZXEoLTAuNiwgMSwgMC4yKSkpICsKICBsYWJzKHRpdGxlPSJRL1EgTmV0IFJldmVudWUgZ3Jvd3RoIiwKICAgICAgIHN1YnRpdGxlID0gIlRyZW5kIGxpbmUgb2YgdGhlIGdyb3d0aCByZXByZXNlbnRzIHBvdGVudGlvbmFseSBvZiBkcm9wcGluZyBvZiB0aGUgcmV2ZW51ZVxuZ3Jvd3RoIGR5bmFtaWMgaW4gUTEnMTUuIiwKICAgICAgIHkgPSAiIiwKICAgICAgIHggPSAiIikgKwogIHRoZW1lKGxlZ2VuZC5wb3NpdGlvbiA9ICJ0b3AiLAogICAgICAgIGxlZ2VuZC50aXRsZSA9IGVsZW1lbnRfYmxhbmsoKSkKCmBgYAoKCiMjIFByb2ZpdCB0cmVuZHMKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9Im1vbnRobHlfcHJvZml0In0KClNFTEVDVCAqLAogICAgICAgcm91bmQoKHByb2ZpdCAtIGxhZyhwcm9maXQpIE9WRVIgKE9SREVSIEJZIGxhc3RfbW9udGhfZGF5KSkvbGFnKHByb2ZpdCkgT1ZFUiAoT1JERVIgQlkgbGFzdF9tb250aF9kYXkpLCAyKSBhcyBncm93dGgKRlJPTQooU0VMRUNUCiAgICAgICAoZGF0ZV90cnVuYygnbW9udGgnLCBvcmRlcl9kYXRlKSArIGludGVydmFsICcxIG1vbnRoIC0gMSBkYXknKTo6ZGF0ZSBBUyBsYXN0X21vbnRoX2RheSwKICAgICAgIHN1bShwcm9maXQpICBGSUxURVIgKFdIRVJFIE5PVCByZXR1cm5lZCkgQVMgcHJvZml0CkZST00KYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKR1JPVVAgQlkgMSkgYTsKCmBgYAoKYGBge3J9CiMgcHJpbnQgcmVzdWx0cwptb250aGx5X3Byb2ZpdAoKYGBgCgoKYGBge3IgfQoKc2NhbGUgPC0gbWF4KG1vbnRobHlfcHJvZml0JHByb2ZpdCkKZ2dwbG90KG1vbnRobHlfcHJvZml0KSArCiAgZ2VvbV9obGluZSh5aW50ZXJjZXB0ID0gMCwgY29sb3I9ImdyYXkiLCBzaXplPTAuMjUpICsKICBnZW9tX2xpbmUoYWVzKHg9bGFzdF9tb250aF9kYXksIHk9cHJvZml0LCBjb2xvcj0iUHJvZml0IiksIHNpemU9MSkgKwogIGdlb21fbGluZShhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1ncm93dGgqc2NhbGUsIGNvbG9yPSJZb1kgR3Jvd3RoIiksIHNpemU9MSkgKwogIGdlb21fc21vb3RoKGFlcyh4PWxhc3RfbW9udGhfZGF5LCB5PXByb2ZpdCksIG1ldGhvZD0ibG0iLCBzZSA9IEZBTFNFLCBsaW5ldHlwZT0iZGFzaGVkIiwgY29sb3I9ImJsdWUiLCBzaXplPTAuNzUpICsKICBnZW9tX3Ntb290aChhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1ncm93dGgqc2NhbGUpLCBtZXRob2Q9ImxtIiwgc2UgPSBGQUxTRSwgbGluZXR5cGU9ImRhc2hlZCIsIGNvbG9yPSJyZWQiLCBzaXplPTAuNzUpICsKICBzY2FsZV95X2NvbnRpbnVvdXMoc2VjLmF4aXMgPSBzZWNfYXhpcyh0cmFucyA9IH4uL3NjYWxlLCBsYWJlbHMgPSBzY2FsZXM6OmxhYmVsX3BlcmNlbnQoKSksCiAgICAgICAgICAgICAgICAgICAgIGxpbWl0cyA9IGMoLTUwZTMsIDE1MGUzKSwKICAgICAgICAgICAgICAgICAgICAgYnJlYWtzID0gc2VxKC01MGUzLCAxNTBlMywgMjVlMyksCiAgICAgICAgICAgICAgICAgICAgIGxhYmVscyA9IHNjYWxlczo6bGFiZWxfbnVtYmVyKHNjYWxlID0gMWUtMywgc3VmZml4ID0gIksiKSkgKwogIHNjYWxlX2NvbG9yX21hbnVhbChuYW1lPSIiLCB2YWx1ZXMgPSBjKCJQcm9maXQiPSIjMDAzZjVjIiwgIllvWSBHcm93dGgiPSIjZmZhNjAwIikpICsKICBsYWJzKHRpdGxlPSJQcm9maXQgdHJlbmRzIiwgeD0iIiwgeT0iUHJvZml0LCAkIikgKwogIHRoZW1lKGxlZ2VuZC5wb3NpdGlvbiA9ICJ0b3AiKQoKYGBgCgoKIyMgVG90YWwgbnVtYmVyIG9mIG9yZGVycyBhbmQgbG9zcyBvcmRlcnMKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9Im9yZGVycyJ9CgpTRUxFQ1QgbWFya2V0LAogICAgICAgICAgICAgeWVhciwKICAgICAgICAgICAgIHN1bShzYWxlcykgYXMgc2FsZXMsCiAgICAgICAgICAgICBDT1VOVChESVNUSU5DVCBvcmRlcl9pZCk6OklOVCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBUyB0b3RhbF9vcmRlcnMsCiAgICAgICAgICAgICAoQ09VTlQoRElTVElOQ1Qgb3JkZXJfaWQpIEZJTFRFUiAoIFdIRVJFIHByb2ZpdCA8IDAgKSk6OklOVCBBUyBsb3NzX29yZGVycwogICAgICBGUk9NIChTRUxFQ1QgbWFya2V0LAogICAgICAgICAgICAgICAgICAgRVhUUkFDVChZRUFSIEZST00gb3JkZXJfZGF0ZSkgQVMgeWVhciwKICAgICAgICAgICAgICAgICAgIG9yZGVyX2lkLAogICAgICAgICAgICAgICAgICAgU1VNKHNhbGVzKSAgICAgICAgICAgICAgICAgICAgQVMgc2FsZXMsCiAgICAgICAgICAgICAgICAgICBTVU0ocHJvZml0KSAgICAgICAgICAgICAgICAgICBBUyBwcm9maXQKICAgICAgICAgICAgRlJPTSBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycwogICAgICAgICAgICBHUk9VUCBCWSAxLCAyLCAzKSBhCiAgICAgIEdST1VQIEJZIDEsIDIKICAgICAgT1JERVIgQlkgMiwgMyBkZXNjCgpgYGAKCmBgYHtyfQojIHByaW50IHJlc3VsdHMKb3JkZXJzCgpgYGAKClZpc3VhbGl6ZSBkYXRhIGZvciAyMDE0IHllYXIuCgpgYGAge3J9CmdncGxvdChvcmRlcnNbb3JkZXJzJHllYXIgPT0gMjAxNCwgXSkgKwogIGdlb21fY29sKGFlcyhyZW9yZGVyKG1hcmtldCwgc2FsZXMsIGRlY3JlYXNpbmcgPSBUUlVFKSwgc2FsZXMsIGZpbGw9IlJldmVudWUiKSwgcG9zaXRpb24gPSAiZG9kZ2UyIiwKICAgIHNob3cubGVnZW5kID0gVFJVRSwKICAgIGFscGhhID0gLjkpICsKICBnZW9tX3NlZ21lbnQoCiAgICBhZXMoCiAgICAgIHggPSByZW9yZGVyKG1hcmtldCwgc2FsZXMpLAogICAgICB5ID0gMCwKICAgICAgeGVuZCA9IHJlb3JkZXIobWFya2V0LCBzYWxlcyksCiAgICAgIHllbmQgPSB0b3RhbF9vcmRlcnMqMTAwMGUzL21heChvcmRlcnNbb3JkZXJzJHllYXIgPT0gMjAxNCwgXSR0b3RhbF9vcmRlcnMpLAogICAgICBjb2xvcj0iVG90YWwgT3JkZXJzIgogICAgKSwKICAgIGxpbmV0eXBlID0gInNvbGlkIgogICkgKwogIGdlb21fcG9pbnQoYWVzKHJlb3JkZXIobWFya2V0LCBzYWxlcywgZGVjcmVhc2luZyA9IFRSVUUpLCB0b3RhbF9vcmRlcnMqMTAwMGUzL21heChvcmRlcnNbb3JkZXJzJHllYXIgPT0gMjAxNCwgXSR0b3RhbF9vcmRlcnMpKSwgc2hhcGU9OTUsIHNpemU9MywgY29sb3I9ImJsYWNrIikgICsKICBnZW9tX2NvbChhZXMocmVvcmRlcihtYXJrZXQsIHNhbGVzLCBkZWNyZWFzaW5nID0gVFJVRSksIGxvc3Nfb3JkZXJzKjEwMDBlMy9tYXgob3JkZXJzW29yZGVycyR5ZWFyID09IDIwMTQsIF0kdG90YWxfb3JkZXJzKSwgZmlsbD0iTG9zcyBPcmRlcnMiKSwgd2lkdGg9MC4xKSAgKwogIHNjYWxlX2ZpbGxfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIlJldmVudWUiPSIjZWNlY2VjIiwgIkxvc3MgT3JkZXJzIj0icmVkIikpICsKICBzY2FsZV9jb2xvcl9tYW51YWwobmFtZT0iIiwgdmFsdWVzID0gYygiVG90YWwgT3JkZXJzIj0iYmxhY2siKSkgKwogIHRoZW1lKAogICAgYXhpcy50ZXh0LnggPSBlbGVtZW50X3RleHQoY29sb3IgPSAiZ3JheTEyIiwgc2l6ZSA9IDEyKSwKICAgIGxlZ2VuZC5wb3NpdGlvbiA9ICJ0b3AiLAogICAgcGFuZWwuYmFja2dyb3VuZCA9IGVsZW1lbnRfcmVjdChmaWxsID0gIndoaXRlIiwgY29sb3IgPSAid2hpdGUiKSkgKwogIHNjYWxlX3lfY29udGludW91cygKICAgIGxhYmVscyA9IHNjYWxlczo6bGFiZWxfbnVtYmVyKGFjY3VyYWN5ID0gMC4wMSwgc2NhbGUgPSAxZS02LCBzdWZmaXggPSAiTSIpLAogICAgbGltaXRzID0gYygwLCBtYXgob3JkZXJzW29yZGVycyR5ZWFyID09IDIwMTQsIF0kc2FsZXMpKjEuMSksCiAgICBleHBhbmQgPSBjKDAsIDApLAogICAgYnJlYWtzID0gc2VxKDAsIG1heChvcmRlcnNbb3JkZXJzJHllYXIgPT0gMjAxNCwgXSRzYWxlcykqMS4xLCAyNTBlMyksCiAgICBzZWMuYXhpcyA9IHNlY19heGlzKHRyYW5zID0gfi4vMTAwMGUzKm1heChvcmRlcnNbb3JkZXJzJHllYXIgPT0gMjAxNCwgXSR0b3RhbF9vcmRlcnMpLCBuYW1lID0gIk51bWJlciBvZiBPcmRlcnMiLCBicmVha3MgPSBzZXEoMCwgMjAwMCwgMjUwKSkKICApICsgCiAgbGFicyh0aXRsZSA9ICJOdW1iZXIgb2YgbG9zcyBvcmRlcnMgZm9yIDIwMTQiLCB5PSJSZXZlbnVlLCAkIiwgeD0iTWFya2V0IikgKwogIGd1aWRlcyhjb2xvciA9IGd1aWRlX2xlZ2VuZChvdmVycmlkZS5hZXMgPSBsaXN0KGZpbGwgPSAid2hpdGUiKSksCiAgbGluZXR5cGUgPSBndWlkZV9sZWdlbmQob3ZlcnJpZGUuYWVzID0gbGlzdChmaWxsID0gIndoaXRlIikpKQoKCmBgYAoKCiMjIEN1c3RvbWVyIExpZmV0aW1lIFZhbHVlIChDTFYpCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJDTFYifQoKU0VMRUNUIG1hcmtldCwKICAgICAgIHNlZ21lbnQsCiAgICAgICB5ZWFyLAogICAgICAgcm91bmQoQ0xWLCAyKSBBUyBDTFYsCiAgICAgICByb3VuZCgoQ0xWIC0gbGFnKENMVikgT1ZFUiAoUEFSVElUSU9OIEJZIG1hcmtldCwgc2VnbWVudCBPUkRFUiBCWSB5ZWFyKSkvbGFnKENMVikgT1ZFUiAoUEFSVElUSU9OIEJZIG1hcmtldCwgc2VnbWVudCBPUkRFUiBCWSB5ZWFyKSwgMikgQVMgZ3Jvd3RoCkZST00KKFNFTEVDVCBhLm1hcmtldCwKICAgICAgIGEuc2VnbWVudCwKICAgICAgIGEueWVhciwKICAgICAgIGEuY3VzdG9tZXJfdmFsdWUgKiBiLkNMUyBBUyBDTFYKICBGUk9NIChTRUxFQ1QgYS5tYXJrZXQsCiAgICAgICAgICAgICAgIGEuc2VnbWVudCwKICAgICAgICAgICAgICAgYS55ZWFyLAogICAgICAgICAgICAgICBhLnNhbGVzLAogICAgICAgICAgICAgICBiLnVuaXF1ZV9jdXN0b21lcnMsCiAgICAgICAgICAgICAgIGEuc2FsZXMgLyBiLnVuaXF1ZV9jdXN0b21lcnMgQVMgY3VzdG9tZXJfdmFsdWUKICAgICAgICBGUk9NIChTRUxFQ1QgbWFya2V0LAogICAgICAgICAgICAgICAgICAgICBzZWdtZW50LAogICAgICAgICAgICAgICAgICAgICBFWFRSQUNUKFlFQVIgRlJPTSBvcmRlcl9kYXRlKSBBUyB5ZWFyLAogICAgICAgICAgICAgICAgICAgICBTVU0oc2FsZXMpICAgICAgICAgICAgICAgICAgICBBUyBzYWxlcwogICAgICAgICAgICAgIEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKICAgICAgICAgICAgICBHUk9VUCBCWSAxLCAyLCAzCiAgICAgICAgICAgICAgT1JERVIgQlkgMSwgMiwgMykgYQogICAgICAgICAgICAgICAgIExFRlQgSk9JTgogICAgICAgICAgICAgKFNFTEVDVCBtYXJrZXQsCiAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgIEVYVFJBQ1QoWUVBUiBGUk9NIG9yZGVyX2RhdGUpIEFTIHllYXIsCiAgICAgICAgICAgICAgICAgICAgIENPVU5UKERJU1RJTkNUIGN1c3RvbWVyX2lkKSAgIEFTIHVuaXF1ZV9jdXN0b21lcnMKICAgICAgICAgICAgICBGUk9NIGFuYWx5c2lzLmFsbF9nbG9iYWxfb3JkZXJzCiAgICAgICAgICAgICAgR1JPVVAgQlkgMSwgMiwgMwogICAgICAgICAgICAgIE9SREVSIEJZIDEsIDIsIDMpIGIgT04gYS5tYXJrZXQgPSBiLm1hcmtldCBBTkQgYS5zZWdtZW50ID0gYi5zZWdtZW50IEFORCBhLnllYXIgPSBiLnllYXIpIGEKICAgICAgICAgICBJTk5FUiBKT0lOCiAgICAgICAoU0VMRUNUIG1hcmtldCwKICAgICAgICAgICAgICAgc2VnbWVudCwKICAgICAgICAgICAgICAgeWVhciwKICAgICAgICAgICAgICAgREFURV9QQVJUKCd5ZWFyJywgU1VNKGRheXMpKTo6ZGVjaW1hbCAvIENPVU5UKERJU1RJTkNUIGN1c3RvbWVyX2lkKSBBUyBDTFMKICAgICAgICBGUk9NIChTRUxFQ1QgRElTVElOQ1QgbWFya2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ZWFyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lcl9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTUlOKG9yZGVyX2RhdGUpIE9WRVIgKFBBUlRJVElPTiBCWSBjdXN0b21lcl9pZCkgICAgICAgQVMgZmlyc3RfZGF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTUFYKG9yZGVyX2RhdGUpIE9WRVIgKFBBUlRJVElPTiBCWSB5ZWFyLCBjdXN0b21lcl9pZCkgQVMgbGFzdF9kYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBR0UoTUFYKG9yZGVyX2RhdGUpIE9WRVIgKFBBUlRJVElPTiBCWSB5ZWFyLCBjdXN0b21lcl9pZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNSU4ob3JkZXJfZGF0ZSkgT1ZFUiAoUEFSVElUSU9OIEJZIGN1c3RvbWVyX2lkKSkgIEFTIGRheXMKICAKICAgICAgICAgICAgICBGUk9NIChTRUxFQ1QgKiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgRVhUUkFDVChZRUFSIEZST00gb3JkZXJfZGF0ZSkgQVMgeWVhcgogICAgICAgICAgICAgICAgICAgIEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMpIGEpIGIKICAgICAgICBHUk9VUCBCWSAxLCAyLCAzKSBiIE9OCiAgICAgICAgICAgICAgICAgICBhLm1hcmtldCA9IGIubWFya2V0IEFORAogICAgICAgICAgICAgICAgICAgYS5zZWdtZW50ID0gYi5zZWdtZW50IEFORAogICAgICAgICAgICAgICAgICAgYS55ZWFyID0gYi55ZWFyKSBhOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHQKQ0xWCgpgYGAKCgpgYGB7ciwgZmlnLmhlaWdodD0xMH0KCgpnZ3Bsb3QoQ0xWKSArCiAgZ2VvbV9iYXIoYWVzKHg9eWVhciwgeT1jbHYsIGZpbGw9c2VnbWVudCksIHN0YXQgPSAiaWRlbnRpdHkiLCBwb3NpdGlvbiA9IHBvc2l0aW9uX2RvZGdlKCkpICsKICBnZW9tX2xpbmUoYWVzKHg9eWVhciwgeT1ncm93dGgqbWVhbihDTFZbQ0xWJG1hcmtldCA9PSBtYXJrZXQgJiBDTFYkc2VnbWVudCA9PSBzZWdtZW50LCAiY2x2Il0pLCBjb2xvcj0iWW9ZIEdyb3d0aCIpKSArCiAgZ2VvbV9wb2ludChhZXMoeD15ZWFyLCB5PWdyb3d0aCptZWFuKENMVltDTFYkbWFya2V0ID09IG1hcmtldCAmIENMViRzZWdtZW50ID09IHNlZ21lbnQsICJjbHYiXSksIGNvbG9yPSJZb1kgR3Jvd3RoIiksIHNpemU9MSkgKwogIGdlb21fdGV4dChhZXMoeD15ZWFyLCB5PWdyb3d0aCptZWFuKENMVltDTFYkbWFya2V0ID09IG1hcmtldCAmIENMViRzZWdtZW50ID09IHNlZ21lbnQsICJjbHYiXSksIGxhYmVsPXNjYWxlczo6cGVyY2VudChncm93dGgsIGFjY3VyYWN5ID0gMUwpLCBjb2xvcj0iWW9ZIEdyb3d0aCIpLCB2anVzdD0tMSwgc2l6ZT0yKSArCiAgbGFicyh0aXRsZSA9ICJDdXN0b21lciBMaWZldGltZSBWYWx1ZSIsIHg9IiIsIHk9IkN1c3RvbWVyIExpZmV0aW1lIFZhbHVlLCAkIikgKwogIHNjYWxlX2ZpbGxfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIkNvbnN1bWVyIj0iI2ZmNjM2MSIsICJDb3Jwb3JhdGUiPSIjYmM1MDkwIiwgIkhvbWUgT2ZmaWNlIj0iI2ZmYTYwMCIpKSArCiAgc2NhbGVfY29sb3JfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIllvWSBHcm93dGgiPSJibGFjayIpKSArCiAgZmFjZXRfZ3JpZChtYXJrZXR+c2VnbWVudCwgc2NhbGVzPSdmcmVlX3knKSArCiAgdGhlbWUobGVnZW5kLnBvc2l0aW9uID0gInRvcCIsCiAgICAgICAgbGVnZW5kLnRpdGxlID0gZWxlbWVudF9ibGFuaygpLAogICAgICAgIHN0cmlwLmJhY2tncm91bmQgPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgc3RyaXAudGV4dCA9IGVsZW1lbnRfdGV4dChjb2xvciA9ICJibGFjayIsIGZhY2UgPSAiYm9sZCIpKQoKCmBgYAoKCgojIyBRdWFydGVybHkgQ3VzdG9tZXIgUmV0ZW50aW9uIFJhdGUKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9ImN1c3RvbWVyX3JldGVudGlvbiJ9CgpXSVRIIGN0ZV9vcmRlcnMgQVMgKApTRUxFQ1QgRElTVElOQ1QKICAgICAgIG9yZGVyX2lkLAogICAgICAgY3VzdG9tZXJfaWQsCiAgICAgICBvcmRlcl9kYXRlLAogICAgICAgbWFya2V0LAogICAgICAgc2VnbWVudCwKICAgICAgIG1pbihvcmRlcl9kYXRlKSBPVkVSIChQQVJUSVRJT04gQlkgY3VzdG9tZXJfaWQsIG1hcmtldCkgQVMgZmlyc3RfZGF0ZQpGUk9NCiAgICBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycwpPUkRFUiBCWSBjdXN0b21lcl9pZCwgbWFya2V0LCBvcmRlcl9kYXRlKSwKICAgIGN0ZV9vcmRlcnNfc3BsaXQgQVMgKApTRUxFQ1QgKiwKICAgICAgIGV4dHJhY3QoWUVBUiBGUk9NIG9yZGVyX2RhdGUpIEFTIG9yZGVyX3llYXIsCiAgICAgICBleHRyYWN0KFFVQVJURVIgRlJPTSBvcmRlcl9kYXRlKSBBUyBvcmRlcl9xLAogICAgICAgZXh0cmFjdChZRUFSIEZST00gZmlyc3RfZGF0ZSkgQVMgZmlyc3RfeWVhciwKICAgICAgIGV4dHJhY3QoUVVBUlRFUiBGUk9NIGZpcnN0X2RhdGUpIEFTIGZpcnN0X3EKRlJPTSBjdGVfb3JkZXJzKQoKU0VMRUNUIHllYXIsIHF1YXJ0ZXIsCiAgICAgICBtYXJrZXQsIHNlZ21lbnQsCiAgICAgICB1bmlxX2N1c3RvbWVyczo6SU5ULAogICAgICAgbmV3X2N1c3RvbWVyczo6SU5ULAogICAgICAgbjo6SU5ULAogICAgICAgQ09OQ0FUKCdRJywgcXVhcnRlciwgJycnJywgU1VCU1RSSU5HKFRFWFQoeWVhciksIDMsIDIpKSAgICAgICAgICAgICAgIEFTIHF5LAogICAgICAgcm91bmQoKHVuaXFfY3VzdG9tZXJzLWNvYWxlc2NlKG5ld19jdXN0b21lcnMsIDApKTo6ZGVjaW1hbC9sYWcodW5pcV9jdXN0b21lcnMpIE9WRVIgKFBBUlRJVElPTiBCWSBtYXJrZXQsIHNlZ21lbnQgT1JERVIgQlkgbiksIDIpIEFTIHJldF9yYXRlCkZST00KKFNFTEVDVCBvcmRlcl95ZWFyIEFTIHllYXIsCiAgICAgICBvcmRlcl9xIEFTIHF1YXJ0ZXIsCiAgICAgICBhLm1hcmtldCwKICAgICAgIGEuc2VnbWVudCwKICAgICAgIGEudW5pcV9jdXN0b21lcnMsCiAgICAgICBiLm5ld19jdXN0b21lcnMsCiAgICAgICByb3dfbnVtYmVyKCkgT1ZFUiAoUEFSVElUSU9OIEJZIGEubWFya2V0LCBhLnNlZ21lbnQgT1JERVIgQlkgYS5vcmRlcl95ZWFyLCBhLm9yZGVyX3EpIG4KRlJPTQooU0VMRUNUIG9yZGVyX3llYXIsCiAgICAgICBvcmRlcl9xLAogICAgICAgbWFya2V0LAogICAgICAgc2VnbWVudCwKICAgICAgIGNvdW50KERJU1RJTkNUIGN1c3RvbWVyX2lkKSB1bmlxX2N1c3RvbWVycwpGUk9NIGN0ZV9vcmRlcnNfc3BsaXQKR1JPVVAgQlkgMSwgMiwgMywgNCkgYQpMRUZUIEpPSU4KKFNFTEVDVCBmaXJzdF95ZWFyLAogICAgICAgZmlyc3RfcSwKICAgICAgIG1hcmtldCwKICAgICAgIHNlZ21lbnQsCiAgICAgICBjb3VudChESVNUSU5DVCBjdXN0b21lcl9pZCkgbmV3X2N1c3RvbWVycwpGUk9NIGN0ZV9vcmRlcnNfc3BsaXQKR1JPVVAgQlkgMSwgMiwgMywgNCkgYiBPTiBhLm9yZGVyX3llYXIgPSBiLmZpcnN0X3llYXIgQU5ECiAgICAgICAgICAgICAgICAgICAgICAgICAgYS5vcmRlcl9xID0gYi5maXJzdF9xIEFORAogICAgICAgICAgICAgICAgICAgICAgICAgIGEubWFya2V0ID0gYi5tYXJrZXQgQU5ECiAgICAgICAgICAgICAgICAgICAgICAgICAgYS5zZWdtZW50ID0gYi5zZWdtZW50CikgYTsKCmBgYAoKYGBge3J9CiMgcHJpbml0IHJlc3VsdHMKY3VzdG9tZXJfcmV0ZW50aW9uCgpgYGAKCgpgYGB7ciwgZmlnLmhlaWdodD0xMH0KCmdncGxvdChjdXN0b21lcl9yZXRlbnRpb24pICsKICBnZW9tX2xpbmUoYWVzKHg9cmVvcmRlcihxeSwgbiksIHkgPSByZXRfcmF0ZSwgZ3JvdXA9MSwgY29sb3I9c2VnbWVudCksIHdpZHRoPTIsIHNob3cubGVnZW5kID0gRkFMU0UpICsKICBzY2FsZV95X2NvbnRpbnVvdXMobGFiZWxzID0gc2NhbGVzOjpsYWJlbF9wZXJjZW50KCkpICsKICBnZW9tX3ZsaW5lKGFlcyh4aW50ZXJjZXB0PTQuNSksIGxpbmV0eXBlID0gImRvdHRlZCIpICsKICBnZW9tX3ZsaW5lKGFlcyh4aW50ZXJjZXB0PTguNSksIGxpbmV0eXBlID0gImRvdHRlZCIpICsKICBnZW9tX3ZsaW5lKGFlcyh4aW50ZXJjZXB0PTEyLjUpLCBsaW5ldHlwZSA9ICJkb3R0ZWQiKSArCiAgYW5ub3RhdGUoZ2VvbSA9ICJ0ZXh0IiwgbGFiZWw9IDIwMTEsIHg9Mi41LCB5PTAuMSwgY29sb3I9ImxpZ2h0Z3JheSIpICsKICBhbm5vdGF0ZShnZW9tID0gInRleHQiLCBsYWJlbD0gMjAxMiwgeD02LjUsIHk9MC4xLCBjb2xvcj0ibGlnaHRncmF5IikgKwogIGFubm90YXRlKGdlb20gPSAidGV4dCIsIGxhYmVsPSAyMDEzLCB4PTEwLjUsIHk9MC4xLCBjb2xvcj0ibGlnaHRncmF5IikgKwogIGFubm90YXRlKGdlb20gPSAidGV4dCIsIGxhYmVsPSAyMDE0LCB4PTE0LjUsIHk9MC4xLCBjb2xvcj0ibGlnaHRncmF5IikgKwogIHNjYWxlX3hfZGlzY3JldGUobGFiZWxzPXJlcChwYXN0ZTAoIlEiLCAxOjQpLCA0KSkgKwogIGZhY2V0X2dyaWQobWFya2V0fnNlZ21lbnQpICsKICB0aGVtZShsZWdlbmQucG9zaXRpb24gPSAidG9wIiwKICAgICAgICBsZWdlbmQudGl0bGUgPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgc3RyaXAuYmFja2dyb3VuZCA9IGVsZW1lbnRfYmxhbmsoKSwKICAgICAgICBzdHJpcC50ZXh0ID0gZWxlbWVudF90ZXh0KGNvbG9yID0gImJsYWNrIiwgZmFjZSA9ICJib2xkIikpKwogIGxhYnModGl0bGU9IlF1YXJ0ZXJseSBDdXN0b21lciBSZXRlbnRpb24gUmF0ZSIsIHg9IiIsIHk9IlJldGVudGlvbiBSYXRlIikKCmBgYAoKIyMgQVJQUFUgYW5kIEF2ZXJhZ2UgY2hlY2sgdmFsdWUKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9ImFycHB1X2NoZWNrIn0KClNFTEVDVCAoZGF0ZV90cnVuYygnbW9udGgnLCBvcmRlcl9kYXRlKSk6OmRhdGUgQVMgbGFzdF9tb250aF9kYXksCiAgICAgICBjb3VudChESVNUSU5DVCBjdXN0b21lcl9pZCk6OklOVCBBUyB1bmlxX2N1c3RvbWVycywKICAgICAgIGNvdW50KERJU1RJTkNUIG9yZGVyX2lkKTo6SU5UIEFTIGNvdW50X29yZGVycywKICAgICAgIHJvdW5kKHN1bShzYWxlcykvY291bnQoRElTVElOQ1QgY3VzdG9tZXJfaWQpLCAyKSBBUyBhcnBwdSwKICAgICAgIHJvdW5kKHN1bShzYWxlcykvY291bnQoRElTVElOQ1Qgb3JkZXJfaWQpLCAyKSBBUyBhdmdfY2hlY2sKRlJPTSBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycyAtLSBmcm9tIG1hdGVyaWFsaXplZCB2aWV3CkdST1VQIEJZIDEKT1JERVIgQlkgMTsKCmBgYAoKYGBge3J9CiMgcHJpbnQgcmVzdWx0cwphcnBwdV9jaGVjawoKYGBgCgoKYGBge3J9CgpnZ3Bsb3QoYXJwcHVfY2hlY2spICsKICBnZW9tX2JhcihhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1hcnBwdSwgZmlsbD0iQVJQUFUiKSwgc3RhdD0iaWRlbnRpdHkiKSArCiAgZ2VvbV9saW5lKGFlcyh4PWxhc3RfbW9udGhfZGF5LCB5PWF2Z19jaGVjaywgY29sb3I9IkF2Zy4gY2hlY2siKSwgc2l6ZT0xKSArCiAgZ2VvbV9wb2ludChhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1hdmdfY2hlY2ssIGNvbG9yPSJBdmcuIGNoZWNrIiksIHNoYXBlPTE4LCBzaXplPTMpICsKICBnZW9tX3Ntb290aChhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1hdmdfY2hlY2spLCBtZXRob2Q9ImxtIiwgY29sb3I9InJlZCIsIGxpbmV0eXBlPSJkYXNoZWQiLCBzZT1GQUxTRSkgKwogIGdlb21fc21vb3RoKGFlcyh4PWxhc3RfbW9udGhfZGF5LCB5PWFycHB1KSwgbWV0aG9kPSJsbSIsIGNvbG9yPSJibHVlIiwgbGluZXR5cGU9ImRhc2hlZCIsIHNlPUZBTFNFKSArCiAgbGFicyh0aXRsZT0iQXZlcmFnZSByZXZlbnVlIHBlciBwYXlpbmcgdXNlciAoQVJQUFUpIGFuZCBhdmVyYWdlIGNoZWNrIHZhbHVlXG5mcm9tIDIwMTEgdG8gMjAxNCIsCiAgICAgICB5PSJBUlBQVSAmIEF2Zy5jaGVjayB2YWx1ZSwgJCIsIHg9IiIpICsKICBzY2FsZV9maWxsX21hbnVhbChuYW1lPSIiLCB2YWx1ZXM9YygiQVJQUFUiPSIjMDAzZjVjIikpICsKICBzY2FsZV9jb2xvcl9tYW51YWwobmFtZT0iIiwgdmFsdWVzPWMoIkF2Zy4gY2hlY2siPSIjZmZhNjAwIikpICsKICB0aGVtZShsZWdlbmQucG9zaXRpb24gPSAidG9wIikKCmBgYAoKCiMjIEF2ZXJhZ2UgQmFza2V0IFZhbHVlIGFuZCBzaXplCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJiYXNrZXRfdmFsdWUifQoKLS0gYXZnIGJhc2tldCB2YWx1ZSBhbmQgc2l6ZQpXSVRIIG9yZGVyX2Nvc3QgQVMgKAogICAgU0VMRUNUIG1hcmtldCwKICAgICAgIChkYXRlX3RydW5jKCdtb250aCcsIG9yZGVyX2RhdGUpKTo6ZGF0ZSBBUyBsYXN0X21vbnRoX2RheSwKICAgICAgIHNlZ21lbnQsCiAgICAgICBvcmRlcl9pZCwKICAgICAgIHJvdW5kKHN1bShzYWxlcyksIDIpIGFzIHNhbGVzLAogICAgICAgcm91bmQoc3VtKHF1YW50aXR5KSwgMikgYXMgcXVhbnRpdHkKICAgIEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKICAgIEdST1VQIEJZIDEsIDIsIDMsIDQKICAgIE9SREVSIEJZIDIsIDEsIDMsIDQKICAgICkKCgpzZWxlY3QgKiwKICAgICAgIHJvdW5kKG1pbihiYXNrZXRfdmFsdWUpIG92ZXIgKHBhcnRpdGlvbiBieSBtYXJrZXQpIC8gbWF4KGJhc2tldF9zaXplKSBvdmVyIChwYXJ0aXRpb24gYnkgbWFya2V0KSwgMikgQVMgc2NhbGUKICAgICAgIGZyb20KKFNFTEVDVAogICAgbWFya2V0LAogICAgbGFzdF9tb250aF9kYXksCiAgICByb3VuZChhdmcoc2FsZXMpLCAyKSBBUyBiYXNrZXRfdmFsdWUsCiAgICByb3VuZChhdmcocXVhbnRpdHkpLCAwKSBBUyBiYXNrZXRfc2l6ZQogICAgRlJPTSBvcmRlcl9jb3N0CkdST1VQIEJZIDEsIDIpIGE7CgpgYGAKCmBgYHtyfQojIHByaW50IHJlc3VsdHMKYmFza2V0X3ZhbHVlCgpgYGAKCgpgYGB7ciBmaWcuaGVpZ2h0PTEwfQoKZ2dwbG90KGJhc2tldF92YWx1ZSkgKwogIGdlb21fbGluZShhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1iYXNrZXRfdmFsdWUsIGdyb3VwPW1hcmtldCkpICsKICBnZW9tX3NlZ21lbnQoIGFlcyh4PWxhc3RfbW9udGhfZGF5LCB4ZW5kPWxhc3RfbW9udGhfZGF5LCB5PTAsIHllbmQ9YmFza2V0X3NpemUqc2NhbGUpLCBjb2xvcj0icmVkIikgKwogIGdlb21fcG9pbnQoYWVzKHg9bGFzdF9tb250aF9kYXksIHk9YmFza2V0X3NpemUqc2NhbGUsIHNpemU9aWZlbHNlKGJhc2tldF9zaXplIDw9IDMsIDIsIGJhc2tldF9zaXplIC0gMikpLCBzaGFwZT0yMSwgY29sb3I9InJlZCIsIGZpbGw9IndoaXRlIiwgc2hvdy5sZWdlbmQgPSBGQUxTRSkgKwogIGdlb21fdGV4dChhZXMoeD1sYXN0X21vbnRoX2RheSwgeT1iYXNrZXRfc2l6ZSpzY2FsZSwgbGFiZWw9YmFza2V0X3NpemUsIHNpemU9aWZlbHNlKGJhc2tldF9zaXplIDw9IDMsIDIsIGJhc2tldF9zaXplIC0gMikpLCBjb2xvcj0iYmxhY2siLCBzaG93LmxlZ2VuZCA9IEZBTFNFKSArCiAgZ2VvbV9zbW9vdGgoYWVzKHg9bGFzdF9tb250aF9kYXksIHk9YmFza2V0X3ZhbHVlKSwgbWV0aG9kID0gImxtIiwgc2UgPSBGQUxTRSwgc2l6ZT0xKSArCiAgZmFjZXRfZ3JpZChtYXJrZXR+Liwgc2NhbGVzID0gImZyZWVfeSIpICsKICB0aGVtZShsZWdlbmQucG9zaXRpb249InRvcCIsCiAgICAgICAgbGVnZW5kLnRpdGxlPWVsZW1lbnRfYmxhbmsoKSwKICAgICAgICBzdHJpcC5iYWNrZ3JvdW5kID0gZWxlbWVudF9ibGFuaygpLAogICAgICAgIHN0cmlwLnRleHQgPSBlbGVtZW50X3RleHQoY29sb3IgPSAiYmxhY2siLCBmYWNlID0gImJvbGQiKSkgKwogIGxhYnModGl0bGU9IkF2ZXJhZ2UgYmFza2V0IHZhbHVlIGFuZCBzaXplIiwgeD0iIiwgeT0iQmFza2V0IFZhbHVlLCAkIikKCmBgYAoKCiMjIFJldHVybiBSYXRlCgoKYGBge3NxbCBjb25uZWN0aW9uPWNvbiwgb3V0cHV0LnZhcj0icmV0dXJucyJ9CgotLSByZXR1cm4gcmF0ZQpTRUxFQ1QgZXh0cmFjdCh5ZWFyIGZyb20gb3JkZXJfZGF0ZSkgQVMgeWVhciwKICAgICAgIHJvdW5kKHN1bShzYWxlcyksIDIpIEFTIHRvdGFsX3NhbGVzLAogICAgICAgcm91bmQoc3VtKHNhbGVzKSBGSUxURVIgKFdIRVJFIHJldHVybmVkKSwgMikgQVMgcmV0dXJuZWRfc2FsZXMsCiAgICAgICBjb3VudChkaXN0aW5jdCBvcmRlcl9pZCk6OklOVCBBUyBjb3VudF9vcmRlcnMsCiAgICAgICAoY291bnQoZGlzdGluY3Qgb3JkZXJfaWQpIEZJTFRFUiAoV0hFUkUgcmV0dXJuZWQpKTo6SU5UIEFTIHJldHVybmVkX29yZGVycywKICAgICAgIHJvdW5kKChjb3VudChkaXN0aW5jdCBvcmRlcl9pZCkgRklMVEVSIChXSEVSRSByZXR1cm5lZCkpOjpkZWNpbWFsL2NvdW50KGRpc3RpbmN0IG9yZGVyX2lkKSwgMykgYXMgcmV0dXJuX3JhdGUKRlJPTSBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycwpHUk9VUCBCWSAxOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCnJldHVybnMKCmBgYAoKCmBgYHtyfQpnZ3Bsb3QocmV0dXJucykgKwogIGdlb21fYmFyKGFlcyh4PXllYXIsIHk9dG90YWxfc2FsZXMsIGZpbGw9IlNhbGVzIiksIHN0YXQ9ImlkZW50aXR5IiwgcG9zaXRpb249cG9zaXRpb25fZG9kZ2Uod2lkdGg9MC44KSkgKwogIGdlb21fYmFyKGFlcyh4PXllYXIsIHk9cmV0dXJuZWRfc2FsZXMsIGZpbGw9IlJldHVybmVkIFNhbGVzIiksIHN0YXQ9ImlkZW50aXR5IiwgcG9zaXRpb249cG9zaXRpb25fZG9kZ2Uod2lkdGg9MC44KSkgKwogIGdlb21fcG9pbnQoYWVzKHg9eWVhciwgeT1yZXR1cm5fcmF0ZSp0b3RhbF9zYWxlcywgY29sb3I9IlJldHVybiBSYXRlIikpICsKICBnZW9tX3RleHQoYWVzKHg9eWVhciwgeT1yZXR1cm5fcmF0ZSp0b3RhbF9zYWxlcywgbGFiZWw9c2NhbGVzOjpwZXJjZW50KHJldHVybl9yYXRlLCBhY2N1cmFjeSA9IDAuMSkpLCB2anVzdD0tMS41KSArCiAgbGFicyh0aXRsZT0iUmV0dXJuIHJhdGUiLCB5PSJTYWxlcywgJCIsIHg9IiIpICsKICBzY2FsZV95X2NvbnRpbnVvdXMobGFiZWxzID0gc2NhbGVzOjpsYWJlbF9udW1iZXIoc2NhbGU9MWUtNiwgc3VmZml4ID0gIk0iKSkgKwogIHNjYWxlX2ZpbGxfbWFudWFsKG5hbWU9IiIsIHZhbHVlcz1jKCJTYWxlcyI9IiNkYmU1ZGEiLCAiUmV0dXJuZWQgU2FsZXMiPSIjYmJjYmJjIikpICsKICBzY2FsZV9jb2xvcl9tYW51YWwobmFtZT0iIiwgdmFsdWVzPWMoIlJldHVybiBSYXRlIj0iYmxhY2siKSkgKwogIHRoZW1lKGxlZ2VuZC5wb3NpdGlvbj0idG9wIikKYGBgCgoKIyMgV2hhdCBtb3N0IHNpZ25pZmljYW50IHN1Yi1jYXRlZ29yaWVzPwoKYGBge3NxbCBjb25uZWN0aW9uPWNvbiwgb3V0cHV0LnZhcj0icGFyZXRvX3NhbGVzIn0KCldJVEggY3RlX3NhbGVzIEFTKApTRUxFQ1QgZXh0cmFjdCh5ZWFyIGZyb20gb3JkZXJfZGF0ZSkgYXMgeWVhciwKICAgICAgIHN1Yl9jYXRlZ29yeSwKICAgICAgIHNlZ21lbnQsCiAgICAgICBzdW0oc2FsZXMpIGFzIHNhbGVzLAogICAgICAgc3VtKHByb2ZpdCkgYXMgcHJvZml0CmZyb20gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKZ3JvdXAgYnkgMSwgMiwgMykKCnNlbGVjdCAqLAogICAgICAgcm91bmQoc3VtKHNhbGVzL3RvdGFsX3NhbGVzKSBvdmVyKHBhcnRpdGlvbiBieSB5ZWFyLCBzZWdtZW50IG9yZGVyIGJ5IHNhbGVzIGRlc2Mgcm93cyBCRVRXRUVOCiAgICAgICAgICAgIHVuYm91bmRlZCBwcmVjZWRpbmcgYW5kIGN1cnJlbnQgcm93KSwgMikgYXMgY3VtX3BlcmNlbnQKICAgICAgIGZyb20KKHNlbGVjdCB5ZWFyLCBzdWJfY2F0ZWdvcnksIHNlZ21lbnQsCiAgICAgICBzYWxlcywgc3VtKHNhbGVzKSBvdmVyIChQQVJUSVRJT04gQlkgeWVhciwgc2VnbWVudCkgYXMgdG90YWxfc2FsZXMKZnJvbSBjdGVfc2FsZXMKb3JkZXIgYnkgMSwgMiwgMywgNCBkZXNjKSBhOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCnBhcmV0b19zYWxlcwoKYGBgCgoKYGBge3J9CgoKZm9yIChzZWdtZW50IGluIHVuaXF1ZShwYXJldG9fc2FsZXMkc2VnbWVudCkpIHsKICBzY2FsZSA8LSBtYXgocGFyZXRvX3NhbGVzW3BhcmV0b19zYWxlcyR5ZWFyID09IDIwMTQgJiBwYXJldG9fc2FsZXMkc2VnbWVudD09c2VnbWVudCxdJHNhbGVzKQogIHhfaW50ZXJjZXB0IDwtIGFwcHJveCgKICAgIHBhcmV0b19zYWxlc1twYXJldG9fc2FsZXMkeWVhciA9PSAyMDE0ICYgcGFyZXRvX3NhbGVzJHNlZ21lbnQ9PXNlZ21lbnQsXSRjdW1fcGVyY2VudCpzY2FsZSwKICAgIGZjdF9yZW9yZGVyKHBhcmV0b19zYWxlc1twYXJldG9fc2FsZXMkeWVhciA9PSAyMDE0ICYgcGFyZXRvX3NhbGVzJHNlZ21lbnQ9PXNlZ21lbnQsXSRzdWJfY2F0ZWdvcnksIC1wYXJldG9fc2FsZXNbcGFyZXRvX3NhbGVzJHllYXIgPT0gMjAxNCAmIHBhcmV0b19zYWxlcyRzZWdtZW50PT1zZWdtZW50LF0kc2FsZXMpLCAKICAgIDAuOCpzY2FsZSkkeQogIAogIGcgPC0gZ2dwbG90KHBhcmV0b19zYWxlc1twYXJldG9fc2FsZXMkeWVhciA9PSAyMDE0ICYgcGFyZXRvX3NhbGVzJHNlZ21lbnQ9PXNlZ21lbnQsXSkgKwogICAgZ2VvbV9hcmVhKGFlcyh4PWZjdF9yZW9yZGVyKHN1Yl9jYXRlZ29yeSwgLXNhbGVzKSwgeT1jdW1fcGVyY2VudCpzY2FsZSwgZ3JvdXA9MSksIGZpbGw9IiNlY2VjZWMiKSArCiAgICBnZW9tX2JhcihhZXMoeD1mY3RfcmVvcmRlcihzdWJfY2F0ZWdvcnksIC1zYWxlcyksIHk9c2FsZXMpLCBzdGF0PSJpZGVudGl0eSIsIGZpbGw9IiNiYmNiYmMiKSArCiAgICBnZW9tX2xpbmUoYWVzKHg9ZmN0X3Jlb3JkZXIoc3ViX2NhdGVnb3J5LCAtc2FsZXMpLCB5PWN1bV9wZXJjZW50KnNjYWxlLCBncm91cD0xKSkgKwogICAgZ2VvbV9wb2ludChhZXMoeD1mY3RfcmVvcmRlcihzdWJfY2F0ZWdvcnksIC1zYWxlcyksIHk9Y3VtX3BlcmNlbnQqc2NhbGUpKSArCiAgICBnZW9tX3RleHQoYWVzKHg9ZmN0X3Jlb3JkZXIoc3ViX2NhdGVnb3J5LCAtc2FsZXMpLCB5PWN1bV9wZXJjZW50KnNjYWxlLCAKICAgICAgICAgICAgICAgICAgbGFiZWw9c2NhbGVzOjpwZXJjZW50KGN1bV9wZXJjZW50LCBhY2N1cmFjeSA9IDAuMSkpLAogICAgICAgICAgICAgIHNpemU9Miwgdmp1c3Q9LTEuNSkgKwogICAgc2NhbGVfeV9jb250aW51b3VzKHNlYy5heGlzID0gc2VjX2F4aXModHJhbnMgPSB+Li9zY2FsZSwgbGFiZWxzID0gc2NhbGVzOjpsYWJlbF9wZXJjZW50KCksIGJyZWFrcyA9IHNlcSgwLCAxLCAwLjIpKSwgYnJlYWtzID0gc2VxKDAsIHNjYWxlLCAyNWUzKSwgbGltaXRzPWMoMCwgc2NhbGUqMS4xKSwgbGFiZWxzID0gc2NhbGVzOjpsYWJlbF9udW1iZXIoc2NhbGUgPSAxZS0zLCBzdWZmaXggPSAiSyIpKSArCiAgICAgc2NhbGVfeF9kaXNjcmV0ZShndWlkZSA9IGd1aWRlX2F4aXMoYW5nbGUgPSA0NSkpICsKICAgIGdlb21fc2VnbWVudCh4ID0gMCwgeGVuZCA9IEluZiwgeSA9IDAuOCpzY2FsZSwgeWVuZCA9IDAuOCpzY2FsZSwgY29sb3IgPSAiYmx1ZSIsIHNpemU9MC4yNSwKICAgICAgICAgICAgICAgICBsaW5ldHlwZT0iZGFzaGVkIikgKwogICAgZ2VvbV9zZWdtZW50KHggPSB4X2ludGVyY2VwdCwKICAgICAgIHhlbmQgPSB4X2ludGVyY2VwdCwgeSA9IC1JbmYsIHllbmQgPSAwLjgqc2NhbGUsIGNvbG9yID0gImJsdWUiLCBzaXplPTAuMjUsCiAgICAgICAgICAgICAgICAgbGluZXR5cGU9ImRhc2hlZCIpICsKICAgIGxhYnModGl0bGUgPSBwYXN0ZTAoIlNhbGVzIGJ5IHN1Yi1jYXRlZ29yeSBpbiAiLCBzZWdtZW50LCIgY3VzdG9tZXIgc2VnbWVudCBmb3IgMjAxNCIpLCB4PSJTdWItQ2F0ZWdvcnkiLCB5PSJTYWxlcywgJCIsIHN1YnRpdGxlID0gcGFzdGUwKCI4MCUgb2YgdGhlIHRvdGFsIHJldmVudWUgY29tZXMgZnJvbSBtb3N0IHNpZ25pZmljYW50IHN1Yi1jYXRlZ29yaWVzXG5zdWNoIGFzICIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpX3JlcGxhY2VfbGFzdChwYXN0ZShhcy5jaGFyYWN0ZXIoZmN0X3Jlb3JkZXIocGFyZXRvX3NhbGVzW3BhcmV0b19zYWxlcyR5ZWFyID09IDIwMTQgJiBwYXJldG9fc2FsZXMkc2VnbWVudD09c2VnbWVudCxdJHN1Yl9jYXRlZ29yeSwgLXBhcmV0b19zYWxlc1twYXJldG9fc2FsZXMkeWVhciA9PSAyMDE0ICYgcGFyZXRvX3NhbGVzJHNlZ21lbnQ9PXNlZ21lbnQsXSRzYWxlcylbc2VxKDEsIHJvdW5kKDguMjcsIDApLCAxKV0pLCBjb2xsYXBzZSA9ICcsICcpLCBmaXhlZCA9ICcsJywgJyAmJykpKSAKICBwcmludChnKQp9CgpgYGAKCiMjIE1hcAoKYGBge3NxbCBjb25uZWN0aW9uPWNvbiwgb3V0cHV0LnZhcj0ibWFwIn0KClNFTEVDVCBtYXJrZXQsCiAgICAgICByZWdpb24sCiAgICAgICBjb3VudHJ5LAogICAgICAgc3VtKHNhbGVzKSBBUyBzYWxlcwpGUk9NIGFuYWx5c2lzLmFsbF9nbG9iYWxfb3JkZXJzCkdST1VQIEJZIDEsIDIsIDMKT1JERVIgQlkgMSwgMiwgMzsKCmBgYAoKYGBge3J9CiMgcHJpbnQgcmVzdWx0cwptYXAKCmBgYAoKCmBgYHtyfQoKIyBhZGQgZ2VvY29kZXMKd29ybGQgPC0gbWFwX2RhdGEoIndvcmxkIikKbWFwcCA8LSBtYXAgJT4lIGdlb2NvZGUoY291bnRyeSA9IGNvdW50cnksIG1ldGhvZCA9ICdvc20nLCBsYXQgPSBsYXRpdHVkZSAsIGxvbmcgPSBsb25naXR1ZGUpCgpjZW50cm9pZHMgPC0gbWFwcCAlPiUKICBncm91cF9ieShtYXJrZXQpICU+JQogIHN1bW1hcmlzZShsb25naXR1ZGU9bWVhbihsb25naXR1ZGUsIG5hLnJtID0gVFJVRSksIGxhdGl0dWRlPW1lYW4obGF0aXR1ZGUsIG5hLnJtID0gVFJVRSksIHNhbGVzPSBzdW0oc2FsZXMsIG5hLnJtID0gVFJVRSkpCgpnZ3Bsb3QoKSArCiAgZ2VvbV9tYXAoCiAgICBkYXRhID0gd29ybGQsIG1hcCA9IHdvcmxkLAogICAgYWVzKGxvbmcsIGxhdCwgbWFwX2lkID0gcmVnaW9uKSwKICAgIGNvbG9yID0gImRhcmtncmF5IiwgZmlsbCA9ICIjZWNlY2VjIiwgc2l6ZSA9IDAuMQogICkgKwogIGdlb21fcG9pbnQoZGF0YT1jZW50cm9pZHMsIGFlcyh4PWxvbmdpdHVkZSwgeT1sYXRpdHVkZSwgc2l6ZT1zYWxlcywgY29sb3I9bWFya2V0KSwgc2hvdy5sZWdlbmQgPSBGQUxTRSwgYWxwaGE9MC43NSkgKwogIHNjYWxlX3NpemUocmFuZ2UgPSBjKDEsIDIwKSkgKwogIGdlb21fdGV4dChkYXRhPWNlbnRyb2lkcywgYWVzKHg9bG9uZ2l0dWRlLCB5PWxhdGl0dWRlLCBsYWJlbD1zY2FsZXM6OmRvbGxhcihzYWxlcywgc2NhbGUgPSAxZS02LCBzdWZmaXggPSAiTSIsIGFjY3VyYWN5ID0gMC4xKSksIHNpemU9Miwgdmp1c3Q9MS41KSArCiAgZ2VvbV90ZXh0KGRhdGE9Y2VudHJvaWRzLCBhZXMoeD1sb25naXR1ZGUsIHk9bGF0aXR1ZGUsIGxhYmVsPW1hcmtldCksIHNpemU9Miwgdmp1c3Q9LTAuNSwgZm9udGZhY2U9ImJvbGQiKSArCiAgbGFicyh0aXRsZT0iVG90YWwgcmV2ZW51ZSBwZXIgbWFya2V0IGZyb20gMjAxMSB0byAyMDE0IiwgeD0iIiwgeT0iIikgKwogIHRoZW1lKGF4aXMubGluZT1lbGVtZW50X2JsYW5rKCksCiAgICAgIGF4aXMudGV4dC54PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50ZXh0Lnk9ZWxlbWVudF9ibGFuaygpLAogICAgICBheGlzLnRpY2tzPWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50aXRsZS54PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50aXRsZS55PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgbGVnZW5kLnBvc2l0aW9uPSJub25lIiwKICAgICAgcGFuZWwuYmFja2dyb3VuZD1lbGVtZW50X2JsYW5rKCksCiAgICAgIHBhbmVsLmdyaWQubWFqb3I9ZWxlbWVudF9ibGFuaygpLAogICAgICBwYW5lbC5ncmlkLm1pbm9yPWVsZW1lbnRfYmxhbmsoKSwKICAgICAgcGxvdC5iYWNrZ3JvdW5kPWVsZW1lbnRfYmxhbmsoKSkKCmBgYAoKCiMjIFRvcCAxMCBjb3VudHJpZXMgYnkgU2FsZXMgVm9sdW1lCgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJ0b3Bfc2FsZXNfY291bnRyaWVzIn0KCnNlbGVjdCAqIGZyb20KKHNlbGVjdCAqLAogICAgICAgcm91bmQoKHNhbGVzIC0gbGFnKHNhbGVzKSBvdmVyIChQQVJUSVRJT04gQlkgbWFya2V0LCBjb3VudHJ5ICBPUkRFUiBCWSB5ZWFyKSkvCiAgICAgICBsYWcoc2FsZXMpIG92ZXIgKFBBUlRJVElPTiBCWSBtYXJrZXQsIGNvdW50cnkgIE9SREVSIEJZICB5ZWFyKSwgMikgYXMgWW9ZX0dyb3d0aF9TYWxlcywKICAgICAgIHJvdW5kKChwcm9maXQgLSBsYWcocHJvZml0KSBvdmVyIChQQVJUSVRJT04gQlkgbWFya2V0LCBjb3VudHJ5ICBPUkRFUiBCWSB5ZWFyKSkvCiAgICAgICBsYWcocHJvZml0KSBvdmVyIChQQVJUSVRJT04gQlkgbWFya2V0LCBjb3VudHJ5ICBPUkRFUiBCWSAgeWVhciksIDIpIGFzIFlvWV9Hcm93dGhfUHJvZml0CmZyb20KKHNlbGVjdCBtYXJrZXQsCiAgICAgICBjb3VudHJ5LAogICAgICAgZXh0cmFjdCh5ZWFyIGZyb20gb3JkZXJfZGF0ZSkgYXMgeWVhciwKICAgICAgIHN1bShzYWxlcykgYXMgc2FsZXMsCiAgICAgICBzdW0ocHJvZml0KSBhcyBwcm9maXQKZnJvbSBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycwpncm91cCBieSAxLCAyLCAzKSBhKSBhCndoZXJlIHllYXIgPSAyMDE0IE9SREVSIEJZIHNhbGVzIGRlc2MgbGltaXQgMTA7CgpgYGAKCmBgYHtyfQojIHByaW50IHJlc3VsdHMKdG9wX3NhbGVzX2NvdW50cmllcwoKYGBgCgoKYGBge3J9Cgp0b3Bfc2FsZXNfY291bnRyaWVzICU+JQogIG11dGF0ZV9hdChjKCJ5b3lfZ3Jvd3RoX3NhbGVzIiwgInlveV9ncm93dGhfcHJvZml0IiksIH5jZWxsX3NwZWMoc2NhbGVzOjpwZXJjZW50KC4sCiAgICBhY2N1cmFjeSA9IDAuMSksICJodG1sIiwgY29sb3IgPSBjYXNlX3doZW4oLiA8IDAgfiAicmVkIiwgLiA+PSAwIH4gImdyZWVuIiwKICAgIGlzLm5hKC4pIH4gImxpZ2h0Z3JheSIsIFRSVUUgfiAiYmxhY2siKSkpICU+JQogIG11dGF0ZV9hdChjKCJzYWxlcyIsICJwcm9maXQiKSwgfnNjYWxlczo6ZG9sbGFyKC4sIGFjY3VyYWN5ID0gMC4wMSkpICU+JQogIHJlbG9jYXRlKHlveV9ncm93dGhfc2FsZXMsIC5hZnRlciA9IHNhbGVzKSAlPiUKICBzZWxlY3QoLXllYXIpICU+JQogIGtibChjb2wubmFtZXMgPSBjKCJNYXJrZXQiLCAiQ291bnRyeSIsICJUb3RhbCIsICJZb1kgR3Jvd3RoIiwgIlRvdGFsIiwgIllvWSBHcm93dGgiKSwKICAgIGNhcHRpb24gPSAiVG9wIDEwIGNvdW50cmllcyBieSBTYWxlcyBWb2x1bWUgZm9yIDIwMTQiLCBlc2NhcGUgPSBGLAogICAgYWxpZ24gPSBjKCJsbHJycnIiKSkgJT4lCiAgcm93X3NwZWMoMCwgYWxpZ24gPSAiYyIpICU+JQogIGthYmxlX3N0eWxpbmcoYm9vdHN0cmFwX29wdGlvbnMgPSBjKCJzdHJpcGVkIiwgImJvcmRlcmVkIiksIGZ1bGxfd2lkdGggPSBUUlVFKSAlPiUKICBhZGRfaGVhZGVyX2Fib3ZlKGhlYWRlciA9IGMoIiAiLCAiICIsIFNhbGVzID0gMiwgUHJvZml0ID0gMiksIGJvbGQgPSBUUlVFLCBib3JkZXJfbGVmdCA9IFRSVUUsCiAgICBib3JkZXJfcmlnaHQgPSBUUlVFKQoKYGBgCgpgYGB7cn0KCmNvdW50cmllc19jb29yZHMgPC0gdG9wX3NhbGVzX2NvdW50cmllcyAlPiUKICBnZW9jb2RlKGNvdW50cnkgPSBjb3VudHJ5LCBtZXRob2QgPSAnb3NtJywgbGF0ID0gbGF0aXR1ZGUgLCBsb25nID0gbG9uZ2l0dWRlKQoKZ2dwbG90KCkgKwogIGdlb21fbWFwKAogICAgZGF0YSA9IHdvcmxkLCBtYXAgPSB3b3JsZCwKICAgIGFlcyhsb25nLCBsYXQsIG1hcF9pZCA9IHJlZ2lvbiksCiAgICBjb2xvciA9ICJkYXJrZ3JheSIsIGZpbGwgPSAiI2VjZWNlYyIsIHNpemUgPSAwLjEKICApICsKICBnZW9tX3BvaW50KGRhdGE9Y291bnRyaWVzX2Nvb3JkcywgYWVzKHg9bG9uZ2l0dWRlLCB5PWxhdGl0dWRlLCBzaXplPXNhbGVzLCBjb2xvcj1tYXJrZXQsIGFscGhhPTAuNSksIHNob3cubGVnZW5kID0gRkFMU0UpICsKICBzY2FsZV9zaXplKHJhbmdlID0gYygxLCAyMCkpICsKICBnZW9tX3RleHQoZGF0YT1jb3VudHJpZXNfY29vcmRzLCBhZXMoeD1sb25naXR1ZGUsIHk9bGF0aXR1ZGUsIGxhYmVsPXNjYWxlczo6ZG9sbGFyKHNhbGVzLCBzY2FsZSA9IDFlLTMsIHN1ZmZpeCA9ICJLIiwgYWNjdXJhY3kgPSAwLjEpKSwgc2l6ZT0yLCB2anVzdD0xLjUpICsKICBnZW9tX3RleHQoZGF0YT1jb3VudHJpZXNfY29vcmRzLCBhZXMoeD1sb25naXR1ZGUsIHk9bGF0aXR1ZGUsIGxhYmVsPWNvdW50cnkpLCBzaXplPTEsIHZqdXN0PS0wLjUsIGZvbnRmYWNlPSJib2xkIikgKwogIGxhYnModGl0bGU9IlRvcCAxMCBjb3VudHJpZXMgYnkgU2FsZXMgVm9sdW1lIGZvciAyMDE0IiwgeD0iIiwgeT0iIikgKwogIHRoZW1lKGF4aXMubGluZT1lbGVtZW50X2JsYW5rKCksCiAgICAgIGF4aXMudGV4dC54PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50ZXh0Lnk9ZWxlbWVudF9ibGFuaygpLAogICAgICBheGlzLnRpY2tzPWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50aXRsZS54PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgYXhpcy50aXRsZS55PWVsZW1lbnRfYmxhbmsoKSwKICAgICAgbGVnZW5kLnBvc2l0aW9uPSJub25lIiwKICAgICAgcGFuZWwuYmFja2dyb3VuZD1lbGVtZW50X2JsYW5rKCksCiAgICAgIHBhbmVsLmdyaWQubWFqb3I9ZWxlbWVudF9ibGFuaygpLAogICAgICBwYW5lbC5ncmlkLm1pbm9yPWVsZW1lbnRfYmxhbmsoKSwKICAgICAgcGxvdC5iYWNrZ3JvdW5kPWVsZW1lbnRfYmxhbmsoKSkKCmBgYAoKCiMjIFNhbGVzIGFuYWx5c2lzIGhlYXQgbWFwIGJ5IGRheSBhbmQgbW9udGgKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9ImhlYXQifQoKU0VMRUNUICosCiAgICAgICBjb3VudF9vcmRlcnM6Om51bWVyaWMgLyAoU1VNKGNvdW50X29yZGVycykgT1ZFUiAoKSkgQVMgcHJvYwpGUk9NIChTRUxFQ1QgbW9udGgsCiAgICAgICAgICAgICBuX21vbnRoLAogICAgICAgICAgICAgd29kLAogICAgICAgICAgICAgbl93b2QsCiAgICAgICAgICAgICBDT1VOVChESVNUSU5DVCBvcmRlcl9pZCk6OklOVCBjb3VudF9vcmRlcnMKICAgICAgRlJPTSAoU0VMRUNUIERJU1RJTkNUIG9yZGVyX2lkLAogICAgICAgICAgICAgICAgRVhUUkFDVChNT05USCBGUk9NIEZJUlNUX1ZBTFVFKG9yZGVyX2RhdGUpIE9WRVIgKFBBUlRJVElPTiBCWSBvcmRlcl9pZCkpICBBUyBuX21vbnRoLAogICAgICAgICAgICAgICAgVE9fQ0hBUihGSVJTVF9WQUxVRShvcmRlcl9kYXRlKSBPVkVSIChQQVJUSVRJT04gQlkgb3JkZXJfaWQpLCAnTW9udGgnKSAgICBBUyBtb250aCwKICAgICAgICAgICAgICAgIEVYVFJBQ1QoSVNPRE9XIEZST00gRklSU1RfVkFMVUUob3JkZXJfZGF0ZSkgT1ZFUiAoUEFSVElUSU9OIEJZIG9yZGVyX2lkKSkgQVMgbl93b2QsCiAgICAgICAgICAgICAgICBUT19DSEFSKEZJUlNUX1ZBTFVFKG9yZGVyX2RhdGUpIE9WRVIgKFBBUlRJVElPTiBCWSBvcmRlcl9pZCksICdEYXknKSAgICAgIEFTIHdvZAogICAgICAgICAgICBGUk9NIGFuYWx5c2lzLmFsbF9nbG9iYWxfb3JkZXJzCiAgICAgICAgICAgIE9SREVSIEJZIG5fbW9udGgsIG5fd29kKSBhCiAgICAgIEdST1VQIEJZIG1vbnRoLCBuX21vbnRoLCB3b2QsIG5fd29kKSBhCk9SREVSIEJZIG5fbW9udGgsIG5fd29kOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCmhlYXQKCmBgYAoKCmBgYHtyfQoKaGVhdCAlPiUKICBtdXRhdGUod29kPWFzLmZhY3Rvcih3b2QpLCBtb250aD1hcy5mYWN0b3IobW9udGgpKSAlPiUKICBtdXRhdGUod29kPWZjdF9yZW9yZGVyKHdvZCwgbl93b2QpLCBtb250aD1mY3RfcmVvcmRlcihtb250aCwgLW5fbW9udGgpKSAlPiUKZ2dwbG90KGFlcyh4ID0gd29kLCB5ID0gbW9udGgsIGZpbGwgPSBwcm9jKSkgKyAKICBnZW9tX3RpbGUoc2hvdy5sZWdlbmQgPSBGQUxTRSkgKwogIHNjYWxlX2ZpbGxfZ3JhZGllbnQoaGlnaCA9ICJyZWQiLCBsb3cgPSAid2hpdGUiLCBuYS52YWx1ZSA9ICJ3aGl0ZSIpICsKICBzY2FsZV94X2Rpc2NyZXRlKHBvc2l0aW9uID0gInRvcCIpICsKICBsYWJzKHRpdGxlPSJTYWxlcyBoZWF0IG1hcCBieSBkYXkgb2Ygd2VlayBhbmQgbW9udGggZnJvbSAyMDExIHRvIDIwMTQiLCB4PSJXZWVrZGF5IiwgeT0iTW9udGgiKQoKYGBgCgoKIyMgVG9wIDUgcmV0dXJuYWJsZSBzdWItY2F0ZWdvcmllcyBieSBtZXJrZXQKCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9InJldHVybmFibGVfc3ViX2NhdGVnb3J5In0KClNFTEVDVCBhLm1hcmtldCwKICAgICAgIGEubmV3X3N1Yl9jYXRlZ29yeSBBUyBzdWJfY2F0ZWdvcnksCiAgICAgICBTVU0oYS5wZXJjKSAgICAgICAgQVMgcGVyYwpGUk9NIChTRUxFQ1QgYS5tYXJrZXQsCiAgICAgICAgICAgICBhLnBlcmMsCiAgICAgICAgICAgICBDQVNFCiAgICAgICAgICAgICAgICAgV0hFTiBSQU5LKCkgT1ZFUiAoUEFSVElUSU9OIEJZIG1hcmtldCBPUkRFUiBCWSBwZXJjIERFU0MpIDw9IDUgVEhFTiBzdWJfY2F0ZWdvcnkKICAgICAgICAgICAgICAgICBFTFNFICdPdGhlcicKICAgICAgICAgICAgICAgICBFTkQgQVMgbmV3X3N1Yl9jYXRlZ29yeQogICAgICBGUk9NIChTRUxFQ1QgRElTVElOQ1QgbWFya2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViX2NhdGVnb3J5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgUk9VTkQoQ09VTlQoKikgT1ZFUiAoUEFSVElUSU9OIEJZIG1hcmtldCwgc3ViX2NhdGVnb3J5KSAvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDT1VOVCgqKSBPVkVSIChQQVJUSVRJT04gQlkgbWFya2V0KTo6bnVtZXJpYywgMykgQVMgcGVyYwogICAgICAgICAgICBGUk9NIGFuYWx5c2lzLmFsbF9nbG9iYWxfb3JkZXJzCiAgICAgICAgICAgIFdIRVJFIHJldHVybmVkCiAgICAgICAgICAgIE9SREVSIEJZIG1hcmtldCwgcGVyYyBERVNDKSBhKSBhCkdST1VQIEJZIG1hcmtldCwgc3ViX2NhdGVnb3J5Ck9SREVSIEJZIG1hcmtldCwgcGVyYyBERVNDOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCnJldHVybmFibGVfc3ViX2NhdGVnb3J5CgpgYGAKCgpgYGB7cn0KCmZvciAobWFya2V0IGluIHVuaXF1ZShyZXR1cm5hYmxlX3N1Yl9jYXRlZ29yeSRtYXJrZXQpKSB7CiAgcHJpbnQocmV0dXJuYWJsZV9zdWJfY2F0ZWdvcnlbcmV0dXJuYWJsZV9zdWJfY2F0ZWdvcnkkbWFya2V0ID09IG1hcmtldCxdICU+JQogIGdncGxvdChhZXMoeCA9ICIiLCB5ID0gcGVyYywgZmlsbCA9IHN1Yl9jYXRlZ29yeSkpICsKICBnZW9tX2NvbCgpICsgCiAgICBnZW9tX3RleHQoYWVzKGxhYmVsID0gc2NhbGVzOjpwZXJjZW50KHBlcmMpKSwgc2l6ZT0zLCBwb3NpdGlvbiA9IHBvc2l0aW9uX3N0YWNrKHZqdXN0ID0gMC41KSkgKwogIGNvb3JkX3BvbGFyKHRoZXRhID0gInkiKSArCiAgICBsYWJzKHRpdGxlPXBhc3RlKCJUb3AgNSByZXR1cm5hYmxlIHN1Yi1jYXRlZ29yaWVzIGluIiwgbWFya2V0LCAibWFya2V0IiksIHg9IiIsIHk9IiIsIGZpbGw9IlN1Yi1DYXRlZ29yeSIpICsKICAgIHRoZW1lKAogIGF4aXMudGV4dCA9IGVsZW1lbnRfYmxhbmsoKSwgYXhpcy50aWNrcyA9IGVsZW1lbnRfYmxhbmsoKSwgcGFuZWwuZ3JpZCA9IGVsZW1lbnRfYmxhbmsoKSwKICBwYW5lbC5ncmlkLm1ham9yID0gZWxlbWVudF9ibGFuaygpLCBwYW5lbC5ib3JkZXIgPSBlbGVtZW50X2JsYW5rKCkpCiAgKSAKCiAgfQoKYGBgCgojIyBXaGF0IGFyZSBudW1iZXIgb2YgdG90YWwgYW5kIG5ldyBjdXN0b21lcnM/CgpgYGB7c3FsIGNvbm5lY3Rpb249Y29uLCBvdXRwdXQudmFyPSJuZXdfdG90YWxfY3VzdG9tZXJzIn0KCldJVEggY3RlX3RpbWVzcG90IEFTIChTRUxFQ1QgbS5tYXJrZXQsIGEueWVhciwgYS5xdWFydGVyCiAgICAgICAgICAgICAgICAgICAgICBGUk9NIChTRUxFQ1QgRElTVElOQ1QgbWFya2V0IEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMpIG0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENST1NTIEpPSU4KICAgICAgICAgICAgICAgICAgICAgICAgICAgKFNFTEVDVCBiLnllYXIsIGEucXVhcnRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgRlJPTSAoU0VMRUNUIFVOTkVTVChBUlJBWSBbMSwgMiwgMywgNF0pIEFTIHF1YXJ0ZXIpIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENST1NTIEpPSU4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChTRUxFQ1QgVU5ORVNUKEFSUkFZIFsyMDExLCAyMDEyLCAyMDEzLCAyMDE0XSkgQVMgeWVhcikgYgogICAgICAgICAgICAgICAgICAgICAgICAgICAgT1JERVIgQlkgMSwgMikgYQogICAgICAgICAgICAgICAgICAgICAgT1JERVIgQlkgMSwgMiwgMyksCiAgICAgY3RlX3VuaXF1ZV9jdXN0b21lcnMgQVMgKFNFTEVDVCBtYXJrZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFWFRSQUNUKFlFQVIgRlJPTSBvcmRlcl9kYXRlKSAgICBBUyB5ZWFyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRVhUUkFDVChRVUFSVEVSIEZST00gb3JkZXJfZGF0ZSkgQVMgcXVhcnRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENPVU5UKERJU1RJTkNUIGN1c3RvbWVyX2lkKSAgICAgIEFTIHVuaXF1ZV9jdXN0b21lcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlJPTSBhbmFseXNpcy5hbGxfZ2xvYmFsX29yZGVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHUk9VUCBCWSAxLCAyLCAzKSwKICAgICBjdGVfbmV3X2N1c3RvbWVycyBBUyAoU0VMRUNUIG1hcmtldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHllYXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWFydGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ09VTlQoRElTVElOQ1QgY3VzdG9tZXJfaWQpIEFTIG5ld19jdXN0b21lcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgRlJPTSAoU0VMRUNUIERJU1RJTkNUIG1hcmtldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWVyX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRklSU1RfVkFMVUUoRVhUUkFDVChZRUFSIEZST00gb3JkZXJfZGF0ZSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPVkVSIChQQVJUSVRJT04gQlkgbWFya2V0LCBjdXN0b21lcl9pZCBPUkRFUiBCWSBFWFRSQUNUKFlFQVIgRlJPTSBvcmRlcl9kYXRlKSkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFTIHllYXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGSVJTVF9WQUxVRShFWFRSQUNUKFFVQVJURVIgRlJPTSBvcmRlcl9kYXRlKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9WRVIgKFBBUlRJVElPTiBCWSBtYXJrZXQsIGN1c3RvbWVyX2lkIE9SREVSIEJZIEVYVFJBQ1QoWUVBUiBGUk9NIG9yZGVyX2RhdGUpLCBFWFRSQUNUKFFVQVJURVIgRlJPTSBvcmRlcl9kYXRlKSkgQVMgcXVhcnRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGUk9NIGFuYWx5c2lzLmFsbF9nbG9iYWxfb3JkZXJzKSBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgIEdST1VQIEJZIG1hcmtldCwgeWVhciwgcXVhcnRlcikKU0VMRUNUIGEubWFya2V0LAogICAgICAgYS55ZWFyLAogICAgICAgYS5xdWFydGVyLAogICAgICAgYS51bmlxdWVfY3VzdG9tZXJzOjpJTlQsCiAgICAgICBDT0FMRVNDRShiLm5ld19jdXN0b21lcnMsIDApOjpJTlQgQVMgbmV3X2N1c3RvbWVycywKICAgICAgIENPTkNBVCgnUScsIGEucXVhcnRlciwgJycnJywgU1VCU1RSSU5HKFRFWFQoYS55ZWFyKSwgMywgMikpICAgICAgICAgICAgICAgQVMgcXksCiAgICAgICBST1dfTlVNQkVSKCkgT1ZFUiAoUEFSVElUSU9OIEJZIGEubWFya2V0IE9SREVSIEJZIGEueWVhciwgYS5xdWFydGVyKTo6SU5UIEFTIG4KRlJPTSBjdGVfdGltZXNwb3QgdAogICAgICAgICBMRUZUIEpPSU4KICAgICBjdGVfdW5pcXVlX2N1c3RvbWVycyBhIE9OIHQubWFya2V0ID0gYS5tYXJrZXQgQU5EIHQueWVhciA9IGEueWVhciBBTkQgdC5xdWFydGVyID0gYS5xdWFydGVyCiAgICAgICAgIExFRlQgSk9JTgogICAgIGN0ZV9uZXdfY3VzdG9tZXJzIGIgT04gYS5tYXJrZXQgPSBiLm1hcmtldCBBTkQgYS55ZWFyID0gYi55ZWFyIEFORCBhLnF1YXJ0ZXIgPSBiLnF1YXJ0ZXI7CgpgYGAKCmBgYHtyfQojIHByaW50IHJlc3VsdHMKbmV3X3RvdGFsX2N1c3RvbWVycwoKYGBgCgoKYGBge3IgbWVzc2FnZT1UUlVFLCB3YXJuaW5nPVRSVUV9Cgpmb3IgKG1hcmtldCBpbiB1bmlxdWUobmV3X3RvdGFsX2N1c3RvbWVycyRtYXJrZXQpKSB7CiAgcGxvdCA8LSBnZ3Bsb3QobmV3X3RvdGFsX2N1c3RvbWVyc1tuZXdfdG90YWxfY3VzdG9tZXJzJG1hcmtldD09bWFya2V0LF0pICsKICAgIGdlb21fYmFyKGFlcyh4PWZjdF9yZW9yZGVyKHF5LCBuKSwgeT11bmlxdWVfY3VzdG9tZXJzLCBmaWxsPSJVbmlxdWUgQ3VzdG9tZXJzIiksIHN0YXQ9ImlkZW50aXR5IikgKwogICAgZ2VvbV9saW5lKGFlcyh4PWZjdF9yZW9yZGVyKHF5LCBuKSwgeT1uZXdfY3VzdG9tZXJzLCBncm91cD0xLCBjb2xvcj0iTmV3IEN1c3RvbWVycyIpLCBzaXplPTEpICsgCiAgICBnZW9tX3BvaW50KGFlcyh4PWZjdF9yZW9yZGVyKHF5LCBuKSwgeT1uZXdfY3VzdG9tZXJzLCBjb2xvcj0iTmV3IEN1c3RvbWVycyIpLCBzaGFwZT0xOCwgc2l6ZT0zKSArCiAgICBnZW9tX3RleHQoYWVzKHg9ZmN0X3Jlb3JkZXIocXksIG4pLCB5PW5ld19jdXN0b21lcnMsIGxhYmVsPXNjYWxlczo6bnVtYmVyKG5ld19jdXN0b21lcnMpKSwgc2l6ZT0zLCB2anVzdD0tMS4yKSArCiAgICBnZW9tX3ZsaW5lKHhpbnRlcmNlcHQgPSBzZXEoNC41LCAxMi41LCA0KSwgbGluZXR5cGU9ImRvdHRlZCIsIGNvbG9yPSJncmF5IikgKwogICAgc2NhbGVfZmlsbF9tYW51YWwobmFtZT0iIiwgdmFsdWVzPWMoIlVuaXF1ZSBDdXN0b21lcnMiPSIjZTViYzhiIikpICsKICAgIHNjYWxlX2NvbG9yX21hbnVhbChuYW1lPSIiLCB2YWx1ZXM9YygiTmV3IEN1c3RvbWVycyI9IiMwMDNmNWMiKSkgKwogICAgc2NhbGVfeV9jb250aW51b3VzKGxpbWl0cyA9IGMoMCwgbWF4KG5ld190b3RhbF9jdXN0b21lcnNbbmV3X3RvdGFsX2N1c3RvbWVycyRtYXJrZXQ9PW1hcmtldCxdJHVuaXF1ZV9jdXN0b21lcnMpKjEuMSkpICsKICAgIGxhYnModGl0bGU9cGFzdGUoJ1RvdGFsIHVuaXF1ZSBhbmQgbmV3IGN1c3RvbWVycyBpbicsIG1hcmtldCwgJ21hcmtldCcpLCB4PSIiLCB5PSJOdW1iZXIgb2YgY3VzdG9tZXJzIikgKwogICAgdGhlbWUobGVnZW5kLnBvc2l0aW9uID0gInRvcCIsIHBhbmVsLmdyaWQubWFqb3IgPSBlbGVtZW50X2JsYW5rKCkpCiAgICAKICBwcmludChwbG90KQp9CgpgYGAKCgojIyBQZXJjZW50YWdlIG9mIG5ldyBidXNpbmVzcyByZXZlbnVlIGdlbmVyYXRpb24KCmBgYHtzcWwgY29ubmVjdGlvbj1jb24sIG91dHB1dC52YXI9Im5ld19idXNpbmVzcyJ9CgpXSVRIIGN0ZV9hbGxfb3JkZXJzIEFTIChTRUxFQ1QgbWFya2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmRlcl9kYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTVU0oc2FsZXMpIEFTIHNhbGVzCiAgICAgICAgICAgICAgICAgICAgICAgIEZST00gYW5hbHlzaXMuYWxsX2dsb2JhbF9vcmRlcnMKICAgICAgICAgICAgICAgICAgICAgICAgR1JPVVAgQlkgMSwgMiwgMywgNCkKU0VMRUNUICosCiAgICAgICBST1dfTlVNQkVSKCkgT1ZFUiAoUEFSVElUSU9OIEJZIG1hcmtldCBPUkRFUiBCWSB5ZWFyLCBxdWFydGVyKSBBUyBuCkZST00gKFNFTEVDVCBtYXJrZXQsCiAgICAgICAgICAgICB5ZWFyLAogICAgICAgICAgICAgcXVhcnRlciwKCiAgICAgICAgICAgICBDT05DQVQoJ1EnLCBxdWFydGVyLCAnJycnLCBTVUJTVFJJTkcoVEVYVCh5ZWFyKSwgMywgMikpICAgICAgICAgICAgICAgICAgICAgICAgICAgQVMgcXksCiAgICAgICAgICAgICBDT0FMRVNDRShTVU0oc2FsZXMpIEZJTFRFUiAoV0hFUkUgeWVhciA9IGZpcnN0X3llYXIpLCAwKSAgICAgICAgICAgICAgICAgICAgICAgICAgQVMgbmV3X3NhbGVzLAogICAgICAgICAgICAgU1VNKHNhbGVzKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFTIHRvdGFsX3NhbGVzLAogICAgICAgICAgICAgUk9VTkQoKENPQUxFU0NFKFNVTShzYWxlcykgRklMVEVSIChXSEVSRSB5ZWFyID0gZmlyc3RfeWVhciksIDApKSAvIFNVTShzYWxlcyksIDIpIEFTIHByb2NfbmV3X2J1c2luZXNzCiAgICAgIEZST00gKFNFTEVDVCAqLAogICAgICAgICAgICAgICAgICAgRVhUUkFDVChZRUFSIEZST00gb3JkZXJfZGF0ZSkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQVMgeWVhciwKICAgICAgICAgICAgICAgICAgIEVYVFJBQ1QoUVVBUlRFUiBGUk9NIG9yZGVyX2RhdGUpICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFTIHF1YXJ0ZXIsCiAgICAgICAgICAgICAgICAgICBGSVJTVF9WQUxVRShFWFRSQUNUKFlFQVIgRlJPTSBvcmRlcl9kYXRlKSkKICAgICAgICAgICAgICAgICAgIE9WRVIgKFBBUlRJVElPTiBCWSBtYXJrZXQsIGN1c3RvbWVyX2lkIE9SREVSIEJZIG9yZGVyX2RhdGUpIEFTIGZpcnN0X3llYXIKICAgICAgICAgICAgRlJPTSBjdGVfYWxsX29yZGVycykgYQogICAgICBHUk9VUCBCWSBtYXJrZXQsIHllYXIsIHF1YXJ0ZXIsIHF5KSBhOwoKYGBgCgpgYGB7cn0KIyBwcmludCByZXN1bHRzCm5ld19idXNpbmVzcwpgYGAKCmBgYHtyfQoKZm9yIChtYXJrZXQgaW4gdW5pcXVlKG5ld19idXNpbmVzcyRtYXJrZXQpKSB7CiAgc2NhbGUgPC0gbWF4KG5ld19idXNpbmVzc1tuZXdfYnVzaW5lc3MkbWFya2V0ID09IG1hcmtldCxdJHRvdGFsX3NhbGVzKQogIGhpIDwtIHJvdW5kKHNjYWxlKjEuMSAvIDEwXmZsb29yKGxvZzEwKHNjYWxlKjEuMSkpLCAwKSoxMF5mbG9vcihsb2cxMChzY2FsZSoxLjEpKQogIHNjYWxlIDwtIHNjYWxlICogMC44CiAgcGxvdCA8LSBuZXdfYnVzaW5lc3NbbmV3X2J1c2luZXNzJG1hcmtldCA9PSBtYXJrZXQsXSAlPiUKICAgICAgICAgIGdncGxvdCgpICsgCiAgICAgICAgICBnZW9tX2JhcihhZXMoeD1mY3RfcmVvcmRlcihxeSwgbiksIHk9dG90YWxfc2FsZXMsIGZpbGw9IlRvdGFsIFJldmVudWUiKSwgc3RhdD0iaWRlbnRpdHkiKSsKICAgICAgICAgIGdlb21fYmFyKGFlcyh4PWZjdF9yZW9yZGVyKHF5LCBuKSwgeT1uZXdfc2FsZXMsIGZpbGw9Ik5ldyBSZXZlbnVlIiksIHN0YXQ9ImlkZW50aXR5IikrCiAgICAgICAgICBnZW9tX2xpbmUoYWVzKHg9ZmN0X3Jlb3JkZXIocXksIG4pLCB5PXByb2NfbmV3X2J1c2luZXNzKnNjYWxlLCBncm91cD0xLCBjb2xvcj0iTmV3IEJ1c2luZXNzIikpICsKICAgICAgICAgIGdlb21fcG9pbnQoYWVzKHg9ZmN0X3Jlb3JkZXIocXksIG4pLCB5PXByb2NfbmV3X2J1c2luZXNzKnNjYWxlLCBjb2xvcj0iTmV3IEJ1c2luZXNzIiksIHNoYXBlPTE4LCBzaXplPTMpICsKICAgICAgICAgIGdlb21fdGV4dChhZXMoeD1mY3RfcmVvcmRlcihxeSwgbiksIHk9cHJvY19uZXdfYnVzaW5lc3Mqc2NhbGUsIGxhYmVsPXNjYWxlczo6cGVyY2VudChwcm9jX25ld19idXNpbmVzcywgYWNjdXJhY3kgPSAwLjEpKSwgc2hhcGU9MTgsIHNpemU9Mi41LCB2anVzdD0tMSkgKwogICAgICAgICAgZ2VvbV92bGluZSh4aW50ZXJjZXB0ID0gc2VxKDQuNSwgMTIuNSwgNCksIGxpbmV0eXBlPSJkb3R0ZWQiLCBjb2xvcj0iZ3JheSIpICsKICAgICAgICAgIHNjYWxlX3lfY29udGludW91cyhsaW1pdHMgPSBjKDAsIGhpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWtzID0gc2VxKDAsIGhpLCBieSA9IGhpLzUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVscyA9IHNjYWxlczo6bnVtYmVyKHNlcSgwLCBoaSwgYnkgPSBoaS81KSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGUgPSAxMF4tKGZsb29yKGxvZzEwKGhpKSkgLSBmbG9vcihsb2cxMChoaSkpICUlIDMpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBpZmVsc2UoZmxvb3IobG9nMTAoaGkpKSAtIGZsb29yKGxvZzEwKGhpKSkgJSUgMyA+IDMsICJNIiwgIksiKSkpICsKICAgICAgICAgIGxhYnModGl0bGU9cGFzdGUoIlBlcmNlbnRhZ2Ugb2YgbmV3IGJ1c2luZXNzIHJldmVudWUgZ2VuZXJhdGlvbiBpbiIsIG1hcmtldCwgJ21hcmtldCcpLAogICAgICAgICAgICAgICB4PSIiLCB5PSJSZXZlbnVlLCAkIikgKwogICAgICAgICAgdGhlbWUobGVnZW5kLnBvc2l0aW9uID0gInRvcCIsCiAgICAgICAgICAgICAgICBsZWdlbmQudGl0bGUgPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgICAgICAgICBheGlzLnRpdGxlLnggPSBlbGVtZW50X2JsYW5rKCksCiAgICAgICAgICAgICAgICBwYW5lbC5ncmlkLm1ham9yID0gZWxlbWVudF9ibGFuaygpKSArCiAgICBzY2FsZV9maWxsX21hbnVhbChuYW1lPSIiLCB2YWx1ZXMgPSBjKCJUb3RhbCBSZXZlbnVlIj0iI2RiZTVkYSIsICJOZXcgUmV2ZW51ZSI9IiNiYmNiYmMiKSkgKwogICAgc2NhbGVfY29sb3JfbWFudWFsKG5hbWU9IiIsIHZhbHVlcyA9IGMoIk5ldyBCdXNpbmVzcyI9IiM1ZTg3NjUiKSkKICAgIAogIHByaW50KHBsb3QpCn0KCgpgYGAKCgpgYGB7cn0KCiMgRGlzY29ubmVjdCBEQiBjb25uZWN0aW9uCmRiRGlzY29ubmVjdChjb25uID0gY29uKQoKYGBgCgo=</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("superstore_global_analysis.Rmd");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
